<!DOCTYPE html><html><head><meta charSet="utf-8"/><title class="animate__fadeIn">0xPhaze</title><meta name="viewport" content="initial-scale=1.0, width=device-width"/><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/f18da0241135f2a4.css" as="style"/><link rel="stylesheet" href="/_next/static/css/f18da0241135f2a4.css" data-n-g=""/><link rel="preload" href="/_next/static/css/65875c30e26bdd78.css" as="style"/><link rel="stylesheet" href="/_next/static/css/65875c30e26bdd78.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-ede13cf31a63337e.js" defer=""></script><script src="/_next/static/chunks/framework-bb5c596eafb42b22.js" defer=""></script><script src="/_next/static/chunks/main-914fbfab4f90b52f.js" defer=""></script><script src="/_next/static/chunks/pages/_app-ad82082731d58181.js" defer=""></script><script src="/_next/static/chunks/175675d1-5e59763be147fa1f.js" defer=""></script><script src="/_next/static/chunks/634-958ce5c52c8283ef.js" defer=""></script><script src="/_next/static/chunks/pages/%5B...slug%5D-1036fd4ff48bafcd.js" defer=""></script><script src="/_next/static/Ob_ZNrHzPQ-bg8j1Qlw7q/_buildManifest.js" defer=""></script><script src="/_next/static/Ob_ZNrHzPQ-bg8j1Qlw7q/_ssgManifest.js" defer=""></script><script src="/_next/static/Ob_ZNrHzPQ-bg8j1Qlw7q/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="app px-4 pb-20 min-h-screen flex flex-col items-center w-full max-w-screen"><header class="w-full flex flex-col px-4 sm:px-8 md:px-12 max-w-5xl sm:flex-row justify-between items-center border-white/20 overflow-hidden border-b p-4 h-16"><div class="w-full h-full flex flex-col sm:flex-row justify-start sm:justify-between items-center gap-y-4 overflow-hidden sm:overflow-visible"><div class="flex w-full sm:w-fit items-center"><h1 class="text-xl mx-auto font-display"><a href="/">0xPhaze</a></h1><div class="my-auto -ml-6 w-6 sm:hidden"><div class="text-slate-300 hover:text-secondary-400 transition-colors duration-200 cursor-pointer h-6"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="bars" class="svg-inline--fa fa-bars " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416C433.7 64 448 78.33 448 96C448 113.7 433.7 128 416 128H32C14.33 128 0 113.7 0 96zM0 256C0 238.3 14.33 224 32 224H416C433.7 224 448 238.3 448 256C448 273.7 433.7 288 416 288H32C14.33 288 0 273.7 0 256zM416 448H32C14.33 448 0 433.7 0 416C0 398.3 14.33 384 32 384H416C433.7 384 448 398.3 448 416C448 433.7 433.7 448 416 448z"></path></svg></div></div></div><div class="flex flex-col sm:flex-row gap-x-8 md:gap-x-10 gap-y-4"><div class="flex gap-x-2 sm:gap-x-5 items-center justify-evenly"><a target="_blank" rel="noreferrer" class="link" href="https://github.com/0xPhaze/"><div><div class="text-slate-300 hover:text-secondary-400 transition-colors duration-200 cursor-pointer"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-4"><path style="fill:currentColor" d="M12 0C5.374 0 0 5.373 0 12c0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23A11.509 11.509 0 0 1 12 5.803c1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.3 24 12c0-6.627-5.373-12-12-12z"></path></svg></div></div></a><a target="_blank" rel="noreferrer" class="link" href="https://twitter.com/lovethewired"><div><div class="text-slate-300 hover:text-secondary-400 transition-colors duration-200 cursor-pointer"><svg viewBox="0 0 16 14" fill="none" xmlns="http://www.w3.org/2000/svg" class="h-4"><path style="fill:currentColor" d="M15.584 1.578a7.91 7.91 0 0 1-1.57 1.807v.482c0 .965-.112 1.929-.336 2.772-.224.965-.673 1.808-1.121 2.652a17.373 17.373 0 0 1-1.794 2.29c-.785.723-1.681 1.205-2.578 1.566-1.01.362-2.13.603-3.252.603-1.793 0-3.475-.603-4.932-1.567h.784c1.458 0 2.915-.482 4.036-1.446a2.914 2.914 0 0 1-1.905-.723c-.561-.482-.897-.964-1.122-1.687h.561c.336 0 .56 0 .897-.12C2.579 8.085 1.907 7.603 1.458 7 .785 6.398.561 5.675.561 4.83c.449.242 1.01.362 1.458.483A5.531 5.531 0 0 1 .898 4.109C.673 3.626.449 3.024.449 2.42c0-.602.112-1.205.449-1.687a8.606 8.606 0 0 0 2.914 2.53c1.122.603 2.355.965 3.7 1.086 0-.241-.112-.483-.112-.844 0-.723.224-1.326.56-1.928.337-.603.897-.965 1.458-1.326.56-.241 1.233-.362 1.906-.12.672.12 1.233.481 1.681.964.673-.121 1.458-.362 2.018-.844-.224.844-.784 1.446-1.457 1.928.785-.12 1.457-.24 2.018-.602Z" fill="#081026"></path></svg></div></div></a><div><div class="text-slate-300 hover:text-secondary-400 transition-colors duration-200 cursor-pointer">ABI</div></div><div><div class="text-slate-300 hover:text-secondary-400 transition-colors duration-200 cursor-pointer">ENC</div></div></div><button class="rounded px-4 py-2 uppercase text-white select-none  transition-all duration-300 disabled:pointer-events-none bg-primary-600 hover:bg-primary-700  !outline-none normal-case text-sm w-[140px] w-36">Connect Wallet</button></div></div></header><main class="gap-y-20 mt-8 py-4 sm:px-8 md:px-12 w-full min-h-[500px] max-w-4xl"><div class="flex flex-col justify-between gap-y-20"><div class="content markdown"><h1 class="text-center">Test Your Tests!</h1><h2 class="text-center">The Dos and Don&#x27;ts of testing</h2><p class="text-slate-500 text-sm text-center">Oct 20, 2023</p><div class="mt-16"><blockquote>
<p>This is a writeup of the talks given at <a target="_blank" rel="noreferrer" class="link" href="https://www.secureum.xyz/trustx/">TrustX</a> and <a target="_blank" rel="noreferrer" class="link" href="https://soliditylang.org/summit/">Solidity Summit</a> at <a target="_blank" rel="noreferrer" class="link" href="https://devconnect.org/">Devconnect Istanbul 2023</a>. I am a blockchain security engineer and researcher at Trail of Bits.</p>
</blockquote>
<p><em>In order to gain the most out of this article, it is advised that you actively try to discover the issue within the tests in the examples (hidden behind spoiler tags). Take a moment and consider what patterns might seem dangerous or brittle and how you could implement safer tests.</em></p>
<p>In the rapidly evolving landscape of software development, <strong>the importance of rigorous testing cannot be overstated</strong>. This is especially true when dealing with mission-critical systems like blockchains with millions at risk. The reliability of tests are fundamental to ensuring the integrity and security of these systems. But, <em>how can we guarantee robustness of our tests, and how do we evaluate their quality and efficacy?</em></p>
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="/blog/2023/test-your-tests#the-role-of-testing">The Role of Testing</a></li>
<li><a href="/blog/2023/test-your-tests#motivation-behind-the-topic">Motivation Behind the Topic</a>
<ul>
<li><a href="/blog/2023/test-your-tests#improving-erc721a">Improving ERC721A</a></li>
<li><a href="/blog/2023/test-your-tests#development-and-testing-approach">Development and Testing Approach</a></li>
</ul>
</li>
<li><a href="/blog/2023/test-your-tests#testing-shortcomings-exemplified">Testing Shortcomings Exemplified</a>
<ul>
<li><a href="/blog/2023/test-your-tests#testing-wad-conversions">Testing WAD Conversions</a></li>
<li><a href="/blog/2023/test-your-tests#testing-wad-multiplication">Testing WAD Multiplication</a></li>
<li><a href="/blog/2023/test-your-tests#exploring-various-testing-strategies">Exploring Various Testing Strategies</a></li>
</ul>
</li>
<li><a href="/blog/2023/test-your-tests#offensive-testing">Offensive Testing</a>
<ul>
<li><a href="/blog/2023/test-your-tests#case-study-primitive-finance---hyper">Case Study: Primitive Finance - Hyper</a></li>
<li><a href="/blog/2023/test-your-tests#initial-testing-strategy">Initial Testing Strategy</a></li>
<li><a href="/blog/2023/test-your-tests#refining-the-testing-strategy">Refining the Testing Strategy</a></li>
</ul>
</li>
<li><a href="/blog/2023/test-your-tests#conclusions-and-takeaways">Conclusions and Takeaways</a></li>
<li><a href="/blog/2023/test-your-tests#extra-material-additional-testing-shortcomings">Extra Material: Additional Testing Shortcomings</a>
<ul>
<li><a href="/blog/2023/test-your-tests#testing-helper-functions">Testing Helper Functions</a></li>
<li><a href="/blog/2023/test-your-tests#tool-quirks">Tool Quirks</a></li>
</ul>
</li>
</ul>
<h3 id="the-role-of-testing"><a href="/blog/2023/test-your-tests#the-role-of-testing"><span class="icon icon-link"></span></a>The Role of Testing</h3>
<p><em>Why do we even test our software?</em></p>
<p>Tests are primarily written with the goal of <strong>identifying incorrect or unexpected behavior</strong> of our software. Unit tests are great for validating that our code will produce a certain outcome given an input. With the advancement of automated testing we are also able to <strong>validate properties or invariants of our system</strong> by simulating function calls with persistent state. Unit and fuzz tests can also be great for <strong>ensuring that a piece of code adheres to its specification</strong>. Tests for the ERC721 standard, for example, can be applied to an extension of the specification in order to uncover unexpected deviations from the requirements of the norm.</p>
<p>What&#x27;s more, tests act as the protective layer for preserving code functionality. A well-crafted test should <strong>cement the anticipated code behavior</strong>, safeguarding it against unexpected issues that might be introduced in future modifications.</p>
<p>Although applying various testing methods and static analysis can vouch for your code&#x27;s stability, it&#x27;s important to keep in mind that <strong>no test and testing method is infallible</strong>. <em>Testing is an ongoing process of refinement, not a final endpoint!</em> It is impossible to gain absolute certainty that your code will be bug-free. Tests may contain bugs themselves, fuzzers can be used ineffectively and even tools for formal verification make faulty assumptions and suffer from state explosion or bad heuristics. In order to achieve robustness in software, constant attention and multiple testing methods are essential.</p>
<h3 id="motivation-behind-the-topic"><a href="/blog/2023/test-your-tests#motivation-behind-the-topic"><span class="icon icon-link"></span></a>Motivation Behind the Topic</h3>
<p>This topic&#x27;s inspiration stems from my own experiences and reflections on past shortcomings. Before becoming a security researcher, I paved my path as a developer. Every developer makes a mistake at some point. I wanted to learn from every single one of them. Each identified vulnerability led me to re-evaluate my approach–––<em>how could I improve my development and testing process to prevent similar situations arising in the future?</em></p>
<p>A memorable experience in this regard remains when optimizing the <a target="_blank" rel="noreferrer" class="link" href="https://www.erc721a.org/">ERC721A</a> contract.</p>
<h3 id="improving-erc721a"><a href="/blog/2023/test-your-tests#improving-erc721a"><span class="icon icon-link"></span></a>Improving ERC721A</h3>
<p>ERC721A works by leveraging batched token mints involving sequential IDs. The idea is to defer costly storage operations at a time of high network costs (during the mint) to a time of low network costs (for subsequent transfers). This is done by keeping the ownership data of IDs minted in sequence implicit instead of explicitly committing them to the storage one by one.</p>
<p>When identifying the owner of an ID, if the ownership data is empty (uncommitted/implicit), then the owner is looked up in the previous slot.</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span>Bob mints 5 IDs:
</span></span><span>               tokenId
</span><span>                  V
</span><span>| X | Bob |    |    |    |    | Y |
</span><span>       ^
</span><span>      from
</span><span>
</span><span>Bob transfers `tokenId` to Eve:
</span><span>
</span><span>| X | Bob |    | Eve |    |    | Y |
</span><span>                  ^
</span><span>                  to
</span><span>
</span><span>Following Ownership Commit:
</span><span>
</span><span>| X | Bob |    | Eve | Bob |    | Y |
</span><span>                        ^
</span></code></pre></pre>
<p>Upon transfers, ERC721A checks whether the ownership data of the subsequent ID is explicit or implicit. In order to maintain consistent ownership data, it must be set explicitly.</p>
<p>It&#x27;s not important to understand the specifics of the implementation. All that should be known is that it aims to mimic the behavior of an ERC721 and maintain correct NFT ownerships. However, the underlying business logic makes it such that <em>new edge-cases not present in the default ERC721 implementation need to be handled with additional care</em>.</p>
<p>The idea for further optimization in the ERC721A contract came from realizing that the check for explicit ownership of the subsequent ID was only required to be performed a single time. Once the data is explicit, this check can be skipped, saving gas on all future transfers by removing a cold storage load. A boolean variable <code>nextTokenDataSet</code> packed together in the current (already warm) ownership slot could track whether the following data is explicit.</p>
<h3 id="development-and-testing-approach"><a href="/blog/2023/test-your-tests#development-and-testing-approach"><span class="icon icon-link"></span></a>Development and Testing Approach</h3>
<p>At the time, testing had become an integral part of my development process. I often wrote tests before the actual implementation guiding my process. The idea was that through sufficiently covering as many scenarios as possible in tests any coding mistake would eventually be uncovered. <em>However, this approach can backfire when the implementation nuances are disregarded</em>. For the ERC721A optimization, I ended up writing four unit tests in addition to Solmate&#x27;s ERC721 unit and fuzz tests to validate that the ownerships remained consistent.</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span> </span><span class="token" style="color:#6f705e">/// Transfer last minted id.</span><span>
</span></span><span><span> </span><span class="token" style="color:#6f705e">/// Ensure id beyond last is not written to.</span><span>
</span></span><span><span> </span><span class="token" style="color:#6f705e">/// Ensure correct ownership.</span><span>
</span></span><span><span> </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">test_transferFrom1</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">public</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>     </span><span class="token" style="color:#6f705e">// ...</span><span>
</span></span><span><span> </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span>
</span><span><span> </span><span class="token" style="color:#6f705e">/// Transfer last two minted IDs in batch.</span><span>
</span></span><span><span> </span><span class="token" style="color:#6f705e">/// Ensure correct ownership.</span><span>
</span></span><span><span> </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">test_transferFrom2</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">public</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>     </span><span class="token" style="color:#6f705e">// ...</span><span>
</span></span><span><span> </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span>
</span><span><span> </span><span class="token" style="color:#6f705e">/// Mint new tokens after previous transfers.</span><span>
</span></span><span><span> </span><span class="token" style="color:#6f705e">/// Ensure correct ownership.</span><span>
</span></span><span><span> </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">test_transferFrom3</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">public</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>     </span><span class="token" style="color:#6f705e">// ...</span><span>
</span></span><span><span> </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span>
</span><span><span> </span><span class="token" style="color:#6f705e">/// Transfer tokens in middle of batch.</span><span>
</span></span><span><span> </span><span class="token" style="color:#6f705e">/// Ensure correct ownership.</span><span>
</span></span><span><span> </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">test_transferFrom4</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">public</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>     </span><span class="token" style="color:#6f705e">// ...</span><span>
</span></span><span><span> </span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<p>Imagine my surprise when I was notified about a bug in the implementation.</p>
<p><img src="/data/blog/2023/test-your-tests/bug-alert.png" alt="Bug alert"/></p>
<p>I was surprised how this was even possible with all those extra test scenarios. Eventually, in order to mitigate the bug, I ended up including an additional test-case which showed up as failing.</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span class="token" style="color:#6f705e">/// Transfer first token in batch.</span><span>
</span></span><span><span></span><span class="token" style="color:#6f705e">/// Ensure correct ownership.</span><span>
</span></span><span><span></span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">test_transferFrom5</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">public</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>    </span><span class="token" style="color:#6f705e">// ...</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<p>Then I quickly applied a patch that would satisfy all the tests.</p>
<p>Imagine my shock when I discovered that I had inadvertently included another bug in my patch which the expanded tests did not catch. This realization led me to slow down and reflect on the shortcomings of my current approach.</p>
<p><em>What went wrong?</em></p>
<p>It is hard to point a finger on what exactly had gone wrong and allowed a bug to slip through the cracks of all the tests. Was I supposed to create unit tests for every possible state? After tracking all relevant variables related to control flow and producing tests covering the cartesian product of all important states, I realized that such an approach is likely infeasible in most practical cases due to the high overhead and state explosion.</p>
<p>I realized that there is no one single thing which I should have done differently given a limited budget on time. Nevertheless, a few things can be said. For one, I was <strong>lacking structure and a systematic approach</strong> when writing the tests. This is especially true when covering every possible state is infeasible. In my case, this lead to <strong>missing important edge-cases</strong> in the tests that were relevant to the optimization. Another thing that could be identified was that some tests were <strong>testing multiple things at once</strong> which pronounced the lack of structure.</p>
<p>Finally another important factor was that I was <strong>lacking expressive and meaningful fuzz tests</strong> that could handle, multiple transfers with random IDs and arbitrary actors. Let&#x27;s further analyze how testing shortcomings could be avoided in simpler examples.</p>
<h3 id="testing-shortcomings-exemplified"><a href="/blog/2023/test-your-tests#testing-shortcomings-exemplified"><span class="icon icon-link"></span></a>Testing Shortcomings Exemplified</h3>
<h3 id="testing-wad-conversions"><a href="/blog/2023/test-your-tests#testing-wad-conversions"><span class="icon icon-link"></span></a>Testing WAD Conversions</h3>
<p>To shed light on the concepts discussed, consider a simple exercise of writing a fuzz test for WAD unit conversions.</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span>uint256 constant </span><span class="token constant">WAD</span><span> </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#a77afe">1e18</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span></span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">fromWAD</span><span class="token" style="color:#bebec5">(</span><span class="token parameter">uint256 a</span><span class="token" style="color:#bebec5">)</span><span> pure </span><span class="token function">returns</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token parameter">uint256 c</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>    c </span><span class="token" style="color:#a77afe">=</span><span> a </span><span class="token" style="color:#a77afe">/</span><span> </span><span class="token constant">WAD</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span>
</span><span><span></span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">toWAD</span><span class="token" style="color:#bebec5">(</span><span class="token parameter">uint256 a</span><span class="token" style="color:#bebec5">)</span><span> pure </span><span class="token function">returns</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token parameter">uint256 c</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>    c </span><span class="token" style="color:#a77afe">=</span><span> a </span><span class="token" style="color:#a77afe">*</span><span> </span><span class="token constant">WAD</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span>
</span><span><span>contract </span><span class="token maybe-class-name">TestFromWAD_DONT</span><span> is </span><span class="token maybe-class-name">Test</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">test_toWAD_fromWAD</span><span class="token" style="color:#bebec5">(</span><span class="token parameter">uint256 a</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">public</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        </span><span class="token control-flow" style="color:#ef3b7d">if</span><span> </span><span class="token" style="color:#bebec5">(</span><span>a </span><span class="token" style="color:#a77afe">&gt;=</span><span> </span><span class="token function">type</span><span class="token" style="color:#bebec5">(</span><span>uint256</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">max</span><span> </span><span class="token" style="color:#a77afe">/</span><span> </span><span class="token constant">WAD</span><span class="token" style="color:#bebec5">)</span><span> vm</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">expectRevert</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        </span><span class="token function">assertEq</span><span class="token" style="color:#bebec5">(</span><span class="token function">fromWAD</span><span class="token" style="color:#bebec5">(</span><span class="token function">toWAD</span><span class="token" style="color:#bebec5">(</span><span>a</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">,</span><span> a</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span class="token maybe-class-name">Running</span><span> </span><span class="token" style="color:#a77afe">1</span><span> test </span><span class="token control-flow" style="color:#ef3b7d">for</span><span> test</span><span class="token" style="color:#a77afe">/</span><span class="token maybe-class-name">TestFromWAD</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">sol</span><span class="token" style="color:#a77afe">:</span><span class="token maybe-class-name">TestFromWAD_DONT</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">[</span><span class="token constant">PASS</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token function">test_toWAD_fromWAD</span><span class="token" style="color:#bebec5">(</span><span>uint256</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">(</span><span>runs</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token" style="color:#a77afe">10000</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token literal-property property">μ</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token" style="color:#a77afe">1201</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">~</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token" style="color:#a77afe">589</span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span></span><span class="token maybe-class-name">Test</span><span> result</span><span class="token" style="color:#a77afe">:</span><span> ok</span><span class="token" style="color:#bebec5">.</span><span> </span><span class="token" style="color:#a77afe">1</span><span> passed</span><span class="token" style="color:#bebec5">;</span><span> </span><span class="token" style="color:#a77afe">0</span><span> failed</span><span class="token" style="color:#bebec5">;</span><span> </span><span class="token" style="color:#a77afe">0</span><span> skipped</span><span class="token" style="color:#bebec5">;</span><span> finished </span><span class="token" style="color:#ef3b7d">in</span><span> </span><span class="token" style="color:#a77afe">156</span><span class="token" style="color:#bebec5">.</span><span>80ms</span></span></code></pre></pre>
<p>While the fuzz test passes, there is something wrong in this setup.</p>
<details>
<summary><b>Spot the issue above! [spoiler]</b><br/><br/></summary>
<p>While the above test passed numerous fuzzing iterations, the test itself contains an incorrect boundary check which the fuzzer doesn&#x27;t find. Specifically, the conversion should not revert for <code>a = type(uint256).max / WAD</code>.</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span class="token deleted-sign prefix" style="color:#ef3b7d">-</span><span class="token deleted-sign line" style="color:#ef3b7d">       if (a &gt;= type(uint256).max / WAD) vm.expectRevert();
</span></span><span><span class="token deleted-sign line" style="color:#ef3b7d"></span><span class="token inserted-sign prefix" style="color:#a6e22d">+</span><span class="token inserted-sign line" style="color:#a6e22d">       if (a &gt;  type(uint256).max / WAD) vm.expectRevert();</span></span></code></pre></pre>
<p>To further illustrate this, we can create a unit test and pass the boundary point to our fuzz test.</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">test_toWAD_fromWAD_boundary</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">public</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>    uint256 a </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">type</span><span class="token" style="color:#bebec5">(</span><span>uint256</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">max</span><span> </span><span class="token" style="color:#a77afe">/</span><span> </span><span class="token constant">WAD</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#ef3b7d">this</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">test_toWAD_fromWAD</span><span class="token" style="color:#bebec5">(</span><span>a</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span class="token maybe-class-name">Running</span><span> </span><span class="token" style="color:#a77afe">2</span><span> tests </span><span class="token control-flow" style="color:#ef3b7d">for</span><span> test</span><span class="token" style="color:#a77afe">/</span><span class="token maybe-class-name">TestFromWAD</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">sol</span><span class="token" style="color:#a77afe">:</span><span class="token maybe-class-name">TestFromWAD_DONT</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">[</span><span class="token constant">PASS</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token function">test_toWAD_fromWAD</span><span class="token" style="color:#bebec5">(</span><span>uint256</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">(</span><span>runs</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token" style="color:#a77afe">10000</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token literal-property property">μ</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token" style="color:#a77afe">1222</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">~</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token" style="color:#a77afe">589</span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">[</span><span class="token constant">FAIL</span><span class="token" style="color:#bebec5">.</span><span> </span><span class="token property-access maybe-class-name">Reason</span><span class="token" style="color:#a77afe">:</span><span> call did not revert </span><span class="token module" style="color:#ef3b7d">as</span><span> expected</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token function">test_toWAD_fromWAD_boundary</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">(</span><span>gas</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token" style="color:#a77afe">4093</span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span></span><span class="token literal-property property">Traces</span><span class="token" style="color:#a77afe">:</span><span>
</span></span><span><span>  </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">4093</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token maybe-class-name">TestFromWAD_DONT</span><span class="token" style="color:#a77afe">:</span><span class="token" style="color:#a77afe">:</span><span class="token function">test_toWAD_fromWAD_boundary</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span>    ├─ </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">3446</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token maybe-class-name">TestFromWAD_DONT</span><span class="token" style="color:#a77afe">:</span><span class="token" style="color:#a77afe">:</span><span class="token function">test_toWAD_fromWAD</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#a77afe">115792089237316195423570985008687907853269984665640564039457</span><span> </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">1.157e59</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span>    │   ├─ </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token constant">VM</span><span class="token" style="color:#a77afe">:</span><span class="token" style="color:#a77afe">:</span><span class="token function">expectRevert</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span>    │   │   └─ </span><span class="token function">←</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span>    │   └─ </span><span class="token function">←</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span>    └─ ← </span><span class="token" style="color:#e6d06c">&quot;call did not revert as expected&quot;</span><span>
</span></span><span>
</span><span><span></span><span class="token maybe-class-name">Test</span><span> result</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token constant">FAILED</span><span class="token" style="color:#bebec5">.</span><span> </span><span class="token" style="color:#a77afe">1</span><span> passed</span><span class="token" style="color:#bebec5">;</span><span> </span><span class="token" style="color:#a77afe">1</span><span> failed</span><span class="token" style="color:#bebec5">;</span><span> </span><span class="token" style="color:#a77afe">0</span><span> skipped</span><span class="token" style="color:#bebec5">;</span><span> finished </span><span class="token" style="color:#ef3b7d">in</span><span> </span><span class="token" style="color:#a77afe">149</span><span class="token" style="color:#bebec5">.</span><span>86ms</span></span></code></pre></pre>
<p>Rerunning the tests, we see that the fuzz test passes, but the unit test which simply calls the fuzz test with a concrete value fails.</p>
<p><em>Why does the fuzzer not test the boundary value?</em></p>
<p>From the fuzzer&#x27;s perspective, this value might appear as any other in the space of all possible <code>uint256</code> inputs. It is thus very unlikely that the fuzzer will input this value without some further knowledge about the system or without some static analysis of the code.</p>
</details>
<p>This inaccuracy in the test exemplifies how an unclear precondition can not only obfuscate the true functionality but, in more severe scenarios, also mask vulnerabilities. For this reason, <strong>it is important to know how your tool works</strong>, their strengths and weaknesses, and any biases. It is also not uncommon for tools to contain quirks and bugs themselves. Leaning too heavily on a single tool or a type of test can be detrimental to the reliability of your testing results.</p>
<p><em>How could we have done better?</em></p>
<p>To help the fuzzer do its work, we can restructure the test as follows:</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span>contract </span><span class="token maybe-class-name">TestFromWAD_DO</span><span> is </span><span class="token maybe-class-name">Test</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>    </span><span class="token" style="color:#6f705e">/// Testing for values where `toWAD(a)` shouldn&#x27;t revert.</span><span>
</span></span><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">test_toWAD_fromWAD</span><span class="token" style="color:#bebec5">(</span><span class="token parameter">uint256 a</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">public</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        a </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">bound</span><span class="token" style="color:#bebec5">(</span><span>a</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token function">type</span><span class="token" style="color:#bebec5">(</span><span>uint256</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">max</span><span> </span><span class="token" style="color:#a77afe">/</span><span> </span><span class="token constant">WAD</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        </span><span class="token function">assertEq</span><span class="token" style="color:#bebec5">(</span><span class="token function">fromWAD</span><span class="token" style="color:#bebec5">(</span><span class="token function">toWAD</span><span class="token" style="color:#bebec5">(</span><span>a</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">,</span><span> a</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#6f705e">/// Testing for values where `toWAD(a)` should revert.</span><span>
</span></span><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">test_toWAD_fromWAD_revert_Panic</span><span class="token" style="color:#bebec5">(</span><span class="token parameter">uint256 a</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">public</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        a </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">bound</span><span class="token" style="color:#bebec5">(</span><span>a</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token function">type</span><span class="token" style="color:#bebec5">(</span><span>uint256</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">max</span><span> </span><span class="token" style="color:#a77afe">/</span><span> </span><span class="token constant">WAD</span><span> </span><span class="token" style="color:#a77afe">+</span><span> </span><span class="token" style="color:#a77afe">1</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token function">type</span><span class="token" style="color:#bebec5">(</span><span>uint256</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">max</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        vm</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">expectRevert</span><span class="token" style="color:#bebec5">(</span><span>abi</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">encodeWithSignature</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#e6d06c">&quot;Panic(uint256)&quot;</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#a77afe">0x11</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        </span><span class="token function">assertEq</span><span class="token" style="color:#bebec5">(</span><span class="token function">fromWAD</span><span class="token" style="color:#bebec5">(</span><span class="token function">toWAD</span><span class="token" style="color:#bebec5">(</span><span>a</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">,</span><span> a</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>u</mi><mi>i</mi><mi>n</mi><mi>t</mi><mn>256</mn><mtext> domain</mtext></mrow><annotation encoding="application/x-tex">uint256 \text{ domain}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal">u</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord">256</span><span class="mord text"><span class="mord"> domain</span></span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi><mover><mo><mtext>├</mtext><mi><munder><mo><mtext>─</mtext></mo><mn>0</mn></munder></mi><mtext>────────────</mtext><mi><munder><mo><mtext>─</mtext></mo><mrow><mspace width="-1em"><mfrac><mrow><mi>M</mi><mi>A</mi><mi>X</mi></mrow><mrow><mi>W</mi><mi>A</mi><mi>D</mi></mrow></mfrac></mspace></mrow></munder></mi><mtext>┤</mtext></mo><mpadded voffset="2pt"><mstyle scriptlevel="0" displaystyle="false"><mstyle mathcolor="green"><mtext> passing</mtext></mstyle></mstyle></mpadded></mover></mi><mi><mover><mo><mtext>├────</mtext><mi><munder><mo><mtext>─</mtext></mo><mrow><mspace width="-3.5em"><mfrac><mrow><mi>M</mi><mi>A</mi><mi>X</mi></mrow><mrow><mi>W</mi><mi>A</mi><mi>D</mi></mrow></mfrac><mo>+</mo><mn>1</mn></mspace></mrow></munder></mi><mtext>──────</mtext><mi><munder><mo><mtext>───</mtext></mo><mrow><mspace width="-0.4em"><mi>M</mi><mi>A</mi><mi>X</mi></mspace></mrow></munder></mi><mtext>┤</mtext></mo><mpadded voffset="2pt"><mstyle scriptlevel="0" displaystyle="false"><mstyle mathcolor="red"><mtext>reverting</mtext></mstyle></mstyle></mpadded></mover></mi></mrow><annotation encoding="application/x-tex">\overset{\raisebox{2pt}{\color{green} passing}}{
    ├\underset{0}{─}────────────\underset{\hskip -1em \frac {MAX} {WAD}}{─}┤
}
\overset{\raisebox{2pt} {\color{red}reverting}}{
    ├────\underset{\hskip -3.5em \frac {MAX} {WAD} + 1}───────\underset{\hskip -0.4 em MAX }{───}┤
}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.2851em;vertical-align:-1.1173em"></span><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1679em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span><span class="mop"><span class="mord">├</span><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0em"><span style="top:-2.3829em;margin-left:0em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span><span class="mop">─</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7171em"><span></span></span></span></span></span></span><span class="mord">────────────</span><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0em"><span style="top:-2.2235em;margin-left:0em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mspace mtight" style="margin-right:-1.4286em"></span><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8721em"><span style="top:-2.656em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em">W</span><span class="mord mathnormal mtight">A</span><span class="mord mathnormal mtight" style="margin-right:0.02778em">D</span></span></span></span><span style="top:-3.2255em"><span class="pstrut" style="height:3em"></span><span class="frac-line mtight" style="border-bottom-width:0.049em"></span></span><span style="top:-3.384em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em">M</span><span class="mord mathnormal mtight">A</span><span class="mord mathnormal mtight" style="margin-right:0.07847em">X</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span></span></span></span><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span><span class="mop">─</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.1173em"><span></span></span></span></span></span></span><span class="mord">┤</span></span></span></span><span style="top:-3.2em;margin-left:0em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.2398em"><span style="top:-3.2857em"><span class="pstrut" style="height:3em"></span><span class="mord sizing reset-size3 size6"><span class="mord" style="color:green"> passing</span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.1173em"><span></span></span></span></span></span></span><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1679em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span><span class="mop"><span class="mord">├────</span><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0em"><span style="top:-2.2235em;margin-left:0em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mspace mtight" style="margin-right:-5em"></span><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8721em"><span style="top:-2.656em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em">W</span><span class="mord mathnormal mtight">A</span><span class="mord mathnormal mtight" style="margin-right:0.02778em">D</span></span></span></span><span style="top:-3.2255em"><span class="pstrut" style="height:3em"></span><span class="frac-line mtight" style="border-bottom-width:0.049em"></span></span><span style="top:-3.384em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em">M</span><span class="mord mathnormal mtight">A</span><span class="mord mathnormal mtight" style="margin-right:0.07847em">X</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span><span class="mop">─</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.1173em"><span></span></span></span></span></span></span><span class="mord">──────</span><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0em"><span style="top:-2.3557em;margin-left:0em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mspace mtight" style="margin-right:-0.5714em"></span><span class="mord mathnormal mtight" style="margin-right:0.10903em">M</span><span class="mord mathnormal mtight">A</span><span class="mord mathnormal mtight" style="margin-right:0.07847em">X</span></span></span></span><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span><span class="mop">───</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7443em"><span></span></span></span></span></span></span><span class="mord">┤</span></span></span></span><span style="top:-3.2em;margin-left:0em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.2398em"><span style="top:-3.2857em"><span class="pstrut" style="height:3em"></span><span class="mord sizing reset-size3 size6"><span class="mord" style="color:red">reverting</span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.1173em"><span></span></span></span></span></span></span></span></span></span></span></div>
<p>By <strong>dividing tests based on expected results</strong> (success or failure), our testing approach becomes clearer and ensures both situations are sufficiently tested. Generally, we want to <strong>avoid complex decision trees in our test</strong>. A test should ideally be doing one thing only.</p>
<p>This also ensures that we are getting enough coverage for our specific test scenario. Before this refactor, it could have been possible for the happy path to be chosen 99% of the time and only 1% of the test cases covering the reverting path. In the new setup we ensure that both cases receive the same number of successful fuzz runs.</p>
<p>Any <strong>edge cases should be explicitly tested</strong> in further unit (and fuzz) tests. However, in this simple case, we can rely on Foundry&#x27;s <code>bound</code> function. This helps in testing near boundary conditions, since it adds a bias to the <code>min</code> and <code>max</code> values in <code>bound(var, min, max)</code>.</p>
<p>Further, testing for a specific error (<code>Panic(0x11)</code>) can identify unintentional coding errors. <strong>Catching general (unspecified) reverts via <code>vm.expectRevert()</code> is strongly discouraged</strong>. You should always be able to exactly anticipate your code&#x27;s behavior and outcome––and specifically, in what way it will revert.</p>
<p>As a further improvement, one might argue that the calls <code>fromWAD(toWAD(a))</code> should be separated. Currently the expected revert could apply to both functions (since they are called internally). In order to pinpoint (and anticipate) the exact occurrence of the error, these functions should be called externally.</p>
<p>It&#x27;s worth noting, however, that the current tests alone don&#x27;t offer a clear picture of the actual behavior of the <code>toWAD</code> and <code>fromWAD</code> functions. Multiple functions satisfy the constraints set by the tests, as illustrated below:</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">fromWAD</span><span class="token" style="color:#bebec5">(</span><span class="token parameter">uint256 a</span><span class="token" style="color:#bebec5">)</span><span> pure </span><span class="token function">returns</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token parameter">uint256 c</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>    c </span><span class="token" style="color:#a77afe">=</span><span> a </span><span class="token" style="color:#a77afe">+</span><span> </span><span class="token" style="color:#a77afe">1234</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span>
</span><span><span></span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">toWAD</span><span class="token" style="color:#bebec5">(</span><span class="token parameter">uint256 a</span><span class="token" style="color:#bebec5">)</span><span> pure </span><span class="token function">returns</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token parameter">uint256 c</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>    </span><span class="token control-flow" style="color:#ef3b7d">if</span><span> </span><span class="token" style="color:#bebec5">(</span><span>a </span><span class="token" style="color:#a77afe">&gt;</span><span> </span><span class="token function">type</span><span class="token" style="color:#bebec5">(</span><span>uint256</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">max</span><span> </span><span class="token" style="color:#a77afe">/</span><span> </span><span class="token constant">WAD</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token function">revert</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    c </span><span class="token" style="color:#a77afe">=</span><span> a </span><span class="token" style="color:#a77afe">-</span><span> </span><span class="token" style="color:#a77afe">1234</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<p>Without getting lost in details, let&#x27;s look at another example.</p>
<h3 id="testing-wad-multiplication"><a href="/blog/2023/test-your-tests#testing-wad-multiplication"><span class="icon icon-link"></span></a>Testing WAD Multiplication</h3>
<p>We just examined a case where a test contained a wrong precondition compared compared to the implementation. <em>What if, however, our test mirrored an incorrect precondition contained in the implementation itself?</em></p>
<p>The next testing example showcases multiplication in <code>WAD</code> units using <code>unchecked</code> arithmetic for optimization purposes.</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span>contract </span><span class="token maybe-class-name">TestMulWAD_DONT</span><span> is </span><span class="token maybe-class-name">Test</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">mulWAD</span><span class="token" style="color:#bebec5">(</span><span class="token parameter">uint256 a</span><span class="token parameter" style="color:#bebec5">,</span><span class="token parameter"> uint256 b</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">public</span><span> pure </span><span class="token function">returns</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token parameter">uint256 c</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        unchecked </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>            </span><span class="token control-flow" style="color:#ef3b7d">if</span><span> </span><span class="token" style="color:#bebec5">(</span><span>b </span><span class="token" style="color:#a77afe">==</span><span> </span><span class="token" style="color:#a77afe">0</span><span> </span><span class="token" style="color:#a77afe">||</span><span> a </span><span class="token" style="color:#a77afe">&gt;</span><span> </span><span class="token function">type</span><span class="token" style="color:#bebec5">(</span><span>uint256</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">max</span><span> </span><span class="token" style="color:#a77afe">/</span><span> b</span><span class="token" style="color:#bebec5">)</span><span> revert </span><span class="token function maybe-class-name">Overflow</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>            c </span><span class="token" style="color:#a77afe">=</span><span> a </span><span class="token" style="color:#a77afe">*</span><span> b </span><span class="token" style="color:#a77afe">/</span><span> </span><span class="token constant">WAD</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">test_mulWAD</span><span class="token" style="color:#bebec5">(</span><span class="token parameter">uint256 a</span><span class="token parameter" style="color:#bebec5">,</span><span class="token parameter"> uint256 b</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">public</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        </span><span class="token control-flow" style="color:#ef3b7d">if</span><span> </span><span class="token" style="color:#bebec5">(</span><span>b </span><span class="token" style="color:#a77afe">==</span><span> </span><span class="token" style="color:#a77afe">0</span><span> </span><span class="token" style="color:#a77afe">||</span><span> a </span><span class="token" style="color:#a77afe">&gt;</span><span> </span><span class="token function">type</span><span class="token" style="color:#bebec5">(</span><span>uint256</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">max</span><span> </span><span class="token" style="color:#a77afe">/</span><span> b</span><span class="token" style="color:#bebec5">)</span><span> vm</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">expectRevert</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        uint256 c </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">mulWAD</span><span class="token" style="color:#bebec5">(</span><span>a</span><span class="token" style="color:#bebec5">,</span><span> b</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        </span><span class="token function">assertEq</span><span class="token" style="color:#bebec5">(</span><span>c</span><span class="token" style="color:#bebec5">,</span><span> a </span><span class="token" style="color:#a77afe">*</span><span> b </span><span class="token" style="color:#a77afe">/</span><span> </span><span class="token constant">WAD</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<p>Again, if we give the fuzzer a go at this test, it will report that it passes for all cases.</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span class="token maybe-class-name">Running</span><span> </span><span class="token" style="color:#a77afe">1</span><span> test </span><span class="token control-flow" style="color:#ef3b7d">for</span><span> test</span><span class="token" style="color:#a77afe">/</span><span class="token maybe-class-name">TestMulWAD</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">sol</span><span class="token" style="color:#a77afe">:</span><span class="token maybe-class-name">TestMulWAD_DONT</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">[</span><span class="token constant">PASS</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token function">test_mulWAD</span><span class="token" style="color:#bebec5">(</span><span>uint256</span><span class="token" style="color:#bebec5">,</span><span>uint256</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">(</span><span>runs</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token" style="color:#a77afe">10000</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token literal-property property">μ</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token" style="color:#a77afe">1698</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">~</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token" style="color:#a77afe">732</span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span></span><span class="token maybe-class-name">Test</span><span> result</span><span class="token" style="color:#a77afe">:</span><span> ok</span><span class="token" style="color:#bebec5">.</span><span> </span><span class="token" style="color:#a77afe">1</span><span> passed</span><span class="token" style="color:#bebec5">;</span><span> </span><span class="token" style="color:#a77afe">0</span><span> failed</span><span class="token" style="color:#bebec5">;</span><span> </span><span class="token" style="color:#a77afe">0</span><span> skipped</span><span class="token" style="color:#bebec5">;</span><span> finished </span><span class="token" style="color:#ef3b7d">in</span><span> </span><span class="token" style="color:#a77afe">158</span><span class="token" style="color:#bebec5">.</span><span>97ms</span></span></code></pre></pre>
<details>
<summary><b>Spot the issue above! [spoiler]</b><br/><br/></summary>
<p>The issue in this example arises from the incorrect precondition mirrored in the test. The boolean OR operator <code>||</code> is accidentally used instead of an AND operator <code>&amp;&amp;</code>.</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span class="token unchanged prefix"> </span><span class="token unchanged line">   function mulWAD(uint256 a, uint256 b) public pure returns (uint256 c) {
</span></span><span><span class="token unchanged line"></span><span class="token unchanged prefix"> </span><span class="token unchanged line">       unchecked {
</span></span><span><span class="token unchanged line"></span><span class="token deleted-sign prefix" style="color:#ef3b7d">-</span><span class="token deleted-sign line" style="color:#ef3b7d">           if (b == 0 || a &gt; type(uint256).max / b) revert Overflow();
</span></span><span><span class="token deleted-sign line" style="color:#ef3b7d"></span><span class="token inserted-sign prefix" style="color:#a6e22d">+</span><span class="token inserted-sign line" style="color:#a6e22d">           if (b != 0 &amp;&amp; a &gt; type(uint256).max / b) revert Overflow();
</span></span><span><span class="token inserted-sign line" style="color:#a6e22d"></span><span class="token unchanged prefix"> </span><span class="token unchanged line">       }
</span></span><span><span class="token unchanged line"></span><span class="token unchanged prefix"> </span><span class="token unchanged line">   }
</span></span><span><span class="token unchanged line"></span><span>
</span></span><span><span></span><span class="token unchanged prefix"> </span><span class="token unchanged line">   function test_mulWAD(uint256 a, uint256 b) public {
</span></span><span><span class="token unchanged line"></span><span class="token deleted-sign prefix" style="color:#ef3b7d">-</span><span class="token deleted-sign line" style="color:#ef3b7d">       if (b == 0 || a &gt; type(uint256).max / b) vm.expectRevert();
</span></span><span><span class="token deleted-sign line" style="color:#ef3b7d"></span><span class="token inserted-sign prefix" style="color:#a6e22d">+</span><span class="token inserted-sign line" style="color:#a6e22d">       if (b != 0 &amp;&amp; a &gt; type(uint256).max / b) vm.expectRevert();
</span></span><span><span class="token inserted-sign line" style="color:#a6e22d"></span><span class="token unchanged prefix"> </span><span class="token unchanged line">   }</span></span></code></pre></pre>
<p>A mistake like this could likely have been introduced by manually copying the flawed precondition for overflow to the test. Such a case, can not be detected by the fuzzer.</p>
</details>
<p><em>How could we have done better to avoid the such a failure case?</em></p>
<h3 id="exploring-various-testing-strategies"><a href="/blog/2023/test-your-tests#exploring-various-testing-strategies"><span class="icon icon-link"></span></a>Exploring Various Testing Strategies</h3>
<p>As we have just seen in the previous example, <strong>solely relying on a single form of testing can lead to brittle results</strong>. Including a simple <em>unit test</em> for known values, e.g. <code>mulWAD(0, 0)</code> could have uncovered the incorrect check.</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span>contract </span><span class="token maybe-class-name">TestMulWAD_DO</span><span> is </span><span class="token maybe-class-name">Test</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>    </span><span class="token" style="color:#6f705e">/// Unit test</span><span>
</span></span><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">test_mulWAD_unit</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">public</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        uint256 a </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        uint256 b </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        uint256 c </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">mulWAD</span><span class="token" style="color:#bebec5">(</span><span>a</span><span class="token" style="color:#bebec5">,</span><span> b</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        </span><span class="token function">assertEq</span><span class="token" style="color:#bebec5">(</span><span>c</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<p>It never hurts to cover the implementation behavior with multiple unit tests and <strong>additional adjacent property/fuzz tests</strong>. For example, checking that our function satisfies the commutative property would have uncovered the mistake in the code as well.</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span>contract </span><span class="token maybe-class-name">TestMulWAD_DO</span><span> is </span><span class="token maybe-class-name">Test</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>    </span><span class="token" style="color:#6f705e">// Fuzz test commutative property</span><span>
</span></span><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">test_mulWAD_fuzz_commutative</span><span class="token" style="color:#bebec5">(</span><span class="token parameter">uint256 a</span><span class="token parameter" style="color:#bebec5">,</span><span class="token parameter"> uint256 b</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">public</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        </span><span class="token" style="color:#6f705e">// If `a * b = c` doesn&#x27;t overflow...</span><span>
</span></span><span><span>        </span><span class="token control-flow" style="color:#ef3b7d">try</span><span> </span><span class="token" style="color:#ef3b7d">this</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">mulWAD</span><span class="token" style="color:#bebec5">(</span><span>a</span><span class="token" style="color:#bebec5">,</span><span> b</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token function">returns</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token parameter">uint256 c</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>            </span><span class="token" style="color:#6f705e">// then `b * a = c`.</span><span>
</span></span><span><span>            </span><span class="token function">assertEq</span><span class="token" style="color:#bebec5">(</span><span>c</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token function">mulWAD</span><span class="token" style="color:#bebec5">(</span><span>b</span><span class="token" style="color:#bebec5">,</span><span> a</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        </span><span class="token" style="color:#bebec5">}</span><span> </span><span class="token control-flow" style="color:#ef3b7d">catch</span><span> </span><span class="token" style="color:#bebec5">{</span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<p>Another point to be mindful of is that when code from the implementation is reused in a test, we rely on its correctness to be able to trust the outcome of the test. In this example an incorrect pre-condition was copied to the test, but we could also make the same mistake when we re-use function calls which evaluate a pre-condition.</p>
<p>This is why it&#x27;s important to <strong>approach testing from multiple angles</strong>. In the case of the overflow check, we could have also re-implemented the overflow logic in another manner.</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span>contract </span><span class="token maybe-class-name">TestMulWAD_DO</span><span> is </span><span class="token maybe-class-name">Test</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>    </span><span class="token" style="color:#6f705e">/// Fuzz test</span><span>
</span></span><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">test_mulWAD_fuzz</span><span class="token" style="color:#bebec5">(</span><span class="token parameter">uint256 a</span><span class="token parameter" style="color:#bebec5">,</span><span class="token parameter"> uint256 b</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">public</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        unchecked </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>            </span><span class="token" style="color:#6f705e">// Compute `c = a * b` while ignoring overflow.</span><span>
</span></span><span><span>            uint256 c </span><span class="token" style="color:#a77afe">=</span><span> a </span><span class="token" style="color:#a77afe">*</span><span> b</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>            </span><span class="token" style="color:#6f705e">// If we can&#x27;t reconstruct `b = c / a`, then we lost some bits.</span><span>
</span></span><span><span>            </span><span class="token control-flow" style="color:#ef3b7d">if</span><span> </span><span class="token" style="color:#bebec5">(</span><span>a </span><span class="token" style="color:#a77afe">!=</span><span> </span><span class="token" style="color:#a77afe">0</span><span> </span><span class="token" style="color:#a77afe">&amp;&amp;</span><span> b </span><span class="token" style="color:#a77afe">!=</span><span> c </span><span class="token" style="color:#a77afe">/</span><span> a</span><span class="token" style="color:#bebec5">)</span><span> vm</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">expectRevert</span><span class="token" style="color:#bebec5">(</span><span class="token maybe-class-name">Overflow</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">selector</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>            </span><span class="token function">assertEq</span><span class="token" style="color:#bebec5">(</span><span class="token function">mulWAD</span><span class="token" style="color:#bebec5">(</span><span>a</span><span class="token" style="color:#bebec5">,</span><span> b</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">,</span><span> c</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<p>What&#x27;s more, if we have a reference implementation at hand, we can also <strong>use fuzzing to detect any discrepancies by differentially testing</strong> the behavior of two implementations against each other.</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span>contract </span><span class="token maybe-class-name">TestMulWAD_DO</span><span> is </span><span class="token maybe-class-name">Test</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">mulWADNative</span><span class="token" style="color:#bebec5">(</span><span class="token parameter">uint256 a</span><span class="token parameter" style="color:#bebec5">,</span><span class="token parameter"> uint256 b</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">public</span><span> pure </span><span class="token function">returns</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token parameter">uint256 c</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        c </span><span class="token" style="color:#a77afe">=</span><span> a </span><span class="token" style="color:#a77afe">*</span><span> b </span><span class="token" style="color:#a77afe">/</span><span> </span><span class="token constant">WAD</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#6f705e">/// Differential test</span><span>
</span></span><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">test_mulWAD_differential</span><span class="token" style="color:#bebec5">(</span><span class="token parameter">uint256 a</span><span class="token parameter" style="color:#bebec5">,</span><span class="token parameter"> uint256 b</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">public</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        </span><span class="token function">assertEqCall</span><span class="token" style="color:#bebec5">(</span><span>
</span></span><span><span>            </span><span class="token function">address</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#ef3b7d">this</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">,</span><span>
</span></span><span><span>            abi</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">encodeCall</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#ef3b7d">this</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">mulWAD</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#bebec5">(</span><span>a</span><span class="token" style="color:#bebec5">,</span><span> b</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">,</span><span>
</span></span><span><span>            abi</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">encodeCall</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#ef3b7d">this</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">mulWADNative</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#bebec5">(</span><span>a</span><span class="token" style="color:#bebec5">,</span><span> b</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span>        </span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<p>Using the <code>ffi</code> (foreign function interface) cheat code we can also test Solidity code against non-Solidity implementations adding another safety layer.</p>
<p><strong>Redundancy is key when aiming to create a robust testing suite</strong>. Testing multiple properties through various strategies and techniques improves the confidence and soundness of the testing outcomes.</p>
<h3 id="offensive-testing"><a href="/blog/2023/test-your-tests#offensive-testing"><span class="icon icon-link"></span></a>Offensive Testing</h3>
<p>So far we have mostly been focusing on validating properties of our system as robustly as possible to strengthen behavioral guarantees. This could be termed as &#x27;defensive testing&#x27;, where expected behavior is solidified and validated. However, sometimes, the more revealing approach is the opposite––aiming to invalidate or disprove properties we suspect might not hold. This is what we could term as the &#x27;offensive&#x27; side of testing.</p>
<h3 id="case-study-primitive-finance---hyper"><a href="/blog/2023/test-your-tests#case-study-primitive-finance---hyper"><span class="icon icon-link"></span></a>Case Study: Primitive Finance - Hyper</h3>
<p>In January 2023 Trail of Bits conducted a security review of &#x27;Primitive Finance - Hyper AMM&#x27; (renamed to &#x27;Portfolio&#x27;). The <a target="_blank" rel="noreferrer" class="link" href="https://github.com/trailofbits/publications/blob/master/reviews/2023-03-primitive-securityreview.pdf">report is publicly available</a> and Primitive has given permission to highlight the testing that was performed during our review of their system.</p>
<p>As an overview, a few notable characteristics of the system were:</p>
<ul>
<li>CFMM (Constant Function Market Maker) protocol incorporating time-dependent curves, potentially enabling options trading.</li>
<li>Internal accounting system for pool balances along with a batch swapping functionality.</li>
<li>It heavily employs assembly language and intricate function approximations (gauss <code>pdf</code> and <code>ierfc</code>) in its dependency <code>solstat</code>. Additionally, it showcases inconsistent rounding behavior.</li>
</ul>
<h3 id="initial-testing-strategy"><a href="/blog/2023/test-your-tests#initial-testing-strategy"><span class="icon icon-link"></span></a>Initial Testing Strategy</h3>
<p>In the early stages of the audit, a natural inclination was to employ fuzz testing. The hypothesis was simple: <em>Can one exploit inaccuracies in the pool&#x27;s state (parameters, reserves, etc.) to achieve favorable swaps?</em> The goal was to determine if repeated swaps could lead to value extraction.</p>
<p>Below is an excerpt from an initial test attempt:</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">test_swap</span><span class="token" style="color:#bebec5">(</span><span>
</span></span><span><span>    </span><span class="token parameter">bool sellAsset</span><span class="token parameter" style="color:#bebec5">,</span><span class="token parameter">
</span></span><span><span class="token parameter">    uint128 input</span><span class="token parameter" style="color:#bebec5">,</span><span class="token parameter">
</span></span><span><span class="token parameter">    uint128 tempOutput</span><span class="token parameter" style="color:#bebec5">,</span><span class="token parameter">
</span></span><span><span class="token parameter">    uint256 liquidity</span><span class="token parameter" style="color:#bebec5">,</span><span class="token parameter">
</span></span><span><span class="token parameter">    uint256 volatility</span><span class="token parameter" style="color:#bebec5">,</span><span class="token parameter">
</span></span><span><span class="token parameter">    uint256 duration</span><span class="token parameter" style="color:#bebec5">,</span><span class="token parameter">
</span></span><span><span class="token parameter">    uint128 stkPrice</span><span class="token parameter" style="color:#bebec5">,</span><span class="token parameter">
</span></span><span><span class="token parameter">    uint128 price</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">public</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>    </span><span class="token" style="color:#6f705e">// Alice create&#x27;s an honest pool with liquidity.</span><span>
</span></span><span><span>    </span><span class="token function">createPoolAndAllocateLiquidity</span><span class="token" style="color:#bebec5">(</span><span>alice</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">100</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">10</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">2e18</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">1e18</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">1_000_000</span><span> </span><span class="token" style="color:#a77afe">*</span><span> </span><span class="token" style="color:#a77afe">1e18</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#6f705e">// Bob create&#x27;s a malicious pool with liquidity.</span><span>
</span></span><span><span>    </span><span class="token function">createPoolAndAllocateLiquidity</span><span class="token" style="color:#bebec5">(</span><span>bob</span><span class="token" style="color:#bebec5">,</span><span> volatility</span><span class="token" style="color:#bebec5">,</span><span> duration</span><span class="token" style="color:#bebec5">,</span><span> stkPrice</span><span class="token" style="color:#bebec5">,</span><span> price</span><span class="token" style="color:#bebec5">,</span><span> liquidity</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#6f705e">// Bob tries to extract tokens by swapping back and forth.</span><span>
</span></span><span><span>    uint128 targetValue </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#a77afe">1e18</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#6f705e">// Swap input X -&gt; tempOutput Y -&gt; output X.</span><span>
</span></span><span><span>    bool success </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">swapBackAndForth</span><span class="token" style="color:#bebec5">(</span><span>sellAsset</span><span class="token" style="color:#bebec5">,</span><span> input</span><span class="token" style="color:#bebec5">,</span><span> tempOutput</span><span class="token" style="color:#bebec5">,</span><span> input </span><span class="token" style="color:#a77afe">+</span><span> targetValue</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token control-flow" style="color:#ef3b7d">if</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#a77afe">!</span><span>success</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token control-flow" style="color:#ef3b7d">return</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#6f705e">// Bob withdraws all of his assets.</span><span>
</span></span><span><span>    </span><span class="token function">withdrawAllAssets</span><span class="token" style="color:#bebec5">(</span><span>bob</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>    int256 assetGain </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">int256</span><span class="token" style="color:#bebec5">(</span><span>asset</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">balanceOf</span><span class="token" style="color:#bebec5">(</span><span>bob</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#a77afe">-</span><span> </span><span class="token function">int256</span><span class="token" style="color:#bebec5">(</span><span class="token constant">INITIAL_BALANCE</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    int256 quoteGain </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">int256</span><span class="token" style="color:#bebec5">(</span><span>quote</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">balanceOf</span><span class="token" style="color:#bebec5">(</span><span>bob</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#a77afe">-</span><span> </span><span class="token function">int256</span><span class="token" style="color:#bebec5">(</span><span class="token constant">INITIAL_BALANCE</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#6f705e">// Bob should gain tokens.</span><span>
</span></span><span><span>    </span><span class="token control-flow" style="color:#ef3b7d">if</span><span> </span><span class="token" style="color:#bebec5">(</span><span>assetGain </span><span class="token" style="color:#a77afe">&lt;</span><span> </span><span class="token" style="color:#a77afe">0</span><span> </span><span class="token" style="color:#a77afe">||</span><span> quoteGain </span><span class="token" style="color:#a77afe">&lt;</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token control-flow" style="color:#ef3b7d">return</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#6f705e">// Log the balance gain.</span><span>
</span></span><span><span>    </span><span class="token console class-name">console</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">log</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#e6d06c">&quot;Asset gain&quot;</span><span class="token" style="color:#bebec5">,</span><span> vm</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">toString</span><span class="token" style="color:#bebec5">(</span><span>assetGain</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token console class-name">console</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">log</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#e6d06c">&quot;Quote gain&quot;</span><span class="token" style="color:#bebec5">,</span><span> vm</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">toString</span><span class="token" style="color:#bebec5">(</span><span>quoteGain</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#6f705e">// Report the test case.</span><span>
</span></span><span><span>    </span><span class="token function">fail</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<p>This initial approach led to repeated failures when setting up pools, allocating liquidity or when performing a swap.</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span class="token literal-property property">Traces</span><span class="token" style="color:#a77afe">:</span><span>
</span></span><span><span>  </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">128911</span><span class="token" style="color:#bebec5">]</span><span> self</span><span class="token" style="color:#a77afe">:</span><span class="token" style="color:#a77afe">:</span><span class="token function">test_swap</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#a77afe">false</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span>    ├─ </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token constant">VM</span><span class="token" style="color:#a77afe">:</span><span class="token" style="color:#a77afe">:</span><span class="token function">startPrank</span><span class="token" style="color:#bebec5">(</span><span>alice</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">0x00000000000000000000000000000000000A11cE</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span>    │   └─ </span><span class="token function">←</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span>    ├─ </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">113457</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token constant">HYPER</span><span class="token" style="color:#a77afe">:</span><span class="token" style="color:#a77afe">:</span><span class="token function">aa012c0c</span><span class="token" style="color:#bebec5">(</span><span>5991a2df15a8f6a256d3ec51e99254cd3fb576a9f62849f9a0b5bf2913b396098f7c7019b51a820a</span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span>    │   ├─ emit </span><span class="token function maybe-class-name">CreatePair</span><span class="token" style="color:#bebec5">(</span><span>pairId</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token" style="color:#a77afe">1</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token literal-property property">asset</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token constant">ASSET</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">0x5991A2dF15A8F6A256D3Ec51E99254Cd3fb576A9</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token literal-property property">quote</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token constant">QUOTE</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">0xF62849F9A0B5Bf2913b396098F7c7019b51A820a</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token literal-property property">decimalsAsset</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token" style="color:#a77afe">18</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token literal-property property">decimalsQuote</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token" style="color:#a77afe">18</span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span>    │   └─ </span><span class="token function">←</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span>    └─ ← </span><span class="token" style="color:#e6d06c">&quot;UNDEFINED&quot;</span></span></code></pre></pre>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span class="token literal-property property">Traces</span><span class="token" style="color:#a77afe">:</span><span>
</span></span><span><span>  </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">306133</span><span class="token" style="color:#bebec5">]</span><span> self</span><span class="token" style="color:#a77afe">:</span><span class="token" style="color:#a77afe">:</span><span class="token function">test_swap</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#a77afe">false</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">170141183460469231731687303715884105728</span><span> </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">1.701e38</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span>    ├─ </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token constant">VM</span><span class="token" style="color:#a77afe">:</span><span class="token" style="color:#a77afe">:</span><span class="token function">startPrank</span><span class="token" style="color:#bebec5">(</span><span>alice</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">0x00000000000000000000000000000000000A11cE</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span>    │   └─ </span><span class="token function">←</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span>    ├─ </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">113457</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token constant">HYPER</span><span class="token" style="color:#a77afe">:</span><span class="token" style="color:#a77afe">:</span><span class="token function">aa012c0c</span><span class="token" style="color:#bebec5">(</span><span>5991a2df15a8f6a256d3ec51e99254cd3fb576a9f62849f9a0b5bf2913b396098f7c7019b51a820a</span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span>    │   ├─ emit </span><span class="token function maybe-class-name">CreatePair</span><span class="token" style="color:#bebec5">(</span><span>pairId</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token" style="color:#a77afe">1</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token literal-property property">asset</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token constant">ASSET</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">0x5991A2dF15A8F6A256D3Ec51E99254Cd3fb576A9</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token literal-property property">quote</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token constant">QUOTE</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">0xF62849F9A0B5Bf2913b396098F7c7019b51A820a</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token literal-property property">decimalsAsset</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token" style="color:#a77afe">18</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token literal-property property">decimalsQuote</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token" style="color:#a77afe">18</span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span>    </span><span class="token spread" style="color:#a77afe">...</span><span>
</span></span><span><span>    ├─ </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">5912</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token constant">HYPER</span><span class="token" style="color:#a77afe">:</span><span class="token" style="color:#a77afe">:</span><span class="token function">allocate</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#a77afe">1103806595073</span><span> </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">1.103e12</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">170141183460469231731687303715884105728</span><span> </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">1.701e38</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span>    │   └─ ← </span><span class="token" style="color:#e6d06c">&quot;EvmError: Revert&quot;</span><span>
</span></span><span><span>    └─ ← </span><span class="token" style="color:#e6d06c">&quot;EvmError: Revert&quot;</span></span></code></pre></pre>
<p>In order to not spend too much time on a single thesis during the review, these reverting function calls were handled using <code>try ... catch</code>––simply discarding any error case. This way, the fuzzer could be allowed to continue to search for a combination of inputs that would invalidate the invariant while allowing us to continue the manual review of the code.</p>
<p>The fuzzer continued for nearly a week without presenting any exploit. <strong>It would be easy, albeit premature, to interpret this as a sign of robustness against the hypothesized exploit.</strong></p>
<p>In order to make the fuzzer more effective at its task, it required further guidance when selecting the parameters increasing the amount of valid test cases. Ideally, <strong>every single test run should produce valid parameters</strong>. This is achieved by properly specifying the bounds on the parameters. However, <strong>it&#x27;s equally important not to discard any valid parameter combination</strong>, as otherwise certain edge-cases which might be required for a successful exploit might be discarded.</p>
<p>Defining tight bounds might require precisely reconstructing of the protocol&#x27;s pre-conditions. Sometimes these conditions might be explicitly stated, and sometimes they might be complex to evaluate, and the bounds of one parameter can depend on another.</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">test_swap</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#6f705e">/* ... */</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">public</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>    </span><span class="token" style="color:#6f705e">// Properly bound pool parameters.</span><span>
</span></span><span><span>    duration </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">bound</span><span class="token" style="color:#bebec5">(</span><span>duration</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">1</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">500</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    volatility </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">bound</span><span class="token" style="color:#bebec5">(</span><span>volatility</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">100</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">25_000</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    stkPrice </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">uint128</span><span class="token" style="color:#bebec5">(</span><span class="token function">bound</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">(</span><span>stkPrice</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">1</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token function">type</span><span class="token" style="color:#bebec5">(</span><span>uint128</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">max</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token" style="color:#6f705e">// Prevent lnWad&#x27;s &quot;UNDEFINED&quot; when `price * 1e18 / stkPrice == 0`.</span><span>
</span></span><span><span>    price </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">uint128</span><span class="token" style="color:#bebec5">(</span><span>
</span></span><span><span>        </span><span class="token function">bound</span><span class="token" style="color:#bebec5">(</span><span>
</span></span><span><span>            </span><span class="token function">uint256</span><span class="token" style="color:#bebec5">(</span><span>price</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">,</span><span>
</span></span><span><span>            </span><span class="token" style="color:#bebec5">(</span><span class="token maybe-class-name">Price</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">computePriceWithTick</span><span class="token" style="color:#bebec5">(</span><span class="token maybe-class-name">Price</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">computeTickWithPrice</span><span class="token" style="color:#bebec5">(</span><span>stkPrice</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#a77afe">+</span><span> </span><span class="token" style="color:#a77afe">1</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#a77afe">+</span><span> </span><span class="token" style="color:#a77afe">1e18</span><span> </span><span class="token" style="color:#a77afe">-</span><span> </span><span class="token" style="color:#a77afe">1</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#a77afe">/</span><span> </span><span class="token" style="color:#a77afe">1e18</span><span class="token" style="color:#bebec5">,</span><span>
</span></span><span><span>            </span><span class="token function">type</span><span class="token" style="color:#bebec5">(</span><span>uint128</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">max</span><span>
</span></span><span><span>        </span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#6f705e">// Alice create&#x27;s a pool with liquidity.</span><span>
</span></span><span><span>    </span><span class="token" style="color:#6f705e">// ...</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span class="token maybe-class-name">Running</span><span> </span><span class="token" style="color:#a77afe">1</span><span> test </span><span class="token control-flow" style="color:#ef3b7d">for</span><span> test</span><span class="token" style="color:#a77afe">/</span><span>foundry</span><span class="token" style="color:#a77afe">/</span><span class="token maybe-class-name">TestSwapPoc</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">t</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">sol</span><span class="token" style="color:#a77afe">:</span><span class="token maybe-class-name">TestHyperSwapPoc</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">[</span><span class="token constant">PASS</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token function">test_swap</span><span class="token" style="color:#bebec5">(</span><span>bool</span><span class="token" style="color:#bebec5">,</span><span>uint128</span><span class="token" style="color:#bebec5">,</span><span>uint128</span><span class="token" style="color:#bebec5">,</span><span>uint256</span><span class="token" style="color:#bebec5">,</span><span>uint256</span><span class="token" style="color:#bebec5">,</span><span>uint256</span><span class="token" style="color:#bebec5">,</span><span>uint128</span><span class="token" style="color:#bebec5">,</span><span>uint128</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">(</span><span>runs</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token" style="color:#a77afe">10000</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token literal-property property">μ</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token" style="color:#a77afe">723780</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">~</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token" style="color:#a77afe">794869</span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span></span><span class="token maybe-class-name">Test</span><span> result</span><span class="token" style="color:#a77afe">:</span><span> ok</span><span class="token" style="color:#bebec5">.</span><span> </span><span class="token" style="color:#a77afe">1</span><span> passed</span><span class="token" style="color:#bebec5">;</span><span> </span><span class="token" style="color:#a77afe">0</span><span> failed</span><span class="token" style="color:#bebec5">;</span><span> </span><span class="token" style="color:#a77afe">0</span><span> skipped</span><span class="token" style="color:#bebec5">;</span><span> finished </span><span class="token" style="color:#ef3b7d">in</span><span> </span><span class="token" style="color:#a77afe">10</span><span class="token" style="color:#bebec5">.</span><span>23s</span></span></code></pre></pre>
<p>After addressing all transaction reverts and properly bounding all parameters, all test runs should now complete.</p>
<p>However, Bob has yet to make a profitable trade.</p>
<h3 id="refining-the-testing-strategy"><a href="/blog/2023/test-your-tests#refining-the-testing-strategy"><span class="icon icon-link"></span></a>Refining the Testing Strategy</h3>
<p>A good way to test whether the test actually makes sense is by <em>testing it</em>. A well-written test should be able to immediately identify the case when an invariant is removed manually.</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span>liveInvariantWad </span><span class="token" style="color:#a77afe">=</span><span> liveInvariantWad</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">scaleFromWadDownSigned</span><span class="token" style="color:#bebec5">(</span><span>pool</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">pair</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">decimalsQuote</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span> </span><span class="token" style="color:#6f705e">// invariant is denominated in quote token.</span><span>
</span></span><span><span>nextInvariantWad </span><span class="token" style="color:#a77afe">=</span><span> nextInvariantWad</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">scaleFromWadDownSigned</span><span class="token" style="color:#bebec5">(</span><span>pool</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">pair</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">decimalsQuote</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span></span><span class="token control-flow" style="color:#ef3b7d">if</span><span> </span><span class="token" style="color:#bebec5">(</span><span>nextInvariantWad </span><span class="token" style="color:#a77afe">&lt;</span><span> liveInvariantWad</span><span class="token" style="color:#bebec5">)</span><span> revert </span><span class="token function maybe-class-name">InvalidInvariant</span><span class="token" style="color:#bebec5">(</span><span>liveInvariantWad</span><span class="token" style="color:#bebec5">,</span><span> nextInvariantWad</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span></span></code></pre></pre>
<p>This code enforces the invariant in the protocol. Generally, an invariant like this should guarantee that, under no circumstances, there&#x27;s a possibility of a profitable trade when swapping back and forth. However, as the protocol invariant was uses the newly computed price and pool balances––also derived from the price––doubts whether this invariant was truly enforcing the desired properties emerged.</p>
<p>By removing the invariant check above, we should immediately be able to see whether the fuzzer is capable of finding inputs that invalidate our swap test case. Once our setup is validated, we can go further and remove any swap fees while re-introducing the invariant. If a failing test case can be found without swap fees, this is already a big hint that there might be some rounding, overflow or precision loss issue in the protocol that could be exploited.</p>
<p><strong>We test our hypothesis by first making the conditions as ideal as possible for an attacker and then trim the capabilities back down to pinpoint the exact conditions required for an exploit.</strong></p>
<p>A significant discovery came after questioning further assumptions made in the test setup. The assumption that Bob must gain a profit on both tokens is unnecessarily strict. Usually, when swapping <code>X quote -&gt; Y asset -&gt; Z quote</code>, the amount of Asset tokens required should be zero. This is because the second swap&#x27;s input is simply defined as the first swaps output <code>Y asset</code>.</p>
<p>Normally, this would mean that we are not required to provide any Asset tokens. However, in this particular system, due to the rounding logic in the protocol, often a minimum of <code>1</code> (wei) Asset token is required in the process of swapping back and forth. The test could be adapted to allow for one token to be lost, or simply removing</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span class="token" style="color:#6f705e">// Bob should gain tokens.</span><span>
</span></span><span><span></span><span class="token control-flow" style="color:#ef3b7d">if</span><span> </span><span class="token" style="color:#bebec5">(</span><span>assetGain </span><span class="token" style="color:#a77afe">&lt;</span><span> </span><span class="token" style="color:#a77afe">-</span><span class="token" style="color:#a77afe">1</span><span> </span><span class="token" style="color:#a77afe">||</span><span> quoteGain </span><span class="token" style="color:#a77afe">&lt;</span><span> </span><span class="token" style="color:#a77afe">-</span><span class="token" style="color:#a77afe">1</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token control-flow" style="color:#ef3b7d">return</span><span class="token" style="color:#bebec5">;</span></span></code></pre></pre>
<p>Furthermore, Hyper&#x27;s batched instruction processing allowed to execute more efficient swaps.</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">swapBackAndForth</span><span class="token" style="color:#bebec5">(</span><span class="token parameter">bool sellAsset</span><span class="token parameter" style="color:#bebec5">,</span><span class="token parameter"> uint128 input</span><span class="token parameter" style="color:#bebec5">,</span><span class="token parameter"> uint128 output1</span><span class="token parameter" style="color:#bebec5">,</span><span class="token parameter"> uint128 output2</span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span>    internal
</span><span><span>    </span><span class="token function">returns</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token parameter">bool success</span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>    </span><span class="token" style="color:#6f705e">// Encode batch instructions.</span><span>
</span></span><span><span>    bytes</span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#bebec5">]</span><span> memory instructions </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#ef3b7d">new</span><span> </span><span class="token class-name">bytes</span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#a77afe">2</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>    instructions</span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token maybe-class-name">ProcessingLib</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">encodeSwap</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">,</span><span> poolId</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">,</span><span> input</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">,</span><span> output1</span><span class="token" style="color:#bebec5">,</span><span> sellAsset </span><span class="token" style="color:#a77afe">?</span><span> </span><span class="token" style="color:#a77afe">0</span><span> </span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token" style="color:#a77afe">1</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    instructions</span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">1</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token maybe-class-name">ProcessingLib</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">encodeSwap</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">,</span><span> poolId</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">,</span><span> output1</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">,</span><span> output2</span><span class="token" style="color:#bebec5">,</span><span> sellAsset </span><span class="token" style="color:#a77afe">?</span><span> </span><span class="token" style="color:#a77afe">1</span><span> </span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>    bytes memory data </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token maybe-class-name">ProcessingLib</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">encodeJumpInstruction</span><span class="token" style="color:#bebec5">(</span><span>instructions</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#bebec5">(</span><span>success</span><span class="token" style="color:#bebec5">,</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">address</span><span class="token" style="color:#bebec5">(</span><span>hyper</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">call</span><span class="token" style="color:#bebec5">(</span><span>data</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<p>A last discovery was made when it was observed that the exploit would only be possible if the attacker was <strong>not</strong> the pool controller. The original idea was that the pool controller would receive a favorable fee compared to the standard swap fee. However, since the pool controller&#x27;s fee is charged in Ether independently of the Asset and Quote tokens (but dependent on the pool&#x27;s liquidity) this created a scenario, where the exploit was not possible.</p>
<p>This highlighted the <strong>significance of questioning assumptions in tests</strong>. The Primitive Hyper swap case offers several insights that can be applied to offensive testing:</p>
<ol>
<li><strong>Establish Precise Variable Bounds</strong>: Address potential reverts by ensuring that all variables are bounded correctly. Ensure that the number of discarded test cases remains at a minimum.</li>
<li><strong>Augment Coverage Insight</strong>: Introduce sanity checks to assess the feasibility of the test hypothesis. Considering testing the setup by removing the protocol invariant checks.</li>
<li><strong>Challenge Every Assumption</strong>: The audit revealed how certain assumptions, like the fixed priority fee required for the exploit, or the prerequisite of token approvals, can skew results and lead to premature conclusions.</li>
</ol>
<p>In essence, offensive testing requires a dynamic and persistent approach. It&#x27;s not just about confirming the robustness of a system but actively seeking potential cracks. Only by repeatedly challenging our understanding and assumptions can we hope to uncover hidden vulnerabilities.</p>
<h3 id="conclusions-and-takeaways"><a href="/blog/2023/test-your-tests#conclusions-and-takeaways"><span class="icon icon-link"></span></a>Conclusions and Takeaways</h3>
<ol>
<li><strong>Treat your tests as production code</strong>
<ul>
<li>Tests can also contain bugs.</li>
<li>Risks: Faulty tests can lead to misleading outcomes, false confidence and mask bugs.</li>
</ul>
</li>
<li><strong>Understand limitations of testing and tooling</strong>
<ul>
<li>Recognize flawed or insignificant tests.</li>
<li>Tests can only go so far in reproducing realistic scenarios.</li>
<li>Tools can have biases or bugs, or might not be able to cover all significant input space.</li>
</ul>
</li>
<li><strong>Explore different testing strategies and techniques</strong>
<ul>
<li>Incorporate unit, fuzz, integration tests.</li>
<li>Test multiple properties and different angles.</li>
<li>Add redundancy.</li>
</ul>
</li>
<li><strong>Examine assumptions, preconditions, and conclusions of tests</strong>
<ul>
<li>Check for hidden assumptions or inaccurate preconditions: e.g. actors behaving differently in a realistic scenario, assuming well-formed inputs, e.g. sorted tokens, bytes data encoded correctly.</li>
<li>Do tested properties hold for all significant cases?</li>
</ul>
</li>
<li><strong>Test your tests</strong>
<ul>
<li>Create meta-tests.</li>
<li>Introduce deliberate bugs to see if tests detect them.</li>
<li>Apply mutation testing.</li>
</ul>
</li>
</ol>
<p>Questions to be asking yourself when reviewing your tests:</p>
<ul>
<li>How can we ensure that our tests are sufficiently covering critical parts of the code base?</li>
<li>How can we measure the efficacy and robustness of our tests?</li>
<li>What kind of guarantees does the passing of a test give and under what circumstances are these valid?</li>
</ul>
<h3 id="extra-material-additional-testing-shortcomings"><a href="/blog/2023/test-your-tests#extra-material-additional-testing-shortcomings"><span class="icon icon-link"></span></a>Extra Material: Additional Testing Shortcomings</h3>
<p>This section contains additional scenarios highlighting shortcomings in testing that would have made the main article too lengthy.</p>
<h3 id="testing-helper-functions"><a href="/blog/2023/test-your-tests#testing-helper-functions"><span class="icon icon-link"></span></a>Testing Helper Functions</h3>
<p>Thinking back to the shortcomings of tests in the ERC721A improvement example, we saw that expressive fuzz tests were absent (e.g. allowing multiple ID transfers).The next example examines a quick and dirty workaround that aims to cover that case.</p>
<p>In retrospect, the ERC721A improvement case highlighted a significant shortfall: the absence of expressive fuzz tests, including the ability to transfer multiple IDs. The next example explores a quick and practical fuzz test to address this deficiency.</p>
<p>We&#x27;ll make use of a testing helper library called <code>random</code>, which will be used to generate a new pseudo random <code>uint256</code> number when calling <code>random.next()</code>. The library is seeded by calling <code>random.seed()</code>.</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span>library random </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>    bytes32 constant </span><span class="token constant">RANDOM_SEED_SLOT</span><span> </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">keccak256</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#e6d06c">&quot;random.seed.slot&quot;</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#6f705e">/// @notice Seed randomness.</span><span>
</span></span><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">seed</span><span class="token" style="color:#bebec5">(</span><span class="token parameter">uint256 randomSeed</span><span class="token" style="color:#bebec5">)</span><span> internal </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        assembly </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>            </span><span class="token" style="color:#6f705e">// Store random seed.</span><span>
</span></span><span><span>            </span><span class="token function">sstore</span><span class="token" style="color:#bebec5">(</span><span class="token constant">RANDOM_SEED_SLOT</span><span class="token" style="color:#bebec5">,</span><span> randomSeed</span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span>        </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#6f705e">/// @notice Generates a next random number by hashing</span><span>
</span></span><span><span>    </span><span class="token" style="color:#6f705e">///         the current seed value stored in `RANDOM_SEED_SLOT`.</span><span>
</span></span><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">next</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span> internal </span><span class="token function">returns</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token parameter">uint256 nextRandom</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        assembly </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>            </span><span class="token" style="color:#6f705e">// Load random seed from storage slot.</span><span>
</span></span><span><span>            </span><span class="token" style="color:#ef3b7d">let</span><span> </span><span class="token literal-property property">r</span><span> </span><span class="token" style="color:#a77afe">:</span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">sload</span><span class="token" style="color:#bebec5">(</span><span class="token constant">RANDOM_SEED_SLOT</span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span>            </span><span class="token" style="color:#6f705e">// Compute keccak256 hash of seed.</span><span>
</span></span><span><span>            </span><span class="token function">mstore</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">,</span><span> r</span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span>            </span><span class="token literal-property property">nextRandom</span><span> </span><span class="token" style="color:#a77afe">:</span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">keccak256</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0x20</span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span>            </span><span class="token" style="color:#6f705e">// Update random seed.</span><span>
</span></span><span><span>            </span><span class="token function">sstore</span><span class="token" style="color:#bebec5">(</span><span class="token constant">RANDOM_SEED_SLOT</span><span class="token" style="color:#bebec5">,</span><span> r</span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span>        </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<p>Using this library we can quickly implement a function that will test <code>10</code> token transfers for all <code>30</code> minted IDs.</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span>contract </span><span class="token maybe-class-name">TestRandom_DONT</span><span> is </span><span class="token maybe-class-name">Test</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>    uint256 constant </span><span class="token constant">NUM_TRANSFERS</span><span> </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#a77afe">10</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    uint256 constant </span><span class="token constant">NUM_IDS</span><span> </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#a77afe">30</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">test_transfer</span><span class="token" style="color:#bebec5">(</span><span class="token parameter">uint256 seed</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">public</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        </span><span class="token" style="color:#6f705e">// Seed randomness.</span><span>
</span></span><span><span>        random</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">seed</span><span class="token" style="color:#bebec5">(</span><span>seed</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        </span><span class="token" style="color:#6f705e">// Create token and mint to `address(this)`.</span><span>
</span></span><span><span>        </span><span class="token constant">ERC721</span><span> token </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#ef3b7d">new</span><span> </span><span class="token class-name">ERC721A</span><span class="token" style="color:#bebec5">(</span><span class="token constant">NUM_IDS</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        </span><span class="token" style="color:#6f705e">// Set all local token ownerships to `address(this)`.</span><span>
</span></span><span><span>        address</span><span class="token" style="color:#bebec5">[</span><span class="token constant">NUM_IDS</span><span class="token" style="color:#bebec5">]</span><span> memory owners</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        </span><span class="token control-flow" style="color:#ef3b7d">for</span><span> </span><span class="token" style="color:#bebec5">(</span><span>uint256 i</span><span class="token" style="color:#bebec5">;</span><span> i </span><span class="token" style="color:#a77afe">&lt;</span><span> </span><span class="token constant">NUM_IDS</span><span class="token" style="color:#bebec5">;</span><span> i</span><span class="token" style="color:#a77afe">++</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>            owners</span><span class="token" style="color:#bebec5">[</span><span>i</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">address</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#ef3b7d">this</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span>
</span><span><span>        </span><span class="token control-flow" style="color:#ef3b7d">for</span><span> </span><span class="token" style="color:#bebec5">(</span><span>uint256 i</span><span class="token" style="color:#bebec5">;</span><span> i </span><span class="token" style="color:#a77afe">&lt;</span><span> </span><span class="token constant">NUM_TRANSFERS</span><span class="token" style="color:#bebec5">;</span><span> i</span><span class="token" style="color:#a77afe">++</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>            </span><span class="token" style="color:#6f705e">// Select a random id `nextId` to</span><span>
</span></span><span><span>            </span><span class="token" style="color:#6f705e">// transfer from `currOwner` to a randomly</span><span>
</span></span><span><span>            </span><span class="token" style="color:#6f705e">// selected `nextOwner`.</span><span>
</span></span><span><span>            uint256 nextId </span><span class="token" style="color:#a77afe">=</span><span> random</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">next</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#a77afe">%</span><span> </span><span class="token constant">NUM_IDS</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>            address nextOwner </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">address</span><span class="token" style="color:#bebec5">(</span><span class="token function">uint160</span><span class="token" style="color:#bebec5">(</span><span>random</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">next</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>            address currOwner </span><span class="token" style="color:#a77afe">=</span><span> owners</span><span class="token" style="color:#bebec5">[</span><span>nextId</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>            </span><span class="token" style="color:#6f705e">// Transfer `nextId` from `currOwner` to `nextOwner`.</span><span>
</span></span><span><span>            vm</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">prank</span><span class="token" style="color:#bebec5">(</span><span>currOwner</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>            token</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">transferFrom</span><span class="token" style="color:#bebec5">(</span><span>currOwner</span><span class="token" style="color:#bebec5">,</span><span> nextOwner</span><span class="token" style="color:#bebec5">,</span><span> nextId</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>            </span><span class="token" style="color:#6f705e">// Update local ownership data.</span><span>
</span></span><span><span>            owners</span><span class="token" style="color:#bebec5">[</span><span>nextId</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token" style="color:#a77afe">=</span><span> nextOwner</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span>
</span><span><span>        </span><span class="token" style="color:#6f705e">// Validate final token ownerships.</span><span>
</span></span><span><span>        </span><span class="token control-flow" style="color:#ef3b7d">for</span><span> </span><span class="token" style="color:#bebec5">(</span><span>uint256 i</span><span class="token" style="color:#bebec5">;</span><span> i </span><span class="token" style="color:#a77afe">&lt;</span><span> </span><span class="token constant">NUM_IDS</span><span class="token" style="color:#bebec5">;</span><span> i</span><span class="token" style="color:#a77afe">++</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>            </span><span class="token function">assertEq</span><span class="token" style="color:#bebec5">(</span><span>owners</span><span class="token" style="color:#bebec5">[</span><span>i</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">,</span><span> token</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">ownerOf</span><span class="token" style="color:#bebec5">(</span><span>i</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<p>Through analyzing this code, we can start out by highlighting some <em>hidden assumptions contained in this test that might not reflect real world conditions</em> and are limitations of the setup:</p>
<ol>
<li>All <code>30</code> tokens are minted in a single batch to a single owner.
<ol>
<li>There are no successive mints to multiple (or the same) owners.</li>
<li>There is no mint of variable size (e.g. <code>0</code>, <code>1</code>, ...).</li>
<li>There is no further mint after IDs have been transferred.</li>
</ol>
</li>
<li>The <code>nextId</code> is selected uniformly (low edge-case probability).
<ol>
<li>Selecting previous <code>ID</code> or <code>ID + 1</code> is low.</li>
<li>Selecting <code>ID = 0</code> or <code>ID = 30</code> is low.</li>
</ol>
</li>
<li>The <code>nextOwner</code> is selected uniformly.
<ol>
<li>The probability that the same or a previous owner is selected is negligible.</li>
<li>The probability that the zero address is selected is negligible.</li>
</ol>
</li>
</ol>
<p>Despite all these shortcomings and biases, this fuzz test should still be able to catch the missing edge case related to the ownership bug in the ERC721A implementation from earlier. However, it won&#x27;t <em>ever</em> be able to find it. This test will pass no matter what random IDs and owners will be drawn. In fact, this test might pass for entirely degenerate ERC721A implementations as well..</p>
<p><em>What is wrong with the given test setup and what steps would you employ to improve the security guarantees?</em></p>
<details>
<summary><b>Spot the issue above! [spoiler]</b><br/><br/></summary>
<p>The issue here is that the random seed is not updated to the new value. The old previous seed is simply stored again.</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span class="token unchanged prefix"> </span><span class="token unchanged line">           let r := sload(RANDOM_SEED_SLOT)
</span></span><span><span class="token unchanged line"></span><span class="token unchanged prefix"> </span><span class="token unchanged line">           // Compute keccak256 hash of seed.
</span></span><span><span class="token unchanged line"></span><span class="token unchanged prefix"> </span><span class="token unchanged line">           mstore(0, r)
</span></span><span><span class="token unchanged line"></span><span class="token unchanged prefix"> </span><span class="token unchanged line">           nextRandom := keccak256(0, 0x20)
</span></span><span><span class="token unchanged line"></span><span class="token unchanged prefix"> </span><span class="token unchanged line">           // Update random seed.
</span></span><span><span class="token unchanged line"></span><span class="token deleted-sign prefix" style="color:#ef3b7d">-</span><span class="token deleted-sign line" style="color:#ef3b7d">           sstore(RANDOM_SEED_SLOT, r)
</span></span><span><span class="token deleted-sign line" style="color:#ef3b7d"></span><span class="token inserted-sign prefix" style="color:#a6e22d">+</span><span class="token inserted-sign line" style="color:#a6e22d">           sstore(RANDOM_SEED_SLOT, nextRandom)</span></span></code></pre></pre>
<p>This results in poor randomness. This library always returns the same random value, the same <code>nextTokenId</code> and the same <code>nextOwner</code>!</p>
<p><em>How could the mistake in the helper function have been discovered?</em></p>
<p>The helper function is being used without any guarantees whatsoever. We require minimal tests for our helper functions to ensure that every test being built on top of it is working reliably.</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span>contract </span><span class="token maybe-class-name">TestRandom_DO</span><span> is </span><span class="token maybe-class-name">Test</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>    uint256 constant </span><span class="token constant">NUM</span><span> </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#a77afe">30</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#6f705e">/// Test seeding the `random` library.</span><span>
</span></span><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">test_seed</span><span class="token" style="color:#bebec5">(</span><span class="token parameter">uint256 seed1</span><span class="token parameter" style="color:#bebec5">,</span><span class="token parameter"> uint256 seed2</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">public</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        </span><span class="token" style="color:#6f705e">// Require the seeds to differ.</span><span>
</span></span><span><span>        vm</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">assume</span><span class="token" style="color:#bebec5">(</span><span>seed1 </span><span class="token" style="color:#a77afe">!=</span><span> seed2</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        </span><span class="token" style="color:#6f705e">// Store the first `NUM` random numbers</span><span>
</span></span><span><span>        </span><span class="token" style="color:#6f705e">// produced by the first seed.</span><span>
</span></span><span><span>        uint256</span><span class="token" style="color:#bebec5">[</span><span class="token constant">NUM</span><span class="token" style="color:#bebec5">]</span><span> memory randomNumbers</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        random</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">seed</span><span class="token" style="color:#bebec5">(</span><span>seed1</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        </span><span class="token control-flow" style="color:#ef3b7d">for</span><span> </span><span class="token" style="color:#bebec5">(</span><span>uint256 i</span><span class="token" style="color:#bebec5">;</span><span> i </span><span class="token" style="color:#a77afe">&lt;</span><span> </span><span class="token constant">NUM</span><span class="token" style="color:#bebec5">;</span><span> i</span><span class="token" style="color:#a77afe">++</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>            randomNumbers</span><span class="token" style="color:#bebec5">[</span><span>i</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token" style="color:#a77afe">=</span><span> random</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">next</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span>
</span><span><span>        </span><span class="token" style="color:#6f705e">// Assert the random numbers produced</span><span>
</span></span><span><span>        </span><span class="token" style="color:#6f705e">// by the second seed differ.</span><span>
</span></span><span><span>        random</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">seed</span><span class="token" style="color:#bebec5">(</span><span>seed2</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        </span><span class="token control-flow" style="color:#ef3b7d">for</span><span> </span><span class="token" style="color:#bebec5">(</span><span>uint256 i</span><span class="token" style="color:#bebec5">;</span><span> i </span><span class="token" style="color:#a77afe">&lt;</span><span> </span><span class="token constant">NUM</span><span class="token" style="color:#bebec5">;</span><span> i</span><span class="token" style="color:#a77afe">++</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>            </span><span class="token function">assertTrue</span><span class="token" style="color:#bebec5">(</span><span>randomNumbers</span><span class="token" style="color:#bebec5">[</span><span>i</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token" style="color:#a77afe">!=</span><span> random</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">next</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span>
</span><span><span>        </span><span class="token" style="color:#6f705e">// Assert that resetting to the old</span><span>
</span></span><span><span>        </span><span class="token" style="color:#6f705e">// seed produces the same random sequence.</span><span>
</span></span><span><span>        random</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">seed</span><span class="token" style="color:#bebec5">(</span><span>seed1</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        </span><span class="token control-flow" style="color:#ef3b7d">for</span><span> </span><span class="token" style="color:#bebec5">(</span><span>uint256 i</span><span class="token" style="color:#bebec5">;</span><span> i </span><span class="token" style="color:#a77afe">&lt;</span><span> </span><span class="token constant">NUM</span><span class="token" style="color:#bebec5">;</span><span> i</span><span class="token" style="color:#a77afe">++</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>            </span><span class="token function">assertEq</span><span class="token" style="color:#bebec5">(</span><span>randomNumbers</span><span class="token" style="color:#bebec5">[</span><span>i</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">,</span><span> random</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">next</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#6f705e">/// @notice Marks a random number as seen.</span><span>
</span></span><span><span>    </span><span class="token function">mapping</span><span class="token" style="color:#bebec5">(</span><span class="token parameter">uint256</span><span> </span><span class="token arrow" style="color:#a77afe">=&gt;</span><span> bool</span><span class="token" style="color:#bebec5">)</span><span> randomNumberSeen</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#6f705e">/// Test the random numbers returned by the library do not repeat.</span><span>
</span></span><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">test_next</span><span class="token" style="color:#bebec5">(</span><span class="token parameter">uint256 seed</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">public</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        random</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">seed</span><span class="token" style="color:#bebec5">(</span><span>seed</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        </span><span class="token control-flow" style="color:#ef3b7d">for</span><span> </span><span class="token" style="color:#bebec5">(</span><span>uint256 i</span><span class="token" style="color:#bebec5">;</span><span> i </span><span class="token" style="color:#a77afe">&lt;</span><span> </span><span class="token constant">NUM</span><span class="token" style="color:#bebec5">;</span><span> i</span><span class="token" style="color:#a77afe">++</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>            uint256 r </span><span class="token" style="color:#a77afe">=</span><span> random</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">next</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>            </span><span class="token" style="color:#6f705e">// The probability of r ∈ [0, 100_000]</span><span>
</span></span><span><span>            </span><span class="token" style="color:#6f705e">// should be negligible.</span><span>
</span></span><span><span>            </span><span class="token function">assertTrue</span><span class="token" style="color:#bebec5">(</span><span>r </span><span class="token" style="color:#a77afe">&gt;</span><span> </span><span class="token" style="color:#a77afe">100_000</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>            </span><span class="token" style="color:#6f705e">// The random number should be unseen.</span><span>
</span></span><span><span>            </span><span class="token function">assertEq</span><span class="token" style="color:#bebec5">(</span><span>randomNumberSeen</span><span class="token" style="color:#bebec5">[</span><span>r</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">false</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>            </span><span class="token" style="color:#6f705e">// Mark number as seen.</span><span>
</span></span><span><span>            randomNumberSeen</span><span class="token" style="color:#bebec5">[</span><span>r</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#a77afe">true</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<p>Testing the <code>random</code> library&#x27;s <code>seed</code> and <code>next</code> functions in a couple fuzz tests would have detected the issue related to the bad randomness.</p>
<p>That&#x27;s why it&#x27;s important to <strong>test your helper functions</strong> as well. Building a robust structure of tests requires a solid foundation. <em>There is no cake without a base!</em></p>
</details>
<h3 id="tool-quirks"><a href="/blog/2023/test-your-tests#tool-quirks"><span class="icon icon-link"></span></a>Tool Quirks</h3>
<p>Let&#x27;s revisit the notion that it&#x27;s important to understand how to use your tool, its biases and quirks. Below is a function <code>MerkleLib.zeros</code> that returns pre-computed roots for empty subtrees of a given depth. These have been computed beforehand and are being validated and fixed through a unit test that checks all values.</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span>uint256 constant </span><span class="token constant">DEPTH</span><span> </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#a77afe">4</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>library </span><span class="token maybe-class-name">MerkleLib</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>    error </span><span class="token function maybe-class-name">InvalidZerosLevel</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#6f705e">/// @notice Returns pre-computed zero sub-tree root of depth `level`.</span><span>
</span></span><span><span>    </span><span class="token" style="color:#6f705e">///         Each sub-tree root is computed by:</span><span>
</span></span><span><span>    </span><span class="token" style="color:#6f705e">///             root(0) := keccak256(enc(0, 0))</span><span>
</span></span><span><span>    </span><span class="token" style="color:#6f705e">///             root(N) := keccak256(enc(root(N-1), root(N-1)))</span><span>
</span></span><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">zeros</span><span class="token" style="color:#bebec5">(</span><span class="token parameter">uint256 level</span><span class="token" style="color:#bebec5">)</span><span> internal pure </span><span class="token function">returns</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token parameter">bytes32</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        </span><span class="token control-flow" style="color:#ef3b7d">if</span><span> </span><span class="token" style="color:#bebec5">(</span><span>level </span><span class="token" style="color:#a77afe">==</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token control-flow" style="color:#ef3b7d">return</span><span> </span><span class="token" style="color:#a77afe">0x2098f5fb9e239eab3ceac3f27b81e481dc3124d55ffed523a839ee8446b64864</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        </span><span class="token control-flow" style="color:#ef3b7d">if</span><span> </span><span class="token" style="color:#bebec5">(</span><span>level </span><span class="token" style="color:#a77afe">==</span><span> </span><span class="token" style="color:#a77afe">1</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token control-flow" style="color:#ef3b7d">return</span><span> </span><span class="token" style="color:#a77afe">0x1069673dcdb12263df301a6ff584a7ec261a44cb9dc68df067a4774460b1f1e1</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        </span><span class="token control-flow" style="color:#ef3b7d">if</span><span> </span><span class="token" style="color:#bebec5">(</span><span>level </span><span class="token" style="color:#a77afe">==</span><span> </span><span class="token" style="color:#a77afe">2</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token control-flow" style="color:#ef3b7d">return</span><span> </span><span class="token" style="color:#a77afe">0x18f43331537ee2af2e3d758d50f72106467c6eea50371dd528d57eb2b856d238</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        </span><span class="token control-flow" style="color:#ef3b7d">if</span><span> </span><span class="token" style="color:#bebec5">(</span><span>level </span><span class="token" style="color:#a77afe">==</span><span> </span><span class="token" style="color:#a77afe">3</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token control-flow" style="color:#ef3b7d">return</span><span> </span><span class="token" style="color:#a77afe">0x07f9d837cb17b0d36320ffe93ba52345f1b728571a568265caac97559dbc952a</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        </span><span class="token control-flow" style="color:#ef3b7d">if</span><span> </span><span class="token" style="color:#bebec5">(</span><span>level </span><span class="token" style="color:#a77afe">==</span><span> </span><span class="token" style="color:#a77afe">4</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token control-flow" style="color:#ef3b7d">return</span><span> </span><span class="token" style="color:#a77afe">0x2b94cf5e8746b3f5c9631f4c5df32907a699c58c94b2ad4d7b5cec1639183f55</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        revert </span><span class="token function maybe-class-name">InvalidZerosLevel</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span>
</span><span><span>contract </span><span class="token maybe-class-name">TestMerkle_DONT</span><span> is </span><span class="token maybe-class-name">Test</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>    </span><span class="token" style="color:#6f705e">/// Test `MerkleLib.zeros` returns correct hash values.</span><span>
</span></span><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">test_zeros</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">public</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        bytes32 node</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        </span><span class="token control-flow" style="color:#ef3b7d">for</span><span> </span><span class="token" style="color:#bebec5">(</span><span>uint256 i</span><span class="token" style="color:#bebec5">;</span><span> i </span><span class="token" style="color:#a77afe">&lt;</span><span> </span><span class="token constant">DEPTH</span><span> </span><span class="token" style="color:#a77afe">+</span><span> </span><span class="token" style="color:#a77afe">1</span><span class="token" style="color:#bebec5">;</span><span> i</span><span class="token" style="color:#a77afe">++</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>            node </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">keccak256</span><span class="token" style="color:#bebec5">(</span><span>abi</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">encode</span><span class="token" style="color:#bebec5">(</span><span>node</span><span class="token" style="color:#bebec5">,</span><span> node</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>            </span><span class="token function">assertEq</span><span class="token" style="color:#bebec5">(</span><span class="token maybe-class-name">MerkleLib</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">zeros</span><span class="token" style="color:#bebec5">(</span><span>i</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">,</span><span> node</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span>
</span><span><span>        </span><span class="token" style="color:#6f705e">// Calling `MerkleLib.zeros(DEPTH + 1)` should revert.</span><span>
</span></span><span><span>        vm</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">expectRevert</span><span class="token" style="color:#bebec5">(</span><span class="token maybe-class-name">MerkleLib</span><span class="token" style="color:#bebec5">.</span><span class="token property-access maybe-class-name">InvalidZerosLevel</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">selector</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        </span><span class="token maybe-class-name">MerkleLib</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">zeros</span><span class="token" style="color:#bebec5">(</span><span class="token constant">DEPTH</span><span> </span><span class="token" style="color:#a77afe">+</span><span> </span><span class="token" style="color:#a77afe">1</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<p>The test <code>test_zeros</code> passes the unit test.</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span class="token maybe-class-name">Running</span><span> </span><span class="token" style="color:#a77afe">1</span><span> test </span><span class="token control-flow" style="color:#ef3b7d">for</span><span> test</span><span class="token" style="color:#a77afe">/</span><span class="token maybe-class-name">TestMerkle</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">sol</span><span class="token" style="color:#a77afe">:</span><span class="token maybe-class-name">TestMerkle_DONT</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">[</span><span class="token constant">PASS</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token function">test_zeros</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">(</span><span>gas</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token" style="color:#a77afe">46756</span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span></span><span class="token maybe-class-name">Test</span><span> result</span><span class="token" style="color:#a77afe">:</span><span> ok</span><span class="token" style="color:#bebec5">.</span><span> </span><span class="token" style="color:#a77afe">1</span><span> passed</span><span class="token" style="color:#bebec5">;</span><span> </span><span class="token" style="color:#a77afe">0</span><span> failed</span><span class="token" style="color:#bebec5">;</span><span> </span><span class="token" style="color:#a77afe">0</span><span> skipped</span><span class="token" style="color:#bebec5">;</span><span> finished </span><span class="token" style="color:#ef3b7d">in</span><span> </span><span class="token" style="color:#a77afe">337.54</span><span>µs</span></span></code></pre></pre>
<p><em>What is wrong here?</em></p>
<p>If you recall some of the advice previously given, then you might be able to rewrite the test in a safer way and spot the issue.</p>
<details>
<summary><b>Spot the issue above! [spoiler]</b><br/><br/></summary>
<p>Once we split up our test based on the expected outcomes (passing, reverting), we immediately see the issue at hand.</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span>contract </span><span class="token maybe-class-name">TestMerkle_DO</span><span> is </span><span class="token maybe-class-name">Test</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>    </span><span class="token" style="color:#6f705e">/// Test `MerkleLib.zeros` returns correct hash values.</span><span>
</span></span><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">test_zeros</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">public</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        bytes32 node</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        </span><span class="token control-flow" style="color:#ef3b7d">for</span><span> </span><span class="token" style="color:#bebec5">(</span><span>uint256 i</span><span class="token" style="color:#bebec5">;</span><span> i </span><span class="token" style="color:#a77afe">&lt;</span><span> </span><span class="token constant">DEPTH</span><span> </span><span class="token" style="color:#a77afe">+</span><span> </span><span class="token" style="color:#a77afe">1</span><span class="token" style="color:#bebec5">;</span><span> i</span><span class="token" style="color:#a77afe">++</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>            node </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">keccak256</span><span class="token" style="color:#bebec5">(</span><span>abi</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">encode</span><span class="token" style="color:#bebec5">(</span><span>node</span><span class="token" style="color:#bebec5">,</span><span> node</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>            </span><span class="token function">assertEq</span><span class="token" style="color:#bebec5">(</span><span class="token maybe-class-name">MerkleLib</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">zeros</span><span class="token" style="color:#bebec5">(</span><span>i</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">,</span><span> node</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#6f705e">/// Calling `MerkleLib.zeros(DEPTH + 1)` should revert.</span><span>
</span></span><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">test_zeros_revert_InvalidZerosLevel</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">public</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        vm</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">expectRevert</span><span class="token" style="color:#bebec5">(</span><span class="token maybe-class-name">MerkleLib</span><span class="token" style="color:#bebec5">.</span><span class="token property-access maybe-class-name">InvalidZerosLevel</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">selector</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        </span><span class="token maybe-class-name">MerkleLib</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">zeros</span><span class="token" style="color:#bebec5">(</span><span class="token constant">DEPTH</span><span> </span><span class="token" style="color:#a77afe">+</span><span> </span><span class="token" style="color:#a77afe">1</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<p>This produces the following output.</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span class="token maybe-class-name">Running</span><span> </span><span class="token" style="color:#a77afe">2</span><span> tests </span><span class="token control-flow" style="color:#ef3b7d">for</span><span> test</span><span class="token" style="color:#a77afe">/</span><span class="token maybe-class-name">TestMerkle</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">sol</span><span class="token" style="color:#a77afe">:</span><span class="token maybe-class-name">TestMerkle_DO</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">[</span><span class="token constant">FAIL</span><span class="token" style="color:#bebec5">.</span><span> </span><span class="token property-access maybe-class-name">Reason</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token maybe-class-name">Assertion</span><span> failed</span><span class="token" style="color:#bebec5">.</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token function">test_zeros</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">(</span><span>gas</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token" style="color:#a77afe">46138</span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">[</span><span class="token constant">PASS</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token function">test_zeros_revert_InvalidZerosLevel</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">(</span><span>gas</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token" style="color:#a77afe">3252</span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span></span><span class="token maybe-class-name">Test</span><span> result</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token constant">FAILED</span><span class="token" style="color:#bebec5">.</span><span> </span><span class="token" style="color:#a77afe">1</span><span> passed</span><span class="token" style="color:#bebec5">;</span><span> </span><span class="token" style="color:#a77afe">1</span><span> failed</span><span class="token" style="color:#bebec5">;</span><span> </span><span class="token" style="color:#a77afe">0</span><span> skipped</span><span class="token" style="color:#bebec5">;</span><span> finished </span><span class="token" style="color:#ef3b7d">in</span><span> </span><span class="token" style="color:#a77afe">397.04</span><span>µs
</span></span><span>
</span><span><span></span><span class="token maybe-class-name">Ran</span><span> </span><span class="token" style="color:#a77afe">2</span><span> test suites</span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token" style="color:#a77afe">2</span><span> tests passed</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">1</span><span> failed</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0</span><span> </span><span class="token function">skipped</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#a77afe">3</span><span> total tests</span><span class="token" style="color:#bebec5">)</span></span></code></pre></pre>
<p>We now see that the first part of the test was actually failing. All the pre-computed hashes have been calculated using the Poseidon hash instead of <code>keccak256</code> resulting in incorrect values.</p>
<p><em>Why does the test pass nonetheless?</em></p>
<p>The reason the single test passes nonetheless when testing both things at once is due to a <a target="_blank" rel="noreferrer" class="link" href="https://github.com/foundry-rs/foundry/issues/4832">quirk in Foundry</a> related to using <code>vm.expectRevert</code> on internal functions. Failing <code>assert</code> statements are ignored if a revert is caught on an internal function.</p>
</details>
<p>Remember the advice from earlier that <strong>a test should only be testing one thing</strong> at a time. Again, this also makes the testing structure clearer and simpler.</p></div></div></div></main></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"slug":["blog","2023","test-your-tests"],"contentRaw":"\n\u003e This is a writeup of the talks given at [TrustX](https://www.secureum.xyz/trustx/) and [Solidity Summit](https://soliditylang.org/summit/) at [Devconnect Istanbul 2023](https://devconnect.org/). I am a blockchain security engineer and researcher at Trail of Bits.\n\n_In order to gain the most out of this article, it is advised that you actively try to discover the issue within the tests in the examples (hidden behind spoiler tags). Take a moment and consider what patterns might seem dangerous or brittle and how you could implement safer tests._\n\nIn the rapidly evolving landscape of software development, **the importance of rigorous testing cannot be overstated**. This is especially true when dealing with mission-critical systems like blockchains with millions at risk. The reliability of tests are fundamental to ensuring the integrity and security of these systems. But, _how can we guarantee robustness of our tests, and how do we evaluate their quality and efficacy?_\n\n**Table of Contents**\n\n- [The Role of Testing](#the-role-of-testing)\n- [Motivation Behind the Topic](#motivation-behind-the-topic)\n  - [Improving ERC721A](#improving-erc721a)\n  - [Development and Testing Approach](#development-and-testing-approach)\n- [Testing Shortcomings Exemplified](#testing-shortcomings-exemplified)\n  - [Testing WAD Conversions](#testing-wad-conversions)\n  - [Testing WAD Multiplication](#testing-wad-multiplication)\n  - [Exploring Various Testing Strategies](#exploring-various-testing-strategies)\n- [Offensive Testing](#offensive-testing)\n  - [Case Study: Primitive Finance - Hyper](#case-study-primitive-finance---hyper)\n  - [Initial Testing Strategy](#initial-testing-strategy)\n  - [Refining the Testing Strategy](#refining-the-testing-strategy)\n- [Conclusions and Takeaways](#conclusions-and-takeaways)\n- [Extra Material: Additional Testing Shortcomings](#extra-material-additional-testing-shortcomings)\n  - [Testing Helper Functions](#testing-helper-functions)\n  - [Tool Quirks](#tool-quirks)\n\n## The Role of Testing\n\n_Why do we even test our software?_\n\nTests are primarily written with the goal of **identifying incorrect or unexpected behavior** of our software. Unit tests are great for validating that our code will produce a certain outcome given an input. With the advancement of automated testing we are also able to **validate properties or invariants of our system** by simulating function calls with persistent state. Unit and fuzz tests can also be great for **ensuring that a piece of code adheres to its specification**. Tests for the ERC721 standard, for example, can be applied to an extension of the specification in order to uncover unexpected deviations from the requirements of the norm.\n\nWhat's more, tests act as the protective layer for preserving code functionality. A well-crafted test should **cement the anticipated code behavior**, safeguarding it against unexpected issues that might be introduced in future modifications.\n\nAlthough applying various testing methods and static analysis can vouch for your code's stability, it's important to keep in mind that **no test and testing method is infallible**. _Testing is an ongoing process of refinement, not a final endpoint!_ It is impossible to gain absolute certainty that your code will be bug-free. Tests may contain bugs themselves, fuzzers can be used ineffectively and even tools for formal verification make faulty assumptions and suffer from state explosion or bad heuristics. In order to achieve robustness in software, constant attention and multiple testing methods are essential.\n\n## Motivation Behind the Topic\n\nThis topic's inspiration stems from my own experiences and reflections on past shortcomings. Before becoming a security researcher, I paved my path as a developer. Every developer makes a mistake at some point. I wanted to learn from every single one of them. Each identified vulnerability led me to re-evaluate my approach–––_how could I improve my development and testing process to prevent similar situations arising in the future?_\n\nA memorable experience in this regard remains when optimizing the [ERC721A](https://www.erc721a.org/) contract.\n\n### Improving ERC721A\n\nERC721A works by leveraging batched token mints involving sequential IDs. The idea is to defer costly storage operations at a time of high network costs (during the mint) to a time of low network costs (for subsequent transfers). This is done by keeping the ownership data of IDs minted in sequence implicit instead of explicitly committing them to the storage one by one.\n\nWhen identifying the owner of an ID, if the ownership data is empty (uncommitted/implicit), then the owner is looked up in the previous slot.\n\n```\nBob mints 5 IDs:\n               tokenId\n                  V\n| X | Bob |    |    |    |    | Y |\n       ^\n      from\n\nBob transfers `tokenId` to Eve:\n\n| X | Bob |    | Eve |    |    | Y |\n                  ^\n                  to\n\nFollowing Ownership Commit:\n\n| X | Bob |    | Eve | Bob |    | Y |\n                        ^\n```\n\nUpon transfers, ERC721A checks whether the ownership data of the subsequent ID is explicit or implicit. In order to maintain consistent ownership data, it must be set explicitly.\n\nIt's not important to understand the specifics of the implementation. All that should be known is that it aims to mimic the behavior of an ERC721 and maintain correct NFT ownerships. However, the underlying business logic makes it such that _new edge-cases not present in the default ERC721 implementation need to be handled with additional care_.\n\nThe idea for further optimization in the ERC721A contract came from realizing that the check for explicit ownership of the subsequent ID was only required to be performed a single time. Once the data is explicit, this check can be skipped, saving gas on all future transfers by removing a cold storage load. A boolean variable `nextTokenDataSet` packed together in the current (already warm) ownership slot could track whether the following data is explicit.\n\n### Development and Testing Approach\n\nAt the time, testing had become an integral part of my development process. I often wrote tests before the actual implementation guiding my process. The idea was that through sufficiently covering as many scenarios as possible in tests any coding mistake would eventually be uncovered. _However, this approach can backfire when the implementation nuances are disregarded_. For the ERC721A optimization, I ended up writing four unit tests in addition to Solmate's ERC721 unit and fuzz tests to validate that the ownerships remained consistent.\n\n```js\n /// Transfer last minted id.\n /// Ensure id beyond last is not written to.\n /// Ensure correct ownership.\n function test_transferFrom1() public {\n     // ...\n }\n\n /// Transfer last two minted IDs in batch.\n /// Ensure correct ownership.\n function test_transferFrom2() public {\n     // ...\n }\n\n /// Mint new tokens after previous transfers.\n /// Ensure correct ownership.\n function test_transferFrom3() public {\n     // ...\n }\n\n /// Transfer tokens in middle of batch.\n /// Ensure correct ownership.\n function test_transferFrom4() public {\n     // ...\n }\n```\n\nImagine my surprise when I was notified about a bug in the implementation.\n\n![Bug alert](/data/blog/2023/test-your-tests/bug-alert.png)\n\nI was surprised how this was even possible with all those extra test scenarios. Eventually, in order to mitigate the bug, I ended up including an additional test-case which showed up as failing.\n\n```js\n/// Transfer first token in batch.\n/// Ensure correct ownership.\nfunction test_transferFrom5() public {\n    // ...\n}\n```\n\nThen I quickly applied a patch that would satisfy all the tests.\n\nImagine my shock when I discovered that I had inadvertently included another bug in my patch which the expanded tests did not catch. This realization led me to slow down and reflect on the shortcomings of my current approach.\n\n_What went wrong?_\n\nIt is hard to point a finger on what exactly had gone wrong and allowed a bug to slip through the cracks of all the tests. Was I supposed to create unit tests for every possible state? After tracking all relevant variables related to control flow and producing tests covering the cartesian product of all important states, I realized that such an approach is likely infeasible in most practical cases due to the high overhead and state explosion.\n\nI realized that there is no one single thing which I should have done differently given a limited budget on time. Nevertheless, a few things can be said. For one, I was **lacking structure and a systematic approach** when writing the tests. This is especially true when covering every possible state is infeasible. In my case, this lead to **missing important edge-cases** in the tests that were relevant to the optimization. Another thing that could be identified was that some tests were **testing multiple things at once** which pronounced the lack of structure.\n\nFinally another important factor was that I was **lacking expressive and meaningful fuzz tests** that could handle, multiple transfers with random IDs and arbitrary actors. Let's further analyze how testing shortcomings could be avoided in simpler examples.\n\n## Testing Shortcomings Exemplified\n\n### Testing WAD Conversions\n\nTo shed light on the concepts discussed, consider a simple exercise of writing a fuzz test for WAD unit conversions.\n\n```js\nuint256 constant WAD = 1e18;\n\nfunction fromWAD(uint256 a) pure returns (uint256 c) {\n    c = a / WAD;\n}\n\nfunction toWAD(uint256 a) pure returns (uint256 c) {\n    c = a * WAD;\n}\n\ncontract TestFromWAD_DONT is Test {\n    function test_toWAD_fromWAD(uint256 a) public {\n        if (a \u003e= type(uint256).max / WAD) vm.expectRevert();\n\n        assertEq(fromWAD(toWAD(a)), a);\n    }\n}\n```\n\n```js\nRunning 1 test for test/TestFromWAD.sol:TestFromWAD_DONT\n[PASS] test_toWAD_fromWAD(uint256) (runs: 10000, μ: 1201, ~: 589)\nTest result: ok. 1 passed; 0 failed; 0 skipped; finished in 156.80ms\n```\n\nWhile the fuzz test passes, there is something wrong in this setup.\n\n\u003cdetails\u003e\n\u003csummary\u003e\u003cb\u003eSpot the issue above! [spoiler]\u003c/b\u003e\u003cbr\u003e\u003cbr\u003e\u003c/summary\u003e\n\nWhile the above test passed numerous fuzzing iterations, the test itself contains an incorrect boundary check which the fuzzer doesn't find. Specifically, the conversion should not revert for `a = type(uint256).max / WAD`.\n\n```diff\n-       if (a \u003e= type(uint256).max / WAD) vm.expectRevert();\n+       if (a \u003e  type(uint256).max / WAD) vm.expectRevert();\n```\n\nTo further illustrate this, we can create a unit test and pass the boundary point to our fuzz test.\n\n```js\nfunction test_toWAD_fromWAD_boundary() public {\n    uint256 a = type(uint256).max / WAD;\n\n    this.test_toWAD_fromWAD(a);\n}\n```\n\n```js\nRunning 2 tests for test/TestFromWAD.sol:TestFromWAD_DONT\n[PASS] test_toWAD_fromWAD(uint256) (runs: 10000, μ: 1222, ~: 589)\n[FAIL. Reason: call did not revert as expected] test_toWAD_fromWAD_boundary() (gas: 4093)\nTraces:\n  [4093] TestFromWAD_DONT::test_toWAD_fromWAD_boundary()\n    ├─ [3446] TestFromWAD_DONT::test_toWAD_fromWAD(115792089237316195423570985008687907853269984665640564039457 [1.157e59])\n    │   ├─ [0] VM::expectRevert()\n    │   │   └─ ← ()\n    │   └─ ← ()\n    └─ ← \"call did not revert as expected\"\n\nTest result: FAILED. 1 passed; 1 failed; 0 skipped; finished in 149.86ms\n```\n\nRerunning the tests, we see that the fuzz test passes, but the unit test which simply calls the fuzz test with a concrete value fails.\n\n_Why does the fuzzer not test the boundary value?_\n\nFrom the fuzzer's perspective, this value might appear as any other in the space of all possible `uint256` inputs. It is thus very unlikely that the fuzzer will input this value without some further knowledge about the system or without some static analysis of the code.\n\n\u003c/details\u003e\n\nThis inaccuracy in the test exemplifies how an unclear precondition can not only obfuscate the true functionality but, in more severe scenarios, also mask vulnerabilities. For this reason, **it is important to know how your tool works**, their strengths and weaknesses, and any biases. It is also not uncommon for tools to contain quirks and bugs themselves. Leaning too heavily on a single tool or a type of test can be detrimental to the reliability of your testing results.\n\n_How could we have done better?_\n\nTo help the fuzzer do its work, we can restructure the test as follows:\n\n```js\ncontract TestFromWAD_DO is Test {\n    /// Testing for values where `toWAD(a)` shouldn't revert.\n    function test_toWAD_fromWAD(uint256 a) public {\n        a = bound(a, 0, type(uint256).max / WAD);\n\n        assertEq(fromWAD(toWAD(a)), a);\n    }\n\n    /// Testing for values where `toWAD(a)` should revert.\n    function test_toWAD_fromWAD_revert_Panic(uint256 a) public {\n        a = bound(a, type(uint256).max / WAD + 1, type(uint256).max);\n\n        vm.expectRevert(abi.encodeWithSignature(\"Panic(uint256)\", (0x11)));\n\n        assertEq(fromWAD(toWAD(a)), a);\n    }\n}\n```\n\n$$\nuint256 \\text{ domain}\n$$\n\n$$\n\\overset{\\raisebox{2pt}{\\color{green} passing}}{\n    ├\\underset{0}{─}────────────\\underset{\\hskip -1em \\frac {MAX} {WAD}}{─}┤\n}\n\\overset{\\raisebox{2pt} {\\color{red}reverting}}{\n    ├────\\underset{\\hskip -3.5em \\frac {MAX} {WAD} + 1}───────\\underset{\\hskip -0.4 em MAX }{───}┤\n}\n$$\n\nBy **dividing tests based on expected results** (success or failure), our testing approach becomes clearer and ensures both situations are sufficiently tested. Generally, we want to **avoid complex decision trees in our test**. A test should ideally be doing one thing only.\n\nThis also ensures that we are getting enough coverage for our specific test scenario. Before this refactor, it could have been possible for the happy path to be chosen 99% of the time and only 1% of the test cases covering the reverting path. In the new setup we ensure that both cases receive the same number of successful fuzz runs.\n\nAny **edge cases should be explicitly tested** in further unit (and fuzz) tests. However, in this simple case, we can rely on Foundry's `bound` function. This helps in testing near boundary conditions, since it adds a bias to the `min` and `max` values in `bound(var, min, max)`.\n\nFurther, testing for a specific error (`Panic(0x11)`) can identify unintentional coding errors. **Catching general (unspecified) reverts via `vm.expectRevert()` is strongly discouraged**. You should always be able to exactly anticipate your code's behavior and outcome––and specifically, in what way it will revert.\n\nAs a further improvement, one might argue that the calls `fromWAD(toWAD(a))` should be separated. Currently the expected revert could apply to both functions (since they are called internally). In order to pinpoint (and anticipate) the exact occurrence of the error, these functions should be called externally.\n\nIt's worth noting, however, that the current tests alone don't offer a clear picture of the actual behavior of the `toWAD` and `fromWAD` functions. Multiple functions satisfy the constraints set by the tests, as illustrated below:\n\n```js\nfunction fromWAD(uint256 a) pure returns (uint256 c) {\n    c = a + 1234;\n}\n\nfunction toWAD(uint256 a) pure returns (uint256 c) {\n    if (a \u003e type(uint256).max / WAD) revert();\n    c = a - 1234;\n}\n```\n\nWithout getting lost in details, let's look at another example.\n\n### Testing WAD Multiplication\n\nWe just examined a case where a test contained a wrong precondition compared compared to the implementation. _What if, however, our test mirrored an incorrect precondition contained in the implementation itself?_\n\nThe next testing example showcases multiplication in `WAD` units using `unchecked` arithmetic for optimization purposes.\n\n```js\ncontract TestMulWAD_DONT is Test {\n    function mulWAD(uint256 a, uint256 b) public pure returns (uint256 c) {\n        unchecked {\n            if (b == 0 || a \u003e type(uint256).max / b) revert Overflow();\n\n            c = a * b / WAD;\n        }\n    }\n\n    function test_mulWAD(uint256 a, uint256 b) public {\n        if (b == 0 || a \u003e type(uint256).max / b) vm.expectRevert();\n\n        uint256 c = mulWAD(a, b);\n\n        assertEq(c, a * b / WAD);\n    }\n}\n```\n\nAgain, if we give the fuzzer a go at this test, it will report that it passes for all cases.\n\n```js\nRunning 1 test for test/TestMulWAD.sol:TestMulWAD_DONT\n[PASS] test_mulWAD(uint256,uint256) (runs: 10000, μ: 1698, ~: 732)\nTest result: ok. 1 passed; 0 failed; 0 skipped; finished in 158.97ms\n```\n\n\u003cdetails\u003e\n\u003csummary\u003e\u003cb\u003eSpot the issue above! [spoiler]\u003c/b\u003e\u003cbr\u003e\u003cbr\u003e\u003c/summary\u003e\n\nThe issue in this example arises from the incorrect precondition mirrored in the test. The boolean OR operator `||` is accidentally used instead of an AND operator `\u0026\u0026`.\n\n```diff\n    function mulWAD(uint256 a, uint256 b) public pure returns (uint256 c) {\n        unchecked {\n-           if (b == 0 || a \u003e type(uint256).max / b) revert Overflow();\n+           if (b != 0 \u0026\u0026 a \u003e type(uint256).max / b) revert Overflow();\n        }\n    }\n\n    function test_mulWAD(uint256 a, uint256 b) public {\n-       if (b == 0 || a \u003e type(uint256).max / b) vm.expectRevert();\n+       if (b != 0 \u0026\u0026 a \u003e type(uint256).max / b) vm.expectRevert();\n    }\n```\n\nA mistake like this could likely have been introduced by manually copying the flawed precondition for overflow to the test. Such a case, can not be detected by the fuzzer.\n\n\u003c/details\u003e\n\n_How could we have done better to avoid the such a failure case?_\n\n### Exploring Various Testing Strategies\n\nAs we have just seen in the previous example, **solely relying on a single form of testing can lead to brittle results**. Including a simple _unit test_ for known values, e.g. `mulWAD(0, 0)` could have uncovered the incorrect check.\n\n```js\ncontract TestMulWAD_DO is Test {\n    /// Unit test\n    function test_mulWAD_unit() public {\n        uint256 a = 0;\n        uint256 b = 0;\n        uint256 c = mulWAD(a, b);\n\n        assertEq(c, 0);\n    }\n}\n```\n\nIt never hurts to cover the implementation behavior with multiple unit tests and **additional adjacent property/fuzz tests**. For example, checking that our function satisfies the commutative property would have uncovered the mistake in the code as well.\n\n```js\ncontract TestMulWAD_DO is Test {\n    // Fuzz test commutative property\n    function test_mulWAD_fuzz_commutative(uint256 a, uint256 b) public {\n        // If `a * b = c` doesn't overflow...\n        try this.mulWAD(a, b) returns (uint256 c) {\n            // then `b * a = c`.\n            assertEq(c, mulWAD(b, a));\n        } catch {}\n    }\n}\n```\n\nAnother point to be mindful of is that when code from the implementation is reused in a test, we rely on its correctness to be able to trust the outcome of the test. In this example an incorrect pre-condition was copied to the test, but we could also make the same mistake when we re-use function calls which evaluate a pre-condition.\n\nThis is why it's important to **approach testing from multiple angles**. In the case of the overflow check, we could have also re-implemented the overflow logic in another manner.\n\n```js\ncontract TestMulWAD_DO is Test {\n    /// Fuzz test\n    function test_mulWAD_fuzz(uint256 a, uint256 b) public {\n        unchecked {\n            // Compute `c = a * b` while ignoring overflow.\n            uint256 c = a * b;\n\n            // If we can't reconstruct `b = c / a`, then we lost some bits.\n            if (a != 0 \u0026\u0026 b != c / a) vm.expectRevert(Overflow.selector);\n\n            assertEq(mulWAD(a, b), c);\n        }\n    }\n}\n```\n\nWhat's more, if we have a reference implementation at hand, we can also **use fuzzing to detect any discrepancies by differentially testing** the behavior of two implementations against each other.\n\n```js\ncontract TestMulWAD_DO is Test {\n    function mulWADNative(uint256 a, uint256 b) public pure returns (uint256 c) {\n        c = a * b / WAD;\n    }\n\n    /// Differential test\n    function test_mulWAD_differential(uint256 a, uint256 b) public {\n        assertEqCall(\n            address(this),\n            abi.encodeCall(this.mulWAD, (a, b)),\n            abi.encodeCall(this.mulWADNative, (a, b))\n        );\n    }\n}\n```\n\nUsing the `ffi` (foreign function interface) cheat code we can also test Solidity code against non-Solidity implementations adding another safety layer.\n\n**Redundancy is key when aiming to create a robust testing suite**. Testing multiple properties through various strategies and techniques improves the confidence and soundness of the testing outcomes.\n\n## Offensive Testing\n\nSo far we have mostly been focusing on validating properties of our system as robustly as possible to strengthen behavioral guarantees. This could be termed as 'defensive testing', where expected behavior is solidified and validated. However, sometimes, the more revealing approach is the opposite––aiming to invalidate or disprove properties we suspect might not hold. This is what we could term as the 'offensive' side of testing.\n\n### Case Study: Primitive Finance - Hyper\n\nIn January 2023 Trail of Bits conducted a security review of 'Primitive Finance - Hyper AMM' (renamed to 'Portfolio'). The [report is publicly available](https://github.com/trailofbits/publications/blob/master/reviews/2023-03-primitive-securityreview.pdf) and Primitive has given permission to highlight the testing that was performed during our review of their system.\n\nAs an overview, a few notable characteristics of the system were:\n\n- CFMM (Constant Function Market Maker) protocol incorporating time-dependent curves, potentially enabling options trading.\n- Internal accounting system for pool balances along with a batch swapping functionality.\n- It heavily employs assembly language and intricate function approximations (gauss `pdf` and `ierfc`) in its dependency `solstat`. Additionally, it showcases inconsistent rounding behavior.\n\n### Initial Testing Strategy\n\nIn the early stages of the audit, a natural inclination was to employ fuzz testing. The hypothesis was simple: _Can one exploit inaccuracies in the pool's state (parameters, reserves, etc.) to achieve favorable swaps?_ The goal was to determine if repeated swaps could lead to value extraction.\n\nBelow is an excerpt from an initial test attempt:\n\n```js\nfunction test_swap(\n    bool sellAsset,\n    uint128 input,\n    uint128 tempOutput,\n    uint256 liquidity,\n    uint256 volatility,\n    uint256 duration,\n    uint128 stkPrice,\n    uint128 price\n) public {\n    // Alice create's an honest pool with liquidity.\n    createPoolAndAllocateLiquidity(alice, 100, 10, 2e18, 1e18, 1_000_000 * 1e18);\n\n    // Bob create's a malicious pool with liquidity.\n    createPoolAndAllocateLiquidity(bob, volatility, duration, stkPrice, price, liquidity);\n\n    // Bob tries to extract tokens by swapping back and forth.\n    uint128 targetValue = 1e18;\n\n    // Swap input X -\u003e tempOutput Y -\u003e output X.\n    bool success = swapBackAndForth(sellAsset, input, tempOutput, input + targetValue);\n    if (!success) return;\n\n    // Bob withdraws all of his assets.\n    withdrawAllAssets(bob);\n\n    int256 assetGain = int256(asset.balanceOf(bob)) - int256(INITIAL_BALANCE);\n    int256 quoteGain = int256(quote.balanceOf(bob)) - int256(INITIAL_BALANCE);\n\n    // Bob should gain tokens.\n    if (assetGain \u003c 0 || quoteGain \u003c 0) return;\n\n    // Log the balance gain.\n    console.log(\"Asset gain\", vm.toString(assetGain));\n    console.log(\"Quote gain\", vm.toString(quoteGain));\n\n    // Report the test case.\n    fail();\n}\n```\n\nThis initial approach led to repeated failures when setting up pools, allocating liquidity or when performing a swap.\n\n```js\nTraces:\n  [128911] self::test_swap(false, 0, 0, 0, 0, 0, 0, 0)\n    ├─ [0] VM::startPrank(alice: [0x00000000000000000000000000000000000A11cE])\n    │   └─ ← ()\n    ├─ [113457] HYPER::aa012c0c(5991a2df15a8f6a256d3ec51e99254cd3fb576a9f62849f9a0b5bf2913b396098f7c7019b51a820a)\n    │   ├─ emit CreatePair(pairId: 1, asset: ASSET: [0x5991A2dF15A8F6A256D3Ec51E99254Cd3fb576A9], quote: QUOTE: [0xF62849F9A0B5Bf2913b396098F7c7019b51A820a], decimalsAsset: 18, decimalsQuote: 18)\n    │   └─ ← ()\n    └─ ← \"UNDEFINED\"\n```\n\n```js\nTraces:\n  [306133] self::test_swap(false, 0, 0, 170141183460469231731687303715884105728 [1.701e38], 0, 0, 0, 0)\n    ├─ [0] VM::startPrank(alice: [0x00000000000000000000000000000000000A11cE])\n    │   └─ ← ()\n    ├─ [113457] HYPER::aa012c0c(5991a2df15a8f6a256d3ec51e99254cd3fb576a9f62849f9a0b5bf2913b396098f7c7019b51a820a)\n    │   ├─ emit CreatePair(pairId: 1, asset: ASSET: [0x5991A2dF15A8F6A256D3Ec51E99254Cd3fb576A9], quote: QUOTE: [0xF62849F9A0B5Bf2913b396098F7c7019b51A820a], decimalsAsset: 18, decimalsQuote: 18)\n    ...\n    ├─ [5912] HYPER::allocate(1103806595073 [1.103e12], 170141183460469231731687303715884105728 [1.701e38])\n    │   └─ ← \"EvmError: Revert\"\n    └─ ← \"EvmError: Revert\"\n```\n\nIn order to not spend too much time on a single thesis during the review, these reverting function calls were handled using `try ... catch`––simply discarding any error case. This way, the fuzzer could be allowed to continue to search for a combination of inputs that would invalidate the invariant while allowing us to continue the manual review of the code.\n\nThe fuzzer continued for nearly a week without presenting any exploit. **It would be easy, albeit premature, to interpret this as a sign of robustness against the hypothesized exploit.**\n\nIn order to make the fuzzer more effective at its task, it required further guidance when selecting the parameters increasing the amount of valid test cases. Ideally, **every single test run should produce valid parameters**. This is achieved by properly specifying the bounds on the parameters. However, **it's equally important not to discard any valid parameter combination**, as otherwise certain edge-cases which might be required for a successful exploit might be discarded.\n\nDefining tight bounds might require precisely reconstructing of the protocol's pre-conditions. Sometimes these conditions might be explicitly stated, and sometimes they might be complex to evaluate, and the bounds of one parameter can depend on another.\n\n```js\nfunction test_swap(/* ... */) public {\n    // Properly bound pool parameters.\n    duration = bound(duration, 1, 500);\n    volatility = bound(volatility, 100, 25_000);\n    stkPrice = uint128(bound((stkPrice), 1, type(uint128).max));\n    // Prevent lnWad's \"UNDEFINED\" when `price * 1e18 / stkPrice == 0`.\n    price = uint128(\n        bound(\n            uint256(price),\n            (Price.computePriceWithTick(Price.computeTickWithPrice(stkPrice) + 1) + 1e18 - 1) / 1e18,\n            type(uint128).max\n        )\n    );\n\n    // Alice create's a pool with liquidity.\n    // ...\n}\n```\n\n```js\nRunning 1 test for test/foundry/TestSwapPoc.t.sol:TestHyperSwapPoc\n[PASS] test_swap(bool,uint128,uint128,uint256,uint256,uint256,uint128,uint128) (runs: 10000, μ: 723780, ~: 794869)\nTest result: ok. 1 passed; 0 failed; 0 skipped; finished in 10.23s\n```\n\nAfter addressing all transaction reverts and properly bounding all parameters, all test runs should now complete.\n\nHowever, Bob has yet to make a profitable trade.\n\n### Refining the Testing Strategy\n\nA good way to test whether the test actually makes sense is by _testing it_. A well-written test should be able to immediately identify the case when an invariant is removed manually.\n\n```js\nliveInvariantWad = liveInvariantWad.scaleFromWadDownSigned(pool.pair.decimalsQuote); // invariant is denominated in quote token.\nnextInvariantWad = nextInvariantWad.scaleFromWadDownSigned(pool.pair.decimalsQuote);\nif (nextInvariantWad \u003c liveInvariantWad) revert InvalidInvariant(liveInvariantWad, nextInvariantWad);\n```\n\nThis code enforces the invariant in the protocol. Generally, an invariant like this should guarantee that, under no circumstances, there's a possibility of a profitable trade when swapping back and forth. However, as the protocol invariant was uses the newly computed price and pool balances––also derived from the price––doubts whether this invariant was truly enforcing the desired properties emerged.\n\nBy removing the invariant check above, we should immediately be able to see whether the fuzzer is capable of finding inputs that invalidate our swap test case. Once our setup is validated, we can go further and remove any swap fees while re-introducing the invariant. If a failing test case can be found without swap fees, this is already a big hint that there might be some rounding, overflow or precision loss issue in the protocol that could be exploited.\n\n**We test our hypothesis by first making the conditions as ideal as possible for an attacker and then trim the capabilities back down to pinpoint the exact conditions required for an exploit.**\n\nA significant discovery came after questioning further assumptions made in the test setup. The assumption that Bob must gain a profit on both tokens is unnecessarily strict. Usually, when swapping `X quote -\u003e Y asset -\u003e Z quote`, the amount of Asset tokens required should be zero. This is because the second swap's input is simply defined as the first swaps output `Y asset`.\n\nNormally, this would mean that we are not required to provide any Asset tokens. However, in this particular system, due to the rounding logic in the protocol, often a minimum of `1` (wei) Asset token is required in the process of swapping back and forth. The test could be adapted to allow for one token to be lost, or simply removing\n\n```js\n// Bob should gain tokens.\nif (assetGain \u003c -1 || quoteGain \u003c -1) return;\n```\n\nFurthermore, Hyper's batched instruction processing allowed to execute more efficient swaps.\n\n```js\nfunction swapBackAndForth(bool sellAsset, uint128 input, uint128 output1, uint128 output2)\n    internal\n    returns (bool success)\n{\n    // Encode batch instructions.\n    bytes[] memory instructions = new bytes[](2);\n\n    instructions[0] = ProcessingLib.encodeSwap(0, poolId, 0, input, 0, output1, sellAsset ? 0 : 1);\n    instructions[1] = ProcessingLib.encodeSwap(0, poolId, 0, output1, 0, output2, sellAsset ? 1 : 0);\n\n    bytes memory data = ProcessingLib.encodeJumpInstruction(instructions);\n\n    (success,) = address(hyper).call(data);\n}\n```\n\nA last discovery was made when it was observed that the exploit would only be possible if the attacker was **not** the pool controller. The original idea was that the pool controller would receive a favorable fee compared to the standard swap fee. However, since the pool controller's fee is charged in Ether independently of the Asset and Quote tokens (but dependent on the pool's liquidity) this created a scenario, where the exploit was not possible.\n\nThis highlighted the **significance of questioning assumptions in tests**. The Primitive Hyper swap case offers several insights that can be applied to offensive testing:\n\n1. **Establish Precise Variable Bounds**: Address potential reverts by ensuring that all variables are bounded correctly. Ensure that the number of discarded test cases remains at a minimum.\n2. **Augment Coverage Insight**: Introduce sanity checks to assess the feasibility of the test hypothesis. Considering testing the setup by removing the protocol invariant checks.\n3. **Challenge Every Assumption**: The audit revealed how certain assumptions, like the fixed priority fee required for the exploit, or the prerequisite of token approvals, can skew results and lead to premature conclusions.\n\nIn essence, offensive testing requires a dynamic and persistent approach. It's not just about confirming the robustness of a system but actively seeking potential cracks. Only by repeatedly challenging our understanding and assumptions can we hope to uncover hidden vulnerabilities.\n\n## Conclusions and Takeaways\n\n1. **Treat your tests as production code**\n   - Tests can also contain bugs.\n   - Risks: Faulty tests can lead to misleading outcomes, false confidence and mask bugs.\n2. **Understand limitations of testing and tooling**\n   - Recognize flawed or insignificant tests.\n   - Tests can only go so far in reproducing realistic scenarios.\n   - Tools can have biases or bugs, or might not be able to cover all significant input space.\n3. **Explore different testing strategies and techniques**\n   - Incorporate unit, fuzz, integration tests.\n   - Test multiple properties and different angles.\n   - Add redundancy.\n4. **Examine assumptions, preconditions, and conclusions of tests**\n   - Check for hidden assumptions or inaccurate preconditions: e.g. actors behaving differently in a realistic scenario, assuming well-formed inputs, e.g. sorted tokens, bytes data encoded correctly.\n   - Do tested properties hold for all significant cases?\n5. **Test your tests**\n   - Create meta-tests.\n   - Introduce deliberate bugs to see if tests detect them.\n   - Apply mutation testing.\n\nQuestions to be asking yourself when reviewing your tests:\n\n- How can we ensure that our tests are sufficiently covering critical parts of the code base?\n- How can we measure the efficacy and robustness of our tests?\n- What kind of guarantees does the passing of a test give and under what circumstances are these valid?\n\n## Extra Material: Additional Testing Shortcomings\n\nThis section contains additional scenarios highlighting shortcomings in testing that would have made the main article too lengthy.\n\n### Testing Helper Functions\n\nThinking back to the shortcomings of tests in the ERC721A improvement example, we saw that expressive fuzz tests were absent (e.g. allowing multiple ID transfers).The next example examines a quick and dirty workaround that aims to cover that case.\n\nIn retrospect, the ERC721A improvement case highlighted a significant shortfall: the absence of expressive fuzz tests, including the ability to transfer multiple IDs. The next example explores a quick and practical fuzz test to address this deficiency.\n\nWe'll make use of a testing helper library called `random`, which will be used to generate a new pseudo random `uint256` number when calling `random.next()`. The library is seeded by calling `random.seed()`.\n\n```js\nlibrary random {\n    bytes32 constant RANDOM_SEED_SLOT = keccak256(\"random.seed.slot\");\n\n    /// @notice Seed randomness.\n    function seed(uint256 randomSeed) internal {\n        assembly {\n            // Store random seed.\n            sstore(RANDOM_SEED_SLOT, randomSeed)\n        }\n    }\n\n    /// @notice Generates a next random number by hashing\n    ///         the current seed value stored in `RANDOM_SEED_SLOT`.\n    function next() internal returns (uint256 nextRandom) {\n        assembly {\n            // Load random seed from storage slot.\n            let r := sload(RANDOM_SEED_SLOT)\n            // Compute keccak256 hash of seed.\n            mstore(0, r)\n            nextRandom := keccak256(0, 0x20)\n            // Update random seed.\n            sstore(RANDOM_SEED_SLOT, r)\n        }\n    }\n}\n```\n\nUsing this library we can quickly implement a function that will test `10` token transfers for all `30` minted IDs.\n\n```js\ncontract TestRandom_DONT is Test {\n    uint256 constant NUM_TRANSFERS = 10;\n    uint256 constant NUM_IDS = 30;\n\n    function test_transfer(uint256 seed) public {\n        // Seed randomness.\n        random.seed(seed);\n\n        // Create token and mint to `address(this)`.\n        ERC721 token = new ERC721A(NUM_IDS);\n\n        // Set all local token ownerships to `address(this)`.\n        address[NUM_IDS] memory owners;\n        for (uint256 i; i \u003c NUM_IDS; i++) {\n            owners[i] = address(this);\n        }\n\n        for (uint256 i; i \u003c NUM_TRANSFERS; i++) {\n            // Select a random id `nextId` to\n            // transfer from `currOwner` to a randomly\n            // selected `nextOwner`.\n            uint256 nextId = random.next() % NUM_IDS;\n            address nextOwner = address(uint160(random.next()));\n            address currOwner = owners[nextId];\n\n            // Transfer `nextId` from `currOwner` to `nextOwner`.\n            vm.prank(currOwner);\n            token.transferFrom(currOwner, nextOwner, nextId);\n\n            // Update local ownership data.\n            owners[nextId] = nextOwner;\n        }\n\n        // Validate final token ownerships.\n        for (uint256 i; i \u003c NUM_IDS; i++) {\n            assertEq(owners[i], token.ownerOf(i));\n        }\n    }\n}\n```\n\nThrough analyzing this code, we can start out by highlighting some _hidden assumptions contained in this test that might not reflect real world conditions_ and are limitations of the setup:\n\n1. All `30` tokens are minted in a single batch to a single owner.\n   1. There are no successive mints to multiple (or the same) owners.\n   2. There is no mint of variable size (e.g. `0`, `1`, ...).\n   3. There is no further mint after IDs have been transferred.\n2. The `nextId` is selected uniformly (low edge-case probability).\n   1. Selecting previous `ID` or `ID + 1` is low.\n   2. Selecting `ID = 0` or `ID = 30` is low.\n3. The `nextOwner` is selected uniformly.\n   1. The probability that the same or a previous owner is selected is negligible.\n   2. The probability that the zero address is selected is negligible.\n\nDespite all these shortcomings and biases, this fuzz test should still be able to catch the missing edge case related to the ownership bug in the ERC721A implementation from earlier. However, it won't _ever_ be able to find it. This test will pass no matter what random IDs and owners will be drawn. In fact, this test might pass for entirely degenerate ERC721A implementations as well..\n\n_What is wrong with the given test setup and what steps would you employ to improve the security guarantees?_\n\n\u003cdetails\u003e\n\u003csummary\u003e\u003cb\u003eSpot the issue above! [spoiler]\u003c/b\u003e\u003cbr\u003e\u003cbr\u003e\u003c/summary\u003e\n\nThe issue here is that the random seed is not updated to the new value. The old previous seed is simply stored again.\n\n```diff\n            let r := sload(RANDOM_SEED_SLOT)\n            // Compute keccak256 hash of seed.\n            mstore(0, r)\n            nextRandom := keccak256(0, 0x20)\n            // Update random seed.\n-           sstore(RANDOM_SEED_SLOT, r)\n+           sstore(RANDOM_SEED_SLOT, nextRandom)\n```\n\nThis results in poor randomness. This library always returns the same random value, the same `nextTokenId` and the same `nextOwner`!\n\n_How could the mistake in the helper function have been discovered?_\n\nThe helper function is being used without any guarantees whatsoever. We require minimal tests for our helper functions to ensure that every test being built on top of it is working reliably.\n\n```js\ncontract TestRandom_DO is Test {\n    uint256 constant NUM = 30;\n\n    /// Test seeding the `random` library.\n    function test_seed(uint256 seed1, uint256 seed2) public {\n        // Require the seeds to differ.\n        vm.assume(seed1 != seed2);\n\n        // Store the first `NUM` random numbers\n        // produced by the first seed.\n        uint256[NUM] memory randomNumbers;\n\n        random.seed(seed1);\n\n        for (uint256 i; i \u003c NUM; i++) {\n            randomNumbers[i] = random.next();\n        }\n\n        // Assert the random numbers produced\n        // by the second seed differ.\n        random.seed(seed2);\n\n        for (uint256 i; i \u003c NUM; i++) {\n            assertTrue(randomNumbers[i] != random.next());\n        }\n\n        // Assert that resetting to the old\n        // seed produces the same random sequence.\n        random.seed(seed1);\n\n        for (uint256 i; i \u003c NUM; i++) {\n            assertEq(randomNumbers[i], random.next());\n        }\n    }\n\n    /// @notice Marks a random number as seen.\n    mapping(uint256 =\u003e bool) randomNumberSeen;\n\n    /// Test the random numbers returned by the library do not repeat.\n    function test_next(uint256 seed) public {\n        random.seed(seed);\n\n        for (uint256 i; i \u003c NUM; i++) {\n            uint256 r = random.next();\n\n            // The probability of r ∈ [0, 100_000]\n            // should be negligible.\n            assertTrue(r \u003e 100_000);\n            // The random number should be unseen.\n            assertEq(randomNumberSeen[r], false);\n            // Mark number as seen.\n            randomNumberSeen[r] = true;\n        }\n    }\n}\n```\n\nTesting the `random` library's `seed` and `next` functions in a couple fuzz tests would have detected the issue related to the bad randomness.\n\nThat's why it's important to **test your helper functions** as well. Building a robust structure of tests requires a solid foundation. _There is no cake without a base!_\n\n\u003c/details\u003e\n\n### Tool Quirks\n\nLet's revisit the notion that it's important to understand how to use your tool, its biases and quirks. Below is a function `MerkleLib.zeros` that returns pre-computed roots for empty subtrees of a given depth. These have been computed beforehand and are being validated and fixed through a unit test that checks all values.\n\n```js\nuint256 constant DEPTH = 4;\n\nlibrary MerkleLib {\n    error InvalidZerosLevel();\n\n    /// @notice Returns pre-computed zero sub-tree root of depth `level`.\n    ///         Each sub-tree root is computed by:\n    ///             root(0) := keccak256(enc(0, 0))\n    ///             root(N) := keccak256(enc(root(N-1), root(N-1)))\n    function zeros(uint256 level) internal pure returns (bytes32) {\n        if (level == 0) return 0x2098f5fb9e239eab3ceac3f27b81e481dc3124d55ffed523a839ee8446b64864;\n        if (level == 1) return 0x1069673dcdb12263df301a6ff584a7ec261a44cb9dc68df067a4774460b1f1e1;\n        if (level == 2) return 0x18f43331537ee2af2e3d758d50f72106467c6eea50371dd528d57eb2b856d238;\n        if (level == 3) return 0x07f9d837cb17b0d36320ffe93ba52345f1b728571a568265caac97559dbc952a;\n        if (level == 4) return 0x2b94cf5e8746b3f5c9631f4c5df32907a699c58c94b2ad4d7b5cec1639183f55;\n        revert InvalidZerosLevel();\n    }\n}\n\ncontract TestMerkle_DONT is Test {\n    /// Test `MerkleLib.zeros` returns correct hash values.\n    function test_zeros() public {\n        bytes32 node;\n\n        for (uint256 i; i \u003c DEPTH + 1; i++) {\n            node = keccak256(abi.encode(node, node));\n\n            assertEq(MerkleLib.zeros(i), node);\n        }\n\n        // Calling `MerkleLib.zeros(DEPTH + 1)` should revert.\n        vm.expectRevert(MerkleLib.InvalidZerosLevel.selector);\n        MerkleLib.zeros(DEPTH + 1);\n    }\n}\n```\n\nThe test `test_zeros` passes the unit test.\n\n```js\nRunning 1 test for test/TestMerkle.sol:TestMerkle_DONT\n[PASS] test_zeros() (gas: 46756)\nTest result: ok. 1 passed; 0 failed; 0 skipped; finished in 337.54µs\n```\n\n_What is wrong here?_\n\nIf you recall some of the advice previously given, then you might be able to rewrite the test in a safer way and spot the issue.\n\n\u003cdetails\u003e\n\u003csummary\u003e\u003cb\u003eSpot the issue above! [spoiler]\u003c/b\u003e\u003cbr\u003e\u003cbr\u003e\u003c/summary\u003e\n\nOnce we split up our test based on the expected outcomes (passing, reverting), we immediately see the issue at hand.\n\n```js\ncontract TestMerkle_DO is Test {\n    /// Test `MerkleLib.zeros` returns correct hash values.\n    function test_zeros() public {\n        bytes32 node;\n\n        for (uint256 i; i \u003c DEPTH + 1; i++) {\n            node = keccak256(abi.encode(node, node));\n\n            assertEq(MerkleLib.zeros(i), node);\n        }\n    }\n\n    /// Calling `MerkleLib.zeros(DEPTH + 1)` should revert.\n    function test_zeros_revert_InvalidZerosLevel() public {\n        vm.expectRevert(MerkleLib.InvalidZerosLevel.selector);\n        MerkleLib.zeros(DEPTH + 1);\n    }\n}\n```\n\nThis produces the following output.\n\n```js\nRunning 2 tests for test/TestMerkle.sol:TestMerkle_DO\n[FAIL. Reason: Assertion failed.] test_zeros() (gas: 46138)\n[PASS] test_zeros_revert_InvalidZerosLevel() (gas: 3252)\nTest result: FAILED. 1 passed; 1 failed; 0 skipped; finished in 397.04µs\n\nRan 2 test suites: 2 tests passed, 1 failed, 0 skipped (3 total tests)\n```\n\nWe now see that the first part of the test was actually failing. All the pre-computed hashes have been calculated using the Poseidon hash instead of `keccak256` resulting in incorrect values.\n\n_Why does the test pass nonetheless?_\n\nThe reason the single test passes nonetheless when testing both things at once is due to a [quirk in Foundry](https://github.com/foundry-rs/foundry/issues/4832) related to using `vm.expectRevert` on internal functions. Failing `assert` statements are ignored if a revert is caught on an internal function.\n\n\u003c/details\u003e\n\nRemember the advice from earlier that **a test should only be testing one thing** at a time. Again, this also makes the testing structure clearer and simpler.\n","title":"Test Your Tests!","date":"Oct 20, 2023","excerpt":"Writeup of the talks given at TrustX \u0026 Solidity Summit at Devconnect in Istanbul.","suptitle":"The Dos and Don'ts of testing"}},"__N_SSG":true},"page":"/[...slug]","query":{"slug":["blog","2023","test-your-tests"]},"buildId":"Ob_ZNrHzPQ-bg8j1Qlw7q","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>
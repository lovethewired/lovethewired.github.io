<!DOCTYPE html><html><head><meta charSet="utf-8"/><title class="animate__fadeIn">0xPhaze</title><meta name="viewport" content="initial-scale=1.0, width=device-width"/><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/fcf81e63369216ac.css" as="style"/><link rel="stylesheet" href="/_next/static/css/fcf81e63369216ac.css" data-n-g=""/><link rel="preload" href="/_next/static/css/65875c30e26bdd78.css" as="style"/><link rel="stylesheet" href="/_next/static/css/65875c30e26bdd78.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-ede13cf31a63337e.js" defer=""></script><script src="/_next/static/chunks/framework-bb5c596eafb42b22.js" defer=""></script><script src="/_next/static/chunks/main-914fbfab4f90b52f.js" defer=""></script><script src="/_next/static/chunks/pages/_app-ad82082731d58181.js" defer=""></script><script src="/_next/static/chunks/175675d1-5e59763be147fa1f.js" defer=""></script><script src="/_next/static/chunks/634-958ce5c52c8283ef.js" defer=""></script><script src="/_next/static/chunks/pages/%5B...slug%5D-1036fd4ff48bafcd.js" defer=""></script><script src="/_next/static/vfs54WcrIK7AZ-vGBfUCo/_buildManifest.js" defer=""></script><script src="/_next/static/vfs54WcrIK7AZ-vGBfUCo/_ssgManifest.js" defer=""></script><script src="/_next/static/vfs54WcrIK7AZ-vGBfUCo/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="app px-4 pb-20 min-h-screen flex flex-col items-center w-full max-w-screen"><header class="w-full flex flex-col px-4 sm:px-8 md:px-12 max-w-5xl sm:flex-row justify-between items-center border-white/20 overflow-hidden border-b p-4 h-16"><div class="w-full h-full flex flex-col sm:flex-row justify-start sm:justify-between items-center gap-y-4 overflow-hidden sm:overflow-visible"><div class="flex w-full sm:w-fit items-center"><h1 class="text-xl mx-auto font-display"><a href="/">0xPhaze</a></h1><div class="my-auto -ml-6 w-6 sm:hidden"><div class="text-slate-300 hover:text-secondary-400 transition-colors duration-200 cursor-pointer h-6"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="bars" class="svg-inline--fa fa-bars " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416C433.7 64 448 78.33 448 96C448 113.7 433.7 128 416 128H32C14.33 128 0 113.7 0 96zM0 256C0 238.3 14.33 224 32 224H416C433.7 224 448 238.3 448 256C448 273.7 433.7 288 416 288H32C14.33 288 0 273.7 0 256zM416 448H32C14.33 448 0 433.7 0 416C0 398.3 14.33 384 32 384H416C433.7 384 448 398.3 448 416C448 433.7 433.7 448 416 448z"></path></svg></div></div></div><div class="flex flex-col sm:flex-row gap-x-8 md:gap-x-10 gap-y-4"><div class="flex gap-x-2 sm:gap-x-5 items-center justify-evenly"><a target="_blank" rel="noreferrer" class="link" href="https://github.com/0xPhaze/"><div><div class="text-slate-300 hover:text-secondary-400 transition-colors duration-200 cursor-pointer"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-4"><path style="fill:currentColor" d="M12 0C5.374 0 0 5.373 0 12c0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23A11.509 11.509 0 0 1 12 5.803c1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.3 24 12c0-6.627-5.373-12-12-12z"></path></svg></div></div></a><a target="_blank" rel="noreferrer" class="link" href="https://twitter.com/lovethewired"><div><div class="text-slate-300 hover:text-secondary-400 transition-colors duration-200 cursor-pointer"><svg viewBox="0 0 16 14" fill="none" xmlns="http://www.w3.org/2000/svg" class="h-4"><path style="fill:currentColor" d="M15.584 1.578a7.91 7.91 0 0 1-1.57 1.807v.482c0 .965-.112 1.929-.336 2.772-.224.965-.673 1.808-1.121 2.652a17.373 17.373 0 0 1-1.794 2.29c-.785.723-1.681 1.205-2.578 1.566-1.01.362-2.13.603-3.252.603-1.793 0-3.475-.603-4.932-1.567h.784c1.458 0 2.915-.482 4.036-1.446a2.914 2.914 0 0 1-1.905-.723c-.561-.482-.897-.964-1.122-1.687h.561c.336 0 .56 0 .897-.12C2.579 8.085 1.907 7.603 1.458 7 .785 6.398.561 5.675.561 4.83c.449.242 1.01.362 1.458.483A5.531 5.531 0 0 1 .898 4.109C.673 3.626.449 3.024.449 2.42c0-.602.112-1.205.449-1.687a8.606 8.606 0 0 0 2.914 2.53c1.122.603 2.355.965 3.7 1.086 0-.241-.112-.483-.112-.844 0-.723.224-1.326.56-1.928.337-.603.897-.965 1.458-1.326.56-.241 1.233-.362 1.906-.12.672.12 1.233.481 1.681.964.673-.121 1.458-.362 2.018-.844-.224.844-.784 1.446-1.457 1.928.785-.12 1.457-.24 2.018-.602Z" fill="#081026"></path></svg></div></div></a><div><div class="text-slate-300 hover:text-secondary-400 transition-colors duration-200 cursor-pointer">ABI</div></div><div><div class="text-slate-300 hover:text-secondary-400 transition-colors duration-200 cursor-pointer">ENC</div></div></div><button class="rounded px-4 py-2 uppercase text-white select-none  transition-all duration-300 disabled:pointer-events-none bg-primary-600 hover:bg-primary-700  !outline-none normal-case text-sm w-[140px] w-36">Connect Wallet</button></div></div></header><main class="gap-y-20 mt-8 py-4 sm:px-8 md:px-12 w-full min-h-[500px] max-w-4xl"><div class="flex flex-col justify-between gap-y-20"><div class="content markdown"><h1 class="text-center">Test Your Tests!</h1><h2 class="text-center">The Dos and Don&#x27;ts of testing</h2><p class="text-slate-500 text-sm text-center">Oct 20, 2023</p><div class="mt-16"><blockquote>
<p>This is a writeup of the talks given at <a target="_blank" rel="noreferrer" class="link" href="https://www.secureum.xyz/trustx/">TrustX</a> and <a target="_blank" rel="noreferrer" class="link" href="https://soliditylang.org/summit/">Solidity Summit</a> at <a target="_blank" rel="noreferrer" class="link" href="https://devconnect.org/">Devconnect Istanbul 2023</a>.</p>
</blockquote>
<p>In the rapidly evolving landscape of software development, the importance of rigorous testing cannot be overstated, especially when dealing with system-critical applications like blockchains. The reliability of tests are fundamental to ensuring the integrity and security of the applications they support. But, how do we evaluate the quality and efficacy of our tests?</p>
<h3 id="key-insights"><a href="/blog/2023/test-your-tests#key-insights"><span class="icon icon-link"></span></a>Key Insights:</h3>
<ol>
<li>
<p><strong>Treat Tests with the Same Rigor as Production Code</strong>: Treat your unit, fuzz, and integration tests with the same seriousness as your main application code. Given that tests can also harbor bugs, their detailed assessment is crucial. A flawed test may not just yield incorrect outcomes but could also create a deceptive sense of security.</p>
</li>
<li>
<p><strong>Critically Examine the Assumptions, Preconditions, and Conclusions in Tests</strong>:</p>
<ul>
<li>Re-evaluate your preconditions. Are they backed by concrete examples?</li>
<li>Review your test conclusions. Are there hidden assumptions that might skew the outcomes?</li>
</ul>
</li>
<li>
<p><strong>Incorporate &#x27;Meta-Tests&#x27;</strong>:</p>
<ul>
<li>Design tests to evaluate your primary tests.</li>
<li>Examine specific edge cases with dedicated unit tests.</li>
<li>Introduce intentional bugs to see if your tests spot them.</li>
<li>Use mutation testing to check the resilience of your tests.</li>
</ul>
</li>
<li>
<p><strong>Understand the Limitations of Testing Tools</strong>: While testing tools enhance our testing abilities, they have their limitations. These tools can contain inherent biases, idiosyncrasies, or bugs. Not fully grasping their capabilities or misapplying them might distort test results.</p>
</li>
</ol>
<h3 id="the-role-of-robust-testing"><a href="/blog/2023/test-your-tests#the-role-of-robust-testing"><span class="icon icon-link"></span></a>The Role of Robust Testing</h3>
<p>Tests act as the protective layer for code functionality. A well-crafted designed test solidifies the anticipated code behavior, safeguarding it against unexpected issues that might arise from future modifications.
Even though various testing methods and static analysis can vouch for your code&#x27;s stability, no test is infallible. Constant attention and improvement in testing methods are essential for ensuring software robustness.</p>
<h3 id="motivation-behind-the-topic"><a href="/blog/2023/test-your-tests#motivation-behind-the-topic"><span class="icon icon-link"></span></a>Motivation Behind the Topic</h3>
<p>This topic&#x27;s inspiration stems from my own experiences and reflections on past shortcomings. Each identified vulnerability prompted a re-evaluation—-how could both the development and testing phases be enhanced to avert similar challenges in the future?</p>
<h3 id="exemplary-case-the-wad-conversion"><a href="/blog/2023/test-your-tests#exemplary-case-the-wad-conversion"><span class="icon icon-link"></span></a>Exemplary Case: The WAD Conversion</h3>
<p>To shed light on the concepts discussed, consider a simple exercise of writing a fuzz test for WAD unit conversions.</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span>uint256 constant </span><span class="token constant">WAD</span><span> </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#a77afe">1e18</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span></span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">fromWAD</span><span class="token" style="color:#bebec5">(</span><span class="token parameter">uint256 a</span><span class="token" style="color:#bebec5">)</span><span> pure </span><span class="token function">returns</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token parameter">uint256 c</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>    c </span><span class="token" style="color:#a77afe">=</span><span> a </span><span class="token" style="color:#a77afe">/</span><span> </span><span class="token constant">WAD</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span>
</span><span><span></span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">toWAD</span><span class="token" style="color:#bebec5">(</span><span class="token parameter">uint256 a</span><span class="token" style="color:#bebec5">)</span><span> pure </span><span class="token function">returns</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token parameter">uint256 c</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>    c </span><span class="token" style="color:#a77afe">=</span><span> a </span><span class="token" style="color:#a77afe">*</span><span> </span><span class="token constant">WAD</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span>
</span><span><span>contract </span><span class="token maybe-class-name">TestFromWAD_DONT</span><span> is </span><span class="token maybe-class-name">Test</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">test_toWAD_fromWAD</span><span class="token" style="color:#bebec5">(</span><span class="token parameter">uint256 a</span><span class="token" style="color:#bebec5">)</span><span> external </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        </span><span class="token control-flow" style="color:#ef3b7d">if</span><span> </span><span class="token" style="color:#bebec5">(</span><span>a </span><span class="token" style="color:#a77afe">&gt;=</span><span> </span><span class="token function">type</span><span class="token" style="color:#bebec5">(</span><span>uint256</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">max</span><span> </span><span class="token" style="color:#a77afe">/</span><span> </span><span class="token constant">WAD</span><span class="token" style="color:#bebec5">)</span><span> vm</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">expectRevert</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        </span><span class="token function">assertEq</span><span class="token" style="color:#bebec5">(</span><span class="token function">fromWAD</span><span class="token" style="color:#bebec5">(</span><span class="token function">toWAD</span><span class="token" style="color:#bebec5">(</span><span>a</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">,</span><span> a</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<p>While the above test passed numerous fuzzing iterations, a closer examination reveals an oversight in the boundary check. Specifically, the conversion should not revert for <code>a = type(uint256).max / WAD</code>. From the fuzzer&#x27;s perspective, this value might appear as any other in the space of all possible <code>uint256</code> inputs. This inaccuracy exemplifies how an unclear precondition can not only obfuscate the true functionality but, in more severe scenarios, also mask vulnerabilities.</p>
<p>An improved version of the test could be structured as:</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span>contract </span><span class="token maybe-class-name">TestFromWAD_DO</span><span> is </span><span class="token maybe-class-name">Test</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>    </span><span class="token" style="color:#6f705e">/// Testing for values where `toWAD(a)` shouldn&#x27;t revert.</span><span>
</span></span><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">test_toWAD_fromWAD</span><span class="token" style="color:#bebec5">(</span><span class="token parameter">uint256 a</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">public</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        a </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">bound</span><span class="token" style="color:#bebec5">(</span><span>a</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token function">type</span><span class="token" style="color:#bebec5">(</span><span>uint256</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">max</span><span> </span><span class="token" style="color:#a77afe">/</span><span> </span><span class="token constant">WAD</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        </span><span class="token function">assertEq</span><span class="token" style="color:#bebec5">(</span><span class="token function">fromWAD</span><span class="token" style="color:#bebec5">(</span><span class="token function">toWAD</span><span class="token" style="color:#bebec5">(</span><span>a</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">,</span><span> a</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#6f705e">/// Testing for values where `toWAD(a)` should revert.</span><span>
</span></span><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">test_toWAD_fromWAD_revert_Panic</span><span class="token" style="color:#bebec5">(</span><span class="token parameter">uint256 a</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">public</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        a </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">bound</span><span class="token" style="color:#bebec5">(</span><span>a</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token function">type</span><span class="token" style="color:#bebec5">(</span><span>uint256</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">max</span><span> </span><span class="token" style="color:#a77afe">/</span><span> </span><span class="token constant">WAD</span><span> </span><span class="token" style="color:#a77afe">+</span><span> </span><span class="token" style="color:#a77afe">1</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token function">type</span><span class="token" style="color:#bebec5">(</span><span>uint256</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">max</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        vm</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">expectRevert</span><span class="token" style="color:#bebec5">(</span><span>abi</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">encodeWithSignature</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#e6d06c">&quot;Panic(uint256)&quot;</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#a77afe">0x11</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        </span><span class="token function">assertEq</span><span class="token" style="color:#bebec5">(</span><span class="token function">fromWAD</span><span class="token" style="color:#bebec5">(</span><span class="token function">toWAD</span><span class="token" style="color:#bebec5">(</span><span>a</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">,</span><span> a</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi><mi>i</mi><mi>n</mi><mi>t</mi><mn>256</mn><mtext> domain</mtext></mrow><annotation encoding="application/x-tex">uint256 \text{ domain}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal">u</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord">256</span><span class="mord text"><span class="mord"> domain</span></span></span></span></span></span></p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi><mover><mo><mtext>├</mtext><mi><munder><mo><mtext>─</mtext></mo><mn>0</mn></munder></mi><mtext>────────────</mtext><mi><munder><mo><mtext>─</mtext></mo><mrow><mspace width="-1em"><mfrac><mrow><mi>M</mi><mi>A</mi><mi>X</mi></mrow><mrow><mi>W</mi><mi>A</mi><mi>D</mi></mrow></mfrac></mspace></mrow></munder></mi><mtext>┤</mtext></mo><mpadded voffset="2pt"><mstyle scriptlevel="0" displaystyle="false"><mstyle mathcolor="green"><mtext> passing</mtext></mstyle></mstyle></mpadded></mover></mi><mi><mover><mo><mtext>├────</mtext><mi><munder><mo><mtext>─</mtext></mo><mrow><mspace width="-3.5em"><mfrac><mrow><mi>M</mi><mi>A</mi><mi>X</mi></mrow><mrow><mi>W</mi><mi>A</mi><mi>D</mi></mrow></mfrac><mo>+</mo><mn>1</mn></mspace></mrow></munder></mi><mtext>──────</mtext><mi><munder><mo><mtext>───</mtext></mo><mrow><mspace width="-0.4em"><mi>M</mi><mi>A</mi><mi>X</mi></mspace></mrow></munder></mi><mtext>┤</mtext></mo><mpadded voffset="2pt"><mstyle scriptlevel="0" displaystyle="false"><mstyle mathcolor="red"><mtext>reverting</mtext></mstyle></mstyle></mpadded></mover></mi></mrow><annotation encoding="application/x-tex">\overset{\raisebox{2pt}{\color{green} passing}}{
    ├\underset{0}{─}────────────\underset{\hskip -1em \frac {MAX} {WAD}}{─}┤
}
\overset{\raisebox{2pt} {\color{red}reverting}}{
    ├────\underset{\hskip -3.5em \frac {MAX} {WAD} + 1}───────\underset{\hskip -0.4 em MAX }{───}┤
}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.2851em;vertical-align:-1.1173em"></span><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1679em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span><span class="mop"><span class="mord">├</span><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0em"><span style="top:-2.3829em;margin-left:0em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span><span class="mop">─</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7171em"><span></span></span></span></span></span></span><span class="mord">────────────</span><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0em"><span style="top:-2.2235em;margin-left:0em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mspace mtight" style="margin-right:-1.4286em"></span><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8721em"><span style="top:-2.656em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em">W</span><span class="mord mathnormal mtight">A</span><span class="mord mathnormal mtight" style="margin-right:0.02778em">D</span></span></span></span><span style="top:-3.2255em"><span class="pstrut" style="height:3em"></span><span class="frac-line mtight" style="border-bottom-width:0.049em"></span></span><span style="top:-3.384em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em">M</span><span class="mord mathnormal mtight">A</span><span class="mord mathnormal mtight" style="margin-right:0.07847em">X</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span></span></span></span><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span><span class="mop">─</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.1173em"><span></span></span></span></span></span></span><span class="mord">┤</span></span></span></span><span style="top:-3.2em;margin-left:0em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.2398em"><span style="top:-3.2857em"><span class="pstrut" style="height:3em"></span><span class="mord sizing reset-size3 size6"><span class="mord" style="color:green"> passing</span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.1173em"><span></span></span></span></span></span></span><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1679em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span><span class="mop"><span class="mord">├────</span><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0em"><span style="top:-2.2235em;margin-left:0em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mspace mtight" style="margin-right:-5em"></span><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8721em"><span style="top:-2.656em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em">W</span><span class="mord mathnormal mtight">A</span><span class="mord mathnormal mtight" style="margin-right:0.02778em">D</span></span></span></span><span style="top:-3.2255em"><span class="pstrut" style="height:3em"></span><span class="frac-line mtight" style="border-bottom-width:0.049em"></span></span><span style="top:-3.384em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em">M</span><span class="mord mathnormal mtight">A</span><span class="mord mathnormal mtight" style="margin-right:0.07847em">X</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span><span class="mop">─</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.1173em"><span></span></span></span></span></span></span><span class="mord">──────</span><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0em"><span style="top:-2.3557em;margin-left:0em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mspace mtight" style="margin-right:-0.5714em"></span><span class="mord mathnormal mtight" style="margin-right:0.10903em">M</span><span class="mord mathnormal mtight">A</span><span class="mord mathnormal mtight" style="margin-right:0.07847em">X</span></span></span></span><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span><span class="mop">───</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7443em"><span></span></span></span></span></span></span><span class="mord">┤</span></span></span></span><span style="top:-3.2em;margin-left:0em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.2398em"><span style="top:-3.2857em"><span class="pstrut" style="height:3em"></span><span class="mord sizing reset-size3 size6"><span class="mord" style="color:red">reverting</span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.1173em"><span></span></span></span></span></span></span></span></span></span></span></div>
<p>By dividing tests based on expected results (success or failure), our testing approach becomes clearer and ensures both situations are sufficiently tested. Using Foundry&#x27;s <code>bound</code> function aids in testing near boundary conditions. Also, testing for a specific error (<code>Panic(0x11)</code>) can identify unintentional coding errors.</p>
<p>As a further improvement, one could segregate the calls <code>fromWAD(toWAD(a))</code> to pinpoint exactly where an error might occur. This would require the calls to be made externally.</p>
<p>It&#x27;s worth noting, however, that the tests alone don&#x27;t offer a clear picture of the actual behavior of the <code>toWAD</code> and <code>fromWAD</code> functions. Multiple functions can satisfy the constraints set by the tests, as illustrated below:</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">fromWAD</span><span class="token" style="color:#bebec5">(</span><span class="token parameter">uint256 a</span><span class="token" style="color:#bebec5">)</span><span> pure </span><span class="token function">returns</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token parameter">uint256 c</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>    c </span><span class="token" style="color:#a77afe">=</span><span> a </span><span class="token" style="color:#a77afe">+</span><span> </span><span class="token" style="color:#a77afe">1234</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span>
</span><span><span></span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">toWAD</span><span class="token" style="color:#bebec5">(</span><span class="token parameter">uint256 a</span><span class="token" style="color:#bebec5">)</span><span> pure </span><span class="token function">returns</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token parameter">uint256 c</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>    </span><span class="token control-flow" style="color:#ef3b7d">if</span><span> </span><span class="token" style="color:#bebec5">(</span><span>a </span><span class="token" style="color:#a77afe">&gt;</span><span> </span><span class="token function">type</span><span class="token" style="color:#bebec5">(</span><span>uint256</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">max</span><span> </span><span class="token" style="color:#a77afe">/</span><span> </span><span class="token constant">WAD</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token function">revert</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    c </span><span class="token" style="color:#a77afe">=</span><span> a </span><span class="token" style="color:#a77afe">-</span><span> </span><span class="token" style="color:#a77afe">1234</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<h3 id="exemplary-case-mul-wad"><a href="/blog/2023/test-your-tests#exemplary-case-mul-wad"><span class="icon icon-link"></span></a>Exemplary Case: Mul WAD</h3>
<p>We just saw the case where our test had a wrong precondition compared to our implementation. What if, however, our test reflected an incorrect precondition contained in the implementation itself?</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span>contract </span><span class="token maybe-class-name">TestMulWAD_DONT</span><span> is </span><span class="token maybe-class-name">Test</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">mulWAD</span><span class="token" style="color:#bebec5">(</span><span class="token parameter">uint256 a</span><span class="token parameter" style="color:#bebec5">,</span><span class="token parameter"> uint256 b</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">public</span><span> pure </span><span class="token function">returns</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token parameter">uint256 c</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        unchecked </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>            </span><span class="token control-flow" style="color:#ef3b7d">if</span><span> </span><span class="token" style="color:#bebec5">(</span><span>b </span><span class="token" style="color:#a77afe">==</span><span> </span><span class="token" style="color:#a77afe">0</span><span> </span><span class="token" style="color:#a77afe">||</span><span> a </span><span class="token" style="color:#a77afe">&gt;</span><span> </span><span class="token function">type</span><span class="token" style="color:#bebec5">(</span><span>uint256</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">max</span><span> </span><span class="token" style="color:#a77afe">/</span><span> b</span><span class="token" style="color:#bebec5">)</span><span> revert </span><span class="token function maybe-class-name">Overflow</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>            c </span><span class="token" style="color:#a77afe">=</span><span> a </span><span class="token" style="color:#a77afe">*</span><span> b </span><span class="token" style="color:#a77afe">/</span><span> </span><span class="token constant">WAD</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">test_mulWAD</span><span class="token" style="color:#bebec5">(</span><span class="token parameter">uint256 a</span><span class="token parameter" style="color:#bebec5">,</span><span class="token parameter"> uint256 b</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">public</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        </span><span class="token control-flow" style="color:#ef3b7d">if</span><span> </span><span class="token" style="color:#bebec5">(</span><span>b </span><span class="token" style="color:#a77afe">==</span><span> </span><span class="token" style="color:#a77afe">0</span><span> </span><span class="token" style="color:#a77afe">||</span><span> a </span><span class="token" style="color:#a77afe">&gt;</span><span> </span><span class="token function">type</span><span class="token" style="color:#bebec5">(</span><span>uint256</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">max</span><span> </span><span class="token" style="color:#a77afe">/</span><span> b</span><span class="token" style="color:#bebec5">)</span><span> vm</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">expectRevert</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        uint256 c </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">mulWAD</span><span class="token" style="color:#bebec5">(</span><span>a</span><span class="token" style="color:#bebec5">,</span><span> b</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        </span><span class="token function">assertEq</span><span class="token" style="color:#bebec5">(</span><span>c</span><span class="token" style="color:#bebec5">,</span><span> a </span><span class="token" style="color:#a77afe">*</span><span> b </span><span class="token" style="color:#a77afe">/</span><span> </span><span class="token constant">WAD</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<p>This example implementation of <code>mulWAD</code> is using <code>unchecked</code> arithmetic for optimization purposes. In doing so, we have manually included a flawed check that will revert the execution when an overflow occurs. This flawed check is now mirrored in the test and cannot be detected by a fuzzer. How would we have been able to detect the error in this case?</p>
<p>In the case that we have a reference implementation at hand, we can use differential fuzz testing.</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">mulWADNative</span><span class="token" style="color:#bebec5">(</span><span class="token parameter">uint256 a</span><span class="token parameter" style="color:#bebec5">,</span><span class="token parameter"> uint256 b</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">public</span><span> pure </span><span class="token function">returns</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token parameter">uint256 c</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        c </span><span class="token" style="color:#a77afe">=</span><span> a </span><span class="token" style="color:#a77afe">*</span><span> b </span><span class="token" style="color:#a77afe">/</span><span> </span><span class="token constant">WAD</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">test_mulWAD_differential</span><span class="token" style="color:#bebec5">(</span><span class="token parameter">uint256 a</span><span class="token parameter" style="color:#bebec5">,</span><span class="token parameter"> uint256 b</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">public</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        </span><span class="token function">assertEqCall</span><span class="token" style="color:#bebec5">(</span><span>
</span></span><span><span>            </span><span class="token function">address</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#ef3b7d">this</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">,</span><span>
</span></span><span><span>            abi</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">encodeCall</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#ef3b7d">this</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">mulWAD</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#bebec5">(</span><span>a</span><span class="token" style="color:#bebec5">,</span><span> b</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">,</span><span>
</span></span><span><span>            abi</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">encodeCall</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#ef3b7d">this</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">mulWADNative</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#bebec5">(</span><span>a</span><span class="token" style="color:#bebec5">,</span><span> b</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span>        </span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<p>Using the <code>ffi</code> cheat code we can also test against non Solidity implementations.</p>
<p><strong>Takeaway:</strong></p>
<ul>
<li>Don&#x27;t blindly copy preconditions (or code) from your implementations when testing</li>
<li>Re-implement code logic and use <strong>differential testing</strong> when possible</li>
</ul>
<h2 id="ensuring-the-efficacy-of-testing-the-case-of-primitive-finance-hyper-swap"><a href="/blog/2023/test-your-tests#ensuring-the-efficacy-of-testing-the-case-of-primitive-finance-hyper-swap"><span class="icon icon-link"></span></a>Ensuring The Efficacy of Testing: The Case of Primitive Finance Hyper Swap</h2>
<p>In our pursuit of understanding the security of applications, we often focus on verifying the correctness of properties we know or expect to hold. However, sometimes, the more revealing approach is the opposite—trying to invalidate or disprove properties we suspect might not hold. This is what we term as the &quot;offensive&quot; side of testing.</p>
<p>During the audit of Primitive Hyper in January, a few notable characteristics of the system were observed:</p>
<ul>
<li>It&#x27;s a CFMM (Constant Function Market Maker) protocol incorporating time-dependent curves, potentially enabling options trading.</li>
<li>The system manages internal accounting for pool balances along with a batch swapping functionality.</li>
<li>It heavily employs assembly language and intricate function approximations such as solstat, pdf, and erfc. Additionally, it has inconsistent rounding methods.</li>
</ul>
<h3 id="initial-testing-strategy"><a href="/blog/2023/test-your-tests#initial-testing-strategy"><span class="icon icon-link"></span></a>Initial Testing Strategy</h3>
<p>In the early stages of the audit, a natural inclination was to utilize fuzz testing. The hypothesis was simple: Can one exploit inaccuracies in the pool&#x27;s state (parameters, reserves, etc.) to achieve favorable swaps? The goal was to determine if repeated swaps could lead to value extraction.</p>
<p>Below is an excerpt from an initial test attempt:</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">test_swap</span><span class="token" style="color:#bebec5">(</span><span>
</span></span><span><span>        </span><span class="token parameter">bool sellAsset</span><span class="token parameter" style="color:#bebec5">,</span><span class="token parameter">
</span></span><span><span class="token parameter">        uint128 input</span><span class="token parameter" style="color:#bebec5">,</span><span class="token parameter">
</span></span><span><span class="token parameter">        uint128 tempOutput</span><span class="token parameter" style="color:#bebec5">,</span><span class="token parameter">
</span></span><span><span class="token parameter">        uint256 liquidity</span><span class="token parameter" style="color:#bebec5">,</span><span class="token parameter">
</span></span><span><span class="token parameter">        uint256 volatility</span><span class="token parameter" style="color:#bebec5">,</span><span class="token parameter">
</span></span><span><span class="token parameter">        uint256 duration</span><span class="token parameter" style="color:#bebec5">,</span><span class="token parameter">
</span></span><span><span class="token parameter">        uint128 stkPrice</span><span class="token parameter" style="color:#bebec5">,</span><span class="token parameter">
</span></span><span><span class="token parameter">        uint128 price</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">public</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        </span><span class="token" style="color:#6f705e">// Alice create&#x27;s an honest pool with liquidity.</span><span>
</span></span><span><span>        </span><span class="token function">createPoolAndAllocateLiquidity</span><span class="token" style="color:#bebec5">(</span><span>alice</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">100</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">10</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">2e18</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">1e18</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">1_000_000</span><span> </span><span class="token" style="color:#a77afe">*</span><span> </span><span class="token" style="color:#a77afe">1e18</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        </span><span class="token" style="color:#6f705e">// Bob create&#x27;s a malicious pool with liquidity.</span><span>
</span></span><span><span>        </span><span class="token function">createPoolAndAllocateLiquidity</span><span class="token" style="color:#bebec5">(</span><span>bob</span><span class="token" style="color:#bebec5">,</span><span> volatility</span><span class="token" style="color:#bebec5">,</span><span> duration</span><span class="token" style="color:#bebec5">,</span><span> stkPrice</span><span class="token" style="color:#bebec5">,</span><span> price</span><span class="token" style="color:#bebec5">,</span><span> liquidity</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        </span><span class="token" style="color:#6f705e">// Bob tries to extract tokens by swapping back and forth.</span><span>
</span></span><span><span>        uint128 targetValue </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#a77afe">1e18</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        </span><span class="token" style="color:#6f705e">// Swap input X -&gt; tempOutput Y -&gt; output X.</span><span>
</span></span><span><span>        bool success </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">swapBackAndForth</span><span class="token" style="color:#bebec5">(</span><span>sellAsset</span><span class="token" style="color:#bebec5">,</span><span> input</span><span class="token" style="color:#bebec5">,</span><span> tempOutput</span><span class="token" style="color:#bebec5">,</span><span> input </span><span class="token" style="color:#a77afe">+</span><span> targetValue</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        </span><span class="token control-flow" style="color:#ef3b7d">if</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#a77afe">!</span><span>success</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token control-flow" style="color:#ef3b7d">return</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        </span><span class="token" style="color:#6f705e">// Bob withdraws all of his assets.</span><span>
</span></span><span><span>        </span><span class="token function">withdrawAllAssets</span><span class="token" style="color:#bebec5">(</span><span>bob</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        int256 assetGain </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">int256</span><span class="token" style="color:#bebec5">(</span><span>asset</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">balanceOf</span><span class="token" style="color:#bebec5">(</span><span>bob</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#a77afe">-</span><span> </span><span class="token function">int256</span><span class="token" style="color:#bebec5">(</span><span class="token constant">INITIAL_BALANCE</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        int256 quoteGain </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">int256</span><span class="token" style="color:#bebec5">(</span><span>quote</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">balanceOf</span><span class="token" style="color:#bebec5">(</span><span>bob</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#a77afe">-</span><span> </span><span class="token function">int256</span><span class="token" style="color:#bebec5">(</span><span class="token constant">INITIAL_BALANCE</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        </span><span class="token" style="color:#6f705e">// Bob should gain tokens.</span><span>
</span></span><span><span>        </span><span class="token control-flow" style="color:#ef3b7d">if</span><span> </span><span class="token" style="color:#bebec5">(</span><span>assetGain </span><span class="token" style="color:#a77afe">&lt;</span><span> </span><span class="token" style="color:#a77afe">0</span><span> </span><span class="token" style="color:#a77afe">||</span><span> quoteGain </span><span class="token" style="color:#a77afe">&lt;</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token control-flow" style="color:#ef3b7d">return</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        </span><span class="token" style="color:#6f705e">// Log the balance gain.</span><span>
</span></span><span><span>        </span><span class="token console class-name">console</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">log</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#e6d06c">&quot;Asset gain&quot;</span><span class="token" style="color:#bebec5">,</span><span> vm</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">toString</span><span class="token" style="color:#bebec5">(</span><span>assetGain</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        </span><span class="token console class-name">console</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">log</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#e6d06c">&quot;Quote gain&quot;</span><span class="token" style="color:#bebec5">,</span><span> vm</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">toString</span><span class="token" style="color:#bebec5">(</span><span>quoteGain</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        </span><span class="token" style="color:#6f705e">// Report the test case.</span><span>
</span></span><span><span>        </span><span class="token function">fail</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span>Traces:
</span></span><span>  [128911] self::test_swap(false, 0, 0, 0, 0, 0, 0, 0)
</span><span>    ├─ [0] VM::startPrank(alice: [0x00000000000000000000000000000000000A11cE])
</span><span>    │   └─ ← ()
</span><span>    ├─ [113457] HYPER::aa012c0c(5991a2df15a8f6a256d3ec51e99254cd3fb576a9f62849f9a0b5bf2913b396098f7c7019b51a820a)
</span><span>    │   ├─ emit CreatePair(pairId: 1, asset: ASSET: [0x5991A2dF15A8F6A256D3Ec51E99254Cd3fb576A9], quote: QUOTE: [0xF62849F9A0B5Bf2913b396098F7c7019b51A820a], decimalsAsset: 18, decimalsQuote: 18)
</span><span>    │   └─ ← ()
</span><span>    └─ ← &quot;UNDEFINED&quot;
</span></code></pre></pre>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span>Traces:
</span></span><span>  [306133] self::test_swap(false, 0, 0, 170141183460469231731687303715884105728 [1.701e38], 0, 0, 0, 0)
</span><span>    ├─ [0] VM::startPrank(alice: [0x00000000000000000000000000000000000A11cE])
</span><span>    │   └─ ← ()
</span><span>    ├─ [113457] HYPER::aa012c0c(5991a2df15a8f6a256d3ec51e99254cd3fb576a9f62849f9a0b5bf2913b396098f7c7019b51a820a)
</span><span>    │   ├─ emit CreatePair(pairId: 1, asset: ASSET: [0x5991A2dF15A8F6A256D3Ec51E99254Cd3fb576A9], quote: QUOTE: [0xF62849F9A0B5Bf2913b396098F7c7019b51A820a], decimalsAsset: 18, decimalsQuote: 18)
</span><span>    ...
</span><span>    ├─ [5912] HYPER::allocate(1103806595073 [1.103e12], 170141183460469231731687303715884105728 [1.701e38])
</span><span>    │   └─ ← &quot;EvmError: Revert&quot;
</span><span>    └─ ← &quot;EvmError: Revert&quot;
</span></code></pre></pre>
<p>However, multiple test runs encountered frequent reverts, indicating the inability to achieve the envisioned swaps. It would be easy, albeit premature, to interpret this as a sign of robustness against the hypothesized exploit.</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">test_swap</span><span class="token" style="color:#bebec5">(</span><span>
</span></span><span><span>        bool sellAsset</span><span class="token" style="color:#bebec5">,</span><span>
</span></span><span><span>        </span><span class="token" style="color:#6f705e">// ...</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">public</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        </span><span class="token" style="color:#6f705e">// Properly bound pool parameters.</span><span>
</span></span><span><span>        </span><span class="token" style="color:#6f705e">// Prevent lnWad&#x27;s &quot;UNDEFINED&quot; when `price * 1e18 / stkPrice == 0`.</span><span>
</span></span><span><span>        stkPrice </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">uint128</span><span class="token" style="color:#bebec5">(</span><span class="token function">bound</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">(</span><span>stkPrice</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">1</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token function">type</span><span class="token" style="color:#bebec5">(</span><span>uint128</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">max</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        price </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">uint128</span><span class="token" style="color:#bebec5">(</span><span>
</span></span><span><span>            </span><span class="token function">bound</span><span class="token" style="color:#bebec5">(</span><span>
</span></span><span><span>                </span><span class="token function">uint256</span><span class="token" style="color:#bebec5">(</span><span>price</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">,</span><span>
</span></span><span><span>                </span><span class="token" style="color:#bebec5">(</span><span class="token maybe-class-name">Price</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">computePriceWithTick</span><span class="token" style="color:#bebec5">(</span><span class="token maybe-class-name">Price</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">computeTickWithPrice</span><span class="token" style="color:#bebec5">(</span><span>stkPrice</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#a77afe">+</span><span> </span><span class="token" style="color:#a77afe">1</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#a77afe">+</span><span> </span><span class="token" style="color:#a77afe">1e18</span><span> </span><span class="token" style="color:#a77afe">-</span><span> </span><span class="token" style="color:#a77afe">1</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#a77afe">/</span><span> </span><span class="token" style="color:#a77afe">1e18</span><span class="token" style="color:#bebec5">,</span><span>
</span></span><span><span>                </span><span class="token function">type</span><span class="token" style="color:#bebec5">(</span><span>uint128</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">max</span><span>
</span></span><span><span>            </span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span>        </span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        volatility </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">bound</span><span class="token" style="color:#bebec5">(</span><span>volatility</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">100</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">25_000</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        duration </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">bound</span><span class="token" style="color:#bebec5">(</span><span>duration</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">1</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">500</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        </span><span class="token" style="color:#6f705e">// Alice create&#x27;s a pool with liquidity.</span><span>
</span></span><span><span>        </span><span class="token" style="color:#6f705e">// ...</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span>Running 1 test for test/foundry/TestSwapPoc.t.sol:TestHyperSwapPoc
</span></span><span>[PASS] test_swap(bool,uint128,uint128,uint256,uint256,uint256,uint128,uint128) (runs: 10000, μ: 723780, ~: 794869)
</span><span>Test result: ok. 1 passed; 0 failed; 0 skipped; finished in 10.23s
</span></code></pre></pre>
<p>Ok, great. After addressing all reverts and properly bounding the parameters, all runs are completing. Bob has still not made any profitable trades however.</p>
<h3 id="refining-the-testing-strategy"><a href="/blog/2023/test-your-tests#refining-the-testing-strategy"><span class="icon icon-link"></span></a>Refining the Testing Strategy</h3>
<p>Instead of stopping, the testing process continued, and the focus shifted. By letting the fuzzer operate over an extended duration and periodically revisiting the codebase, more insights were gained.</p>
<p>One significant discovery was the reliance on Hyper&#x27;s batch instructions for the swapping process. Coverage indicated that I was able to create pools and allocate liquidity, but not execute the profitable swap.</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">swapBackAndForth</span><span class="token" style="color:#bebec5">(</span><span class="token parameter">bool sellAsset</span><span class="token parameter" style="color:#bebec5">,</span><span class="token parameter"> uint128 input</span><span class="token parameter" style="color:#bebec5">,</span><span class="token parameter"> uint128 output1</span><span class="token parameter" style="color:#bebec5">,</span><span class="token parameter"> uint128 output2</span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span>        internal
</span><span><span>        </span><span class="token function">returns</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token parameter">bool success</span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        </span><span class="token" style="color:#6f705e">// Encode batch instructions.</span><span>
</span></span><span><span>        bytes</span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#bebec5">]</span><span> memory instructions </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#ef3b7d">new</span><span> </span><span class="token class-name">bytes</span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#a77afe">2</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        instructions</span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token maybe-class-name">ProcessingLib</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">encodeSwap</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">,</span><span> poolId</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">,</span><span> input</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">,</span><span> output1</span><span class="token" style="color:#bebec5">,</span><span> sellAsset </span><span class="token" style="color:#a77afe">?</span><span> </span><span class="token" style="color:#a77afe">0</span><span> </span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token" style="color:#a77afe">1</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        instructions</span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">1</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token maybe-class-name">ProcessingLib</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">encodeSwap</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">,</span><span> poolId</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">,</span><span> output1</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">,</span><span> output2</span><span class="token" style="color:#bebec5">,</span><span> sellAsset </span><span class="token" style="color:#a77afe">?</span><span> </span><span class="token" style="color:#a77afe">1</span><span> </span><span class="token" style="color:#a77afe">:</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        bytes memory data </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token maybe-class-name">ProcessingLib</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">encodeJumpInstruction</span><span class="token" style="color:#bebec5">(</span><span>instructions</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        </span><span class="token" style="color:#bebec5">(</span><span>success</span><span class="token" style="color:#bebec5">,</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">address</span><span class="token" style="color:#bebec5">(</span><span>hyper</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">call</span><span class="token" style="color:#bebec5">(</span><span>data</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<p>Due to the settlement logic, all net balances are deducted at the end of a batched instruction. If a successful attack means only receiving tokens from the protocol why would an attacker be required to give token approvals to the protocol? However, due to rounding inconsistencies, attempting to extract Quote tokens often required the transferring at least one Asset token.</p>
<p>Moreover, it was observed that the exploit was only feasible if the attacker did not receive the special pool controller fee but the standard swap fee. This highlighted the significance of questioning assumptions and testing varying conditions.</p>
<h3 id="conclusions-and-takeaways"><a href="/blog/2023/test-your-tests#conclusions-and-takeaways"><span class="icon icon-link"></span></a>Conclusions and Takeaways</h3>
<p>The Primitive Hyper Swap case offers several insights that can be applied to:</p>
<ol start="4">
<li><strong>Establish Precise Variable Bounds</strong>: Address potential reverts by ensuring that all variables are bounded correctly.</li>
<li><strong>Augment Coverage Insight</strong>: Introduce sanity checks to assess the feasibility of the test hypothesis, even considering the removal of protocol invariant checks.</li>
<li><strong>Challenge Every Assumption</strong>: The audit revealed how certain assumptions, like the fixed priority fee required for the exploit, or the prerequisite of token approvals, can skew testing results.</li>
</ol>
<p>In essence, offensive testing requires a dynamic and persistent approach. It&#x27;s not just about confirming the robustness of a system but actively seeking potential cracks. Only by repeatedly challenging our understanding and assumptions can we hope to uncover hidden vulnerabilities.</p></div></div></div></main></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"slug":["blog","2023","test-your-tests"],"contentRaw":"\n\u003e This is a writeup of the talks given at [TrustX](https://www.secureum.xyz/trustx/) and [Solidity Summit](https://soliditylang.org/summit/) at [Devconnect Istanbul 2023](https://devconnect.org/).\n\nIn the rapidly evolving landscape of software development, the importance of rigorous testing cannot be overstated, especially when dealing with system-critical applications like blockchains. The reliability of tests are fundamental to ensuring the integrity and security of the applications they support. But, how do we evaluate the quality and efficacy of our tests?\n\n## Key Insights:\n\n1. **Treat Tests with the Same Rigor as Production Code**: Treat your unit, fuzz, and integration tests with the same seriousness as your main application code. Given that tests can also harbor bugs, their detailed assessment is crucial. A flawed test may not just yield incorrect outcomes but could also create a deceptive sense of security.\n\n2. **Critically Examine the Assumptions, Preconditions, and Conclusions in Tests**:\n\n   - Re-evaluate your preconditions. Are they backed by concrete examples?\n   - Review your test conclusions. Are there hidden assumptions that might skew the outcomes?\n\n3. **Incorporate 'Meta-Tests'**:\n\n   - Design tests to evaluate your primary tests.\n   - Examine specific edge cases with dedicated unit tests.\n   - Introduce intentional bugs to see if your tests spot them.\n   - Use mutation testing to check the resilience of your tests.\n\n4. **Understand the Limitations of Testing Tools**: While testing tools enhance our testing abilities, they have their limitations. These tools can contain inherent biases, idiosyncrasies, or bugs. Not fully grasping their capabilities or misapplying them might distort test results.\n\n## The Role of Robust Testing\n\nTests act as the protective layer for code functionality. A well-crafted designed test solidifies the anticipated code behavior, safeguarding it against unexpected issues that might arise from future modifications.\nEven though various testing methods and static analysis can vouch for your code's stability, no test is infallible. Constant attention and improvement in testing methods are essential for ensuring software robustness.\n\n### Motivation Behind the Topic\n\nThis topic's inspiration stems from my own experiences and reflections on past shortcomings. Each identified vulnerability prompted a re-evaluation—-how could both the development and testing phases be enhanced to avert similar challenges in the future?\n\n### Exemplary Case: The WAD Conversion\n\nTo shed light on the concepts discussed, consider a simple exercise of writing a fuzz test for WAD unit conversions.\n\n```js\nuint256 constant WAD = 1e18;\n\nfunction fromWAD(uint256 a) pure returns (uint256 c) {\n    c = a / WAD;\n}\n\nfunction toWAD(uint256 a) pure returns (uint256 c) {\n    c = a * WAD;\n}\n\ncontract TestFromWAD_DONT is Test {\n    function test_toWAD_fromWAD(uint256 a) external {\n        if (a \u003e= type(uint256).max / WAD) vm.expectRevert();\n\n        assertEq(fromWAD(toWAD(a)), a);\n    }\n}\n```\n\nWhile the above test passed numerous fuzzing iterations, a closer examination reveals an oversight in the boundary check. Specifically, the conversion should not revert for `a = type(uint256).max / WAD`. From the fuzzer's perspective, this value might appear as any other in the space of all possible `uint256` inputs. This inaccuracy exemplifies how an unclear precondition can not only obfuscate the true functionality but, in more severe scenarios, also mask vulnerabilities.\n\nAn improved version of the test could be structured as:\n\n```js\ncontract TestFromWAD_DO is Test {\n    /// Testing for values where `toWAD(a)` shouldn't revert.\n    function test_toWAD_fromWAD(uint256 a) public {\n        a = bound(a, 0, type(uint256).max / WAD);\n\n        assertEq(fromWAD(toWAD(a)), a);\n    }\n\n    /// Testing for values where `toWAD(a)` should revert.\n    function test_toWAD_fromWAD_revert_Panic(uint256 a) public {\n        a = bound(a, type(uint256).max / WAD + 1, type(uint256).max);\n\n        vm.expectRevert(abi.encodeWithSignature(\"Panic(uint256)\", (0x11)));\n\n        assertEq(fromWAD(toWAD(a)), a);\n    }\n}\n```\n\n$$uint256 \\text{ domain}$$\n\n$$\n\\overset{\\raisebox{2pt}{\\color{green} passing}}{\n    ├\\underset{0}{─}────────────\\underset{\\hskip -1em \\frac {MAX} {WAD}}{─}┤\n}\n\\overset{\\raisebox{2pt} {\\color{red}reverting}}{\n    ├────\\underset{\\hskip -3.5em \\frac {MAX} {WAD} + 1}───────\\underset{\\hskip -0.4 em MAX }{───}┤\n}\n$$\n\nBy dividing tests based on expected results (success or failure), our testing approach becomes clearer and ensures both situations are sufficiently tested. Using Foundry's `bound` function aids in testing near boundary conditions. Also, testing for a specific error (`Panic(0x11)`) can identify unintentional coding errors.\n\nAs a further improvement, one could segregate the calls `fromWAD(toWAD(a))` to pinpoint exactly where an error might occur. This would require the calls to be made externally.\n\nIt's worth noting, however, that the tests alone don't offer a clear picture of the actual behavior of the `toWAD` and `fromWAD` functions. Multiple functions can satisfy the constraints set by the tests, as illustrated below:\n\n```js\nfunction fromWAD(uint256 a) pure returns (uint256 c) {\n    c = a + 1234;\n}\n\nfunction toWAD(uint256 a) pure returns (uint256 c) {\n    if (a \u003e type(uint256).max / WAD) revert();\n    c = a - 1234;\n}\n```\n\n### Exemplary Case: Mul WAD\n\nWe just saw the case where our test had a wrong precondition compared to our implementation. What if, however, our test reflected an incorrect precondition contained in the implementation itself?\n\n```js\ncontract TestMulWAD_DONT is Test {\n    function mulWAD(uint256 a, uint256 b) public pure returns (uint256 c) {\n        unchecked {\n            if (b == 0 || a \u003e type(uint256).max / b) revert Overflow();\n\n            c = a * b / WAD;\n        }\n    }\n\n    function test_mulWAD(uint256 a, uint256 b) public {\n        if (b == 0 || a \u003e type(uint256).max / b) vm.expectRevert();\n\n        uint256 c = mulWAD(a, b);\n\n        assertEq(c, a * b / WAD);\n    }\n}\n```\n\nThis example implementation of `mulWAD` is using `unchecked` arithmetic for optimization purposes. In doing so, we have manually included a flawed check that will revert the execution when an overflow occurs. This flawed check is now mirrored in the test and cannot be detected by a fuzzer. How would we have been able to detect the error in this case?\n\nIn the case that we have a reference implementation at hand, we can use differential fuzz testing.\n\n```js\n    function mulWADNative(uint256 a, uint256 b) public pure returns (uint256 c) {\n        c = a * b / WAD;\n    }\n\n    function test_mulWAD_differential(uint256 a, uint256 b) public {\n        assertEqCall(\n            address(this),\n            abi.encodeCall(this.mulWAD, (a, b)),\n            abi.encodeCall(this.mulWADNative, (a, b))\n        );\n    }\n```\n\nUsing the `ffi` cheat code we can also test against non Solidity implementations.\n\n**Takeaway:**\n\n- Don't blindly copy preconditions (or code) from your implementations when testing\n- Re-implement code logic and use **differential testing** when possible\n\n# Ensuring The Efficacy of Testing: The Case of Primitive Finance Hyper Swap\n\nIn our pursuit of understanding the security of applications, we often focus on verifying the correctness of properties we know or expect to hold. However, sometimes, the more revealing approach is the opposite—trying to invalidate or disprove properties we suspect might not hold. This is what we term as the \"offensive\" side of testing.\n\nDuring the audit of Primitive Hyper in January, a few notable characteristics of the system were observed:\n\n- It's a CFMM (Constant Function Market Maker) protocol incorporating time-dependent curves, potentially enabling options trading.\n- The system manages internal accounting for pool balances along with a batch swapping functionality.\n- It heavily employs assembly language and intricate function approximations such as solstat, pdf, and erfc. Additionally, it has inconsistent rounding methods.\n\n## Initial Testing Strategy\n\nIn the early stages of the audit, a natural inclination was to utilize fuzz testing. The hypothesis was simple: Can one exploit inaccuracies in the pool's state (parameters, reserves, etc.) to achieve favorable swaps? The goal was to determine if repeated swaps could lead to value extraction.\n\nBelow is an excerpt from an initial test attempt:\n\n```js\n    function test_swap(\n        bool sellAsset,\n        uint128 input,\n        uint128 tempOutput,\n        uint256 liquidity,\n        uint256 volatility,\n        uint256 duration,\n        uint128 stkPrice,\n        uint128 price\n    ) public {\n        // Alice create's an honest pool with liquidity.\n        createPoolAndAllocateLiquidity(alice, 100, 10, 2e18, 1e18, 1_000_000 * 1e18);\n\n        // Bob create's a malicious pool with liquidity.\n        createPoolAndAllocateLiquidity(bob, volatility, duration, stkPrice, price, liquidity);\n\n        // Bob tries to extract tokens by swapping back and forth.\n        uint128 targetValue = 1e18;\n\n        // Swap input X -\u003e tempOutput Y -\u003e output X.\n        bool success = swapBackAndForth(sellAsset, input, tempOutput, input + targetValue);\n        if (!success) return;\n\n        // Bob withdraws all of his assets.\n        withdrawAllAssets(bob);\n\n        int256 assetGain = int256(asset.balanceOf(bob)) - int256(INITIAL_BALANCE);\n        int256 quoteGain = int256(quote.balanceOf(bob)) - int256(INITIAL_BALANCE);\n\n        // Bob should gain tokens.\n        if (assetGain \u003c 0 || quoteGain \u003c 0) return;\n\n        // Log the balance gain.\n        console.log(\"Asset gain\", vm.toString(assetGain));\n        console.log(\"Quote gain\", vm.toString(quoteGain));\n\n        // Report the test case.\n        fail();\n    }\n```\n\n```\nTraces:\n  [128911] self::test_swap(false, 0, 0, 0, 0, 0, 0, 0)\n    ├─ [0] VM::startPrank(alice: [0x00000000000000000000000000000000000A11cE])\n    │   └─ ← ()\n    ├─ [113457] HYPER::aa012c0c(5991a2df15a8f6a256d3ec51e99254cd3fb576a9f62849f9a0b5bf2913b396098f7c7019b51a820a)\n    │   ├─ emit CreatePair(pairId: 1, asset: ASSET: [0x5991A2dF15A8F6A256D3Ec51E99254Cd3fb576A9], quote: QUOTE: [0xF62849F9A0B5Bf2913b396098F7c7019b51A820a], decimalsAsset: 18, decimalsQuote: 18)\n    │   └─ ← ()\n    └─ ← \"UNDEFINED\"\n```\n\n```\nTraces:\n  [306133] self::test_swap(false, 0, 0, 170141183460469231731687303715884105728 [1.701e38], 0, 0, 0, 0)\n    ├─ [0] VM::startPrank(alice: [0x00000000000000000000000000000000000A11cE])\n    │   └─ ← ()\n    ├─ [113457] HYPER::aa012c0c(5991a2df15a8f6a256d3ec51e99254cd3fb576a9f62849f9a0b5bf2913b396098f7c7019b51a820a)\n    │   ├─ emit CreatePair(pairId: 1, asset: ASSET: [0x5991A2dF15A8F6A256D3Ec51E99254Cd3fb576A9], quote: QUOTE: [0xF62849F9A0B5Bf2913b396098F7c7019b51A820a], decimalsAsset: 18, decimalsQuote: 18)\n    ...\n    ├─ [5912] HYPER::allocate(1103806595073 [1.103e12], 170141183460469231731687303715884105728 [1.701e38])\n    │   └─ ← \"EvmError: Revert\"\n    └─ ← \"EvmError: Revert\"\n```\n\nHowever, multiple test runs encountered frequent reverts, indicating the inability to achieve the envisioned swaps. It would be easy, albeit premature, to interpret this as a sign of robustness against the hypothesized exploit.\n\n```js\n    function test_swap(\n        bool sellAsset,\n        // ...\n    ) public {\n        // Properly bound pool parameters.\n        // Prevent lnWad's \"UNDEFINED\" when `price * 1e18 / stkPrice == 0`.\n        stkPrice = uint128(bound((stkPrice), 1, type(uint128).max));\n        price = uint128(\n            bound(\n                uint256(price),\n                (Price.computePriceWithTick(Price.computeTickWithPrice(stkPrice) + 1) + 1e18 - 1) / 1e18,\n                type(uint128).max\n            )\n        );\n        volatility = bound(volatility, 100, 25_000);\n        duration = bound(duration, 1, 500);\n\n        // Alice create's a pool with liquidity.\n        // ...\n    }\n```\n\n```\nRunning 1 test for test/foundry/TestSwapPoc.t.sol:TestHyperSwapPoc\n[PASS] test_swap(bool,uint128,uint128,uint256,uint256,uint256,uint128,uint128) (runs: 10000, μ: 723780, ~: 794869)\nTest result: ok. 1 passed; 0 failed; 0 skipped; finished in 10.23s\n```\n\nOk, great. After addressing all reverts and properly bounding the parameters, all runs are completing. Bob has still not made any profitable trades however.\n\n## Refining the Testing Strategy\n\nInstead of stopping, the testing process continued, and the focus shifted. By letting the fuzzer operate over an extended duration and periodically revisiting the codebase, more insights were gained.\n\nOne significant discovery was the reliance on Hyper's batch instructions for the swapping process. Coverage indicated that I was able to create pools and allocate liquidity, but not execute the profitable swap.\n\n```js\n    function swapBackAndForth(bool sellAsset, uint128 input, uint128 output1, uint128 output2)\n        internal\n        returns (bool success)\n    {\n        // Encode batch instructions.\n        bytes[] memory instructions = new bytes[](2);\n\n        instructions[0] = ProcessingLib.encodeSwap(0, poolId, 0, input, 0, output1, sellAsset ? 0 : 1);\n        instructions[1] = ProcessingLib.encodeSwap(0, poolId, 0, output1, 0, output2, sellAsset ? 1 : 0);\n\n        bytes memory data = ProcessingLib.encodeJumpInstruction(instructions);\n\n        (success,) = address(hyper).call(data);\n    }\n```\n\nDue to the settlement logic, all net balances are deducted at the end of a batched instruction. If a successful attack means only receiving tokens from the protocol why would an attacker be required to give token approvals to the protocol? However, due to rounding inconsistencies, attempting to extract Quote tokens often required the transferring at least one Asset token.\n\nMoreover, it was observed that the exploit was only feasible if the attacker did not receive the special pool controller fee but the standard swap fee. This highlighted the significance of questioning assumptions and testing varying conditions.\n\n## Conclusions and Takeaways\n\nThe Primitive Hyper Swap case offers several insights that can be applied to:\n\n4. **Establish Precise Variable Bounds**: Address potential reverts by ensuring that all variables are bounded correctly.\n5. **Augment Coverage Insight**: Introduce sanity checks to assess the feasibility of the test hypothesis, even considering the removal of protocol invariant checks.\n6. **Challenge Every Assumption**: The audit revealed how certain assumptions, like the fixed priority fee required for the exploit, or the prerequisite of token approvals, can skew testing results.\n\nIn essence, offensive testing requires a dynamic and persistent approach. It's not just about confirming the robustness of a system but actively seeking potential cracks. Only by repeatedly challenging our understanding and assumptions can we hope to uncover hidden vulnerabilities.\n","title":"Test Your Tests!","date":"Oct 20, 2023","excerpt":"Writeup of the talks given at TrustX \u0026 Solidity Summit at Devconnect in Istanbul.","suptitle":"The Dos and Don'ts of testing","unpublished":true}},"__N_SSG":true},"page":"/[...slug]","query":{"slug":["blog","2023","test-your-tests"]},"buildId":"vfs54WcrIK7AZ-vGBfUCo","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>
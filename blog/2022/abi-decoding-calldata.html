<!DOCTYPE html><html><head><meta charSet="utf-8"/><title class="animate__fadeIn">0xPhaze</title><meta name="viewport" content="initial-scale=1.0, width=device-width"/><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/fcf81e63369216ac.css" as="style"/><link rel="stylesheet" href="/_next/static/css/fcf81e63369216ac.css" data-n-g=""/><link rel="preload" href="/_next/static/css/65875c30e26bdd78.css" as="style"/><link rel="stylesheet" href="/_next/static/css/65875c30e26bdd78.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-ede13cf31a63337e.js" defer=""></script><script src="/_next/static/chunks/framework-bb5c596eafb42b22.js" defer=""></script><script src="/_next/static/chunks/main-914fbfab4f90b52f.js" defer=""></script><script src="/_next/static/chunks/pages/_app-ad82082731d58181.js" defer=""></script><script src="/_next/static/chunks/175675d1-5e59763be147fa1f.js" defer=""></script><script src="/_next/static/chunks/634-958ce5c52c8283ef.js" defer=""></script><script src="/_next/static/chunks/pages/%5B...slug%5D-1036fd4ff48bafcd.js" defer=""></script><script src="/_next/static/DAJAm56ZaJfpNiejQOpy7/_buildManifest.js" defer=""></script><script src="/_next/static/DAJAm56ZaJfpNiejQOpy7/_ssgManifest.js" defer=""></script><script src="/_next/static/DAJAm56ZaJfpNiejQOpy7/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="app px-4 pb-20 min-h-screen flex flex-col items-center w-full max-w-screen"><header class="w-full flex flex-col px-4 sm:px-8 md:px-12 max-w-5xl sm:flex-row justify-between items-center border-white/20 overflow-hidden border-b p-4 h-16"><div class="w-full h-full flex flex-col sm:flex-row justify-start sm:justify-between items-center gap-y-4 overflow-hidden sm:overflow-visible"><div class="flex w-full sm:w-fit items-center"><h1 class="text-xl mx-auto font-display"><a href="/">0xPhaze</a></h1><div class="my-auto -ml-6 w-6 sm:hidden"><div class="text-slate-300 hover:text-secondary-400 transition-colors duration-200 cursor-pointer h-6"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="bars" class="svg-inline--fa fa-bars " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416C433.7 64 448 78.33 448 96C448 113.7 433.7 128 416 128H32C14.33 128 0 113.7 0 96zM0 256C0 238.3 14.33 224 32 224H416C433.7 224 448 238.3 448 256C448 273.7 433.7 288 416 288H32C14.33 288 0 273.7 0 256zM416 448H32C14.33 448 0 433.7 0 416C0 398.3 14.33 384 32 384H416C433.7 384 448 398.3 448 416C448 433.7 433.7 448 416 448z"></path></svg></div></div></div><div class="flex flex-col sm:flex-row gap-x-8 md:gap-x-10 gap-y-4"><div class="flex gap-x-2 sm:gap-x-5 items-center justify-evenly"><a target="_blank" rel="noreferrer" class="link" href="https://github.com/0xPhaze/"><div><div class="text-slate-300 hover:text-secondary-400 transition-colors duration-200 cursor-pointer"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-4"><path style="fill:currentColor" d="M12 0C5.374 0 0 5.373 0 12c0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23A11.509 11.509 0 0 1 12 5.803c1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.3 24 12c0-6.627-5.373-12-12-12z"></path></svg></div></div></a><a target="_blank" rel="noreferrer" class="link" href="https://twitter.com/lovethewired"><div><div class="text-slate-300 hover:text-secondary-400 transition-colors duration-200 cursor-pointer"><svg viewBox="0 0 16 14" fill="none" xmlns="http://www.w3.org/2000/svg" class="h-4"><path style="fill:currentColor" d="M15.584 1.578a7.91 7.91 0 0 1-1.57 1.807v.482c0 .965-.112 1.929-.336 2.772-.224.965-.673 1.808-1.121 2.652a17.373 17.373 0 0 1-1.794 2.29c-.785.723-1.681 1.205-2.578 1.566-1.01.362-2.13.603-3.252.603-1.793 0-3.475-.603-4.932-1.567h.784c1.458 0 2.915-.482 4.036-1.446a2.914 2.914 0 0 1-1.905-.723c-.561-.482-.897-.964-1.122-1.687h.561c.336 0 .56 0 .897-.12C2.579 8.085 1.907 7.603 1.458 7 .785 6.398.561 5.675.561 4.83c.449.242 1.01.362 1.458.483A5.531 5.531 0 0 1 .898 4.109C.673 3.626.449 3.024.449 2.42c0-.602.112-1.205.449-1.687a8.606 8.606 0 0 0 2.914 2.53c1.122.603 2.355.965 3.7 1.086 0-.241-.112-.483-.112-.844 0-.723.224-1.326.56-1.928.337-.603.897-.965 1.458-1.326.56-.241 1.233-.362 1.906-.12.672.12 1.233.481 1.681.964.673-.121 1.458-.362 2.018-.844-.224.844-.784 1.446-1.457 1.928.785-.12 1.457-.24 2.018-.602Z" fill="#081026"></path></svg></div></div></a><div><div class="text-slate-300 hover:text-secondary-400 transition-colors duration-200 cursor-pointer">ABI</div></div><div><div class="text-slate-300 hover:text-secondary-400 transition-colors duration-200 cursor-pointer">ENC</div></div></div><button class="rounded px-4 py-2 uppercase text-white select-none  transition-all duration-300 disabled:pointer-events-none bg-primary-600 hover:bg-primary-700  !outline-none normal-case text-sm w-[140px] w-36">Connect Wallet</button></div></div></header><main class="gap-y-20 mt-8 py-4 sm:px-8 md:px-12 w-full min-h-[500px] max-w-4xl"><div class="flex flex-col justify-between gap-y-20"><div class="content markdown"><h1 class="text-center">ABI-Decoding Calldata</h1><p class="text-slate-500 text-sm text-center">Oct 22, 2022</p><div class="mt-16"><p><code>abi.decode(data, (type))</code> can be used to decode abi-encoded bytes located in memory and calldata. Currently, it&#x27;s only possible to assign dynamic types to memory. Decoding to calldata is not supported yet, however, this can still be achieved manually.</p>
<p>Say we wanted to send a NFT cross-chain. For this we have have to encode a message that could look like this.</p>
<pre><pre before="FxERC721Root.sol" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span class="token builtin">bytes4</span><span> </span><span class="token" style="color:#ef3b7d">constant</span><span> REGISTER_ERC721_IDS_SELECTOR </span><span class="token" style="color:#a77afe">=</span><span> 
</span></span><span><span>    </span><span class="token builtin">bytes4</span><span class="token" style="color:#bebec5">(</span><span class="token function">keccak256</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#e6d06c">&quot;registerERC721IdsWithChild(address,uint256[])&quot;</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">_registerERC721IdsWithChild</span><span class="token" style="color:#bebec5">(</span><span class="token builtin">address</span><span> to</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token builtin">uint256</span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token" style="color:#ef3b7d">calldata</span><span> ids</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">internal</span><span> virtual </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span class="line line-hl"><span>        </span><span class="token builtin">bytes</span><span> </span><span class="token" style="color:#ef3b7d">memory</span><span> message </span><span class="token" style="color:#a77afe">=</span><span> abi</span><span class="token" style="color:#bebec5">.</span><span class="token function">encodeWithSelector</span><span class="token" style="color:#bebec5">(</span><span>REGISTER_ERC721_IDS_SELECTOR</span><span class="token" style="color:#bebec5">,</span><span> to</span><span class="token" style="color:#bebec5">,</span><span> ids</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span> 
</span></span><span>
</span><span><span>        </span><span class="token function">_sendMessageToChild</span><span class="token" style="color:#bebec5">(</span><span>message</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<p>The child chain can receive the full message as <code>calldata</code>, run some security checks and then process it in another function.</p>
<pre><pre before="FxERC721Child.sol" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">processMessageFromRoot</span><span class="token" style="color:#bebec5">(</span><span>
</span></span><span><span>        </span><span class="token builtin">uint256</span><span> stateId</span><span class="token" style="color:#bebec5">,</span><span>
</span></span><span><span>        </span><span class="token builtin">address</span><span> rootMessageSender</span><span class="token" style="color:#bebec5">,</span><span>
</span></span><span class="line line-hl"><span>        </span><span class="token builtin">bytes</span><span> </span><span class="token" style="color:#ef3b7d">calldata</span><span> message 
</span></span><span><span>    </span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">external</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        </span><span class="token" style="color:#ef3b7d">if</span><span> </span><span class="token" style="color:#bebec5">(</span><span>msg</span><span class="token" style="color:#bebec5">.</span><span>sender </span><span class="token" style="color:#a77afe">!=</span><span> fxChild</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">revert</span><span> </span><span class="token function">CallerNotFxChild</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        </span><span class="token" style="color:#ef3b7d">if</span><span> </span><span class="token" style="color:#bebec5">(</span><span>rootMessageSender </span><span class="token" style="color:#a77afe">==</span><span> </span><span class="token builtin">address</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#a77afe">||</span><span> rootMessageSender </span><span class="token" style="color:#a77afe">!=</span><span> </span><span class="token function">s</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">.</span><span>fxRootTunnel</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">revert</span><span> </span><span class="token function">InvalidRootSender</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        </span><span class="token function">_processMessageFromRoot</span><span class="token" style="color:#bebec5">(</span><span>stateId</span><span class="token" style="color:#bebec5">,</span><span> rootMessageSender</span><span class="token" style="color:#bebec5">,</span><span> message</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<p>Solidity does not allow us to decode the ids as a <code>uint256[] calldata</code> array directly yet. I.e. the following</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span>    </span><span class="token" style="color:#bebec5">(</span><span class="token builtin">address</span><span> to</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token builtin">uint256</span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token" style="color:#ef3b7d">calldata</span><span> ids</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#a77afe">=</span><span> abi</span><span class="token" style="color:#bebec5">.</span><span class="token function">decode</span><span class="token" style="color:#bebec5">(</span><span>message</span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">4</span><span class="token" style="color:#bebec5">:</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token builtin">address</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token builtin">uint256</span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span></span></code></pre></pre>
<p>would fail with the message:
<code>&quot;TypeError: Type uint256[] memory is not implicitly convertible to expected type uint256[] calldata.&quot;</code></p>
<p>However, by declaring <code>uint256[] calldata ids;</code> and manually setting <code>ids.offset</code> and <code>ids.length</code> via assembly, we can manually decode the data.
For more on the abi encoding spec, read up on the <a target="_blank" rel="noreferrer" class="link" href="https://docs.soliditylang.org/en/v0.8.17/abi-spec.html#argument-encoding">docs</a>.</p>
<pre><pre before="FxERC721Child.sol" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">_processMessageFromRoot</span><span class="token" style="color:#bebec5">(</span><span>
</span></span><span><span>        </span><span class="token builtin">uint256</span><span class="token" style="color:#bebec5">,</span><span>
</span></span><span><span>        </span><span class="token builtin">address</span><span class="token" style="color:#bebec5">,</span><span>
</span></span><span><span>        </span><span class="token builtin">bytes</span><span> </span><span class="token" style="color:#ef3b7d">calldata</span><span> message
</span></span><span><span>    </span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">internal</span><span> virtual override </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        </span><span class="token builtin">bytes4</span><span> selector </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token builtin">bytes4</span><span class="token" style="color:#bebec5">(</span><span>message</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        </span><span class="token" style="color:#ef3b7d">if</span><span> </span><span class="token" style="color:#bebec5">(</span><span>selector </span><span class="token" style="color:#a77afe">!=</span><span> REGISTER_ERC721_IDS_SELECTOR</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">revert</span><span> </span><span class="token function">InvalidSelector</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        </span><span class="token builtin">address</span><span> to </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token builtin">address</span><span class="token" style="color:#bebec5">(</span><span class="token builtin">uint160</span><span class="token" style="color:#bebec5">(</span><span class="token builtin">uint256</span><span class="token" style="color:#bebec5">(</span><span class="token builtin">bytes32</span><span class="token" style="color:#bebec5">(</span><span>message</span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">4</span><span class="token" style="color:#bebec5">:</span><span class="token" style="color:#a77afe">36</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        </span><span class="token builtin">uint256</span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token" style="color:#ef3b7d">calldata</span><span> ids</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        </span><span class="token" style="color:#6f705e">// abi-decode `ids` directly in calldata.</span><span>
</span></span><span><span>        </span><span class="token" style="color:#ef3b7d">assembly</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>            </span><span class="token" style="color:#6f705e">// Skip bytes4 selector + bytes32 encoded address</span><span>
</span></span><span><span>            </span><span class="token" style="color:#6f705e">// starting from message&#x27;s offset in calldata</span><span>
</span></span><span><span>            </span><span class="token" style="color:#6f705e">// to get the relative offset of the uint256[] encoded array&#x27;s size.</span><span>
</span></span><span><span>            </span><span class="token" style="color:#ef3b7d">let</span><span> idsLenOffset </span><span class="token" style="color:#a77afe">:=</span><span> </span><span class="token function">add</span><span class="token" style="color:#bebec5">(</span><span class="token function">add</span><span class="token" style="color:#bebec5">(</span><span>message</span><span class="token" style="color:#bebec5">.</span><span>offset</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0x04</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token function">calldataload</span><span class="token" style="color:#bebec5">(</span><span class="token function">add</span><span class="token" style="color:#bebec5">(</span><span>message</span><span class="token" style="color:#bebec5">.</span><span>offset</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0x24</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span>            ids</span><span class="token" style="color:#bebec5">.</span><span>length </span><span class="token" style="color:#a77afe">:=</span><span> </span><span class="token function">calldataload</span><span class="token" style="color:#bebec5">(</span><span>idsLenOffset</span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span>            ids</span><span class="token" style="color:#bebec5">.</span><span>offset </span><span class="token" style="color:#a77afe">:=</span><span> </span><span class="token function">add</span><span class="token" style="color:#bebec5">(</span><span>idsLenOffset</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0x20</span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span>        </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span>
</span><span><span>        </span><span class="token function">_registerIds</span><span class="token" style="color:#bebec5">(</span><span>to</span><span class="token" style="color:#bebec5">,</span><span> ids</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">_registerIds</span><span class="token" style="color:#bebec5">(</span><span class="token builtin">address</span><span> to</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token builtin">uint256</span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token" style="color:#ef3b7d">calldata</span><span> ids</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">internal</span><span> virtual </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        </span><span class="token" style="color:#ef3b7d">for</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token builtin">uint256</span><span> i</span><span class="token" style="color:#bebec5">;</span><span> i </span><span class="token" style="color:#a77afe">&lt;</span><span> ids</span><span class="token" style="color:#bebec5">.</span><span>length</span><span class="token" style="color:#bebec5">;</span><span> </span><span class="token" style="color:#a77afe">++</span><span>i</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>            </span><span class="token function">_registerId</span><span class="token" style="color:#bebec5">(</span><span>to</span><span class="token" style="color:#bebec5">,</span><span> ids</span><span class="token" style="color:#bebec5">[</span><span>i</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<p>Here&#x27;s an example of a call to the function <code>processMessageFromRoot()</code>.</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span>    child</span><span class="token" style="color:#bebec5">.</span><span class="token function">processMessageFromRoot</span><span class="token" style="color:#bebec5">(</span><span>
</span></span><span><span>        </span><span class="token" style="color:#a77afe">1</span><span class="token" style="color:#bebec5">,</span><span>
</span></span><span><span>        </span><span class="token builtin">address</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#ef3b7d">this</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">,</span><span>
</span></span><span><span>        abi</span><span class="token" style="color:#bebec5">.</span><span class="token function">encodeWithSelector</span><span class="token" style="color:#bebec5">(</span><span>REGISTER_ERC721_IDS_SELECTOR</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token builtin">address</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#a77afe">0xbabe</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">31.</span><span class="token function">range</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#a77afe">34</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span></span></code></pre></pre>
<p>In this case, the calldata would look like this.</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span>  </span><span class="token" style="color:#bebec5">[</span><span>selector</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token" style="color:#a77afe">0x9a7c4b71</span><span> </span><span class="token" style="color:#6f705e">// processMessageFromRoot.selector</span><span>
</span></span><span><span>  </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">0x00</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token" style="color:#a77afe">0000000000000000000000000000000000000000000000000000000000000001</span><span> </span><span class="token" style="color:#6f705e">// stateId</span><span>
</span></span><span><span>  </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">0x20</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token" style="color:#a77afe">000000000000000000000000</span><span>b4c79dab8f259c7aee6e5b2aa729821864227e84 </span><span class="token" style="color:#6f705e">// rootMessageSender</span><span>
</span></span><span><span>  </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">0x40</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token" style="color:#a77afe">0000000000000000000000000000000000000000000000000000000000000060</span><span> </span><span class="token" style="color:#6f705e">// message.length offset</span><span>
</span></span><span><span>  </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">0x60</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token" style="color:#a77afe">00000000000000000000000000000000000000000000000000000000000000</span><span>c4 </span><span class="token" style="color:#6f705e">// message.length</span><span>
</span></span><span><span>  </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">0x80</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token" style="color:#a77afe">4</span><span>d26d408000000000000000000000000000000000000000000000000000000000000babe00000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000001f0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000002100000000000000000000000000000000000000000000000000000000 </span><span class="token" style="color:#6f705e">// encoded message</span></span></code></pre></pre>
<blockquote>
<p>Note: Even though the message length is located at message[0x64:0x84] the offset (of message.length) is set to 0x60, since the selector is not counted.</p>
</blockquote>
<p>Because the message is abi-encoded separately, the offsets in the encoded bytes are relative to the start of the message after the selector.</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span>  </span><span class="token" style="color:#bebec5">[</span><span>selector</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token" style="color:#a77afe">0x4d26d408</span><span> </span><span class="token" style="color:#6f705e">// REGISTER_ERC721_IDS_SELECTOR</span><span>
</span></span><span><span>  </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">0x00</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token" style="color:#a77afe">000000000000000000000000000000000000000000000000000000000000</span><span>babe </span><span class="token" style="color:#6f705e">// address to</span><span>
</span></span><span><span>  </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">0x20</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token" style="color:#a77afe">0000000000000000000000000000000000000000000000000000000000000040</span><span> </span><span class="token" style="color:#6f705e">// ids.length relative offset</span><span>
</span></span><span><span>  </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">0x40</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token" style="color:#a77afe">0000000000000000000000000000000000000000000000000000000000000003</span><span> </span><span class="token" style="color:#6f705e">// ids.length</span><span>
</span></span><span><span>  </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">0x60</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token" style="color:#a77afe">000000000000000000000000000000000000000000000000000000000000001</span><span>f </span><span class="token" style="color:#6f705e">// ids[0]</span><span>
</span></span><span><span>  </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">0x80</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token" style="color:#a77afe">0000000000000000000000000000000000000000000000000000000000000020</span><span> </span><span class="token" style="color:#6f705e">// ids[1]</span><span>
</span></span><span><span>  </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">0xa0</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token" style="color:#a77afe">0000000000000000000000000000000000000000000000000000000000000021</span><span> </span><span class="token" style="color:#6f705e">// ids[2]</span><span>
</span></span><span><span>  </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#a77afe">0xc0</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token" style="color:#a77afe">00000000000000000000000000000000000000000000000000000000</span><span> </span><span class="token" style="color:#6f705e">// padded zeros</span></span></code></pre></pre>
<p>This means that, if we want to get the correct calldata offset for <code>ids.offset</code>, we need
to load the word located at 0x20 in the encoded message. In order to get the absolute position in the calldata, we thus need to add the offset of the message in the calldata to 0x24 - the 4 bytes selector from the message must be taken into account, since the message is embedded into the calldata as bytes.</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span>    </span><span class="token" style="color:#ef3b7d">let</span><span> idsOffsetRel </span><span class="token" style="color:#a77afe">:=</span><span> </span><span class="token function">calldataload</span><span class="token" style="color:#bebec5">(</span><span class="token function">add</span><span class="token" style="color:#bebec5">(</span><span>message</span><span class="token" style="color:#bebec5">.</span><span>offset</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0x24</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span></span></code></pre></pre>
<p>Now to get the absolute offset of <code>ids.length</code> we need to add the position of where the relative offset in the message starts: <code>message.offset + 0x04</code> - the starting location of the message + the encoded selector.</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span>    </span><span class="token" style="color:#ef3b7d">let</span><span> idsLenOffset </span><span class="token" style="color:#a77afe">:=</span><span> </span><span class="token function">add</span><span class="token" style="color:#bebec5">(</span><span class="token function">add</span><span class="token" style="color:#bebec5">(</span><span>message</span><span class="token" style="color:#bebec5">.</span><span>offset</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0x04</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">,</span><span> idsOffsetRel</span><span class="token" style="color:#bebec5">)</span></span></code></pre></pre>
<p>Now that we have the offset of the length, we just need to load it from the calldata. By looking at the encoding we can also see that we simply need to add one word (0x20) to find the start of the <code>uint256[]</code> data - <code>ids.offset</code>.</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span>    ids</span><span class="token" style="color:#bebec5">.</span><span>length </span><span class="token" style="color:#a77afe">:=</span><span> </span><span class="token function">calldataload</span><span class="token" style="color:#bebec5">(</span><span>idsLenOffset</span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span>    ids</span><span class="token" style="color:#bebec5">.</span><span>offset </span><span class="token" style="color:#a77afe">:=</span><span> </span><span class="token function">add</span><span class="token" style="color:#bebec5">(</span><span>idsLenOffset</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0x20</span><span class="token" style="color:#bebec5">)</span></span></code></pre></pre>
<h3 id="why-not-just-hardcode-the-offset"><a href="/blog/2022/abi-decoding-calldata#why-not-just-hardcode-the-offset"><span class="icon icon-link"></span></a>Why not just hardcode the offset?</h3>
<p>We could also simply hardcode the values for <code>ids.length</code> and <code>ids.offset</code> after we have calculated them once.</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span>    ids</span><span class="token" style="color:#bebec5">.</span><span>offset </span><span class="token" style="color:#a77afe">:=</span><span> </span><span class="token" style="color:#a77afe">0xe8</span><span>
</span></span><span><span>    ids</span><span class="token" style="color:#bebec5">.</span><span>length </span><span class="token" style="color:#a77afe">:=</span><span> </span><span class="token function">calldataload</span><span class="token" style="color:#bebec5">(</span><span class="token function">sub</span><span class="token" style="color:#bebec5">(</span><span>ids</span><span class="token" style="color:#bebec5">.</span><span>offset</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0x20</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span></span></code></pre></pre>
<p>This works as long as the function signature won&#x27;t change (so that the offset of <code>message</code> doesn&#x27;t change) and the calldata is encoded in a standard way.</p>
<p>We can create a non-standard encoding by adding useless filler data for example and we quickly see why the hardcoded version will not work anymore.</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span>    </span><span class="token builtin">address</span><span class="token" style="color:#bebec5">(</span><span>child</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">.</span><span class="token function">call</span><span class="token" style="color:#bebec5">(</span><span>
</span></span><span><span>        hex</span><span class="token" style="color:#e6d06c">&quot;9a7c4b71&quot;</span><span>                                                         </span><span class="token" style="color:#6f705e">// processMessageFromRoot.selector</span><span>
</span></span><span><span>        hex</span><span class="token" style="color:#e6d06c">&quot;0000000000000000000000000000000000000000000000000000000000000001&quot;</span><span> </span><span class="token" style="color:#6f705e">// stateId</span><span>
</span></span><span><span>        hex</span><span class="token" style="color:#e6d06c">&quot;000000000000000000000000b4c79dab8f259c7aee6e5b2aa729821864227e84&quot;</span><span> </span><span class="token" style="color:#6f705e">// rootMessageSender</span><span>
</span></span><span><span>        hex</span><span class="token" style="color:#e6d06c">&quot;0000000000000000000000000000000000000000000000000000000000000080&quot;</span><span> </span><span class="token" style="color:#6f705e">// message.length offset</span><span>
</span></span><span><span>        hex</span><span class="token" style="color:#e6d06c">&quot;ccaaffeeccaaffeeccaaffeeccaaffeeccaaffeeccaaffeeccaaffeeccaaffee&quot;</span><span> </span><span class="token" style="color:#6f705e">// ??</span><span>
</span></span><span><span>        hex</span><span class="token" style="color:#e6d06c">&quot;00000000000000000000000000000000000000000000000000000000000000e4&quot;</span><span> </span><span class="token" style="color:#6f705e">// message.length</span><span>
</span></span><span><span>        hex</span><span class="token" style="color:#e6d06c">&quot;4d26d408&quot;</span><span>                                                         </span><span class="token" style="color:#6f705e">// REGISTER_ERC721_IDS_SELECTOR</span><span>
</span></span><span><span>        hex</span><span class="token" style="color:#e6d06c">&quot;000000000000000000000000000000000000000000000000000000000000babe&quot;</span><span> </span><span class="token" style="color:#6f705e">// address to</span><span>
</span></span><span><span>        hex</span><span class="token" style="color:#e6d06c">&quot;0000000000000000000000000000000000000000000000000000000000000060&quot;</span><span> </span><span class="token" style="color:#6f705e">// ids.length relative offset</span><span>
</span></span><span><span>        hex</span><span class="token" style="color:#e6d06c">&quot;ccaaffeeccaaffeeccaaffeeccaaffeeccaaffeeccaaffeeccaaffeeccaaffee&quot;</span><span> </span><span class="token" style="color:#6f705e">// ??</span><span>
</span></span><span><span>        hex</span><span class="token" style="color:#e6d06c">&quot;0000000000000000000000000000000000000000000000000000000000000003&quot;</span><span> </span><span class="token" style="color:#6f705e">// ids.length</span><span>
</span></span><span><span>        hex</span><span class="token" style="color:#e6d06c">&quot;000000000000000000000000000000000000000000000000000000000000001f&quot;</span><span> </span><span class="token" style="color:#6f705e">// ids[0]</span><span>
</span></span><span><span>        hex</span><span class="token" style="color:#e6d06c">&quot;0000000000000000000000000000000000000000000000000000000000000020&quot;</span><span> </span><span class="token" style="color:#6f705e">// ids[1]</span><span>
</span></span><span><span>        hex</span><span class="token" style="color:#e6d06c">&quot;0000000000000000000000000000000000000000000000000000000000000021&quot;</span><span> </span><span class="token" style="color:#6f705e">// ids[2]</span><span>
</span></span><span><span>        hex</span><span class="token" style="color:#e6d06c">&quot;00000000000000000000000000000000000000000000000000000000&quot;</span><span>         </span><span class="token" style="color:#6f705e">// padded zeros</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span></span></code></pre></pre>
<p>Without hardcoding the offsets, reading the <code>uint256[] calldata</code> from the above encoding will still be possible.</p>
<h2 id="gas-savings"><a href="/blog/2022/abi-decoding-calldata#gas-savings"><span class="icon icon-link"></span></a>Gas Savings</h2>
<p>Abi-decoding directly to calldata can avoid copying data to memory.
This saves us a few <code>mstore</code> and <code>mload</code> operations.
Below is a comparison of the gas savings for encoding a certain number of ids.</p>







































































<table><thead><tr><th>#ids</th><th>Calldata</th><th>Memory</th><th>Difference</th></tr></thead><tbody><tr><td>0</td><td>1125</td><td>1552</td><td>427</td></tr><tr><td>1</td><td>2271</td><td>2775</td><td>504</td></tr><tr><td>2</td><td>3197</td><td>3781</td><td>584</td></tr><tr><td>3</td><td>4126</td><td>4790</td><td>664</td></tr><tr><td>4</td><td>5050</td><td>5794</td><td>744</td></tr><tr><td>5</td><td>5977</td><td>6801</td><td>824</td></tr><tr><td>6</td><td>6904</td><td>7809</td><td>905</td></tr><tr><td>7</td><td>7835</td><td>8820</td><td>985</td></tr><tr><td>8</td><td>8760</td><td>9825</td><td>1065</td></tr><tr><td>9</td><td>9694</td><td>10839</td><td>1145</td></tr></tbody></table>
<p>In this case, using calldata over memory can save us 427 gas + roughly an additional 80 gas per extra word.</p></div></div></div></main></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"slug":["blog","2022","abi-decoding-calldata"],"contentRaw":"\n`abi.decode(data, (type))` can be used to decode abi-encoded bytes located in memory and calldata. Currently, it's only possible to assign dynamic types to memory. Decoding to calldata is not supported yet, however, this can still be achieved manually.\n\nSay we wanted to send a NFT cross-chain. For this we have have to encode a message that could look like this.\n\n```FxERC721Root.sol\nbytes4 constant REGISTER_ERC721_IDS_SELECTOR = \n    bytes4(keccak256(\"registerERC721IdsWithChild(address,uint256[])\"));\n\n    function _registerERC721IdsWithChild(address to, uint256[] calldata ids) internal virtual {\n        bytes memory message = abi.encodeWithSelector(REGISTER_ERC721_IDS_SELECTOR, to, ids); // highlight-line\n\n        _sendMessageToChild(message);\n    }\n```\n\nThe child chain can receive the full message as `calldata`, run some security checks and then process it in another function.\n\n\n```FxERC721Child.sol\n    function processMessageFromRoot(\n        uint256 stateId,\n        address rootMessageSender,\n        bytes calldata message // highlight-line\n    ) external {\n        if (msg.sender != fxChild) revert CallerNotFxChild();\n        if (rootMessageSender == address(0) || rootMessageSender != s().fxRootTunnel) revert InvalidRootSender();\n\n        _processMessageFromRoot(stateId, rootMessageSender, message);\n    }\n```\n\nSolidity does not allow us to decode the ids as a `uint256[] calldata` array directly yet. I.e. the following \n```solidity\n    (address to, uint256[] calldata ids) = abi.decode(message[4:], (address, uint256[]));\n```\nwould fail with the message:\n`\"TypeError: Type uint256[] memory is not implicitly convertible to expected type uint256[] calldata.\"`\n\nHowever, by declaring `uint256[] calldata ids;` and manually setting `ids.offset` and `ids.length` via assembly, we can manually decode the data.\nFor more on the abi encoding spec, read up on the [docs](https://docs.soliditylang.org/en/v0.8.17/abi-spec.html#argument-encoding).\n\n```FxERC721Child.sol\n    function _processMessageFromRoot(\n        uint256,\n        address,\n        bytes calldata message\n    ) internal virtual override {\n        bytes4 selector = bytes4(message);\n\n        if (selector != REGISTER_ERC721_IDS_SELECTOR) revert InvalidSelector();\n\n        address to = address(uint160(uint256(bytes32(message[4:36]))));\n\n        uint256[] calldata ids;\n        // abi-decode `ids` directly in calldata.\n        assembly {\n            // Skip bytes4 selector + bytes32 encoded address\n            // starting from message's offset in calldata\n            // to get the relative offset of the uint256[] encoded array's size.\n            let idsLenOffset := add(add(message.offset, 0x04), calldataload(add(message.offset, 0x24)))\n            ids.length := calldataload(idsLenOffset)\n            ids.offset := add(idsLenOffset, 0x20)\n        }\n\n        _registerIds(to, ids);\n    }\n\n    function _registerIds(address to, uint256[] calldata ids) internal virtual {\n        for (uint256 i; i \u003c ids.length; ++i) {\n            _registerId(to, ids[i]);\n        }\n    }\n```\n\nHere's an example of a call to the function `processMessageFromRoot()`.\n\n```sol\n    child.processMessageFromRoot(\n        1,\n        address(this),\n        abi.encodeWithSelector(REGISTER_ERC721_IDS_SELECTOR, address(0xbabe), 31.range(34))\n    );\n```\n\nIn this case, the calldata would look like this.\n\n```sol\n  [selector] 0x9a7c4b71 // processMessageFromRoot.selector\n  [0x00] 0000000000000000000000000000000000000000000000000000000000000001 // stateId\n  [0x20] 000000000000000000000000b4c79dab8f259c7aee6e5b2aa729821864227e84 // rootMessageSender\n  [0x40] 0000000000000000000000000000000000000000000000000000000000000060 // message.length offset\n  [0x60] 00000000000000000000000000000000000000000000000000000000000000c4 // message.length\n  [0x80] 4d26d408000000000000000000000000000000000000000000000000000000000000babe00000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000001f0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000002100000000000000000000000000000000000000000000000000000000 // encoded message\n```\n\n\u003e Note: Even though the message length is located at message[0x64:0x84] the offset (of message.length) is set to 0x60, since the selector is not counted.\n\nBecause the message is abi-encoded separately, the offsets in the encoded bytes are relative to the start of the message after the selector.\n\n```sol\n  [selector] 0x4d26d408 // REGISTER_ERC721_IDS_SELECTOR\n  [0x00] 000000000000000000000000000000000000000000000000000000000000babe // address to\n  [0x20] 0000000000000000000000000000000000000000000000000000000000000040 // ids.length relative offset\n  [0x40] 0000000000000000000000000000000000000000000000000000000000000003 // ids.length\n  [0x60] 000000000000000000000000000000000000000000000000000000000000001f // ids[0]\n  [0x80] 0000000000000000000000000000000000000000000000000000000000000020 // ids[1]\n  [0xa0] 0000000000000000000000000000000000000000000000000000000000000021 // ids[2]\n  [0xc0] 00000000000000000000000000000000000000000000000000000000 // padded zeros\n```\n\nThis means that, if we want to get the correct calldata offset for `ids.offset`, we need\nto load the word located at 0x20 in the encoded message. In order to get the absolute position in the calldata, we thus need to add the offset of the message in the calldata to 0x24 - the 4 bytes selector from the message must be taken into account, since the message is embedded into the calldata as bytes.\n\n```sol\n    let idsOffsetRel := calldataload(add(message.offset, 0x24))\n```\n\nNow to get the absolute offset of `ids.length` we need to add the position of where the relative offset in the message starts: `message.offset + 0x04` - the starting location of the message + the encoded selector.\n\n```sol\n    let idsLenOffset := add(add(message.offset, 0x04), idsOffsetRel)\n```\n\nNow that we have the offset of the length, we just need to load it from the calldata. By looking at the encoding we can also see that we simply need to add one word (0x20) to find the start of the `uint256[]` data - `ids.offset`.\n\n```sol\n    ids.length := calldataload(idsLenOffset)\n    ids.offset := add(idsLenOffset, 0x20)\n```\n\n## Why not just hardcode the offset?\n\nWe could also simply hardcode the values for `ids.length` and `ids.offset` after we have calculated them once. \n\n```sol\n    ids.offset := 0xe8\n    ids.length := calldataload(sub(ids.offset, 0x20))\n```\n\nThis works as long as the function signature won't change (so that the offset of `message` doesn't change) and the calldata is encoded in a standard way.\n\nWe can create a non-standard encoding by adding useless filler data for example and we quickly see why the hardcoded version will not work anymore.\n\n```sol\n    address(child).call(\n        hex\"9a7c4b71\"                                                         // processMessageFromRoot.selector\n        hex\"0000000000000000000000000000000000000000000000000000000000000001\" // stateId\n        hex\"000000000000000000000000b4c79dab8f259c7aee6e5b2aa729821864227e84\" // rootMessageSender\n        hex\"0000000000000000000000000000000000000000000000000000000000000080\" // message.length offset\n        hex\"ccaaffeeccaaffeeccaaffeeccaaffeeccaaffeeccaaffeeccaaffeeccaaffee\" // ??\n        hex\"00000000000000000000000000000000000000000000000000000000000000e4\" // message.length\n        hex\"4d26d408\"                                                         // REGISTER_ERC721_IDS_SELECTOR\n        hex\"000000000000000000000000000000000000000000000000000000000000babe\" // address to\n        hex\"0000000000000000000000000000000000000000000000000000000000000060\" // ids.length relative offset\n        hex\"ccaaffeeccaaffeeccaaffeeccaaffeeccaaffeeccaaffeeccaaffeeccaaffee\" // ??\n        hex\"0000000000000000000000000000000000000000000000000000000000000003\" // ids.length\n        hex\"000000000000000000000000000000000000000000000000000000000000001f\" // ids[0]\n        hex\"0000000000000000000000000000000000000000000000000000000000000020\" // ids[1]\n        hex\"0000000000000000000000000000000000000000000000000000000000000021\" // ids[2]\n        hex\"00000000000000000000000000000000000000000000000000000000\"         // padded zeros\n    );\n```\n\nWithout hardcoding the offsets, reading the `uint256[] calldata` from the above encoding will still be possible.\n\n\n\n\n# Gas Savings\n\nAbi-decoding directly to calldata can avoid copying data to memory.\nThis saves us a few `mstore` and `mload` operations.\nBelow is a comparison of the gas savings for encoding a certain number of ids.\n\n\n| #ids | Calldata | Memory | Difference |\n| --- | --- | --- | ---- |\n| 0 | 1125 |1552 | 427 |\n| 1 | 2271 |2775 | 504 |\n| 2 | 3197 |3781 | 584 |\n| 3 | 4126 |4790 | 664 |\n| 4 | 5050 |5794 | 744 |\n| 5 | 5977 |6801 | 824 |\n| 6 | 6904 |7809 | 905 |\n| 7 | 7835 |8820 | 985 |\n| 8 | 8760 |9825 | 1065 |\n| 9 | 9694 |10839 | 1145 |\n\n\nIn this case, using calldata over memory can save us 427 gas + roughly an additional 80 gas per extra word.","title":"ABI-Decoding Calldata","date":"Oct 22, 2022","excerpt":"Abi-decode directly in calldata without using memory."}},"__N_SSG":true},"page":"/[...slug]","query":{"slug":["blog","2022","abi-decoding-calldata"]},"buildId":"DAJAm56ZaJfpNiejQOpy7","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>
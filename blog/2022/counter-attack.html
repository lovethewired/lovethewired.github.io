<!DOCTYPE html><html><head><meta charSet="utf-8"/><title class="animate__fadeIn">0xPhaze</title><meta name="viewport" content="initial-scale=1.0, width=device-width"/><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/fcf81e63369216ac.css" as="style"/><link rel="stylesheet" href="/_next/static/css/fcf81e63369216ac.css" data-n-g=""/><link rel="preload" href="/_next/static/css/65875c30e26bdd78.css" as="style"/><link rel="stylesheet" href="/_next/static/css/65875c30e26bdd78.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-ede13cf31a63337e.js" defer=""></script><script src="/_next/static/chunks/framework-bb5c596eafb42b22.js" defer=""></script><script src="/_next/static/chunks/main-914fbfab4f90b52f.js" defer=""></script><script src="/_next/static/chunks/pages/_app-ad82082731d58181.js" defer=""></script><script src="/_next/static/chunks/175675d1-5e59763be147fa1f.js" defer=""></script><script src="/_next/static/chunks/634-958ce5c52c8283ef.js" defer=""></script><script src="/_next/static/chunks/pages/%5B...slug%5D-1036fd4ff48bafcd.js" defer=""></script><script src="/_next/static/qoAvV12bmT3RNNDcIsL6_/_buildManifest.js" defer=""></script><script src="/_next/static/qoAvV12bmT3RNNDcIsL6_/_ssgManifest.js" defer=""></script><script src="/_next/static/qoAvV12bmT3RNNDcIsL6_/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="app px-4 pb-20 min-h-screen flex flex-col items-center w-full max-w-screen"><header class="w-full flex flex-col px-4 sm:px-8 md:px-12 max-w-5xl sm:flex-row justify-between items-center border-white/20 overflow-hidden border-b p-4 h-16"><div class="w-full h-full flex flex-col sm:flex-row justify-start sm:justify-between items-center gap-y-4 overflow-hidden sm:overflow-visible"><div class="flex w-full sm:w-fit items-center"><h1 class="text-xl mx-auto font-display"><a href="/">0xPhaze</a></h1><div class="my-auto -ml-6 w-6 sm:hidden"><div class="text-slate-300 hover:text-secondary-400 transition-colors duration-200 cursor-pointer h-6"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="bars" class="svg-inline--fa fa-bars " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416C433.7 64 448 78.33 448 96C448 113.7 433.7 128 416 128H32C14.33 128 0 113.7 0 96zM0 256C0 238.3 14.33 224 32 224H416C433.7 224 448 238.3 448 256C448 273.7 433.7 288 416 288H32C14.33 288 0 273.7 0 256zM416 448H32C14.33 448 0 433.7 0 416C0 398.3 14.33 384 32 384H416C433.7 384 448 398.3 448 416C448 433.7 433.7 448 416 448z"></path></svg></div></div></div><div class="flex flex-col sm:flex-row gap-x-8 md:gap-x-10 gap-y-4"><div class="flex gap-x-2 sm:gap-x-5 items-center justify-evenly"><a target="_blank" rel="noreferrer" class="link" href="https://github.com/0xPhaze/"><div><div class="text-slate-300 hover:text-secondary-400 transition-colors duration-200 cursor-pointer"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-4"><path style="fill:currentColor" d="M12 0C5.374 0 0 5.373 0 12c0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23A11.509 11.509 0 0 1 12 5.803c1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.3 24 12c0-6.627-5.373-12-12-12z"></path></svg></div></div></a><a target="_blank" rel="noreferrer" class="link" href="https://twitter.com/lovethewired"><div><div class="text-slate-300 hover:text-secondary-400 transition-colors duration-200 cursor-pointer"><svg viewBox="0 0 16 14" fill="none" xmlns="http://www.w3.org/2000/svg" class="h-4"><path style="fill:currentColor" d="M15.584 1.578a7.91 7.91 0 0 1-1.57 1.807v.482c0 .965-.112 1.929-.336 2.772-.224.965-.673 1.808-1.121 2.652a17.373 17.373 0 0 1-1.794 2.29c-.785.723-1.681 1.205-2.578 1.566-1.01.362-2.13.603-3.252.603-1.793 0-3.475-.603-4.932-1.567h.784c1.458 0 2.915-.482 4.036-1.446a2.914 2.914 0 0 1-1.905-.723c-.561-.482-.897-.964-1.122-1.687h.561c.336 0 .56 0 .897-.12C2.579 8.085 1.907 7.603 1.458 7 .785 6.398.561 5.675.561 4.83c.449.242 1.01.362 1.458.483A5.531 5.531 0 0 1 .898 4.109C.673 3.626.449 3.024.449 2.42c0-.602.112-1.205.449-1.687a8.606 8.606 0 0 0 2.914 2.53c1.122.603 2.355.965 3.7 1.086 0-.241-.112-.483-.112-.844 0-.723.224-1.326.56-1.928.337-.603.897-.965 1.458-1.326.56-.241 1.233-.362 1.906-.12.672.12 1.233.481 1.681.964.673-.121 1.458-.362 2.018-.844-.224.844-.784 1.446-1.457 1.928.785-.12 1.457-.24 2.018-.602Z" fill="#081026"></path></svg></div></div></a><div><div class="text-slate-300 hover:text-secondary-400 transition-colors duration-200 cursor-pointer">ABI</div></div><div><div class="text-slate-300 hover:text-secondary-400 transition-colors duration-200 cursor-pointer">ENC</div></div></div><button class="rounded px-4 py-2 uppercase text-white select-none  transition-all duration-300 disabled:pointer-events-none bg-primary-600 hover:bg-primary-700  !outline-none normal-case text-sm w-[140px] w-36">Connect Wallet</button></div></div></header><main class="gap-y-20 mt-8 py-4 sm:px-8 md:px-12 w-full min-h-[500px] max-w-4xl"><div class="flex flex-col justify-between gap-y-20"><div class="content markdown"><h1 class="text-center">Counter-Attack to the Attack</h1><h2 class="text-center">aka &quot;Hackers hate this one weird trick&quot;</h2><p class="text-slate-500 text-sm text-center">Mar 12, 2022</p><div class="mt-16"><p>My <a href="/blog/2022/unexpected-input">last post</a>, which was about an exploit allowing
unlimited minting of an ERC20 token got me thinking about whether any counter-measures
could be implemented if such an exploit were to happen.</p>
<p>Below is the contract of the MadMouse utility token Gouda, which I&#x27;m currently developing.
It&#x27;s a standard ERC20 token combined with OpenZeppelin&#x27;s AccessControl contract.</p>
<pre><pre before="Gouda.sol" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span class="token" style="color:#6f705e">// SPDX-License-Identifier: MIT</span><span>
</span></span><span><span></span><span class="token" style="color:#ef3b7d">pragma</span><span> </span><span class="token" style="color:#ef3b7d">solidity</span><span> </span><span class="token" style="color:#a77afe">^</span><span class="token version" style="color:#a77afe">0.8.0</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span></span><span class="token" style="color:#ef3b7d">import</span><span> </span><span class="token" style="color:#e6d06c">&#x27;@openzeppelin/contracts/access/AccessControl.sol&#x27;</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span></span><span class="token" style="color:#ef3b7d">import</span><span> </span><span class="token" style="color:#e6d06c">&#x27;@openzeppelin/contracts/token/ERC20/ERC20.sol&#x27;</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span></span><span class="token" style="color:#ef3b7d">import</span><span> </span><span class="token" style="color:#e6d06c">&#x27;./lib/ERC721MStaking.sol&#x27;</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>error </span><span class="token function">ExceedsMaxSupply</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span></span><span class="token" style="color:#ef3b7d">contract</span><span> </span><span class="token class-name">Gouda</span><span> </span><span class="token" style="color:#ef3b7d">is</span><span> ERC20</span><span class="token" style="color:#bebec5">,</span><span> AccessControl</span><span class="token" style="color:#bebec5">,</span><span> IERC20Reward </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>    </span><span class="token builtin">bytes32</span><span> </span><span class="token" style="color:#ef3b7d">private</span><span> </span><span class="token" style="color:#ef3b7d">constant</span><span> MINT_AUTHORITY </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">keccak256</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#e6d06c">&#x27;MINT_AUTHORITY&#x27;</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token builtin">bytes32</span><span> </span><span class="token" style="color:#ef3b7d">private</span><span> </span><span class="token" style="color:#ef3b7d">constant</span><span> BURN_AUTHORITY </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">keccak256</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#e6d06c">&#x27;BURN_AUTHORITY&#x27;</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#ef3b7d">constructor</span><span class="token" style="color:#bebec5">(</span><span class="token builtin">address</span><span> madmouse</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token builtin">address</span><span> treasury</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token function">ERC20</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#e6d06c">&#x27;Gouda&#x27;</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#e6d06c">&#x27;GOUDA&#x27;</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        </span><span class="token function">_setupRole</span><span class="token" style="color:#bebec5">(</span><span>DEFAULT_ADMIN_ROLE</span><span class="token" style="color:#bebec5">,</span><span> msg</span><span class="token" style="color:#bebec5">.</span><span>sender</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        </span><span class="token function">_setupRole</span><span class="token" style="color:#bebec5">(</span><span>MINT_AUTHORITY</span><span class="token" style="color:#bebec5">,</span><span> madmouse</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        </span><span class="token function">_setupRole</span><span class="token" style="color:#bebec5">(</span><span>BURN_AUTHORITY</span><span class="token" style="color:#bebec5">,</span><span> madmouse</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        </span><span class="token function">_mint</span><span class="token" style="color:#bebec5">(</span><span>treasury</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">100</span><span>_000 </span><span class="token" style="color:#a77afe">*</span><span> </span><span class="token" style="color:#a77afe">1e18</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#6f705e">// ------------- Restricted -------------</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">mint</span><span class="token" style="color:#bebec5">(</span><span class="token builtin">address</span><span> user</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token builtin">uint256</span><span> amount</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">external</span><span> </span><span class="token function">onlyRole</span><span class="token" style="color:#bebec5">(</span><span>MINT_AUTHORITY</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        </span><span class="token function">_mint</span><span class="token" style="color:#bebec5">(</span><span>user</span><span class="token" style="color:#bebec5">,</span><span> amount</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">burn</span><span class="token" style="color:#bebec5">(</span><span class="token builtin">address</span><span> user</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token builtin">uint256</span><span> amount</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">external</span><span> </span><span class="token function">onlyRole</span><span class="token" style="color:#bebec5">(</span><span>BURN_AUTHORITY</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        </span><span class="token function">_burn</span><span class="token" style="color:#bebec5">(</span><span>user</span><span class="token" style="color:#bebec5">,</span><span> amount</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<h2 id="a-counter-measure-to-an-attack"><a href="/blog/2022/counter-attack#a-counter-measure-to-an-attack"><span class="icon icon-link"></span></a>A counter-measure to an attack</h2>
<p>In the case of an attacker being able to exploit the staking contract,
they would likely mint a high number of tokens not achievable by normal staking.</p>
<p>What if we restrict the mint function to revert in such a case?</p>
<pre><pre before="Gouda.sol" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span class="token" style="color:#ef3b7d">contract</span><span> </span><span class="token class-name">Gouda</span><span> </span><span class="token" style="color:#ef3b7d">is</span><span> ERC20</span><span class="token" style="color:#bebec5">,</span><span> AccessControl</span><span class="token" style="color:#bebec5">,</span><span> IERC20Reward </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#bebec5">.</span><span class="token" style="color:#bebec5">.</span><span class="token" style="color:#bebec5">.</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">mint</span><span class="token" style="color:#bebec5">(</span><span class="token builtin">address</span><span> user</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token builtin">uint256</span><span> amount</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">external</span><span> </span><span class="token function">onlyRole</span><span class="token" style="color:#bebec5">(</span><span>MINT_AUTHORITY</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        </span><span class="token" style="color:#ef3b7d">require</span><span class="token" style="color:#bebec5">(</span><span>amount </span><span class="token" style="color:#a77afe">&gt;</span><span> </span><span class="token" style="color:#a77afe">500</span><span>_000 </span><span class="token" style="color:#a77afe">*</span><span> </span><span class="token" style="color:#a77afe">1e18</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#e6d06c">&#x27;UNDER_ATTACK&#x27;</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        </span><span class="token function">_mint</span><span class="token" style="color:#bebec5">(</span><span>user</span><span class="token" style="color:#bebec5">,</span><span> amount</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<p>This would be too noticeable for an attacker. They would most likely realise the revert when testing locally
and if the first attack failed, they could simply launch many more, smaller ones to bypass the limit.</p>
<p>What if we instead let the call go through and then revoke the <code>MINT_AUTHORITY</code> role of the
staking contract? That way, the funds could remain safe until a solution has been found.</p>
<pre><pre before="Gouda.sol" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span class="token" style="color:#ef3b7d">contract</span><span> </span><span class="token class-name">Gouda</span><span> </span><span class="token" style="color:#ef3b7d">is</span><span> ERC20</span><span class="token" style="color:#bebec5">,</span><span> AccessControl</span><span class="token" style="color:#bebec5">,</span><span> IERC20Reward </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#bebec5">.</span><span class="token" style="color:#bebec5">.</span><span class="token" style="color:#bebec5">.</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">mint</span><span class="token" style="color:#bebec5">(</span><span class="token builtin">address</span><span> user</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token builtin">uint256</span><span> amount</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">external</span><span> </span><span class="token function">onlyRole</span><span class="token" style="color:#bebec5">(</span><span>MINT_AUTHORITY</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        </span><span class="token" style="color:#ef3b7d">if</span><span> </span><span class="token" style="color:#bebec5">(</span><span>amount </span><span class="token" style="color:#a77afe">&lt;</span><span> </span><span class="token" style="color:#a77afe">500</span><span>_000 </span><span class="token" style="color:#a77afe">*</span><span> </span><span class="token" style="color:#a77afe">1e18</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token function">_mint</span><span class="token" style="color:#bebec5">(</span><span>user</span><span class="token" style="color:#bebec5">,</span><span> amount</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        </span><span class="token" style="color:#ef3b7d">else</span><span> </span><span class="token function">_revokeRole</span><span class="token" style="color:#bebec5">(</span><span>MINT_AUTHORITY</span><span class="token" style="color:#bebec5">,</span><span> madmouse</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span> </span><span class="token" style="color:#6f705e">// emergency shutdown</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<p>Hm.. so far so good. Although, they would likely run
tests on a local network first to check whether their attack was successful
and their token balance increased.</p>
<p><a target="_blank" rel="noreferrer" class="link" href="https://eips.ethereum.org/EIPS/eip-1344">EIP-1344</a> introduced the ChainID opcode
which can now be accessed through <code>block.chainid</code>.
This way, we could have our fail-safe code run only when the chain
is on mainnet (chain id 1).
We can also add further checks, since some providers will set <code>tx.origin = address(0)</code>
when running &#x27;call&#x27; methods (i.e. calls that are not sent to the blockchain to be mined).</p>
<pre><pre before="Gouda.sol" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span class="token" style="color:#ef3b7d">contract</span><span> </span><span class="token class-name">Gouda</span><span> </span><span class="token" style="color:#ef3b7d">is</span><span> ERC20</span><span class="token" style="color:#bebec5">,</span><span> AccessControl</span><span class="token" style="color:#bebec5">,</span><span> IERC20Reward </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#bebec5">.</span><span class="token" style="color:#bebec5">.</span><span class="token" style="color:#bebec5">.</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">mint</span><span class="token" style="color:#bebec5">(</span><span class="token builtin">address</span><span> user</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token builtin">uint256</span><span> amount</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">external</span><span> </span><span class="token function">onlyRole</span><span class="token" style="color:#bebec5">(</span><span>MINT_AUTHORITY</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span class="line line-hl"><span>        </span><span class="token" style="color:#ef3b7d">if</span><span> </span><span class="token" style="color:#bebec5">(</span><span>amount </span><span class="token" style="color:#a77afe">&lt;</span><span> </span><span class="token" style="color:#a77afe">500</span><span>_000 </span><span class="token" style="color:#a77afe">*</span><span> </span><span class="token" style="color:#a77afe">1e18</span><span>  
</span></span><span class="line line-hl"><span>            </span><span class="token" style="color:#a77afe">||</span><span> block</span><span class="token" style="color:#bebec5">.</span><span>chainid </span><span class="token" style="color:#a77afe">!=</span><span> </span><span class="token" style="color:#a77afe">1</span><span>  
</span></span><span class="line line-hl"><span>            </span><span class="token" style="color:#a77afe">||</span><span> tx</span><span class="token" style="color:#bebec5">.</span><span>origin </span><span class="token" style="color:#a77afe">==</span><span> </span><span class="token builtin">address</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span> 
</span></span><span class="line line-hl"><span>            </span><span class="token function">_mint</span><span class="token" style="color:#bebec5">(</span><span>user</span><span class="token" style="color:#bebec5">,</span><span> amount</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span> 
</span></span><span class="line line-hl"><span>        </span><span class="token" style="color:#bebec5">}</span><span> 
</span></span><span><span>        </span><span class="token" style="color:#ef3b7d">else</span><span> </span><span class="token function">_revokeRole</span><span class="token" style="color:#bebec5">(</span><span>MINT_AUTHORITY</span><span class="token" style="color:#bebec5">,</span><span> madmouse</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<p>Ok, getting there..
Now, if the attacker tests out their exploit locally, they would be able to mint the
tokens, and if it were to execute on mainnet, the emergency shutdown code would be called.</p>
<p>Still, any quick peak at the contract will directly expose this counter-measure.
So, how can we hide it?</p>
<p>Hiding it in the ERC20.sol contract directly would seem infeasible, because we are trying
to access <code>_revokeRole</code> from AccessControl to automatically trigger the emergency shutdown.
ERC20&#x27;s implementation comes with the hooks <code>_beforeTokenTransfer</code> and <code>_afterTokenTransfer</code>.
Perhaps these could be used in some form..</p>
<p>I tried modifying &#x27;@openzeppelin/contracts/access/AccessControl.sol&#x27;
to inherit from ERC20.sol.
That way, AccessControl could be implementing the special hooks.
The only problem with this is that we&#x27;re now inheriting from two contracts that implement an
<code>_afterTokenTransfer</code> and thus are required to override it again in our ERC20 contract.
This, in turn would look suspicious again,
because &quot;wth is AccessControl doing implementing an <code>_afterTokenTransfer</code>?&quot;</p>
<pre><pre before="Gouda.sol" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span class="token" style="color:#ef3b7d">contract</span><span> </span><span class="token class-name">Gouda</span><span> </span><span class="token" style="color:#ef3b7d">is</span><span> ERC20</span><span class="token" style="color:#bebec5">,</span><span> AccessControl</span><span class="token" style="color:#bebec5">,</span><span> IERC20Reward </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#bebec5">.</span><span class="token" style="color:#bebec5">.</span><span class="token" style="color:#bebec5">.</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">_afterTokenTransfer</span><span class="token" style="color:#bebec5">(</span><span>
</span></span><span><span>        </span><span class="token builtin">address</span><span> </span><span class="token" style="color:#ef3b7d">from</span><span class="token" style="color:#bebec5">,</span><span>
</span></span><span><span>        </span><span class="token builtin">address</span><span> to</span><span class="token" style="color:#bebec5">,</span><span>
</span></span><span><span>        </span><span class="token builtin">uint256</span><span> amount
</span></span><span><span>    </span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">internal</span><span> </span><span class="token function">override</span><span class="token" style="color:#bebec5">(</span><span>ERC20</span><span class="token" style="color:#bebec5">,</span><span> AccessControl</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        super</span><span class="token" style="color:#bebec5">.</span><span class="token function">_afterTokenTransfer</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#ef3b7d">from</span><span class="token" style="color:#bebec5">,</span><span> to</span><span class="token" style="color:#bebec5">,</span><span> amount</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<p>What if... we kept this piece of code in the ERC20.sol implementation and directly modified storage slots?
For that, we would have to figure out what storage slot is being used to grant the staking contract the authority.</p>
<pre><pre before="AccessControl.sol" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span>abstract </span><span class="token" style="color:#ef3b7d">contract</span><span> </span><span class="token class-name">AccessControl</span><span> </span><span class="token" style="color:#ef3b7d">is</span><span> Context</span><span class="token" style="color:#bebec5">,</span><span> IAccessControl</span><span class="token" style="color:#bebec5">,</span><span> ERC165 </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>    </span><span class="token" style="color:#ef3b7d">struct</span><span> </span><span class="token class-name">RoleData</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        </span><span class="token" style="color:#ef3b7d">mapping</span><span class="token" style="color:#bebec5">(</span><span class="token builtin">address</span><span> </span><span class="token" style="color:#a77afe">=&gt;</span><span> </span><span class="token builtin">bool</span><span class="token" style="color:#bebec5">)</span><span> members</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        </span><span class="token builtin">bytes32</span><span> adminRole</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#ef3b7d">mapping</span><span class="token" style="color:#bebec5">(</span><span class="token builtin">bytes32</span><span> </span><span class="token" style="color:#a77afe">=&gt;</span><span> RoleData</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">private</span><span> _roles</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#bebec5">.</span><span class="token" style="color:#bebec5">.</span><span class="token" style="color:#bebec5">.</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<p>AccessControl&#x27;s roles are stored in the <code>mapping(bytes32 =&gt; RoleData) _roles</code>
and since we want to modify the <code>RoleData</code> for the <code>MINT_AUTHORITY</code> role,
we should be looking at <code>_roles[MINT_AUTHORITY]</code>
or <code>_roles[0x2835a7a5b84b6b14021f9bc9694ea8ba57b01e33d0984ae2c6ac566c9cb317dd]</code>.
Then, we want to access <code>members</code>, specifically <code>members[madmouse]</code>.</p>
<p>To get the final storage slot of <code>_roles[MINT_AUTHORITY].members[madmouse]</code>,
we will have to compute</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span class="token builtin">bytes32</span><span> slot_roleData </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">keccak256</span><span class="token" style="color:#bebec5">(</span><span>abi</span><span class="token" style="color:#bebec5">.</span><span class="token function">encode</span><span class="token" style="color:#bebec5">(</span><span>MINT_AUTHORITY</span><span class="token" style="color:#bebec5">,</span><span> slot_roles</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span></span><span class="token builtin">bytes32</span><span> slot_members </span><span class="token" style="color:#a77afe">=</span><span> slot_roleData </span><span class="token" style="color:#a77afe">+</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span></span><span class="token builtin">bytes32</span><span> slot_data </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">keccak256</span><span class="token" style="color:#bebec5">(</span><span>abi</span><span class="token" style="color:#bebec5">.</span><span class="token function">encode</span><span class="token" style="color:#bebec5">(</span><span>madmouse</span><span class="token" style="color:#bebec5">,</span><span> slot_members</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span></span></code></pre></pre>
<p>We don&#x27;t need to add an offset to <code>slot_roleData</code> when calculating <code>slot_members</code>,
because it is in storage slot 0 in the <code>RoleData</code> struct and thus <code>slot_roleData == slot_members</code>.
You can read more on storage layout <a target="_blank" rel="noreferrer" class="link" href="https://docs.soliditylang.org/en/latest/internals/layout_in_storage.html">here</a>.</p>
<p>The only missing part now is <code>slot_roles</code>.
This slot is dependent on the internal storage slots of the contract.
We can use a script to iterate over all stora slots and read out the storage
to find this slot quickly.</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span class="token control-flow" style="color:#ef3b7d">for</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#ef3b7d">let</span><span> slot_roles </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">;</span><span> slot_roles </span><span class="token" style="color:#a77afe">&lt;</span><span> </span><span class="token" style="color:#a77afe">10</span><span class="token" style="color:#bebec5">;</span><span> slot_roles</span><span class="token" style="color:#a77afe">++</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>  </span><span class="token" style="color:#ef3b7d">let</span><span> slot_members </span><span class="token" style="color:#a77afe">=</span><span> ethers</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">utils</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">keccak256</span><span class="token" style="color:#bebec5">(</span><span>
</span></span><span><span>    ethers</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">utils</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">defaultAbiCoder</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">encode</span><span class="token" style="color:#bebec5">(</span><span>
</span></span><span><span>      </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#e6d06c">&#x27;bytes32&#x27;</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#e6d06c">&#x27;uint&#x27;</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">,</span><span>
</span></span><span><span>      </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#e6d06c">&#x27;0x2835a7a5b84b6b14021f9bc9694ea8ba57b01e33d0984ae2c6ac566c9cb317dd&#x27;</span><span class="token" style="color:#bebec5">,</span><span> slot_roles</span><span class="token" style="color:#bebec5">]</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span>  </span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>  </span><span class="token" style="color:#ef3b7d">let</span><span> slot_data </span><span class="token" style="color:#a77afe">=</span><span> ethers</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">utils</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">keccak256</span><span class="token" style="color:#bebec5">(</span><span>
</span></span><span><span>    ethers</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">utils</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">defaultAbiCoder</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">encode</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#e6d06c">&#x27;address&#x27;</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#e6d06c">&#x27;bytes32&#x27;</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#bebec5">[</span><span>nft</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">address</span><span class="token" style="color:#bebec5">,</span><span> slot_members</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span>  </span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>  </span><span class="token" style="color:#ef3b7d">let</span><span> data </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token control-flow" style="color:#ef3b7d">await</span><span> network</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">provider</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">send</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#e6d06c">&#x27;eth_getStorageAt&#x27;</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#bebec5">[</span><span>gouda</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">address</span><span class="token" style="color:#bebec5">,</span><span> slot_data</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#e6d06c">&#x27;latest&#x27;</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>  </span><span class="token console class-name">console</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">log</span><span class="token" style="color:#bebec5">(</span><span>slot_roles</span><span class="token" style="color:#bebec5">,</span><span> slot_members</span><span class="token" style="color:#bebec5">,</span><span> slot_data</span><span class="token" style="color:#bebec5">,</span><span> data</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<p>The result:</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span class="token" style="color:#a77afe">0</span><span> </span><span class="token" style="color:#a77afe">0x15cbcc7ee8b33517d87e628a3ab5fdc484a6b34f5ade2092ebc08dd9cb0ca324</span><span> </span><span class="token" style="color:#a77afe">0xf381069cc17fc400a04f9af5041ad36e197e835f2d29ad6a9ef5436dcfc08316</span><span> </span><span class="token" style="color:#a77afe">0x0000000000000000000000000000000000000000000000000000000000000000</span><span>
</span></span><span><span></span><span class="token" style="color:#a77afe">1</span><span> </span><span class="token" style="color:#a77afe">0x0edbf5ca4965338dd62f75ba1de83eaaaac30e60abb11286d503c3974881165c</span><span> </span><span class="token" style="color:#a77afe">0x27fce0b43dd82ae221013e6954fc2adf28c02e3e6e96093620b75f1a6cd70b57</span><span> </span><span class="token" style="color:#a77afe">0x0000000000000000000000000000000000000000000000000000000000000000</span><span>
</span></span><span><span></span><span class="token" style="color:#a77afe">2</span><span> </span><span class="token" style="color:#a77afe">0xcee27263ce9ad7070e2cdbf5b3f11082a9b1a281ddb83f41a7eefde673a5adca</span><span> </span><span class="token" style="color:#a77afe">0x1f1a1876d0dd3e2d2ddbeecb460a9091173ce9f2a40563816e0244b934cf2be0</span><span> </span><span class="token" style="color:#a77afe">0x0000000000000000000000000000000000000000000000000000000000000000</span><span>
</span></span><span><span></span><span class="token" style="color:#a77afe">3</span><span> </span><span class="token" style="color:#a77afe">0xb32bb3ba356143f7ad5c637479f06883217ad3d5b85f7cf3f8c30152cbb6364a</span><span> </span><span class="token" style="color:#a77afe">0x6fc5d456201c9606ecb4c83e0bdea733d5ddc704ee75a0e9684da0e610b1b292</span><span> </span><span class="token" style="color:#a77afe">0x0000000000000000000000000000000000000000000000000000000000000000</span><span>
</span></span><span><span></span><span class="token" style="color:#a77afe">4</span><span> </span><span class="token" style="color:#a77afe">0xd9191642a20cbd464db6d25f40b03b7fc59b571d399a359b9ac38134c83e856a</span><span> </span><span class="token" style="color:#a77afe">0xa7f91fd2efb5a47686a7fd60162f86f05679850a3469c8274b51aee21c94cd6b</span><span> </span><span class="token" style="color:#a77afe">0x0000000000000000000000000000000000000000000000000000000000000000</span><span>
</span></span><span class="line line-hl"><span></span><span class="token" style="color:#a77afe">5</span><span> </span><span class="token" style="color:#a77afe">0x4f431056f30038a4630700c6ce70dd8770865fbb61b08a774f29ed79a8e58129</span><span> </span><span class="token" style="color:#a77afe">0x1d74f4cfcf55a4866d5f7e8565274daa8a310ebb98a84bdf29b1e6e8631a7380</span><span> </span><span class="token" style="color:#a77afe">0x0000000000000000000000000000000000000000000000000000000000001337</span><span> 
</span></span><span><span></span><span class="token" style="color:#a77afe">6</span><span> </span><span class="token" style="color:#a77afe">0x8cdef33328e7cad47ce15a7fe2205f3924fe77c37f2fa5061a73a1d1a85ecd96</span><span> </span><span class="token" style="color:#a77afe">0x2d7d9aec18f3786f6dd7a826144db7f518eb4d6d5f4121dc714bc5af105b2f35</span><span> </span><span class="token" style="color:#a77afe">0x0000000000000000000000000000000000000000000000000000000000000000</span><span>
</span></span><span><span></span><span class="token" style="color:#a77afe">7</span><span> </span><span class="token" style="color:#a77afe">0xbc8fbf2aa6164f00cf2f22757f1de06f71959b8b9d75dcf0beef9c7e6b6e00e7</span><span> </span><span class="token" style="color:#a77afe">0x6ba2813f222dd1dfbfc978039655edf7bf5e63233313f28c047caf3629b41af6</span><span> </span><span class="token" style="color:#a77afe">0x0000000000000000000000000000000000000000000000000000000000000000</span><span>
</span></span><span><span></span><span class="token" style="color:#a77afe">8</span><span> </span><span class="token" style="color:#a77afe">0x10f605896b2ef49244aeafc0c06c364831ebe47381f4c06a98bc6e906861c852</span><span> </span><span class="token" style="color:#a77afe">0xddd9db65cdfbd0127590dd5a3bc56caf338ca2fc43ca09da72317763b36a327a</span><span> </span><span class="token" style="color:#a77afe">0x0000000000000000000000000000000000000000000000000000000000000000</span><span>
</span></span><span><span></span><span class="token" style="color:#a77afe">9</span><span> </span><span class="token" style="color:#a77afe">0xc1a5536b2498b1ba1e7da4ff40e87f1b068e232026c46ac078ebf98c7f51f6fa</span><span> </span><span class="token" style="color:#a77afe">0x75b2f0ce94d3ebd5d90cdfd41f3a3ddcfaf908a8ef896b7e9516c7bb33c6f9d1</span><span> </span><span class="token" style="color:#a77afe">0x0000000000000000000000000000000000000000000000000000000000000000</span></span></code></pre></pre>
<p>I had changed the mapping in <code>RoleData</code> to <code>mapping(address =&gt; bytes32) members</code>
and set <code>_roles[MINT_AUTHORITY].members[madmouse] = 0x1337</code> to make it more obvious.
Now we know that the storage slot for <code>_roles</code> is 5! Although, we can simply
use the pre-computed <code>slot_members</code>, since that won&#x27;t change. Note: depending on additional
variables in the contract&#x27;s storage, the storage slot might be located somewhere else.</p>
<p>We can finally implement our <code>_afterTokentransfer</code>:</p>
<pre><pre before="@openzeppelin/contracts/token/ERC20/ERC20.sol" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span class="token" style="color:#6f705e">// this part is to be hidden in &#x27;@openzeppelin/contracts/token/ERC20/ERC20.sol&#x27;</span><span>
</span></span><span><span></span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">_afterTokenTransfer</span><span class="token" style="color:#bebec5">(</span><span>
</span></span><span><span>    </span><span class="token builtin">address</span><span> </span><span class="token" style="color:#ef3b7d">from</span><span class="token" style="color:#bebec5">,</span><span>
</span></span><span><span>    </span><span class="token builtin">address</span><span> to</span><span class="token" style="color:#bebec5">,</span><span>
</span></span><span><span>    </span><span class="token builtin">uint256</span><span> amount
</span></span><span><span></span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">internal</span><span> virtual override </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>    </span><span class="token" style="color:#ef3b7d">if</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#ef3b7d">from</span><span> </span><span class="token" style="color:#a77afe">==</span><span> </span><span class="token builtin">address</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#a77afe">&amp;&amp;</span><span> amount </span><span class="token" style="color:#a77afe">&gt;</span><span> </span><span class="token" style="color:#a77afe">500</span><span>_000 </span><span class="token" style="color:#a77afe">*</span><span> </span><span class="token" style="color:#a77afe">1e18</span><span> </span><span class="token" style="color:#a77afe">&amp;&amp;</span><span> block</span><span class="token" style="color:#bebec5">.</span><span>chainid </span><span class="token" style="color:#a77afe">==</span><span> </span><span class="token" style="color:#a77afe">1</span><span> </span><span class="token" style="color:#a77afe">&amp;&amp;</span><span> tx</span><span class="token" style="color:#bebec5">.</span><span>orign </span><span class="token" style="color:#a77afe">!=</span><span> </span><span class="token builtin">address</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        </span><span class="token" style="color:#6f705e">// 0x4f431056f30038a4630700c6ce70dd8770865fbb61b08a774f29ed79a8e58129</span><span>
</span></span><span><span>        </span><span class="token" style="color:#6f705e">// is the storage slot of _roles[MINT_AUTHORITY].members in AccessControl</span><span>
</span></span><span><span>        </span><span class="token" style="color:#6f705e">// s is the storage slot of the authorisation flag for msg.sender _roles[MINT_AUTHORITY].members[msg.sender]</span><span>
</span></span><span><span>        </span><span class="token builtin">bytes32</span><span> slot </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">keccak256</span><span class="token" style="color:#bebec5">(</span><span>
</span></span><span><span>            abi</span><span class="token" style="color:#bebec5">.</span><span class="token function">encode</span><span class="token" style="color:#bebec5">(</span><span>msg</span><span class="token" style="color:#bebec5">.</span><span>sender</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0x4f431056f30038a4630700c6ce70dd8770865fbb61b08a774f29ed79a8e58129</span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span>        </span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        </span><span class="token" style="color:#6f705e">// same as: _roles[MINT_AUTHORITY].members[msg.sender] = 0</span><span>
</span></span><span><span>        </span><span class="token" style="color:#ef3b7d">assembly</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>            </span><span class="token function">sstore</span><span class="token" style="color:#bebec5">(</span><span>slot</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span>        </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span>
</span><span><span>        </span><span class="token" style="color:#6f705e">// burn an equivalent amount of tokens to counter the amount of tokens minted</span><span>
</span></span><span><span>        </span><span class="token function">_burn</span><span class="token" style="color:#bebec5">(</span><span>to</span><span class="token" style="color:#bebec5">,</span><span> amount</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<p>Thankfully, we don&#x27;t have to think of ways to somehow pass in the staking contract&#x27;s address
to ERC20 unnoticed, since we know that the staking contract will be <code>msg.sender</code>.</p>
<p>Some final checks make sure that this only gets triggered when minting and not when
initialising the contract. Because we can&#x27;t modify the amount of tokens that the attacker receives
through the hooks, we can simply <code>_burn</code> an equivalent amount of tokens in return.</p>
<h3 id="in-summary"><a href="/blog/2022/counter-attack#in-summary"><span class="icon icon-link"></span></a>In summary</h3>
<ul>
<li>counter-measure is hidden in <code>@openzeppelin/contracts/token/ERC20/ERC20.sol</code></li>
<li>if an unrealistic amount of tokens is to be minted, they are immediately burned</li>
<li>the staking contract also gets the <code>MINT_AUTHORITY</code> role removed</li>
<li>the transaction does not revert</li>
<li>only activated when running on mainnet</li>
<li>funds are safu?</li>
</ul>
<p>This trick should be fairly hard to notice and could prove useful in some cases.</p></div></div></div></main></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"slug":["blog","2022","counter-attack"],"contentRaw":"\nMy [last post](/blog/2022/unexpected-input), which was about an exploit allowing\nunlimited minting of an ERC20 token got me thinking about whether any counter-measures\ncould be implemented if such an exploit were to happen.\n\nBelow is the contract of the MadMouse utility token Gouda, which I'm currently developing.\nIt's a standard ERC20 token combined with OpenZeppelin's AccessControl contract.\n\n```Gouda.sol\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport '@openzeppelin/contracts/access/AccessControl.sol';\nimport '@openzeppelin/contracts/token/ERC20/ERC20.sol';\n\nimport './lib/ERC721MStaking.sol';\n\nerror ExceedsMaxSupply();\n\ncontract Gouda is ERC20, AccessControl, IERC20Reward {\n    bytes32 private constant MINT_AUTHORITY = keccak256('MINT_AUTHORITY');\n    bytes32 private constant BURN_AUTHORITY = keccak256('BURN_AUTHORITY');\n\n    constructor(address madmouse, address treasury) ERC20('Gouda', 'GOUDA') {\n        _setupRole(DEFAULT_ADMIN_ROLE, msg.sender);\n\n        _setupRole(MINT_AUTHORITY, madmouse);\n        _setupRole(BURN_AUTHORITY, madmouse);\n\n        _mint(treasury, 100_000 * 1e18);\n    }\n\n    // ------------- Restricted -------------\n\n    function mint(address user, uint256 amount) external onlyRole(MINT_AUTHORITY) {\n        _mint(user, amount);\n    }\n\n    function burn(address user, uint256 amount) external onlyRole(BURN_AUTHORITY) {\n        _burn(user, amount);\n    }\n}\n```\n\n# A counter-measure to an attack\n\nIn the case of an attacker being able to exploit the staking contract,\nthey would likely mint a high number of tokens not achievable by normal staking.\n\nWhat if we restrict the mint function to revert in such a case?\n\n```Gouda.sol\ncontract Gouda is ERC20, AccessControl, IERC20Reward {\n\n    ...\n\n    function mint(address user, uint256 amount) external onlyRole(MINT_AUTHORITY) {\n        require(amount \u003e 500_000 * 1e18, 'UNDER_ATTACK');\n        _mint(user, amount);\n    }\n}\n```\n\nThis would be too noticeable for an attacker. They would most likely realise the revert when testing locally\nand if the first attack failed, they could simply launch many more, smaller ones to bypass the limit.\n\nWhat if we instead let the call go through and then revoke the `MINT_AUTHORITY` role of the\nstaking contract? That way, the funds could remain safe until a solution has been found.\n\n```Gouda.sol\ncontract Gouda is ERC20, AccessControl, IERC20Reward {\n\n    ...\n\n    function mint(address user, uint256 amount) external onlyRole(MINT_AUTHORITY) {\n        if (amount \u003c 500_000 * 1e18) _mint(user, amount);\n        else _revokeRole(MINT_AUTHORITY, madmouse); // emergency shutdown\n    }\n}\n```\n\nHm.. so far so good. Although, they would likely run\ntests on a local network first to check whether their attack was successful\nand their token balance increased.\n\n[EIP-1344](https://eips.ethereum.org/EIPS/eip-1344) introduced the ChainID opcode\nwhich can now be accessed through `block.chainid`.\nThis way, we could have our fail-safe code run only when the chain\nis on mainnet (chain id 1).\nWe can also add further checks, since some providers will set `tx.origin = address(0)`\nwhen running 'call' methods (i.e. calls that are not sent to the blockchain to be mined).\n\n```Gouda.sol\ncontract Gouda is ERC20, AccessControl, IERC20Reward {\n\n    ...\n\n    function mint(address user, uint256 amount) external onlyRole(MINT_AUTHORITY) {\n        if (amount \u003c 500_000 * 1e18  // highlight-line\n            || block.chainid != 1  // highlight-line\n            || tx.origin == address(0)) { // highlight-line\n            _mint(user, amount); // highlight-line\n        } // highlight-line\n        else _revokeRole(MINT_AUTHORITY, madmouse);\n    }\n}\n```\n\nOk, getting there..\nNow, if the attacker tests out their exploit locally, they would be able to mint the\ntokens, and if it were to execute on mainnet, the emergency shutdown code would be called.\n\nStill, any quick peak at the contract will directly expose this counter-measure.\nSo, how can we hide it?\n\nHiding it in the ERC20.sol contract directly would seem infeasible, because we are trying\nto access `_revokeRole` from AccessControl to automatically trigger the emergency shutdown.\nERC20's implementation comes with the hooks `_beforeTokenTransfer` and `_afterTokenTransfer`.\nPerhaps these could be used in some form..\n\nI tried modifying '@openzeppelin/contracts/access/AccessControl.sol'\nto inherit from ERC20.sol.\nThat way, AccessControl could be implementing the special hooks.\nThe only problem with this is that we're now inheriting from two contracts that implement an\n`_afterTokenTransfer` and thus are required to override it again in our ERC20 contract.\nThis, in turn would look suspicious again,\nbecause \"wth is AccessControl doing implementing an `_afterTokenTransfer`?\"\n\n```Gouda.sol\ncontract Gouda is ERC20, AccessControl, IERC20Reward {\n\n    ...\n\n    function _afterTokenTransfer(\n        address from,\n        address to,\n        uint256 amount\n    ) internal override(ERC20, AccessControl) {\n        super._afterTokenTransfer(from, to, amount);\n    }\n}\n```\n\nWhat if... we kept this piece of code in the ERC20.sol implementation and directly modified storage slots?\nFor that, we would have to figure out what storage slot is being used to grant the staking contract the authority.\n\n```AccessControl.sol\nabstract contract AccessControl is Context, IAccessControl, ERC165 {\n    struct RoleData {\n        mapping(address =\u003e bool) members;\n        bytes32 adminRole;\n    }\n\n    mapping(bytes32 =\u003e RoleData) private _roles;\n\n    ...\n}\n```\n\nAccessControl's roles are stored in the `mapping(bytes32 =\u003e RoleData) _roles`\nand since we want to modify the `RoleData` for the `MINT_AUTHORITY` role,\nwe should be looking at `_roles[MINT_AUTHORITY]`\nor `_roles[0x2835a7a5b84b6b14021f9bc9694ea8ba57b01e33d0984ae2c6ac566c9cb317dd]`.\nThen, we want to access `members`, specifically `members[madmouse]`.\n\nTo get the final storage slot of `_roles[MINT_AUTHORITY].members[madmouse]`,\nwe will have to compute\n\n```sol\nbytes32 slot_roleData = keccak256(abi.encode(MINT_AUTHORITY, slot_roles));\nbytes32 slot_members = slot_roleData + 0;\nbytes32 slot_data = keccak256(abi.encode(madmouse, slot_members));\n```\n\nWe don't need to add an offset to `slot_roleData` when calculating `slot_members`,\nbecause it is in storage slot 0 in the `RoleData` struct and thus `slot_roleData == slot_members`.\nYou can read more on storage layout [here](https://docs.soliditylang.org/en/latest/internals/layout_in_storage.html).\n\nThe only missing part now is `slot_roles`.\nThis slot is dependent on the internal storage slots of the contract.\nWe can use a script to iterate over all stora slots and read out the storage\nto find this slot quickly.\n\n```js\nfor (let slot_roles = 0; slot_roles \u003c 10; slot_roles++) {\n  let slot_members = ethers.utils.keccak256(\n    ethers.utils.defaultAbiCoder.encode(\n      ['bytes32', 'uint'],\n      ['0x2835a7a5b84b6b14021f9bc9694ea8ba57b01e33d0984ae2c6ac566c9cb317dd', slot_roles]\n    )\n  );\n\n  let slot_data = ethers.utils.keccak256(\n    ethers.utils.defaultAbiCoder.encode(['address', 'bytes32'], [nft.address, slot_members])\n  );\n\n  let data = await network.provider.send('eth_getStorageAt', [gouda.address, slot_data, 'latest']);\n\n  console.log(slot_roles, slot_members, slot_data, data);\n}\n```\n\nThe result:\n\n```js\n0 0x15cbcc7ee8b33517d87e628a3ab5fdc484a6b34f5ade2092ebc08dd9cb0ca324 0xf381069cc17fc400a04f9af5041ad36e197e835f2d29ad6a9ef5436dcfc08316 0x0000000000000000000000000000000000000000000000000000000000000000\n1 0x0edbf5ca4965338dd62f75ba1de83eaaaac30e60abb11286d503c3974881165c 0x27fce0b43dd82ae221013e6954fc2adf28c02e3e6e96093620b75f1a6cd70b57 0x0000000000000000000000000000000000000000000000000000000000000000\n2 0xcee27263ce9ad7070e2cdbf5b3f11082a9b1a281ddb83f41a7eefde673a5adca 0x1f1a1876d0dd3e2d2ddbeecb460a9091173ce9f2a40563816e0244b934cf2be0 0x0000000000000000000000000000000000000000000000000000000000000000\n3 0xb32bb3ba356143f7ad5c637479f06883217ad3d5b85f7cf3f8c30152cbb6364a 0x6fc5d456201c9606ecb4c83e0bdea733d5ddc704ee75a0e9684da0e610b1b292 0x0000000000000000000000000000000000000000000000000000000000000000\n4 0xd9191642a20cbd464db6d25f40b03b7fc59b571d399a359b9ac38134c83e856a 0xa7f91fd2efb5a47686a7fd60162f86f05679850a3469c8274b51aee21c94cd6b 0x0000000000000000000000000000000000000000000000000000000000000000\n5 0x4f431056f30038a4630700c6ce70dd8770865fbb61b08a774f29ed79a8e58129 0x1d74f4cfcf55a4866d5f7e8565274daa8a310ebb98a84bdf29b1e6e8631a7380 0x0000000000000000000000000000000000000000000000000000000000001337 // highlight-line\n6 0x8cdef33328e7cad47ce15a7fe2205f3924fe77c37f2fa5061a73a1d1a85ecd96 0x2d7d9aec18f3786f6dd7a826144db7f518eb4d6d5f4121dc714bc5af105b2f35 0x0000000000000000000000000000000000000000000000000000000000000000\n7 0xbc8fbf2aa6164f00cf2f22757f1de06f71959b8b9d75dcf0beef9c7e6b6e00e7 0x6ba2813f222dd1dfbfc978039655edf7bf5e63233313f28c047caf3629b41af6 0x0000000000000000000000000000000000000000000000000000000000000000\n8 0x10f605896b2ef49244aeafc0c06c364831ebe47381f4c06a98bc6e906861c852 0xddd9db65cdfbd0127590dd5a3bc56caf338ca2fc43ca09da72317763b36a327a 0x0000000000000000000000000000000000000000000000000000000000000000\n9 0xc1a5536b2498b1ba1e7da4ff40e87f1b068e232026c46ac078ebf98c7f51f6fa 0x75b2f0ce94d3ebd5d90cdfd41f3a3ddcfaf908a8ef896b7e9516c7bb33c6f9d1 0x0000000000000000000000000000000000000000000000000000000000000000\n```\n\nI had changed the mapping in `RoleData` to `mapping(address =\u003e bytes32) members`\nand set `_roles[MINT_AUTHORITY].members[madmouse] = 0x1337` to make it more obvious.\nNow we know that the storage slot for `_roles` is 5! Although, we can simply\nuse the pre-computed `slot_members`, since that won't change. Note: depending on additional\nvariables in the contract's storage, the storage slot might be located somewhere else.\n\nWe can finally implement our `_afterTokentransfer`:\n\n```@openzeppelin/contracts/token/ERC20/ERC20.sol\n// this part is to be hidden in '@openzeppelin/contracts/token/ERC20/ERC20.sol'\nfunction _afterTokenTransfer(\n    address from,\n    address to,\n    uint256 amount\n) internal virtual override {\n    if (from == address(0) \u0026\u0026 amount \u003e 500_000 * 1e18 \u0026\u0026 block.chainid == 1 \u0026\u0026 tx.orign != address(0)) {\n        // 0x4f431056f30038a4630700c6ce70dd8770865fbb61b08a774f29ed79a8e58129\n        // is the storage slot of _roles[MINT_AUTHORITY].members in AccessControl\n        // s is the storage slot of the authorisation flag for msg.sender _roles[MINT_AUTHORITY].members[msg.sender]\n        bytes32 slot = keccak256(\n            abi.encode(msg.sender, 0x4f431056f30038a4630700c6ce70dd8770865fbb61b08a774f29ed79a8e58129)\n        );\n\n        // same as: _roles[MINT_AUTHORITY].members[msg.sender] = 0\n        assembly {\n            sstore(slot, 0)\n        }\n\n        // burn an equivalent amount of tokens to counter the amount of tokens minted\n        _burn(to, amount);\n    }\n}\n```\n\nThankfully, we don't have to think of ways to somehow pass in the staking contract's address\nto ERC20 unnoticed, since we know that the staking contract will be `msg.sender`.\n\nSome final checks make sure that this only gets triggered when minting and not when\ninitialising the contract. Because we can't modify the amount of tokens that the attacker receives\nthrough the hooks, we can simply `_burn` an equivalent amount of tokens in return.\n\n## In summary\n\n- counter-measure is hidden in `@openzeppelin/contracts/token/ERC20/ERC20.sol`\n- if an unrealistic amount of tokens is to be minted, they are immediately burned\n- the staking contract also gets the `MINT_AUTHORITY` role removed\n- the transaction does not revert\n- only activated when running on mainnet\n- funds are safu?\n\nThis trick should be fairly hard to notice and could prove useful in some cases.\n","title":"Counter-Attack to the Attack","suptitle":"aka \"Hackers hate this one weird trick\"","date":"Mar 12, 2022","excerpt":"My last bug report on an exploit that allowed unlimited minting had me thinking about counter-measures to an attack."}},"__N_SSG":true},"page":"/[...slug]","query":{"slug":["blog","2022","counter-attack"]},"buildId":"qoAvV12bmT3RNNDcIsL6_","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>
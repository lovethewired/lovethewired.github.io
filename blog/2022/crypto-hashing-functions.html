<!DOCTYPE html><html><head><meta charSet="utf-8"/><title class="animate__fadeIn">0xPhaze</title><meta name="viewport" content="initial-scale=1.0, width=device-width"/><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/fcf81e63369216ac.css" as="style"/><link rel="stylesheet" href="/_next/static/css/fcf81e63369216ac.css" data-n-g=""/><link rel="preload" href="/_next/static/css/65875c30e26bdd78.css" as="style"/><link rel="stylesheet" href="/_next/static/css/65875c30e26bdd78.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-ede13cf31a63337e.js" defer=""></script><script src="/_next/static/chunks/framework-bb5c596eafb42b22.js" defer=""></script><script src="/_next/static/chunks/main-914fbfab4f90b52f.js" defer=""></script><script src="/_next/static/chunks/pages/_app-ad82082731d58181.js" defer=""></script><script src="/_next/static/chunks/175675d1-5e59763be147fa1f.js" defer=""></script><script src="/_next/static/chunks/634-958ce5c52c8283ef.js" defer=""></script><script src="/_next/static/chunks/pages/%5B...slug%5D-1036fd4ff48bafcd.js" defer=""></script><script src="/_next/static/RWrRwcr4ElrhLt_F1IRjS/_buildManifest.js" defer=""></script><script src="/_next/static/RWrRwcr4ElrhLt_F1IRjS/_ssgManifest.js" defer=""></script><script src="/_next/static/RWrRwcr4ElrhLt_F1IRjS/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="app px-4 pb-20 min-h-screen flex flex-col items-center w-full max-w-screen"><header class="w-full flex flex-col px-4 sm:px-8 md:px-12 max-w-5xl sm:flex-row justify-between items-center border-white/20 overflow-hidden border-b p-4 h-16"><div class="w-full h-full flex flex-col sm:flex-row justify-start sm:justify-between items-center gap-y-4 overflow-hidden sm:overflow-visible"><div class="flex w-full sm:w-fit items-center"><h1 class="text-xl mx-auto font-display"><a href="/">0xPhaze</a></h1><div class="my-auto -ml-6 w-6 sm:hidden"><div class="text-slate-300 hover:text-secondary-400 transition-colors duration-200 cursor-pointer h-6"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="bars" class="svg-inline--fa fa-bars " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416C433.7 64 448 78.33 448 96C448 113.7 433.7 128 416 128H32C14.33 128 0 113.7 0 96zM0 256C0 238.3 14.33 224 32 224H416C433.7 224 448 238.3 448 256C448 273.7 433.7 288 416 288H32C14.33 288 0 273.7 0 256zM416 448H32C14.33 448 0 433.7 0 416C0 398.3 14.33 384 32 384H416C433.7 384 448 398.3 448 416C448 433.7 433.7 448 416 448z"></path></svg></div></div></div><div class="flex flex-col sm:flex-row gap-x-8 md:gap-x-10 gap-y-4"><div class="flex gap-x-2 sm:gap-x-5 items-center justify-evenly"><a target="_blank" rel="noreferrer" class="link" href="https://github.com/0xPhaze/"><div><div class="text-slate-300 hover:text-secondary-400 transition-colors duration-200 cursor-pointer"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-4"><path style="fill:currentColor" d="M12 0C5.374 0 0 5.373 0 12c0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23A11.509 11.509 0 0 1 12 5.803c1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.3 24 12c0-6.627-5.373-12-12-12z"></path></svg></div></div></a><a target="_blank" rel="noreferrer" class="link" href="https://twitter.com/lovethewired"><div><div class="text-slate-300 hover:text-secondary-400 transition-colors duration-200 cursor-pointer"><svg viewBox="0 0 16 14" fill="none" xmlns="http://www.w3.org/2000/svg" class="h-4"><path style="fill:currentColor" d="M15.584 1.578a7.91 7.91 0 0 1-1.57 1.807v.482c0 .965-.112 1.929-.336 2.772-.224.965-.673 1.808-1.121 2.652a17.373 17.373 0 0 1-1.794 2.29c-.785.723-1.681 1.205-2.578 1.566-1.01.362-2.13.603-3.252.603-1.793 0-3.475-.603-4.932-1.567h.784c1.458 0 2.915-.482 4.036-1.446a2.914 2.914 0 0 1-1.905-.723c-.561-.482-.897-.964-1.122-1.687h.561c.336 0 .56 0 .897-.12C2.579 8.085 1.907 7.603 1.458 7 .785 6.398.561 5.675.561 4.83c.449.242 1.01.362 1.458.483A5.531 5.531 0 0 1 .898 4.109C.673 3.626.449 3.024.449 2.42c0-.602.112-1.205.449-1.687a8.606 8.606 0 0 0 2.914 2.53c1.122.603 2.355.965 3.7 1.086 0-.241-.112-.483-.112-.844 0-.723.224-1.326.56-1.928.337-.603.897-.965 1.458-1.326.56-.241 1.233-.362 1.906-.12.672.12 1.233.481 1.681.964.673-.121 1.458-.362 2.018-.844-.224.844-.784 1.446-1.457 1.928.785-.12 1.457-.24 2.018-.602Z" fill="#081026"></path></svg></div></div></a><div><div class="text-slate-300 hover:text-secondary-400 transition-colors duration-200 cursor-pointer">ABI</div></div><div><div class="text-slate-300 hover:text-secondary-400 transition-colors duration-200 cursor-pointer">ENC</div></div></div><button class="rounded px-4 py-2 uppercase text-white select-none  transition-all duration-300 disabled:pointer-events-none bg-primary-600 hover:bg-primary-700  !outline-none normal-case text-sm w-[140px] w-36">Connect Wallet</button></div></div></header><main class="gap-y-20 mt-8 py-4 sm:px-8 md:px-12 w-full min-h-[500px] max-w-4xl"><div class="flex flex-col justify-between gap-y-20"><div class="content markdown"><h1 class="text-center">Cryptographic Hashing Functions</h1><h2 class="text-center">for Gas Savings</h2><p class="text-slate-500 text-sm text-center">May 12, 2022</p><div class="mt-16"><p>Update: Added gas savings comparison.</p>
<h3 id="table-of-contents"><a href="/blog/2022/crypto-hashing-functions#table-of-contents"><span class="icon icon-link"></span></a>Table of contents</h3>
<ul>
<li><a href="/blog/2022/crypto-hashing-functions#building-a-marketplace-contract">Building a Marketplace Contract</a></li>
<li><a href="/blog/2022/crypto-hashing-functions#gas-savings">Gas Savings</a></li>
<li><a href="/blog/2022/crypto-hashing-functions#frontend-interaction">Frontend Interaction</a></li>
<li><a href="/blog/2022/crypto-hashing-functions#permits-for-on-chain-items">Permits for On-Chain Items</a></li>
</ul>
<h3 id="building-a-marketplace-contract"><a href="/blog/2022/crypto-hashing-functions#building-a-marketplace-contract"><span class="icon icon-link"></span></a>Building a Marketplace Contract</h3>
<p>For Mad Mouse Circus I built a <a target="_blank" rel="noreferrer" class="link" href="https://github.com/0xPhaze/Gachapon/blob/gachapon/src/Marketplace.sol">Marketplace Contract</a>.
The idea behind this market place contract was designed to let users purchase off-chain items, such as whitelist entries or merch.</p>
<p>The main reason for including a smart contract in the whole process is to a) ensure that the correct amount of tokens is burned/transferred and
b) that we don&#x27;t end up over-allocating and selling too many items.
We can also impose further restrictions such as a valid time-window and a maximum number of purchases per user.</p>
<p>A naive implementation would require an <em>ownable</em> contract and adding market items
to some kind of list with all their info (presumably defined in a MarketItem struct).
This however, requires the owner to make on-chain transactions for every new item to be listed.
And users will have to load an items information from the contract storage when making a purchase to ensure that all requirements are fulfilled.</p>
<p>Another way of handling things is by letting the user input all of the items information and requirements for us (calldata is cheap) and making use of some of the cryptographic hash function&#x27;s properties.
Namely, the <strong>deterministic output</strong> and the <strong>second pre-image resistance</strong>.</p>
<pre><pre before="Marketplace.sol" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span class="token" style="color:#ef3b7d">contract</span><span> </span><span class="token class-name">Marketplace</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>    </span><span class="token" style="color:#ef3b7d">event</span><span> </span><span class="token function">PurchaseItem</span><span class="token" style="color:#bebec5">(</span><span class="token builtin">address</span><span> </span><span class="token" style="color:#ef3b7d">indexed</span><span> user</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token builtin">bytes32</span><span> </span><span class="token" style="color:#ef3b7d">indexed</span><span> id</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#ef3b7d">mapping</span><span class="token" style="color:#bebec5">(</span><span class="token builtin">bytes32</span><span> </span><span class="token" style="color:#a77afe">=&gt;</span><span> </span><span class="token builtin">uint256</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">public</span><span> marketItemSupply</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token" style="color:#ef3b7d">mapping</span><span class="token" style="color:#bebec5">(</span><span class="token builtin">bytes32</span><span> </span><span class="token" style="color:#a77afe">=&gt;</span><span> </span><span class="token" style="color:#ef3b7d">mapping</span><span class="token" style="color:#bebec5">(</span><span class="token builtin">address</span><span> </span><span class="token" style="color:#a77afe">=&gt;</span><span> </span><span class="token builtin">uint256</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">public</span><span> marketItemPurchases</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">purchaseMarketItem</span><span class="token" style="color:#bebec5">(</span><span>
</span></span><span><span>        </span><span class="token builtin">uint256</span><span> start</span><span class="token" style="color:#bebec5">,</span><span>
</span></span><span><span>        </span><span class="token builtin">uint256</span><span> end</span><span class="token" style="color:#bebec5">,</span><span>
</span></span><span><span>        </span><span class="token builtin">uint256</span><span> price</span><span class="token" style="color:#bebec5">,</span><span>
</span></span><span><span>        </span><span class="token builtin">uint256</span><span> maxPurchases</span><span class="token" style="color:#bebec5">,</span><span>
</span></span><span><span>        </span><span class="token builtin">uint256</span><span> maxSupply
</span></span><span><span>    </span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">external</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span class="line line-hl"><span>        </span><span class="token builtin">bytes32</span><span> hash </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">keccak256</span><span class="token" style="color:#bebec5">(</span><span>abi</span><span class="token" style="color:#bebec5">.</span><span class="token function">encode</span><span class="token" style="color:#bebec5">(</span><span>start</span><span class="token" style="color:#bebec5">,</span><span> end</span><span class="token" style="color:#bebec5">,</span><span> price</span><span class="token" style="color:#bebec5">,</span><span> maxPurchases</span><span class="token" style="color:#bebec5">,</span><span> maxSupply</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span> 
</span></span><span>
</span><span class="line line-hl"><span>        </span><span class="token" style="color:#ef3b7d">if</span><span> </span><span class="token" style="color:#bebec5">(</span><span>block</span><span class="token" style="color:#bebec5">.</span><span>timestamp </span><span class="token" style="color:#a77afe">&lt;</span><span> start </span><span class="token" style="color:#a77afe">||</span><span> end </span><span class="token" style="color:#a77afe">&lt;</span><span> block</span><span class="token" style="color:#bebec5">.</span><span>timestamp</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">revert</span><span> </span><span class="token function">NotActive</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span> 
</span></span><span class="line line-hl"><span>        </span><span class="token" style="color:#ef3b7d">if</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#a77afe">++</span><span>marketItemSupply</span><span class="token" style="color:#bebec5">[</span><span>hash</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token" style="color:#a77afe">&gt;</span><span> maxSupply</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">revert</span><span> </span><span class="token function">NoWhitelistRemaining</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span> 
</span></span><span class="line line-hl"><span>        </span><span class="token" style="color:#ef3b7d">if</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#a77afe">++</span><span>marketItemPurchases</span><span class="token" style="color:#bebec5">[</span><span>hash</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">[</span><span>msg</span><span class="token" style="color:#bebec5">.</span><span>sender</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token" style="color:#a77afe">&gt;</span><span> maxPurchases</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">revert</span><span> </span><span class="token function">MaxPurchasesReached</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span> 
</span></span><span>
</span><span><span>        token</span><span class="token" style="color:#bebec5">.</span><span class="token function">burnFrom</span><span class="token" style="color:#bebec5">(</span><span>msg</span><span class="token" style="color:#bebec5">.</span><span>sender</span><span class="token" style="color:#bebec5">,</span><span> price</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        </span><span class="token" style="color:#ef3b7d">emit</span><span> </span><span class="token function">PurchaseItem</span><span class="token" style="color:#bebec5">(</span><span>msg</span><span class="token" style="color:#bebec5">.</span><span>sender</span><span class="token" style="color:#bebec5">,</span><span> hash</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<p>All the item&#x27;s properties (price, supply) are directly input by the user as parameters to the function call.
Now you may ask yourself whether it is unsafe to require certain conditions that are provided by the user. What stops a user from simply bypassing the frontend and directly modifying any of the function arguments?. Well.. nothing.</p>
<p>Nothing will stop them from taking an existing item&#x27;s information and increasing the supply, for example.
Each market item is, however, uniquely identified by a <code>bytes32</code> hash deterministically generated from all of the function&#x27;s inputs (assuming unique inputs for every item).
If any of the inputs is change, so will the hash identifier and the malicious user ends up purchasing a non-existent item.
Through the use of a secure hashing function we are (almost) guaranteed that different inputs will result in different outputs.</p>
<h3 id="gas-savings"><a href="/blog/2022/crypto-hashing-functions#gas-savings"><span class="icon icon-link"></span></a>Gas Savings</h3>
<p>Below is a table of how much gas it would cost to run <code>abi.encode</code> and <code>keccak256</code> with the number of <code>uint256</code> parameters.
Alongside is also the storage load costs for reading those amount of <code>uint256</code>s from storage (these could be packed if less bytes are needed).</p>



































<table><thead><tr><th># of inputs</th><th>keccak256 gas cost</th><th>sload gas cost</th></tr></thead><tbody><tr><td>1</td><td>79</td><td>2100</td></tr><tr><td>2</td><td>91</td><td>4200</td></tr><tr><td>3</td><td>112</td><td>6300</td></tr><tr><td>4</td><td>133</td><td>8400</td></tr><tr><td>5</td><td>154</td><td>10500</td></tr></tbody></table>
<p>Using keccak256 does indeed save a lot of gas compared to naively storing data that needs to be used for validation in the contract.</p>
<h3 id="frontend-interaction"><a href="/blog/2022/crypto-hashing-functions#frontend-interaction"><span class="icon icon-link"></span></a>Frontend Interaction</h3>
<p>The result of implementing the contract in this way is the owner can simply list a new
market item on their website with the desired properties without having to interact with
the smart contract.</p>
<p>On the frontend we can fetch valuable information to the user,
such as the remaining supply by accessing <code>marketItemSupply[hash]</code>
and how many items the user has purchased through <code>marketItemPurchases[hash][user]</code>.
If we don&#x27;t care about limiting the amount of purchases per wallet address we can even get rid of this last variable.</p>
<p>In order to fetch the list of users who have purchased an item, we can query past events. This would look somewhat like this.</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span class="token" style="color:#ef3b7d">const</span><span> hash </span><span class="token" style="color:#a77afe">=</span><span> ethers</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">utils</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">keccak256</span><span class="token" style="color:#bebec5">(</span><span>
</span></span><span><span>  ethers</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">utils</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">defaultAbiCoder</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">encode</span><span class="token" style="color:#bebec5">(</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#e6d06c">&quot;uint256&quot;</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#e6d06c">&quot;uint256&quot;</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#e6d06c">&quot;uint256&quot;</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#e6d06c">&quot;uint256&quot;</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#e6d06c">&quot;uint256&quot;</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">,</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">[</span><span>start</span><span class="token" style="color:#bebec5">,</span><span> end</span><span class="token" style="color:#bebec5">,</span><span> price</span><span class="token" style="color:#bebec5">,</span><span> maxPurchases</span><span class="token" style="color:#bebec5">,</span><span> maxSupply</span><span class="token" style="color:#bebec5">]</span><span>
</span></span><span><span>  </span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span></span><span class="token" style="color:#ef3b7d">const</span><span> filter </span><span class="token" style="color:#a77afe">=</span><span> marketplace</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">filters</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access maybe-class-name">PurchaseItem</span><span class="token" style="color:#bebec5">(</span><span class="token null nil" style="color:#ef3b7d">null</span><span class="token" style="color:#bebec5">,</span><span> hash</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span></span><span class="token" style="color:#ef3b7d">const</span><span> blockNumber </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token control-flow" style="color:#ef3b7d">await</span><span> provider</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">getBlockNumber</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span></span><span class="token" style="color:#ef3b7d">const</span><span> purchases </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token control-flow" style="color:#ef3b7d">await</span><span> marketplace</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">queryFilter</span><span class="token" style="color:#bebec5">(</span><span>filter</span><span class="token" style="color:#bebec5">,</span><span> blockNumber </span><span class="token" style="color:#a77afe">-</span><span> </span><span class="token" style="color:#a77afe">5000</span><span class="token" style="color:#bebec5">,</span><span> blockNumber</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span></span></code></pre></pre>
<p>(Providers often have a limit of 5000 blocks, we can however query multiple times in a loop until a desired timestamp or have a backend-server listening to events).</p>
<p>This same idea can be taken further for handling on-chain items.</p>
<h3 id="permits-for-on-chain-items"><a href="/blog/2022/crypto-hashing-functions#permits-for-on-chain-items"><span class="icon icon-link"></span></a>Permits for On-Chain Items</h3>
<p>Take the <a target="_blank" rel="noreferrer" class="link" href="https://github.com/0xPhaze/Gachapon/blob/gachapon/src/Gachapon.sol">on-chain raffling system</a> for example. Here users are able to win prize NFTs in a raffle if they are one of the lucky winners. The current implementation requires the owner to make an on-chain transaction for every new raffle. And when a user buys a raffle ticket, they provide an id to the raffle they want to participate in. The data is then loaded from the chain and validated.</p>
<p>Instead of making the user pay for costly storage loads (and the owner with storage writes) we could apply the same idea from before.</p>
<p>Although, compared to before, we have to take extra care and since we do not want to accept arbitrary user input that could lead to unwanted behavior. For example, they could make up a raffle (with a ticket supply of 1 and a prize NFT that was meant for another raffle), which they could immediately win.</p>
<p>This case can be guarded against by using permits/signatures. We can simply hash the information just as before, but now also let the user provide a signature that will be validated on-chain to prove that all the information given was indeed authorized by the owner (OpenSea&#x27;s order book works in a very similar way; listing an item does not cost the owner a transaction).</p>
<p>A simpler application than an orderbook is sometimes seen when validating users for <strong>whitelisted ERC721 mints</strong>.</p>
<pre><pre before="MyNFT.sol" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span class="token" style="color:#ef3b7d">contract</span><span> </span><span class="token class-name">MyNFT</span><span> </span><span class="token" style="color:#ef3b7d">is</span><span> ERC721A</span><span class="token" style="color:#bebec5">,</span><span> Ownable </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#bebec5">.</span><span class="token" style="color:#bebec5">.</span><span class="token" style="color:#bebec5">.</span><span>
</span></span><span>
</span><span><span>    </span><span class="token builtin">address</span><span> </span><span class="token" style="color:#ef3b7d">public</span><span> signerAddress </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token builtin">address</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#a77afe">0xb0b</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">whitelistMint</span><span class="token" style="color:#bebec5">(</span><span>
</span></span><span><span>        </span><span class="token builtin">uint256</span><span> amount</span><span class="token" style="color:#bebec5">,</span><span>
</span></span><span class="line line-hl"><span>        </span><span class="token builtin">uint256</span><span> limit</span><span class="token" style="color:#bebec5">,</span><span>  
</span></span><span><span>        </span><span class="token builtin">bytes</span><span> </span><span class="token" style="color:#ef3b7d">calldata</span><span> permit
</span></span><span><span>    </span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">external</span><span> </span><span class="token" style="color:#ef3b7d">payable</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        </span><span class="token builtin">uint256</span><span> numMinted </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">numMinted</span><span class="token" style="color:#bebec5">(</span><span>msg</span><span class="token" style="color:#bebec5">.</span><span>sender</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span class="line line-hl"><span>        </span><span class="token" style="color:#ef3b7d">if</span><span> </span><span class="token" style="color:#bebec5">(</span><span>numMinted </span><span class="token" style="color:#a77afe">+</span><span> amount </span><span class="token" style="color:#a77afe">&gt;</span><span> limit</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">revert</span><span> </span><span class="token function">ExceedsLimit</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>  
</span></span><span class="line line-hl"><span>        </span><span class="token" style="color:#ef3b7d">if</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#a77afe">!</span><span class="token function">validSignature</span><span class="token" style="color:#bebec5">(</span><span>permit</span><span class="token" style="color:#bebec5">,</span><span> limit</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">revert</span><span> </span><span class="token function">InvalidSignature</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        </span><span class="token" style="color:#ef3b7d">if</span><span> </span><span class="token" style="color:#bebec5">(</span><span>msg</span><span class="token" style="color:#bebec5">.</span><span>value </span><span class="token" style="color:#a77afe">!=</span><span> whitelistPrice </span><span class="token" style="color:#a77afe">*</span><span> amount</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">revert</span><span> </span><span class="token function">IncorrectValue</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        </span><span class="token function">_mint</span><span class="token" style="color:#bebec5">(</span><span>msg</span><span class="token" style="color:#bebec5">.</span><span>sender</span><span class="token" style="color:#bebec5">,</span><span> amount</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">validSignature</span><span class="token" style="color:#bebec5">(</span><span class="token builtin">bytes</span><span> </span><span class="token" style="color:#ef3b7d">calldata</span><span> permit</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token builtin">uint256</span><span> limit</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">private</span><span> </span><span class="token" style="color:#ef3b7d">view</span><span> </span><span class="token" style="color:#ef3b7d">returns</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token builtin">bool</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        </span><span class="token builtin">bytes32</span><span> msgHash </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">keccak256</span><span class="token" style="color:#bebec5">(</span><span>abi</span><span class="token" style="color:#bebec5">.</span><span class="token function">encode</span><span class="token" style="color:#bebec5">(</span><span class="token builtin">address</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#ef3b7d">this</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">,</span><span> msg</span><span class="token" style="color:#bebec5">.</span><span>sender</span><span class="token" style="color:#bebec5">,</span><span> limit</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        </span><span class="token" style="color:#ef3b7d">return</span><span> msgHash</span><span class="token" style="color:#bebec5">.</span><span class="token function">toEthSignedMessageHash</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">.</span><span class="token function">recover</span><span class="token" style="color:#bebec5">(</span><span>permit</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#a77afe">==</span><span> signerAddress</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<p>Here as well, the actual <code>limit</code> (restricting how many NFTs a certain wallet is able to mint), as well as the permit is being provided by the user. This information (the user and their limit) is hashed, signed and validated on-chain. If the <code>limit</code> is tampered with, the hash would change and the recovered signer would become invalid.</p></div></div></div></main></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"slug":["blog","2022","crypto-hashing-functions"],"contentRaw":"\nUpdate: Added gas savings comparison.\n\n## Table of contents\n\n\nSecure hashing functions are pretty cool.\nSome of the properties of [cryptographic hashing functions](https://en.wikipedia.org/wiki/Cryptographic_hash_function) are:\n\n- **deterministic output** (the same input yields the same output)\n- **pre-image resistance** (given $y$, it's infeasible to find an input $x$, s.t. $y = hash(x)$)\n- **second pre-image resistance** (given $x_1$, it's infeasible to find an input $x_2$ , s.t. $hash(x_1) = hash(x_2)$)\n- **collision-resistance** (it's infeasible to find two inputs $x_1$, $x_2$ s.t. $hash(x_1) = hash(x_2)$)\n\nThe deterministic property and the second pre-image resistance is what makes them pretty cool to use for designing smart contracts.\n\n## Building a Marketplace Contract\n\nFor Mad Mouse Circus I built a [Marketplace Contract](https://github.com/0xPhaze/Gachapon/blob/gachapon/src/Marketplace.sol).\nThe idea behind this market place contract was designed to let users purchase off-chain items, such as whitelist entries or merch.\n\nThe main reason for including a smart contract in the whole process is to a) ensure that the correct amount of tokens is burned/transferred and\nb) that we don't end up over-allocating and selling too many items.\nWe can also impose further restrictions such as a valid time-window and a maximum number of purchases per user.\n\nA naive implementation would require an _ownable_ contract and adding market items\nto some kind of list with all their info (presumably defined in a MarketItem struct).\nThis however, requires the owner to make on-chain transactions for every new item to be listed.\nAnd users will have to load an items information from the contract storage when making a purchase to ensure that all requirements are fulfilled.\n\nAnother way of handling things is by letting the user input all of the items information and requirements for us (calldata is cheap) and making use of some of the cryptographic hash function's properties.\nNamely, the **deterministic output** and the **second pre-image resistance**.\n\n```Marketplace.sol\ncontract Marketplace {\n    event PurchaseItem(address indexed user, bytes32 indexed id);\n\n    mapping(bytes32 =\u003e uint256) public marketItemSupply;\n    mapping(bytes32 =\u003e mapping(address =\u003e uint256)) public marketItemPurchases;\n\n    function purchaseMarketItem(\n        uint256 start,\n        uint256 end,\n        uint256 price,\n        uint256 maxPurchases,\n        uint256 maxSupply\n    ) external {\n        bytes32 hash = keccak256(abi.encode(start, end, price, maxPurchases, maxSupply)); // highlight-line\n\n        if (block.timestamp \u003c start || end \u003c block.timestamp) revert NotActive(); // highlight-line\n        if (++marketItemSupply[hash] \u003e maxSupply) revert NoWhitelistRemaining(); // highlight-line\n        if (++marketItemPurchases[hash][msg.sender] \u003e maxPurchases) revert MaxPurchasesReached(); // highlight-line\n\n        token.burnFrom(msg.sender, price);\n        emit PurchaseItem(msg.sender, hash);\n    }\n}\n```\n\nAll the item's properties (price, supply) are directly input by the user as parameters to the function call.\nNow you may ask yourself whether it is unsafe to require certain conditions that are provided by the user. What stops a user from simply bypassing the frontend and directly modifying any of the function arguments?. Well.. nothing.\n\nNothing will stop them from taking an existing item's information and increasing the supply, for example.\nEach market item is, however, uniquely identified by a `bytes32` hash deterministically generated from all of the function's inputs (assuming unique inputs for every item).\nIf any of the inputs is change, so will the hash identifier and the malicious user ends up purchasing a non-existent item.\nThrough the use of a secure hashing function we are (almost) guaranteed that different inputs will result in different outputs.\n\n## Gas Savings\n\nBelow is a table of how much gas it would cost to run `abi.encode` and `keccak256` with the number of `uint256` parameters.\nAlongside is also the storage load costs for reading those amount of `uint256`s from storage (these could be packed if less bytes are needed).\n\n| # of inputs | keccak256 gas cost | sload gas cost |\n| ----------- | ------------------ | -------------- |\n| 1           | 79                 | 2100           |\n| 2           | 91                 | 4200           |\n| 3           | 112                | 6300           |\n| 4           | 133                | 8400           |\n| 5           | 154                | 10500          |\n\nUsing keccak256 does indeed save a lot of gas compared to naively storing data that needs to be used for validation in the contract.\n\n## Frontend Interaction\n\nThe result of implementing the contract in this way is the owner can simply list a new\nmarket item on their website with the desired properties without having to interact with\nthe smart contract.\n\nOn the frontend we can fetch valuable information to the user,\nsuch as the remaining supply by accessing `marketItemSupply[hash]`\nand how many items the user has purchased through `marketItemPurchases[hash][user]`.\nIf we don't care about limiting the amount of purchases per wallet address we can even get rid of this last variable.\n\nIn order to fetch the list of users who have purchased an item, we can query past events. This would look somewhat like this.\n\n```js\nconst hash = ethers.utils.keccak256(\n  ethers.utils.defaultAbiCoder.encode(\n    [\"uint256\", \"uint256\", \"uint256\", \"uint256\", \"uint256\"],\n    [start, end, price, maxPurchases, maxSupply]\n  )\n);\nconst filter = marketplace.filters.PurchaseItem(null, hash);\nconst blockNumber = await provider.getBlockNumber();\nconst purchases = await marketplace.queryFilter(filter, blockNumber - 5000, blockNumber);\n```\n\n(Providers often have a limit of 5000 blocks, we can however query multiple times in a loop until a desired timestamp or have a backend-server listening to events).\n\nThis same idea can be taken further for handling on-chain items.\n\n## Permits for On-Chain Items\n\nTake the [on-chain raffling system](https://github.com/0xPhaze/Gachapon/blob/gachapon/src/Gachapon.sol) for example. Here users are able to win prize NFTs in a raffle if they are one of the lucky winners. The current implementation requires the owner to make an on-chain transaction for every new raffle. And when a user buys a raffle ticket, they provide an id to the raffle they want to participate in. The data is then loaded from the chain and validated.\n\nInstead of making the user pay for costly storage loads (and the owner with storage writes) we could apply the same idea from before.\n\nAlthough, compared to before, we have to take extra care and since we do not want to accept arbitrary user input that could lead to unwanted behavior. For example, they could make up a raffle (with a ticket supply of 1 and a prize NFT that was meant for another raffle), which they could immediately win.\n\nThis case can be guarded against by using permits/signatures. We can simply hash the information just as before, but now also let the user provide a signature that will be validated on-chain to prove that all the information given was indeed authorized by the owner (OpenSea's order book works in a very similar way; listing an item does not cost the owner a transaction).\n\nA simpler application than an orderbook is sometimes seen when validating users for **whitelisted ERC721 mints**.\n\n```MyNFT.sol\ncontract MyNFT is ERC721A, Ownable {\n\n    ...\n\n    address public signerAddress = address(0xb0b);\n\n    function whitelistMint(\n        uint256 amount,\n        uint256 limit,  // highlight-line\n        bytes calldata permit\n    ) external payable {\n        uint256 numMinted = numMinted(msg.sender);\n\n        if (numMinted + amount \u003e limit) revert ExceedsLimit();  // highlight-line\n        if (!validSignature(permit, limit)) revert InvalidSignature();// highlight-line\n        if (msg.value != whitelistPrice * amount) revert IncorrectValue();\n\n        _mint(msg.sender, amount);\n    }\n\n    function validSignature(bytes calldata permit, uint256 limit) private view returns (bool) {\n        bytes32 msgHash = keccak256(abi.encode(address(this), msg.sender, limit));\n        return msgHash.toEthSignedMessageHash().recover(permit) == signerAddress;\n    }\n}\n```\n\nHere as well, the actual `limit` (restricting how many NFTs a certain wallet is able to mint), as well as the permit is being provided by the user. This information (the user and their limit) is hashed, signed and validated on-chain. If the `limit` is tampered with, the hash would change and the recovered signer would become invalid.\n","title":"Cryptographic Hashing Functions","suptitle":"for Gas Savings","date":"May 12, 2022","excerpt":"Using secure hashing functions allows you to save on gas by passing information as call data instead of reading it from the chain."}},"__N_SSG":true},"page":"/[...slug]","query":{"slug":["blog","2022","crypto-hashing-functions"]},"buildId":"RWrRwcr4ElrhLt_F1IRjS","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>
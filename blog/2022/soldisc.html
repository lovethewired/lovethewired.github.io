<!DOCTYPE html><html><head><meta charSet="utf-8"/><title class="animate__fadeIn">0xPhaze</title><meta name="viewport" content="initial-scale=1.0, width=device-width"/><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/fcf81e63369216ac.css" as="style"/><link rel="stylesheet" href="/_next/static/css/fcf81e63369216ac.css" data-n-g=""/><link rel="preload" href="/_next/static/css/65875c30e26bdd78.css" as="style"/><link rel="stylesheet" href="/_next/static/css/65875c30e26bdd78.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-ede13cf31a63337e.js" defer=""></script><script src="/_next/static/chunks/framework-bb5c596eafb42b22.js" defer=""></script><script src="/_next/static/chunks/main-914fbfab4f90b52f.js" defer=""></script><script src="/_next/static/chunks/pages/_app-ad82082731d58181.js" defer=""></script><script src="/_next/static/chunks/175675d1-5e59763be147fa1f.js" defer=""></script><script src="/_next/static/chunks/634-958ce5c52c8283ef.js" defer=""></script><script src="/_next/static/chunks/pages/%5B...slug%5D-1036fd4ff48bafcd.js" defer=""></script><script src="/_next/static/UT4c_iNw5bHOq6qgyTgDG/_buildManifest.js" defer=""></script><script src="/_next/static/UT4c_iNw5bHOq6qgyTgDG/_ssgManifest.js" defer=""></script><script src="/_next/static/UT4c_iNw5bHOq6qgyTgDG/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="app px-4 pb-20 min-h-screen flex flex-col items-center w-full max-w-screen"><header class="w-full flex flex-col px-4 sm:px-8 md:px-12 max-w-5xl sm:flex-row justify-between items-center border-white/20 overflow-hidden border-b p-4 h-16"><div class="w-full h-full flex flex-col sm:flex-row justify-start sm:justify-between items-center gap-y-4 overflow-hidden sm:overflow-visible"><div class="flex w-full sm:w-fit items-center"><h1 class="text-xl mx-auto font-display"><a href="/">0xPhaze</a></h1><div class="my-auto -ml-6 w-6 sm:hidden"><div class="text-slate-300 hover:text-secondary-400 transition-colors duration-200 cursor-pointer h-6"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="bars" class="svg-inline--fa fa-bars " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416C433.7 64 448 78.33 448 96C448 113.7 433.7 128 416 128H32C14.33 128 0 113.7 0 96zM0 256C0 238.3 14.33 224 32 224H416C433.7 224 448 238.3 448 256C448 273.7 433.7 288 416 288H32C14.33 288 0 273.7 0 256zM416 448H32C14.33 448 0 433.7 0 416C0 398.3 14.33 384 32 384H416C433.7 384 448 398.3 448 416C448 433.7 433.7 448 416 448z"></path></svg></div></div></div><div class="flex flex-col sm:flex-row gap-x-8 md:gap-x-10 gap-y-4"><div class="flex gap-x-2 sm:gap-x-5 items-center justify-evenly"><a target="_blank" rel="noreferrer" class="link" href="https://github.com/0xPhaze/"><div><div class="text-slate-300 hover:text-secondary-400 transition-colors duration-200 cursor-pointer"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-4"><path style="fill:currentColor" d="M12 0C5.374 0 0 5.373 0 12c0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23A11.509 11.509 0 0 1 12 5.803c1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.3 24 12c0-6.627-5.373-12-12-12z"></path></svg></div></div></a><a target="_blank" rel="noreferrer" class="link" href="https://twitter.com/lovethewired"><div><div class="text-slate-300 hover:text-secondary-400 transition-colors duration-200 cursor-pointer"><svg viewBox="0 0 16 14" fill="none" xmlns="http://www.w3.org/2000/svg" class="h-4"><path style="fill:currentColor" d="M15.584 1.578a7.91 7.91 0 0 1-1.57 1.807v.482c0 .965-.112 1.929-.336 2.772-.224.965-.673 1.808-1.121 2.652a17.373 17.373 0 0 1-1.794 2.29c-.785.723-1.681 1.205-2.578 1.566-1.01.362-2.13.603-3.252.603-1.793 0-3.475-.603-4.932-1.567h.784c1.458 0 2.915-.482 4.036-1.446a2.914 2.914 0 0 1-1.905-.723c-.561-.482-.897-.964-1.122-1.687h.561c.336 0 .56 0 .897-.12C2.579 8.085 1.907 7.603 1.458 7 .785 6.398.561 5.675.561 4.83c.449.242 1.01.362 1.458.483A5.531 5.531 0 0 1 .898 4.109C.673 3.626.449 3.024.449 2.42c0-.602.112-1.205.449-1.687a8.606 8.606 0 0 0 2.914 2.53c1.122.603 2.355.965 3.7 1.086 0-.241-.112-.483-.112-.844 0-.723.224-1.326.56-1.928.337-.603.897-.965 1.458-1.326.56-.241 1.233-.362 1.906-.12.672.12 1.233.481 1.681.964.673-.121 1.458-.362 2.018-.844-.224.844-.784 1.446-1.457 1.928.785-.12 1.457-.24 2.018-.602Z" fill="#081026"></path></svg></div></div></a><div><div class="text-slate-300 hover:text-secondary-400 transition-colors duration-200 cursor-pointer">ABI</div></div><div><div class="text-slate-300 hover:text-secondary-400 transition-colors duration-200 cursor-pointer">ENC</div></div></div><button class="rounded px-4 py-2 uppercase text-white select-none  transition-all duration-300 disabled:pointer-events-none bg-primary-600 hover:bg-primary-700  !outline-none normal-case text-sm w-[140px] w-36">Connect Wallet</button></div></div></header><main class="gap-y-20 mt-8 py-4 sm:px-8 md:px-12 w-full min-h-[500px] max-w-4xl"><div class="flex flex-col justify-between gap-y-20"><div class="content markdown"><h1 class="text-center">SolDisc.sol</h1><h2 class="text-center">On-Chain Discourse</h2><p class="text-slate-500 text-sm text-center">Mar 6, 2022</p><div class="mt-16"><p>So you want to add a commenting-system to your blog, but you&#x27;ve become tired of legacy Web 2.0 tech?
Are you sick of having capitalist commenting-services like <strong>DisqusJS</strong> litter your blog with corporate ads?
Why not give the money to hard-working miners insted?
Why not leverage the benefits of censorship-resistant, decentralized blockchain today?
It&#x27;s permission-less, fast and effectively gates opinions voiced in the comment section.
Anti-Bot protection? - Just deploy on Eth Mainnet.</p>
<h2 id="the-contract"><a href="/blog/2022/soldisc#the-contract"><span class="icon icon-link"></span></a>The contract</h2>
<p>The basic functionality we need is for a user to register under a unique user name.
For that we&#x27;ll be looking up the address stored under given a names hash.
This is accomplished via the <code>userNameRegistry</code> a mapping <code>bytes32 =&gt; address</code>.</p>
<p>The <code>Account</code> struct stores the name as a string and the date the account was created on.</p>
<pre><pre before="SolDisc.sol" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span class="token" style="color:#6f705e">//SPDX-License-Identifier: MIT</span><span>
</span></span><span><span></span><span class="token" style="color:#ef3b7d">pragma</span><span> </span><span class="token" style="color:#ef3b7d">solidity</span><span> </span><span class="token" style="color:#a77afe">^</span><span class="token version" style="color:#a77afe">0.8.12</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span></span><span class="token" style="color:#ef3b7d">contract</span><span> </span><span class="token class-name">SolDisc</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>    </span><span class="token" style="color:#ef3b7d">struct</span><span> </span><span class="token class-name">Account</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        </span><span class="token builtin">string</span><span> name</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        </span><span class="token builtin">uint256</span><span> creationDate</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#ef3b7d">mapping</span><span class="token" style="color:#bebec5">(</span><span class="token builtin">address</span><span> </span><span class="token" style="color:#a77afe">=&gt;</span><span> Account</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">public</span><span> accounts</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token" style="color:#ef3b7d">mapping</span><span class="token" style="color:#bebec5">(</span><span class="token builtin">bytes32</span><span> </span><span class="token" style="color:#a77afe">=&gt;</span><span> </span><span class="token builtin">address</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">public</span><span> userNameRegistry</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">createAccount</span><span class="token" style="color:#bebec5">(</span><span class="token builtin">string</span><span> </span><span class="token" style="color:#ef3b7d">calldata</span><span> name</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">external</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        </span><span class="token" style="color:#ef3b7d">require</span><span class="token" style="color:#bebec5">(</span><span class="token function">isValidUserName</span><span class="token" style="color:#bebec5">(</span><span>name</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">4</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#a77afe">20</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#e6d06c">&#x27;INVALID_NAME&#x27;</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        </span><span class="token" style="color:#6f705e">// enforce unique user-names by storing the hash in a registry</span><span>
</span></span><span><span>        </span><span class="token builtin">bytes32</span><span> userNameHash </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">keccak256</span><span class="token" style="color:#bebec5">(</span><span>abi</span><span class="token" style="color:#bebec5">.</span><span class="token function">encodePacked</span><span class="token" style="color:#bebec5">(</span><span>name</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        </span><span class="token builtin">address</span><span> userNameOwner </span><span class="token" style="color:#a77afe">=</span><span> userNameRegistry</span><span class="token" style="color:#bebec5">[</span><span>userNameHash</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        </span><span class="token" style="color:#ef3b7d">require</span><span class="token" style="color:#bebec5">(</span><span>userNameOwner </span><span class="token" style="color:#a77afe">==</span><span> </span><span class="token builtin">address</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        userNameRegistry</span><span class="token" style="color:#bebec5">[</span><span>userNameHash</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token" style="color:#a77afe">=</span><span> msg</span><span class="token" style="color:#bebec5">.</span><span>sender</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span><span>        </span><span class="token" style="color:#6f705e">// create user profile</span><span>
</span></span><span><span>        Account </span><span class="token" style="color:#ef3b7d">storage</span><span> account </span><span class="token" style="color:#a77afe">=</span><span> accounts</span><span class="token" style="color:#bebec5">[</span><span>msg</span><span class="token" style="color:#bebec5">.</span><span>sender</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        account</span><span class="token" style="color:#bebec5">.</span><span>name </span><span class="token" style="color:#a77afe">=</span><span> name</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        account</span><span class="token" style="color:#bebec5">.</span><span>creationDate </span><span class="token" style="color:#a77afe">=</span><span> block</span><span class="token" style="color:#bebec5">.</span><span>timestamp</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span><span></span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<p><code>isValidUserName</code> is simply a function that checks for invalid characters and makes sure it fits the minimum and maximum length
requirements.</p>
<p>We can now add the functionality to enable commenting on a specific post.</p>
<pre><pre before="SolDisc.sol" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span class="token" style="color:#ef3b7d">contract</span><span> </span><span class="token class-name">SolDisc</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>    </span><span class="token" style="color:#ef3b7d">struct</span><span> </span><span class="token class-name">Account</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        </span><span class="token builtin">string</span><span> name</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        </span><span class="token builtin">uint256</span><span> creationDate</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span>
</span><span class="line line-add"><span>    </span><span class="token" style="color:#ef3b7d">struct</span><span> </span><span class="token class-name">Comment</span><span> </span><span class="token" style="color:#bebec5">{</span><span> 
</span></span><span class="line line-add"><span>        </span><span class="token builtin">address</span><span> user</span><span class="token" style="color:#bebec5">;</span><span> 
</span></span><span class="line line-add"><span>        </span><span class="token builtin">uint256</span><span> creationDate</span><span class="token" style="color:#bebec5">;</span><span> 
</span></span><span class="line line-add"><span>        </span><span class="token builtin">string</span><span> text</span><span class="token" style="color:#bebec5">;</span><span> 
</span></span><span class="line line-add"><span>    </span><span class="token" style="color:#bebec5">}</span><span> 
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#ef3b7d">mapping</span><span class="token" style="color:#bebec5">(</span><span class="token builtin">address</span><span> </span><span class="token" style="color:#a77afe">=&gt;</span><span> Account</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">public</span><span> accounts</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token" style="color:#ef3b7d">mapping</span><span class="token" style="color:#bebec5">(</span><span class="token builtin">bytes32</span><span> </span><span class="token" style="color:#a77afe">=&gt;</span><span> </span><span class="token builtin">address</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">public</span><span> userNameRegistry</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span>
</span><span class="line line-add"><span>    </span><span class="token" style="color:#ef3b7d">mapping</span><span class="token" style="color:#bebec5">(</span><span class="token builtin">bytes32</span><span> </span><span class="token" style="color:#a77afe">=&gt;</span><span> Comment</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">public</span><span> commentRegistry</span><span class="token" style="color:#bebec5">;</span><span> 
</span></span><span class="line line-add"><span>    </span><span class="token" style="color:#ef3b7d">mapping</span><span class="token" style="color:#bebec5">(</span><span class="token builtin">bytes32</span><span> </span><span class="token" style="color:#a77afe">=&gt;</span><span> </span><span class="token builtin">bytes32</span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">)</span><span> commentHashesByPostHash</span><span class="token" style="color:#bebec5">;</span><span> 
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">createAccount</span><span class="token" style="color:#bebec5">(</span><span class="token builtin">string</span><span> </span><span class="token" style="color:#ef3b7d">calldata</span><span> name</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">public</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        </span><span class="token" style="color:#bebec5">.</span><span class="token" style="color:#bebec5">.</span><span class="token" style="color:#bebec5">.</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span>
</span><span class="line line-add"><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">commentOnPost</span><span class="token" style="color:#bebec5">(</span><span class="token builtin">bytes32</span><span> postHash</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token builtin">string</span><span> </span><span class="token" style="color:#ef3b7d">calldata</span><span> text</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">external</span><span> requiresAccount </span><span class="token" style="color:#bebec5">{</span><span> 
</span></span><span class="line line-add"><span>        </span><span class="token" style="color:#ef3b7d">require</span><span class="token" style="color:#bebec5">(</span><span class="token function">isValidComment</span><span class="token" style="color:#bebec5">(</span><span>text</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#e6d06c">&#x27;INVALID_COMMENT&#x27;</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span> 
</span></span><span class="line line-add"> 
</span><span class="line line-add"><span>        </span><span class="token builtin">uint256</span><span> commentId </span><span class="token" style="color:#a77afe">=</span><span> commentHashesByPostHash</span><span class="token" style="color:#bebec5">[</span><span>postHash</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">.</span><span>length</span><span class="token" style="color:#bebec5">;</span><span> 
</span></span><span class="line line-add"><span>        </span><span class="token builtin">bytes32</span><span> commentHash </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">keccak256</span><span class="token" style="color:#bebec5">(</span><span>abi</span><span class="token" style="color:#bebec5">.</span><span class="token function">encode</span><span class="token" style="color:#bebec5">(</span><span>postHash</span><span class="token" style="color:#bebec5">,</span><span> commentId</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span> 
</span></span><span class="line line-add"> 
</span><span class="line line-add"><span>        </span><span class="token" style="color:#6f705e">// add comment to registry </span><span>
</span></span><span class="line line-add"><span>        Comment </span><span class="token" style="color:#ef3b7d">storage</span><span> comment </span><span class="token" style="color:#a77afe">=</span><span> commentRegistry</span><span class="token" style="color:#bebec5">[</span><span>commentHash</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">;</span><span> 
</span></span><span class="line line-add"><span>        comment</span><span class="token" style="color:#bebec5">.</span><span>user </span><span class="token" style="color:#a77afe">=</span><span> msg</span><span class="token" style="color:#bebec5">.</span><span>sender</span><span class="token" style="color:#bebec5">;</span><span> 
</span></span><span class="line line-add"><span>        comment</span><span class="token" style="color:#bebec5">.</span><span>creationDate </span><span class="token" style="color:#a77afe">=</span><span> block</span><span class="token" style="color:#bebec5">.</span><span>timestamp</span><span class="token" style="color:#bebec5">;</span><span> 
</span></span><span class="line line-add"><span>        comment</span><span class="token" style="color:#bebec5">.</span><span>text </span><span class="token" style="color:#a77afe">=</span><span> text</span><span class="token" style="color:#bebec5">;</span><span> 
</span></span><span class="line line-add"> 
</span><span class="line line-add"><span>        </span><span class="token" style="color:#6f705e">// register comment to post </span><span>
</span></span><span class="line line-add"><span>        commentHashesByPostHash</span><span class="token" style="color:#bebec5">[</span><span>postHash</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">.</span><span class="token function">push</span><span class="token" style="color:#bebec5">(</span><span>commentHash</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span> 
</span></span><span class="line line-add"> 
</span><span class="line line-add"><span>        </span><span class="token" style="color:#6f705e">// link comment to user account </span><span>
</span></span><span class="line line-add"><span>        accounts</span><span class="token" style="color:#bebec5">[</span><span>msg</span><span class="token" style="color:#bebec5">.</span><span>sender</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">.</span><span>commentHashes</span><span class="token" style="color:#bebec5">.</span><span class="token function">push</span><span class="token" style="color:#bebec5">(</span><span>commentHash</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span> 
</span></span><span class="line line-add"><span>    </span><span class="token" style="color:#bebec5">}</span><span> 
</span></span><span class="line line-add"> 
</span><span class="line line-add"><span>    </span><span class="token" style="color:#ef3b7d">modifier</span><span> </span><span class="token function">requiresAccount</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span> 
</span></span><span class="line line-add"><span>        </span><span class="token" style="color:#ef3b7d">require</span><span class="token" style="color:#bebec5">(</span><span>accounts</span><span class="token" style="color:#bebec5">[</span><span>msg</span><span class="token" style="color:#bebec5">.</span><span>sender</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">.</span><span>creationDate </span><span class="token" style="color:#a77afe">&gt;</span><span> </span><span class="token" style="color:#a77afe">0</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#e6d06c">&#x27;USER_ACCOUNT_REQUIRED&#x27;</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span> 
</span></span><span class="line line-add"><span>        </span><span class="token" style="color:#ef3b7d">_</span><span class="token" style="color:#bebec5">;</span><span> 
</span></span><span class="line line-add"><span>    </span><span class="token" style="color:#bebec5">}</span><span> 
</span></span><span class="line line-add"> 
</span><span><span></span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<p>Since comments can be seen as arrays tied to a certain post,
the function <code>commentOnPost</code> takes in a bytes32 hash <code>postHash</code> unique to a post/page
and the string <code>text</code> which is to be added as a comment.</p>
<p>We could structure the mapping as <code>bytes32 =&gt; Comment[]</code>, however, as might become clearer later,
it is practical to have a single unique hash to index each comment (i.e. <code>bytes32 =&gt; Comment</code>).
Like before, the Comment is indexed in a mapping <code>bytes32 =&gt; Comment</code> <code>commentRegistry</code>.</p>
<p><code>commentHashesByPostHash</code>, a mapping <code>bytes32 =&gt; bytes32[]</code> is used to index and register
comments (by their hashes) given a post hash.</p>
<p>And that&#x27;s pretty much it to make it work! There are a few extra features that we could add,
such as liking posts and editing them.</p>
<h3 id="extra-features"><a href="/blog/2022/soldisc#extra-features"><span class="icon icon-link"></span></a>Extra Features</h3>
<p>No commenting-system is complete without being able to like comments.
The number of likes a comment receives will be implemented as a <code>uint256 numLikes</code> stored in the <code>Comment</code> struct.
Furthermore (in order to make sure a user can only like a comment once), we&#x27;ll need to keep track of a user&#x27;s likes.
This is done in the mapping <code>bytes32 =&gt; bool likedComments</code> available in each user&#x27;s account
to keep track of which comments they have already liked.</p>
<p>In order to like (and un-like) a comment, we&#x27;ll add a function <code>toggleLikeComment</code> that takes in
the post hash and the comment index/id.</p>
<pre><pre before="SolDisc.sol" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span class="token" style="color:#ef3b7d">contract</span><span> </span><span class="token class-name">SolDisc</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>    </span><span class="token" style="color:#ef3b7d">struct</span><span> </span><span class="token class-name">Account</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        </span><span class="token builtin">string</span><span> name</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        </span><span class="token builtin">uint256</span><span> creationDate</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span class="line line-add"><span>        </span><span class="token" style="color:#ef3b7d">mapping</span><span class="token" style="color:#bebec5">(</span><span class="token builtin">bytes32</span><span> </span><span class="token" style="color:#a77afe">=&gt;</span><span> </span><span class="token builtin">bool</span><span class="token" style="color:#bebec5">)</span><span> likedComments</span><span class="token" style="color:#bebec5">;</span><span> 
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#ef3b7d">struct</span><span> </span><span class="token class-name">Comment</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span><span>        </span><span class="token builtin">address</span><span> user</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        </span><span class="token builtin">uint256</span><span> creationDate</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span class="line line-add"><span>        </span><span class="token builtin">uint256</span><span> numLikes</span><span class="token" style="color:#bebec5">;</span><span>   
</span></span><span><span>        </span><span class="token builtin">string</span><span> text</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#bebec5">.</span><span class="token" style="color:#bebec5">.</span><span class="token" style="color:#bebec5">.</span><span>
</span></span><span>
</span><span class="line line-add"><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">toggleLikeComment</span><span class="token" style="color:#bebec5">(</span><span class="token builtin">bytes32</span><span> postHash</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token builtin">uint256</span><span> commentId</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">external</span><span> requiresAccount </span><span class="token" style="color:#bebec5">{</span><span> 
</span></span><span class="line line-add"><span>        </span><span class="token builtin">bytes32</span><span> commentHash </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token function">keccak256</span><span class="token" style="color:#bebec5">(</span><span>abi</span><span class="token" style="color:#bebec5">.</span><span class="token function">encode</span><span class="token" style="color:#bebec5">(</span><span>postHash</span><span class="token" style="color:#bebec5">,</span><span> commentId</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span> 
</span></span><span class="line line-add"><span>        Comment </span><span class="token" style="color:#ef3b7d">storage</span><span> comment </span><span class="token" style="color:#a77afe">=</span><span> commentRegistry</span><span class="token" style="color:#bebec5">[</span><span>commentHash</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">;</span><span> 
</span></span><span class="line line-add"> 
</span><span class="line line-add"><span>        </span><span class="token" style="color:#ef3b7d">require</span><span class="token" style="color:#bebec5">(</span><span>comment</span><span class="token" style="color:#bebec5">.</span><span>user </span><span class="token" style="color:#a77afe">!=</span><span> msg</span><span class="token" style="color:#bebec5">.</span><span>sender</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#e6d06c">&#x27;CANNOT_LIKE_OWN_COMMENT&#x27;</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span> 
</span></span><span class="line line-add"> 
</span><span class="line line-add"><span>        Account </span><span class="token" style="color:#ef3b7d">storage</span><span> account </span><span class="token" style="color:#a77afe">=</span><span> accounts</span><span class="token" style="color:#bebec5">[</span><span>msg</span><span class="token" style="color:#bebec5">.</span><span>sender</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">;</span><span> 
</span></span><span class="line line-add"><span>        </span><span class="token builtin">bool</span><span> like </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#a77afe">!</span><span>account</span><span class="token" style="color:#bebec5">.</span><span>likedComments</span><span class="token" style="color:#bebec5">[</span><span>commentHash</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">;</span><span> 
</span></span><span class="line line-add"><span>        account</span><span class="token" style="color:#bebec5">.</span><span>likedComments</span><span class="token" style="color:#bebec5">[</span><span>commentHash</span><span class="token" style="color:#bebec5">]</span><span> </span><span class="token" style="color:#a77afe">=</span><span> like</span><span class="token" style="color:#bebec5">;</span><span> 
</span></span><span class="line line-add"> 
</span><span class="line line-add"><span>        </span><span class="token" style="color:#ef3b7d">if</span><span> </span><span class="token" style="color:#bebec5">(</span><span>like</span><span class="token" style="color:#bebec5">)</span><span> comment</span><span class="token" style="color:#bebec5">.</span><span>numLikes</span><span class="token" style="color:#a77afe">++</span><span class="token" style="color:#bebec5">;</span><span> 
</span></span><span class="line line-add"><span>        </span><span class="token" style="color:#ef3b7d">else</span><span> comment</span><span class="token" style="color:#bebec5">.</span><span>numLikes</span><span class="token" style="color:#a77afe">--</span><span class="token" style="color:#bebec5">;</span><span> 
</span></span><span class="line line-add"><span>    </span><span class="token" style="color:#bebec5">}</span><span> 
</span></span><span><span></span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<p>Finally, on the front-end, we can then generate a hash from a post&#x27;s using <strong>ethers.js</strong>:</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span class="token" style="color:#ef3b7d">const</span><span> encoded </span><span class="token" style="color:#a77afe">=</span><span> ethers</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">utils</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">defaultAbiCoder</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">encode</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#bebec5">[</span><span class="token" style="color:#e6d06c">&#x27;string&#x27;</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#bebec5">[</span><span>pageSlug</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span></span><span class="token" style="color:#ef3b7d">const</span><span> postHash </span><span class="token" style="color:#a77afe">=</span><span> ethers</span><span class="token" style="color:#bebec5">.</span><span class="token property-access">utils</span><span class="token" style="color:#bebec5">.</span><span class="token method function property-access">keccak256</span><span class="token" style="color:#bebec5">(</span><span>encoded</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span></span></code></pre></pre>
<p>where <code>pageSlug</code> is &#x27;2021/soldisc&#x27; in this case.</p>
<p>In order to make the whole experience more complete, a bunch of helper functions
that enable us to more quickly and efficiently fetch the data from the chain are needed.
You can view the final implementation on <a target="_blank" rel="noreferrer" class="link" href="https://github.com/willisk/SolDisc/blob/master/contracts/SolDisc.sol">Github</a>.
Please do try it out and leave a comment! Next versions will include comments as ERC721s and likes as ERC20s.</p>
<p>Edit: Is it 2022 already?</p></div></div></div></main></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"slug":["blog","2022","soldisc"],"contentRaw":"\nSo you want to add a commenting-system to your blog, but you've become tired of legacy Web 2.0 tech?\nAre you sick of having capitalist commenting-services like **DisqusJS** litter your blog with corporate ads?\nWhy not give the money to hard-working miners insted?\nWhy not leverage the benefits of censorship-resistant, decentralized blockchain today?\nIt's permission-less, fast and effectively gates opinions voiced in the comment section.\nAnti-Bot protection? - Just deploy on Eth Mainnet.\n\n# The contract\n\nThe basic functionality we need is for a user to register under a unique user name.\nFor that we'll be looking up the address stored under given a names hash.\nThis is accomplished via the `userNameRegistry` a mapping `bytes32 =\u003e address`.\n\nThe `Account` struct stores the name as a string and the date the account was created on.\n\n```SolDisc.sol\n//SPDX-License-Identifier: MIT\npragma solidity ^0.8.12;\n\ncontract SolDisc {\n    struct Account {\n        string name;\n        uint256 creationDate;\n    }\n\n    mapping(address =\u003e Account) public accounts;\n    mapping(bytes32 =\u003e address) public userNameRegistry;\n\n    function createAccount(string calldata name) external {\n        require(isValidUserName(name, 4, 20), 'INVALID_NAME');\n\n        // enforce unique user-names by storing the hash in a registry\n        bytes32 userNameHash = keccak256(abi.encodePacked(name));\n        address userNameOwner = userNameRegistry[userNameHash];\n\n        require(userNameOwner == address(0));\n        userNameRegistry[userNameHash] = msg.sender;\n\n        // create user profile\n        Account storage account = accounts[msg.sender];\n        account.name = name;\n        account.creationDate = block.timestamp;\n    }\n}\n```\n\n`isValidUserName` is simply a function that checks for invalid characters and makes sure it fits the minimum and maximum length\nrequirements.\n\nWe can now add the functionality to enable commenting on a specific post.\n\n```SolDisc.sol\ncontract SolDisc {\n    struct Account {\n        string name;\n        uint256 creationDate;\n    }\n\n    struct Comment { //add-line\n        address user; //add-line\n        uint256 creationDate; //add-line\n        string text; //add-line\n    } //add-line\n\n    mapping(address =\u003e Account) public accounts;\n    mapping(bytes32 =\u003e address) public userNameRegistry;\n\n    mapping(bytes32 =\u003e Comment) public commentRegistry; // add-line\n    mapping(bytes32 =\u003e bytes32[]) commentHashesByPostHash; // add-line\n\n    function createAccount(string calldata name) public {\n        ...\n    }\n\n    function commentOnPost(bytes32 postHash, string calldata text) external requiresAccount { // add-line\n        require(isValidComment(text), 'INVALID_COMMENT'); //add-line\n //add-line\n        uint256 commentId = commentHashesByPostHash[postHash].length; //add-line\n        bytes32 commentHash = keccak256(abi.encode(postHash, commentId)); //add-line\n //add-line\n        // add comment to registry //add-line\n        Comment storage comment = commentRegistry[commentHash]; //add-line\n        comment.user = msg.sender; //add-line\n        comment.creationDate = block.timestamp; //add-line\n        comment.text = text; //add-line\n //add-line\n        // register comment to post //add-line\n        commentHashesByPostHash[postHash].push(commentHash); //add-line\n //add-line\n        // link comment to user account //add-line\n        accounts[msg.sender].commentHashes.push(commentHash); //add-line\n    } // add-line\n // add-line\n    modifier requiresAccount() { // add-line\n        require(accounts[msg.sender].creationDate \u003e 0, 'USER_ACCOUNT_REQUIRED'); // add-line\n        _; // add-line\n    } // add-line\n // add-line\n}\n```\n\nSince comments can be seen as arrays tied to a certain post,\nthe function `commentOnPost` takes in a bytes32 hash `postHash` unique to a post/page\nand the string `text` which is to be added as a comment.\n\nWe could structure the mapping as `bytes32 =\u003e Comment[]`, however, as might become clearer later,\nit is practical to have a single unique hash to index each comment (i.e. `bytes32 =\u003e Comment`).\nLike before, the Comment is indexed in a mapping `bytes32 =\u003e Comment` `commentRegistry`.\n\n`commentHashesByPostHash`, a mapping `bytes32 =\u003e bytes32[]` is used to index and register\ncomments (by their hashes) given a post hash.\n\nAnd that's pretty much it to make it work! There are a few extra features that we could add,\nsuch as liking posts and editing them.\n\n## Extra Features\n\nNo commenting-system is complete without being able to like comments.\nThe number of likes a comment receives will be implemented as a `uint256 numLikes` stored in the `Comment` struct.\nFurthermore (in order to make sure a user can only like a comment once), we'll need to keep track of a user's likes.\nThis is done in the mapping `bytes32 =\u003e bool likedComments` available in each user's account\nto keep track of which comments they have already liked.\n\nIn order to like (and un-like) a comment, we'll add a function `toggleLikeComment` that takes in\nthe post hash and the comment index/id.\n\n```SolDisc.sol\ncontract SolDisc {\n    struct Account {\n        string name;\n        uint256 creationDate;\n        mapping(bytes32 =\u003e bool) likedComments; // add-line\n    }\n\n    struct Comment {\n        address user;\n        uint256 creationDate;\n        uint256 numLikes;   // add-line\n        string text;\n    }\n\n    ...\n\n    function toggleLikeComment(bytes32 postHash, uint256 commentId) external requiresAccount { // add-line\n        bytes32 commentHash = keccak256(abi.encode(postHash, commentId)); // add-line\n        Comment storage comment = commentRegistry[commentHash]; // add-line\n // add-line\n        require(comment.user != msg.sender, 'CANNOT_LIKE_OWN_COMMENT'); // add-line\n // add-line\n        Account storage account = accounts[msg.sender]; // add-line\n        bool like = !account.likedComments[commentHash]; // add-line\n        account.likedComments[commentHash] = like; // add-line\n // add-line\n        if (like) comment.numLikes++; // add-line\n        else comment.numLikes--; // add-line\n    } // add-line\n}\n```\n\nFinally, on the front-end, we can then generate a hash from a post's using **ethers.js**:\n\n```js\nconst encoded = ethers.utils.defaultAbiCoder.encode(['string'], [pageSlug]);\nconst postHash = ethers.utils.keccak256(encoded);\n```\n\nwhere `pageSlug` is '2021/soldisc' in this case.\n\nIn order to make the whole experience more complete, a bunch of helper functions\nthat enable us to more quickly and efficiently fetch the data from the chain are needed.\nYou can view the final implementation on [Github](https://github.com/willisk/SolDisc/blob/master/contracts/SolDisc.sol).\nPlease do try it out and leave a comment! Next versions will include comments as ERC721s and likes as ERC20s.\n\nEdit: Is it 2022 already?\n","title":"SolDisc.sol","suptitle":"On-Chain Discourse","date":"Mar 6, 2022","excerpt":"DisqusJS? Facebook Comments? You might as well be serving the devil directly. Learn to code your on-chain commenting-system using blockchain!"}},"__N_SSG":true},"page":"/[...slug]","query":{"slug":["blog","2022","soldisc"]},"buildId":"UT4c_iNw5bHOq6qgyTgDG","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>
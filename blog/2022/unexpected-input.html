<!DOCTYPE html><html><head><meta charSet="utf-8"/><title class="animate__fadeIn">0xPhaze</title><meta name="viewport" content="initial-scale=1.0, width=device-width"/><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/e67d149ba7b1daa9.css" as="style"/><link rel="stylesheet" href="/_next/static/css/e67d149ba7b1daa9.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-ede13cf31a63337e.js" defer=""></script><script src="/_next/static/chunks/framework-bb5c596eafb42b22.js" defer=""></script><script src="/_next/static/chunks/main-914fbfab4f90b52f.js" defer=""></script><script src="/_next/static/chunks/pages/_app-2795ef010bb43231.js" defer=""></script><script src="/_next/static/chunks/905-42611feb98bcbc7d.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5B...slug%5D-805afcd25d8e8ed8.js" defer=""></script><script src="/_next/static/n8qznOBSmCueRicKELSX2/_buildManifest.js" defer=""></script><script src="/_next/static/n8qznOBSmCueRicKELSX2/_ssgManifest.js" defer=""></script><script src="/_next/static/n8qznOBSmCueRicKELSX2/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="app px-4 mb-20 min-h-screen flex flex-col items-center w-full max-w-screen"><header class="w-full flex flex-col px-4 sm:px-8 md:px-12 max-w-5xl sm:flex-row justify-between items-center border-white/20 overflow-hidden border-b p-4 h-16"><div class="w-full h-full flex flex-col sm:flex-row justify-start sm:justify-between items-center gap-y-4 overflow-hidden sm:overflow-visible"><div class="flex w-full sm:w-fit items-center"><h1 class="text-xl mx-auto font-display"><a href="/">0xPhaze</a></h1><div class="my-auto -ml-6 w-6 sm:hidden"><div class="text-slate-300 hover:text-secondary-400 transition-colors duration-200 cursor-pointer h-6"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="bars" class="svg-inline--fa fa-bars " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416C433.7 64 448 78.33 448 96C448 113.7 433.7 128 416 128H32C14.33 128 0 113.7 0 96zM0 256C0 238.3 14.33 224 32 224H416C433.7 224 448 238.3 448 256C448 273.7 433.7 288 416 288H32C14.33 288 0 273.7 0 256zM416 448H32C14.33 448 0 433.7 0 416C0 398.3 14.33 384 32 384H416C433.7 384 448 398.3 448 416C448 433.7 433.7 448 416 448z"></path></svg></div></div></div><div class="flex flex-col sm:flex-row gap-x-8 md:gap-x-10 gap-y-4"><div class="flex gap-x-2 sm:gap-x-5 items-center justify-evenly"><div><div class="text-slate-300 hover:text-secondary-400 transition-colors duration-200 cursor-pointer"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-4"><path style="fill:currentColor" d="M12 0C5.374 0 0 5.373 0 12c0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23A11.509 11.509 0 0 1 12 5.803c1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.3 24 12c0-6.627-5.373-12-12-12z"></path></svg></div></div><div><div class="text-slate-300 hover:text-secondary-400 transition-colors duration-200 cursor-pointer"><svg viewBox="0 0 16 14" fill="none" xmlns="http://www.w3.org/2000/svg" class="h-4"><path style="fill:currentColor" d="M15.584 1.578a7.91 7.91 0 0 1-1.57 1.807v.482c0 .965-.112 1.929-.336 2.772-.224.965-.673 1.808-1.121 2.652a17.373 17.373 0 0 1-1.794 2.29c-.785.723-1.681 1.205-2.578 1.566-1.01.362-2.13.603-3.252.603-1.793 0-3.475-.603-4.932-1.567h.784c1.458 0 2.915-.482 4.036-1.446a2.914 2.914 0 0 1-1.905-.723c-.561-.482-.897-.964-1.122-1.687h.561c.336 0 .56 0 .897-.12C2.579 8.085 1.907 7.603 1.458 7 .785 6.398.561 5.675.561 4.83c.449.242 1.01.362 1.458.483A5.531 5.531 0 0 1 .898 4.109C.673 3.626.449 3.024.449 2.42c0-.602.112-1.205.449-1.687a8.606 8.606 0 0 0 2.914 2.53c1.122.603 2.355.965 3.7 1.086 0-.241-.112-.483-.112-.844 0-.723.224-1.326.56-1.928.337-.603.897-.965 1.458-1.326.56-.241 1.233-.362 1.906-.12.672.12 1.233.481 1.681.964.673-.121 1.458-.362 2.018-.844-.224.844-.784 1.446-1.457 1.928.785-.12 1.457-.24 2.018-.602Z" fill="#081026"></path></svg></div></div></div><button class="rounded px-4 py-2 uppercase text-white select-none  transition-all duration-300 bg-gradient-to-br from-primary-800 to-secondary-400 via-primary-600 bg-size-200 bg-pos-0 hover:bg-pos-100 !outline-none normal-case text-sm w-[140px] w-36">Connect Wallet</button></div></div></header><main class="gap-y-20 mt-8 py-4 sm:px-8 md:px-12 w-full min-h-[500px] max-w-4xl"><div class="flex flex-col justify-between gap-y-20"><div class="content markdown"><h1 class="text-center">Bug Report</h1><h2 class="text-center">Uninterested Unicorns</h2><p class="text-slate-500 text-sm text-center">12 Mar 2022</p><div class="mt-16"><p>There&#x27;s a bug that seems to occur fairly frequently in the NFT projects venturing
into the DeFi-space.
My guess is that this is because there have not been
fully audited ERC721 and trusted staking contracts,
like the Synthetix staking contract.
I first got to know this bug through Mutant Cats&#x27; <a target="_blank" rel="noreferrer" class="link" href="https://etherscan.io/address/0xb2f43262fc23d253538ca5f7b4890f89f0ee95d9#code">FishFarm</a>
and
Stacked Toadz&#x27; <a target="_blank" rel="noreferrer" class="link" href="https://etherscan.io/address/0x4d1de90bca7a38c556c356c0b802b5102cea032d#code">ERC721Farm</a>.</p>
<p>Mutant Cats were lucky enough to get notified by the community about the vulerability
and began migrating to a new staking contract in time.
Stacked Toadz <a target="_blank" rel="noreferrer" class="link" href="https://twitter.com/stacked_toadz/status/1448953720348102660">were not so lucky</a>
with the hacker making off with 43 ETH from the looted $STACKS.</p>
<p>Because of a project I&#x27;m working on, I wanted to make sure that all of the tokens that will be
able to interact with our eco-system follow the ERC20 standard
(and don&#x27;t resort to a O(N) balanceOf implementation).
And just out of curiosity I went ahead and looked at some of their implementations.</p>
<p>I was able to find the same bug in <a target="_blank" rel="noreferrer" class="link" href="https://etherscan.io/address/0x3a6d70e7989ba6e7d5958d7c1eea487082681698/advanced#code">UniQuest</a>, the staking contract for Uninterested Unicorns.
The Unicandy UCD-ETH pool maximally allowed for swapping out around 100 ETH.</p>
<h2>The code</h2>
<p>The relevant code to claim ERC20 rewards for Mutant Cats is shown below.</p>
<pre><pre before="FishFarm.sol" class="" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code style="white-space:pre"><span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">FishFarm</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#d4d4d4">.</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">calculateRewards</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">address</span><span> account</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">uint256</span><span class="token" style="color:#d4d4d4">[</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#569CD6">memory</span><span> tokenIds</span><span class="token" style="color:#d4d4d4">)</span><span>
</span></span><span><span>        </span><span class="token" style="color:#569CD6">public</span><span>
</span></span><span><span>        </span><span class="token" style="color:#569CD6">view</span><span>
</span></span><span><span>        </span><span class="token" style="color:#569CD6">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint256</span><span class="token" style="color:#d4d4d4">[</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#569CD6">memory</span><span> rewards</span><span class="token" style="color:#d4d4d4">)</span><span>
</span></span><span><span>    </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span>        rewards </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569CD6">new</span><span> </span><span class="token" style="color:#4ec9b0">uint256</span><span class="token" style="color:#d4d4d4">[</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">(</span><span>tokenIds</span><span class="token" style="color:#d4d4d4">.</span><span>length</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span>
</span><span><span>        </span><span class="token" style="color:#569CD6">for</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint256</span><span> i</span><span class="token" style="color:#d4d4d4">;</span><span> i </span><span class="token" style="color:#d4d4d4">&lt;</span><span> tokenIds</span><span class="token" style="color:#d4d4d4">.</span><span>length</span><span class="token" style="color:#d4d4d4">;</span><span> i</span><span class="token" style="color:#d4d4d4">++</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span>            </span><span class="token" style="color:#ce9178">uint256</span><span> tokenId </span><span class="token" style="color:#d4d4d4">=</span><span> tokenIds</span><span class="token" style="color:#d4d4d4">[</span><span>i</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span>
</span><span><span>            rewards</span><span class="token" style="color:#d4d4d4">[</span><span>i</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span>
</span></span><span><span>                RATE </span><span class="token" style="color:#d4d4d4">*</span><span>
</span></span><span><span>                </span><span class="token" style="color:#d4d4d4">(</span><span>_deposits</span><span class="token" style="color:#d4d4d4">[</span><span>account</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">contains</span><span class="token" style="color:#d4d4d4">(</span><span>tokenId</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">?</span><span> </span><span class="token" style="color:#b5cea8">1</span><span> </span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">*</span><span>
</span></span><span><span>                </span><span class="token" style="color:#d4d4d4">(</span><span>Math</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">min</span><span class="token" style="color:#d4d4d4">(</span><span>block</span><span class="token" style="color:#d4d4d4">.</span><span>number</span><span class="token" style="color:#d4d4d4">,</span><span> EXPIRATION</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">-</span><span>
</span></span><span><span>                    depositBlocks</span><span class="token" style="color:#d4d4d4">[</span><span>account</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">[</span><span>tokenId</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span>        </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">claimRewards</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint256</span><span class="token" style="color:#d4d4d4">[</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#569CD6">calldata</span><span> tokenIds</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span>        </span><span class="token" style="color:#ce9178">uint256</span><span> reward</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span>        </span><span class="token" style="color:#ce9178">uint256</span><span> block </span><span class="token" style="color:#d4d4d4">=</span><span> Math</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">min</span><span class="token" style="color:#d4d4d4">(</span><span>block</span><span class="token" style="color:#d4d4d4">.</span><span>number</span><span class="token" style="color:#d4d4d4">,</span><span> EXPIRATION</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span>
</span><span><span>        </span><span class="token" style="color:#ce9178">uint256</span><span class="token" style="color:#d4d4d4">[</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#569CD6">memory</span><span> rewards </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">calculateRewards</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">,</span><span> tokenIds</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span>
</span><span><span>        </span><span class="token" style="color:#569CD6">for</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint256</span><span> i</span><span class="token" style="color:#d4d4d4">;</span><span> i </span><span class="token" style="color:#d4d4d4">&lt;</span><span> tokenIds</span><span class="token" style="color:#d4d4d4">.</span><span>length</span><span class="token" style="color:#d4d4d4">;</span><span> i</span><span class="token" style="color:#d4d4d4">++</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span>            reward </span><span class="token" style="color:#d4d4d4">+=</span><span> rewards</span><span class="token" style="color:#d4d4d4">[</span><span>i</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span>            depositBlocks</span><span class="token" style="color:#d4d4d4">[</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">[</span><span>tokenIds</span><span class="token" style="color:#d4d4d4">[</span><span>i</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> block</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span>        </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span>
</span><span><span>        </span><span class="token" style="color:#569CD6">if</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span>reward </span><span class="token" style="color:#d4d4d4">&gt;</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span>            try </span><span class="token" style="color:#dcdcaa">IERC20</span><span class="token" style="color:#d4d4d4">(</span><span>FISH</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">transfer</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">,</span><span> reward</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">bool</span><span> v</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span>            </span><span class="token" style="color:#d4d4d4">}</span><span> catch </span><span class="token" style="color:#dcdcaa">Error</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">string</span><span> </span><span class="token" style="color:#569CD6">memory</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span>        </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span></span><span class="token" style="color:#d4d4d4">}</span></span></code></pre></pre>
<p>The <code>claimHODLRewards</code> is part of the
<a target="_blank" rel="noreferrer" class="link" href="https://etherscan.io/address/0x3a6d70e7989ba6e7d5958d7c1eea487082681698/advanced#code">UniQuest</a>
staking contract for Uninterested Unicorns NFT.</p>
<pre><pre before="UniQuest.sol" class="" style="color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e"><code style="white-space:pre"><span><span class="token" style="color:#569CD6">contract</span><span> </span><span class="token" style="color:#4ec9b0">UniQuest</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#d4d4d4">.</span><span>
</span></span><span>
</span><span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">claimHODLRewards</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint256</span><span class="token" style="color:#d4d4d4">[</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#569CD6">memory</span><span> tokenIds</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">public</span><span> nonReentrant </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span>        </span><span class="token" style="color:#569CD6">for</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint256</span><span> i </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">;</span><span> i </span><span class="token" style="color:#d4d4d4">&lt;</span><span> tokenIds</span><span class="token" style="color:#d4d4d4">.</span><span>length</span><span class="token" style="color:#d4d4d4">;</span><span> i</span><span class="token" style="color:#d4d4d4">++</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span>            </span><span class="token" style="color:#569CD6">require</span><span class="token" style="color:#d4d4d4">(</span><span>
</span></span><span><span>                UU</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">ownerOf</span><span class="token" style="color:#d4d4d4">(</span><span>tokenIds</span><span class="token" style="color:#d4d4d4">[</span><span>i</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">==</span><span> msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">,</span><span>
</span></span><span><span>                </span><span class="token" style="color:#ce9178">&quot;UniQuest: Not Owner of token&quot;</span><span>
</span></span><span><span>            </span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span>        </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span>
</span><span><span>        </span><span class="token" style="color:#ce9178">uint256</span><span> rewards </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">calculateHODLRewards</span><span class="token" style="color:#d4d4d4">(</span><span>tokenIds</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span>
</span><span><span>        </span><span class="token" style="color:#569CD6">for</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint256</span><span> i </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">;</span><span> i </span><span class="token" style="color:#d4d4d4">&lt;</span><span> tokenIds</span><span class="token" style="color:#d4d4d4">.</span><span>length</span><span class="token" style="color:#d4d4d4">;</span><span> i</span><span class="token" style="color:#d4d4d4">++</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span>            HODLLastClaim</span><span class="token" style="color:#d4d4d4">[</span><span>tokenIds</span><span class="token" style="color:#d4d4d4">[</span><span>i</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> block</span><span class="token" style="color:#d4d4d4">.</span><span>timestamp</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span>        </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span>
</span><span><span>        UCD</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#dcdcaa">mint</span><span class="token" style="color:#d4d4d4">(</span><span>msg</span><span class="token" style="color:#d4d4d4">.</span><span>sender</span><span class="token" style="color:#d4d4d4">,</span><span> rewards</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span>
</span><span>
</span><span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">calculateHODLRewards</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint256</span><span class="token" style="color:#d4d4d4">[</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#569CD6">memory</span><span> tokenIds</span><span class="token" style="color:#d4d4d4">)</span><span>
</span></span><span><span>        </span><span class="token" style="color:#569CD6">public</span><span>
</span></span><span><span>        </span><span class="token" style="color:#569CD6">view</span><span>
</span></span><span><span>        </span><span class="token" style="color:#569CD6">returns</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint256</span><span> HODLRewards</span><span class="token" style="color:#d4d4d4">)</span><span>
</span></span><span><span>    </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span>        HODLRewards </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">;</span><span>
</span></span><span><span>        </span><span class="token" style="color:#569CD6">for</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">uint256</span><span> i </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">;</span><span> i </span><span class="token" style="color:#d4d4d4">&lt;</span><span> tokenIds</span><span class="token" style="color:#d4d4d4">.</span><span>length</span><span class="token" style="color:#d4d4d4">;</span><span> i</span><span class="token" style="color:#d4d4d4">++</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span></span><span><span>            HODLRewards </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#d4d4d4">.</span><span>
</span></span><span><span>        </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span></span><span><span></span><span class="token" style="color:#d4d4d4">}</span></span></code></pre></pre>
<h2>The bug</h2>
<p>The bug is possible because in both contracts, the rewards calculation is separated from the
state-update to the blockchain and because they allow for unchecked user input.
The reward is calculated by first looping over the user-inputted token ids.
And only afterwards the claimed timestamp for each token id is set in another loop.</p>
<p>The problem is that the user is able to input a token id they own
as many times as they want. There is nothing stopping them
from inputting <code>claimRewards([3, 3, 3, 3, ...])</code> for example.
This allows the attacker to mint an unlimited amount of tokens from
the staking contract.</p>
<h2>The solution</h2>
<p>A checks-effects-interactions pattern - well known for guarding
against reentrancy bugs - would have prevented these exploits from being possible.
Instead of using two-loops, the correct way would be to use one loop
and to set the timestamp for the last claim directly after checking
the rewards for a certain token id.</p>
<p>Also, in general it makes sense to limit the degree-of-freedom a user has
while interacting with a contract. <strong>Fishfarm</strong> had direct access to <code>_deposits</code>
and <strong>Uninterested Unicorns</strong> is an <em>ERC721Enumerable</em>, so both contracts
could have implemented a function <code>claimRewards()</code> instead that
directly claims the rewards for all token ids, thereby
limiting attack vectors through malicious user-input.</p>
<p>After getting into contact with the Uninterested Unicorns team, they were able to
upgrade their proxy contract&#x27;s implementation - no unicorns hurt.</p></div></div><div class="soldisc bg-slate-800/40 text-slate-300 -mx-4 px-4 p-4 rounded-xl border border-white/20"><div class="text-lg py-2"><span class="font-display bg-gradient-to-r from-primary-400 to-secondary-500 bg-clip-text text-transparent">SolDisc</span> <span class="text-sm text-slate-400 ml-1">- On-Chain Discourse</span></div><div class="flex justify-center m-4"><button class="rounded px-4 py-2 uppercase text-white select-none  transition-all duration-300 text-primary-600 hover:text-primary-100">Connect to Rinkeby</button></div></div></div></main></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"slug":["2022","unexpected-input"],"contentRaw":"\nThere's a bug that seems to occur fairly frequently in the NFT projects venturing\ninto the DeFi-space.\nMy guess is that this is because there have not been\nfully audited ERC721 and trusted staking contracts,\nlike the Synthetix staking contract.\nI first got to know this bug through Mutant Cats' [FishFarm](https://etherscan.io/address/0xb2f43262fc23d253538ca5f7b4890f89f0ee95d9#code)\nand\nStacked Toadz' [ERC721Farm](https://etherscan.io/address/0x4d1de90bca7a38c556c356c0b802b5102cea032d#code).\n\nMutant Cats were lucky enough to get notified by the community about the vulerability\nand began migrating to a new staking contract in time.\nStacked Toadz [were not so lucky](https://twitter.com/stacked_toadz/status/1448953720348102660)\nwith the hacker making off with 43 ETH from the looted $STACKS.\n\nBecause of a project I'm working on, I wanted to make sure that all of the tokens that will be\nable to interact with our eco-system follow the ERC20 standard\n(and don't resort to a O(N) balanceOf implementation).\nAnd just out of curiosity I went ahead and looked at some of their implementations.\n\nI was able to find the same bug in [UniQuest](https://etherscan.io/address/0x3a6d70e7989ba6e7d5958d7c1eea487082681698/advanced#code), the staking contract for Uninterested Unicorns.\nThe Unicandy UCD-ETH pool maximally allowed for swapping out around 100 ETH.\n\n# The code\n\nThe relevant code to claim ERC20 rewards for Mutant Cats is shown below.\n\n```FishFarm.sol\ncontract FishFarm {\n\n    ...\n\n    function calculateRewards(address account, uint256[] memory tokenIds)\n        public\n        view\n        returns (uint256[] memory rewards)\n    {\n        rewards = new uint256[](tokenIds.length);\n\n        for (uint256 i; i \u003c tokenIds.length; i++) {\n            uint256 tokenId = tokenIds[i];\n\n            rewards[i] =\n                RATE *\n                (_deposits[account].contains(tokenId) ? 1 : 0) *\n                (Math.min(block.number, EXPIRATION) -\n                    depositBlocks[account][tokenId]);\n        }\n    }\n\n    function claimRewards(uint256[] calldata tokenIds) public {\n        uint256 reward;\n        uint256 block = Math.min(block.number, EXPIRATION);\n\n        uint256[] memory rewards = calculateRewards(msg.sender, tokenIds);\n\n        for (uint256 i; i \u003c tokenIds.length; i++) {\n            reward += rewards[i];\n            depositBlocks[msg.sender][tokenIds[i]] = block;\n        }\n\n        if (reward \u003e 0) {\n            try IERC20(FISH).transfer(msg.sender, reward) returns (bool v) {\n            } catch Error(string memory) {}\n        }\n    }\n}\n```\n\nThe `claimHODLRewards` is part of the\n[UniQuest](https://etherscan.io/address/0x3a6d70e7989ba6e7d5958d7c1eea487082681698/advanced#code)\nstaking contract for Uninterested Unicorns NFT.\n\n```UniQuest.sol\ncontract UniQuest {\n\n    ...\n\n    function claimHODLRewards(uint256[] memory tokenIds) public nonReentrant {\n        for (uint256 i = 0; i \u003c tokenIds.length; i++) {\n            require(\n                UU.ownerOf(tokenIds[i]) == msg.sender,\n                \"UniQuest: Not Owner of token\"\n            );\n        }\n\n        uint256 rewards = calculateHODLRewards(tokenIds);\n\n        for (uint256 i = 0; i \u003c tokenIds.length; i++) {\n            HODLLastClaim[tokenIds[i]] = block.timestamp;\n        }\n\n        UCD.mint(msg.sender, rewards);\n    }\n\n\n    function calculateHODLRewards(uint256[] memory tokenIds)\n        public\n        view\n        returns (uint256 HODLRewards)\n    {\n        HODLRewards = 0;\n        for (uint256 i = 0; i \u003c tokenIds.length; i++) {\n            HODLRewards = ...\n        }\n    }\n}\n```\n\n# The bug\n\nThe bug is possible because in both contracts, the rewards calculation is separated from the\nstate-update to the blockchain and because they allow for unchecked user input.\nThe reward is calculated by first looping over the user-inputted token ids.\nAnd only afterwards the claimed timestamp for each token id is set in another loop.\n\nThe problem is that the user is able to input a token id they own\nas many times as they want. There is nothing stopping them\nfrom inputting `claimRewards([3, 3, 3, 3, ...])` for example.\nThis allows the attacker to mint an unlimited amount of tokens from\nthe staking contract.\n\n# The solution\n\nA checks-effects-interactions pattern - well known for guarding\nagainst reentrancy bugs - would have prevented these exploits from being possible.\nInstead of using two-loops, the correct way would be to use one loop\nand to set the timestamp for the last claim directly after checking\nthe rewards for a certain token id.\n\nAlso, in general it makes sense to limit the degree-of-freedom a user has\nwhile interacting with a contract. **Fishfarm** had direct access to `_deposits`\nand **Uninterested Unicorns** is an _ERC721Enumerable_, so both contracts\ncould have implemented a function `claimRewards()` instead that\ndirectly claims the rewards for all token ids, thereby\nlimiting attack vectors through malicious user-input.\n\nAfter getting into contact with the Uninterested Unicorns team, they were able to\nupgrade their proxy contract's implementation - no unicorns hurt.\n","title":"Bug Report","suptitle":"Uninterested Unicorns","date":"12 Mar 2022","excerpt":"There's a bug that seems to occur fairly frequently in the NFT projects venturing into the DeFi-space."}},"__N_SSG":true},"page":"/blog/[...slug]","query":{"slug":["2022","unexpected-input"]},"buildId":"n8qznOBSmCueRicKELSX2","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>
<!DOCTYPE html><html><head><meta charSet="utf-8"/><title class="animate__fadeIn">0xPhaze</title><meta name="viewport" content="initial-scale=1.0, width=device-width"/><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/fcf81e63369216ac.css" as="style"/><link rel="stylesheet" href="/_next/static/css/fcf81e63369216ac.css" data-n-g=""/><link rel="preload" href="/_next/static/css/65875c30e26bdd78.css" as="style"/><link rel="stylesheet" href="/_next/static/css/65875c30e26bdd78.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-ede13cf31a63337e.js" defer=""></script><script src="/_next/static/chunks/framework-bb5c596eafb42b22.js" defer=""></script><script src="/_next/static/chunks/main-914fbfab4f90b52f.js" defer=""></script><script src="/_next/static/chunks/pages/_app-ad82082731d58181.js" defer=""></script><script src="/_next/static/chunks/175675d1-5e59763be147fa1f.js" defer=""></script><script src="/_next/static/chunks/634-958ce5c52c8283ef.js" defer=""></script><script src="/_next/static/chunks/pages/%5B...slug%5D-1036fd4ff48bafcd.js" defer=""></script><script src="/_next/static/anQS0UR8oNItiQN4Mw4Oo/_buildManifest.js" defer=""></script><script src="/_next/static/anQS0UR8oNItiQN4Mw4Oo/_ssgManifest.js" defer=""></script><script src="/_next/static/anQS0UR8oNItiQN4Mw4Oo/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="app px-4 pb-20 min-h-screen flex flex-col items-center w-full max-w-screen"><header class="w-full flex flex-col px-4 sm:px-8 md:px-12 max-w-5xl sm:flex-row justify-between items-center border-white/20 overflow-hidden border-b p-4 h-16"><div class="w-full h-full flex flex-col sm:flex-row justify-start sm:justify-between items-center gap-y-4 overflow-hidden sm:overflow-visible"><div class="flex w-full sm:w-fit items-center"><h1 class="text-xl mx-auto font-display"><a href="/">0xPhaze</a></h1><div class="my-auto -ml-6 w-6 sm:hidden"><div class="text-slate-300 hover:text-secondary-400 transition-colors duration-200 cursor-pointer h-6"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="bars" class="svg-inline--fa fa-bars " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416C433.7 64 448 78.33 448 96C448 113.7 433.7 128 416 128H32C14.33 128 0 113.7 0 96zM0 256C0 238.3 14.33 224 32 224H416C433.7 224 448 238.3 448 256C448 273.7 433.7 288 416 288H32C14.33 288 0 273.7 0 256zM416 448H32C14.33 448 0 433.7 0 416C0 398.3 14.33 384 32 384H416C433.7 384 448 398.3 448 416C448 433.7 433.7 448 416 448z"></path></svg></div></div></div><div class="flex flex-col sm:flex-row gap-x-8 md:gap-x-10 gap-y-4"><div class="flex gap-x-2 sm:gap-x-5 items-center justify-evenly"><a target="_blank" rel="noreferrer" class="link" href="https://github.com/0xPhaze/"><div><div class="text-slate-300 hover:text-secondary-400 transition-colors duration-200 cursor-pointer"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-4"><path style="fill:currentColor" d="M12 0C5.374 0 0 5.373 0 12c0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23A11.509 11.509 0 0 1 12 5.803c1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.3 24 12c0-6.627-5.373-12-12-12z"></path></svg></div></div></a><a target="_blank" rel="noreferrer" class="link" href="https://twitter.com/lovethewired"><div><div class="text-slate-300 hover:text-secondary-400 transition-colors duration-200 cursor-pointer"><svg viewBox="0 0 16 14" fill="none" xmlns="http://www.w3.org/2000/svg" class="h-4"><path style="fill:currentColor" d="M15.584 1.578a7.91 7.91 0 0 1-1.57 1.807v.482c0 .965-.112 1.929-.336 2.772-.224.965-.673 1.808-1.121 2.652a17.373 17.373 0 0 1-1.794 2.29c-.785.723-1.681 1.205-2.578 1.566-1.01.362-2.13.603-3.252.603-1.793 0-3.475-.603-4.932-1.567h.784c1.458 0 2.915-.482 4.036-1.446a2.914 2.914 0 0 1-1.905-.723c-.561-.482-.897-.964-1.122-1.687h.561c.336 0 .56 0 .897-.12C2.579 8.085 1.907 7.603 1.458 7 .785 6.398.561 5.675.561 4.83c.449.242 1.01.362 1.458.483A5.531 5.531 0 0 1 .898 4.109C.673 3.626.449 3.024.449 2.42c0-.602.112-1.205.449-1.687a8.606 8.606 0 0 0 2.914 2.53c1.122.603 2.355.965 3.7 1.086 0-.241-.112-.483-.112-.844 0-.723.224-1.326.56-1.928.337-.603.897-.965 1.458-1.326.56-.241 1.233-.362 1.906-.12.672.12 1.233.481 1.681.964.673-.121 1.458-.362 2.018-.844-.224.844-.784 1.446-1.457 1.928.785-.12 1.457-.24 2.018-.602Z" fill="#081026"></path></svg></div></div></a><div><div class="text-slate-300 hover:text-secondary-400 transition-colors duration-200 cursor-pointer">ABI</div></div><div><div class="text-slate-300 hover:text-secondary-400 transition-colors duration-200 cursor-pointer">ENC</div></div></div><button class="rounded px-4 py-2 uppercase text-white select-none  transition-all duration-300 disabled:pointer-events-none bg-primary-600 hover:bg-primary-700  !outline-none normal-case text-sm w-[140px] w-36">Connect Wallet</button></div></div></header><main class="gap-y-20 mt-8 py-4 sm:px-8 md:px-12 w-full min-h-[500px] max-w-4xl"><div class="flex flex-col justify-between gap-y-20"><div class="content markdown"><h1 class="text-center">Haki/Sekira Contract Audit</h1><p class="text-slate-500 text-sm text-center">Jun 21, 2022</p><div class="mt-16"><h2 id="table-of-contents"><a href="/audit/2022/haki-audit#table-of-contents"><span class="icon icon-link"></span></a>Table of Contents</h2>
<ul>
<li>
<p><a href="/audit/2022/haki-audit#context">Context</a></p>
</li>
<li>
<p><a href="/audit/2022/haki-audit#overview">Overview</a></p>
</li>
<li>
<p><a href="/audit/2022/haki-audit#scope">Scope</a></p>
</li>
<li>
<p><a href="/audit/2022/haki-audit#summary">Summary</a></p>
</li>
<li>
<p><a href="/audit/2022/haki-audit#audit-findings-classifications">Audit Findings Classifications</a></p>
<ul>
<li><a href="/audit/2022/haki-audit#threat-levels">Threat-Levels</a></li>
<li><a href="/audit/2022/haki-audit#categories">Categories</a></li>
</ul>
</li>
<li>
<p><a href="/audit/2022/haki-audit#medium-findings">Medium Findings</a></p>
<ul>
<li><a href="/audit/2022/haki-audit#zap-shrinetokensol-state-desync-possible">‚ö° [ShrineToken.sol] State-Desync Possible</a></li>
<li><a href="/audit/2022/haki-audit#zap-theshrinesol-hardcoded-testnet-address">‚ö° [TheShrine.sol] Hardcoded Testnet Address</a></li>
</ul>
</li>
<li>
<p><a href="/audit/2022/haki-audit#minor-findings">Minor Findings</a></p>
<ul>
<li><a href="/audit/2022/haki-audit#zap-fxbaseroottunnelsol-unprotected-function">‚ö° [FxBaseRootTunnel.sol] Unprotected Function</a></li>
<li><a href="/audit/2022/haki-audit#recycle-shrinetokensol-reduce-use-of-permits">‚ôªÔ∏è [ShrineToken.sol] Reduce Use of Permits</a></li>
<li><a href="/audit/2022/haki-audit#recycle-shrinetokensol-reduce-logic-for-tracking-staked-contracts">‚ôªÔ∏è [ShrineToken.sol] Reduce Logic for Tracking Staked Contracts</a></li>
<li><a href="/audit/2022/haki-audit#recycle-theshrinesol-nearly-identical-logic">‚ôªÔ∏è [TheShrine.sol] Nearly Identical Logic</a></li>
<li><a href="/audit/2022/haki-audit#recycle-theshrinesol-reduce-external-calls">‚ôªÔ∏è [TheShrine.sol] Reduce External Calls</a></li>
<li><a href="/audit/2022/haki-audit#recycle-theshrinesol-optimize-storage-readswrites">‚ôªÔ∏è [TheShrine.sol] Optimize Storage Reads/Writes</a></li>
<li><a href="/audit/2022/haki-audit#recycle-sekiraverifiersol-remove-unused-logic">‚ôªÔ∏è [SekiraVerifier.sol] Remove Unused Logic</a></li>
<li><a href="/audit/2022/haki-audit#%EF%B8%8F%EF%B8%8Frecycle-fxbaseroottunnelsol-make-non-changing-variables-immutable">Ô∏èÔ∏è‚ôªÔ∏è [FxBaseRootTunnel.sol] Make Non-Changing Variables Immutable</a></li>
</ul>
</li>
<li>
<p><a href="/audit/2022/haki-audit#disclaimer">Disclaimer</a></p>
</li>
</ul>
<h2 id="context"><a href="/audit/2022/haki-audit#context"><span class="icon icon-link"></span></a>Context</h2>
<p>The audit was performed as a &quot;non-extensive review&quot;.
This means that solely the code is reviewed as is
and no further tests have been prepared for this review.
Unit-tests are essential for ensuring correct behavior and calculations.</p>
<p>This audit is a review of the <a target="_blank" rel="noreferrer" class="link" href="https://github.com/rekttdoteth/haki-staking-contract">Haki staking contracts</a>
(private)
and was performed at commit
<a target="_blank" rel="noreferrer" class="link" href="https://github.com/rekttdoteth/haki-staking-contract/commit/77865daafe1311dd45ad29bb8087f55fdc660c54">77865daafe1311dd45ad29bb8087f55fdc660c54</a>.</p>
<p>The given repository itself contains no tests.</p>
<p><strong>Focus:</strong></p>
<p>Gas optimizations (specifically storage accesses)
on <code>TheShrine.sol</code> (to be deployed on Ethereum) are highlighted, whereas they are largely ignored for <code>ShrineToken.sol</code> (to be deployed on Polygon).</p>
<p>Special attention was given to unauthorized access-control and exploitability. Logical errors were covered as best as possible,
although these require extensive unit-testing to cover appropriately.</p>
<h2 id="overview"><a href="/audit/2022/haki-audit#overview"><span class="icon icon-link"></span></a>Overview</h2>
<p>The client has designed contracts that allow for staking of ERC721 NFTs.
While the staking itself will be performed on Ethereum,
staking rewards are emitted as ERC20 tokens on Polygon.
The communication between the chains is done using Polygon&#x27;s
<a target="_blank" rel="noreferrer" class="link" href="https://github.com/fx-portal/contracts">flexible portal contracts</a>.
Staking on Ethereum is handled by
<code>TheShrine.sol</code> which is designed to be able to handle multiple ERC721 contracts.
<code>ShrineToken.sol</code> is an ERC20 token on Polygon that contains logic
to handle state updates from the root contract <code>TheShrine.sol</code>.
<code>SekiraVerifier.sol</code> acts as a simple &quot;proxy&quot; that allows counting owned and staked NFT balances for the <em>Sekira</em> contract.</p>
<h2 id="scope"><a href="/audit/2022/haki-audit#scope"><span class="icon icon-link"></span></a>Scope</h2>
<p>The repository contains the following contracts</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span>‚îî‚îÄ‚îÄ contracts
</span></span><span>    ‚îú‚îÄ‚îÄ ERC20.sol
</span><span>    ‚îú‚îÄ‚îÄ ExitPayloadReader.sol
</span><span>    ‚îú‚îÄ‚îÄ FxBaseChildTunnel.sol
</span><span>    ‚îú‚îÄ‚îÄ FxBaseRootTunnel.sol
</span><span>    ‚îú‚îÄ‚îÄ Merkle.sol
</span><span>    ‚îú‚îÄ‚îÄ MerklePatriciaProof.sol
</span><span>    ‚îú‚îÄ‚îÄ RLPReader.sol
</span><span>    ‚îú‚îÄ‚îÄ SekiraVerifier.sol
</span><span>    ‚îú‚îÄ‚îÄ ShrineToken.sol
</span><span>    ‚îî‚îÄ‚îÄ TheShrine.sol
</span></code></pre></pre>
<p>As a basis for the ERC20 contract, <code>ShrineToken.sol</code> uses Rari-Capital solmate&#x27;s <a target="_blank" rel="noreferrer" class="link" href="https://github.com/Rari-Capital/solmate/blob/main/src/tokens/ERC20.sol">ERC20 implementation</a> <code>ERC20.sol</code>.
No noteworthy differences to the <a target="_blank" rel="noreferrer" class="link" href="https://github.com/Rari-Capital/solmate/commit/25015a1d18e75921f8cb1bacd4beb9f364e788a9">latest commit</a> exist.</p>
<p>Polygon&#x27;s <a target="_blank" rel="noreferrer" class="link" href="https://github.com/fx-portal/contracts">flexible portal contracts</a>
are being used for message passing between Ethereum and Polygon.
No noteworthy differences to the <a target="_blank" rel="noreferrer" class="link" href="https://github.com/fx-portal/contracts/commit/baed24d22178201bca33140c303e0925661ec0ac">latest commit</a> exist.</p>
<p>These external contracts are out of scope.
The focus of the review is narrowed down to the following contracts.</p>
<pre><pre before="" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span>‚îî‚îÄ‚îÄ contracts
</span></span><span>    ‚îú‚îÄ‚îÄ SekiraVerifier.sol
</span><span>    ‚îú‚îÄ‚îÄ ShrineToken.sol
</span><span>    ‚îî‚îÄ‚îÄ TheShrine.sol
</span></code></pre></pre>
<h2 id="summary"><a href="/audit/2022/haki-audit#summary"><span class="icon icon-link"></span></a>Summary</h2>
<p>No critical errors were identified.</p>
<p>The contracts could benefit from simplification
to reduce complexity, computation and storage access.
Furthermore, although not explicitly detailed,
repetition of contract logic/functions can be avoided.
This would also help validate logic and improve readability.
It is further noted that the use of custom errors vs. require-statements could chosen consistently and docstring comments could be standardized.</p>
<h2 id="audit-findings-classifications"><a href="/audit/2022/haki-audit#audit-findings-classifications"><span class="icon icon-link"></span></a>Audit Findings Classifications</h2>
<h3 id="threat-levels"><a href="/audit/2022/haki-audit#threat-levels"><span class="icon icon-link"></span></a>Threat-Levels</h3>

























<table><thead><tr><th style="text-align:center">Threat-Level</th><th style="text-align:center">Description</th></tr></thead><tbody><tr><td style="text-align:center">Minor</td><td style="text-align:center">Includes optimizations, best practices, readability or misused semantics. Issues can be addressed using one&#x27;s own judgement.</td></tr><tr><td style="text-align:center">Medium</td><td style="text-align:center">Includes oversights, potentially faulty logic.  These issues should be addressed unless there is a clear reason not to.</td></tr><tr><td style="text-align:center">Major</td><td style="text-align:center">Includes security vulnerabilities that can lead to damages or loss of user funds. These may not be directly exploitable or require certain conditions. These issues should be addressed.</td></tr><tr><td style="text-align:center">Critical</td><td style="text-align:center">Critical findings can affect the funds of a large number of users and be very bad for a client&#x27;s reputation. These issues need to be fixed.</td></tr></tbody></table>
<h3 id="categories"><a href="/audit/2022/haki-audit#categories"><span class="icon icon-link"></span></a>Categories</h3>

























<table><thead><tr><th style="text-align:center">Category</th><th style="text-align:center">Description</th></tr></thead><tbody><tr><td style="text-align:center">‚ú®</td><td style="text-align:center">Readability, best practices, misused semantics</td></tr><tr><td style="text-align:center">‚ôªÔ∏è</td><td style="text-align:center">Optimizations, suggestions for code refactors</td></tr><tr><td style="text-align:center">‚ö°</td><td style="text-align:center">Error / Logical mistake</td></tr><tr><td style="text-align:center">üí•</td><td style="text-align:center">Unauthorized access / Exploitable funds</td></tr></tbody></table>
<h2 id="medium-findings"><a href="/audit/2022/haki-audit#medium-findings"><span class="icon icon-link"></span></a>Medium Findings</h2>
<h3 id="zap-shrinetokensol-state-desync-possible"><a href="/audit/2022/haki-audit#zap-shrinetokensol-state-desync-possible"><span class="icon icon-link"></span></a>‚ö° [ShrineToken.sol] State-Desync Possible</h3>
<p>Currently <code>ShrineToken.sol</code> gets relative balance updates from the root contract <code>TheShrine.sol</code> on Ethereum.
A complete synchronization between the two chains is not guaranteed and incoming tokens are not validated to be uniquely counted in
<code>userInfo.stakedBalance</code> and <code>userInfo.stakedIds</code>.</p>
<p>Setting the child contract <code>ShrineToken.sol</code> to be paused
would lead to failed transactions and a state-desync when <code>_processMessageFromRoot</code> is called.
This would mean that, for example, unstaking on Ethereum L1
would not be updated on L2.</p>
<p>The results of this effect, however, are minimized due to the way
rewards are being calculated.
When claiming rewards, the ids found in <code>userInfo.stakedIds</code>
are iterated over and the reward is calculated based on the
<code>record</code> found for each individual id. The individual id is immediately &quot;marked&quot; as claimed by updating <code>stakeRecord.lastClaimed</code>.</p>
<p>This does, however, still mean that it could be possible for a user to claim
rewards for an NFT no longer owned, even if it is currently being
staked by someone else. Additionally, this could lead to a higher <code>multipleStakedBoostThreshold</code>.</p>
<p><strong>Mitigation:</strong>
New token ids being registered in the <code>ShrineToken</code> contract could
check whether they are currently still attributed to someone else
in the system. If they are, they should be removed from that user&#x27;s
balance/stake.</p>
<h3 id="zap-theshrinesol-hardcoded-testnet-address"><a href="/audit/2022/haki-audit#zap-theshrinesol-hardcoded-testnet-address"><span class="icon icon-link"></span></a>‚ö° [TheShrine.sol] Hardcoded Testnet Address</h3>
<pre><pre before="TheShrine.sol" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">balanceOf</span><span class="token" style="color:#bebec5">(</span><span class="token builtin">address</span><span> owner</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">external</span><span> </span><span class="token" style="color:#ef3b7d">view</span><span> </span><span class="token" style="color:#ef3b7d">returns</span><span> </span><span class="token" style="color:#bebec5">(</span><span class="token builtin">uint256</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#bebec5">{</span><span>
</span></span><span class="line line-hl"><span>        </span><span class="token builtin">address</span><span> hakiContract </span><span class="token" style="color:#a77afe">=</span><span> </span><span class="token" style="color:#a77afe">0xd053b4FdbC3470E6aAF9f65ED13AFDaA5af0d7E5</span><span class="token" style="color:#bebec5">;</span><span> 
</span></span><span><span>        </span><span class="token" style="color:#ef3b7d">return</span><span>
</span></span><span><span>            addressToContractStakedIds</span><span class="token" style="color:#bebec5">[</span><span>owner</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">[</span><span>hakiContract</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">.</span><span>length </span><span class="token" style="color:#a77afe">+</span><span>
</span></span><span><span>            </span><span class="token function">ERC721</span><span class="token" style="color:#bebec5">(</span><span>hakiContract</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">.</span><span class="token function">balanceOf</span><span class="token" style="color:#bebec5">(</span><span>owner</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<p><code>TheShrine.sol</code> contains a hardcoded <code>address hakiContract</code> which does not correspond to <code>address hakiERC721</code> of the constructor. This address currently only contains code on test-nets.</p>
<p><strong>Mitigation:</strong>
Update address pointing to the correct ERC721 contract on Ethereum or declare a variable that is set
by the constructor parameter.</p>
<p><strong>Update:</strong>
The client has responded that this address will be updated accordingly.</p>
<h2 id="minor-findings"><a href="/audit/2022/haki-audit#minor-findings"><span class="icon icon-link"></span></a>Minor Findings</h2>
<h3 id="zap-fxbaseroottunnelsol-unprotected-function"><a href="/audit/2022/haki-audit#zap-fxbaseroottunnelsol-unprotected-function"><span class="icon icon-link"></span></a>‚ö° [FxBaseRootTunnel.sol] Unprotected Function</h3>
<p><em>Note: Originally declared as out of scope.</em></p>
<pre><pre before="FxBaseRootTunnel.sol" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span class="line line-hl"><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">setFxChildTunnel</span><span class="token" style="color:#bebec5">(</span><span class="token builtin">address</span><span> _fxChildTunnel</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">public</span><span> virtual </span><span class="token" style="color:#bebec5">{</span><span> 
</span></span><span><span>        </span><span class="token" style="color:#ef3b7d">require</span><span class="token" style="color:#bebec5">(</span><span>fxChildTunnel </span><span class="token" style="color:#a77afe">==</span><span> </span><span class="token builtin">address</span><span class="token" style="color:#bebec5">(</span><span class="token" style="color:#a77afe">0x0</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">,</span><span> </span><span class="token" style="color:#e6d06c">&quot;FxBaseRootTunnel: CHILD_TUNNEL_ALREADY_SET&quot;</span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>        fxChildTunnel </span><span class="token" style="color:#a77afe">=</span><span> _fxChildTunnel</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<p><code>setFxChildTunnel</code> does not contain any access-control. Anyone is able to call this function. Although, once set, it cannot be changed due to the contract logic. Any malicious address is able to call this and essentially void the full contract if accidentally left unset.
This generally should be seen as bad practice, even if introduced by the Matic-Team.</p>
<p><strong>Mitigation:</strong>
Override function in inheriting contract <code>TheShrine.sol</code> and add the <code>onlyOwner</code> modifier.
A check for whether it has been set already is not strictly necessary, otherwise this could be marked as immutable, furthermore ensuring that it is set and reducing gas costs.</p>
<pre><pre before="TheShrine.sol" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span class="line line-hl"><span>    </span><span class="token" style="color:#ef3b7d">function</span><span> </span><span class="token function">setFxChildTunnel</span><span class="token" style="color:#bebec5">(</span><span class="token builtin">address</span><span> _fxChildTunnel</span><span class="token" style="color:#bebec5">)</span><span> </span><span class="token" style="color:#ef3b7d">public</span><span> override onlyOwner </span><span class="token" style="color:#bebec5">{</span><span> 
</span></span><span><span>        fxChildTunnel </span><span class="token" style="color:#a77afe">=</span><span> _fxChildTunnel</span><span class="token" style="color:#bebec5">;</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">}</span></span></code></pre></pre>
<p><em>Note:</em>
The same holds for <code>setFxRootTunnel</code> in <code>FxBaseChildTunnel.sol</code>.</p>
<h3 id="recycle-shrinetokensol-reduce-use-of-permits"><a href="/audit/2022/haki-audit#recycle-shrinetokensol-reduce-use-of-permits"><span class="icon icon-link"></span></a>‚ôªÔ∏è [ShrineToken.sol] Reduce Use of Permits</h3>
<p><code>gaslessHarvest</code> and <code>gaslessHarvestByNFT</code> allow an authorized party
to distribute pending rewards to a user.
These function are currently guarded by the <code>onlyHarvester</code> modifier
only allowing calls by previously authorized accounts.</p>
<p><strong>Mitigation:</strong>
Since <code>_harvestReward</code> does not contain any security-critical
logic, this extra authorization could be foregone to increase simplicity.</p>
<h3 id="recycle-shrinetokensol-reduce-logic-for-tracking-staked-contracts"><a href="/audit/2022/haki-audit#recycle-shrinetokensol-reduce-logic-for-tracking-staked-contracts"><span class="icon icon-link"></span></a>‚ôªÔ∏è [ShrineToken.sol] Reduce Logic for Tracking Staked Contracts</h3>
<p><code>_processMessageFromRoot</code> keeps track contracts a user
has any staked balances separately through the use of an &#x27;enumerable set&#x27;
structure. This is done via the mapping <code>addressToContractIndex</code>
that keeps track of multiple values, including an index to <code>userInfo.stakedContract</code>. There are multiple variables that are being tracked
that could be redundant.</p>
<p><strong>Mitigation:</strong>
To reduce complexity, <code>addressToContractIndex</code> and <code>userInfo.stakedContract</code> could be removed and logic could be simplified:
Instead of iterating over the <code>userInfo.stakedContract</code> array,
looping over both contracts and checking <code>userInfo.stakedIds[collection].length</code> would reduce complexity.</p>
<p>A lot of the &quot;messy&quot; logic for enumerable sets can be hidden by using
trusted libraries, like <a target="_blank" rel="noreferrer" class="link" href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/utils/structs/EnumerableSet.sol">OpenZeppelin&#x27;s Enumerable Set</a>.</p>
<h3 id="recycle-theshrinesol-nearly-identical-logic"><a href="/audit/2022/haki-audit#recycle-theshrinesol-nearly-identical-logic"><span class="icon icon-link"></span></a>‚ôªÔ∏è [TheShrine.sol] Nearly Identical Logic</h3>
<p><code>stake</code> &amp; <code>stakeMultiple</code> (and <code>unstake</code> &amp; <code>unstakeMultiple</code>) largely contain the same code.
There is very little gas overhead involved when simply using <code>stakeMultiple</code>, <code>unstakeMultiple</code>,
as these would likely involve only a few more stack-operations.
Removing duplicate code, reduces maintenance work and
simplifies interfacing the contract on a frontend
due to multiple choices of functions being considered.</p>
<p><strong>Mitigation:</strong>
Consider removing <code>stake</code> and <code>unstake</code> functions.</p>
<h3 id="recycle-theshrinesol-reduce-external-calls"><a href="/audit/2022/haki-audit#recycle-theshrinesol-reduce-external-calls"><span class="icon icon-link"></span></a>‚ôªÔ∏è [TheShrine.sol] Reduce External Calls</h3>
<p><code>_sendMessageToChild</code> is being called in a loop requiring multiple external calls (&amp; memory accesses, event emissions).</p>
<p><strong>Mitigation:</strong>
Consider directly encoding an array of token ids thus only requiring one message to be sent.</p>
<pre><pre before="TheShrine.sol" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span>    </span><span class="token function">_sendMessageToChild</span><span class="token" style="color:#bebec5">(</span><span>
</span></span><span><span>        abi</span><span class="token" style="color:#bebec5">.</span><span class="token function">encode</span><span class="token" style="color:#bebec5">(</span><span>
</span></span><span><span>            msg</span><span class="token" style="color:#bebec5">.</span><span>sender</span><span class="token" style="color:#bebec5">,</span><span>
</span></span><span><span>            collection</span><span class="token" style="color:#bebec5">,</span><span>
</span></span><span class="line line-del"><span>            tokenIds</span><span class="token" style="color:#bebec5">[</span><span>i</span><span class="token" style="color:#bebec5">]</span><span class="token" style="color:#bebec5">,</span><span> 
</span></span><span class="line line-add"><span>            tokenIds</span><span class="token" style="color:#bebec5">,</span><span> 
</span></span><span><span>            lockupDelta</span><span class="token" style="color:#bebec5">,</span><span>
</span></span><span><span>            </span><span class="token" style="color:#a77afe">true</span><span>
</span></span><span><span>        </span><span class="token" style="color:#bebec5">)</span><span>
</span></span><span><span>    </span><span class="token" style="color:#bebec5">)</span><span class="token" style="color:#bebec5">;</span></span></code></pre></pre>
<h3 id="recycle-theshrinesol-optimize-storage-readswrites"><a href="/audit/2022/haki-audit#recycle-theshrinesol-optimize-storage-readswrites"><span class="icon icon-link"></span></a>‚ôªÔ∏è [TheShrine.sol] Optimize Storage Reads/Writes</h3>
<p>Currently <code>TheShrine.sol</code> keeps track of token ownerships through the use of 3 mappings:</p>
<ul>
<li><code>contractToTokenStaker</code> (tracks token ownership)</li>
<li><code>addressToContractStakedIds</code> (enumerable list of ids per user)</li>
<li><code>contractToTokenIndex</code> (tracks indices in enumerable list)</li>
</ul>
<p>This is comparable to <code>ERC721Enumerable</code> vs. <code>ERC721</code> (logic-wise and storage cost-wise). Reducing these mappings to one would simplify logic
and lower gas costs.</p>
<p><strong>Mitigation:</strong>
The contract could simply track <code>contractToTokenStaker</code> (token ownerships) and balances.</p>
<p><em>Note:</em>
Because <code>contractToTokenIndex</code> is a mapping to a list, keeping track of ownerships
in the <code>stake</code> function update involves 4 distinct storage slots,
whereas, if optimized, it would only involve one.
This would also remove the complexity of keeping track of and re-arranging indices.</p>
<p><em>Further Note:</em>
Because <code>contractToTokenIndex</code> and <code>unlockOn</code> share the same mapping keys, these
could further be combined into one packed storage slot instead of taking up 2 separate slots.</p>
<h3 id="recycle-sekiraverifiersol-remove-unused-logic"><a href="/audit/2022/haki-audit#recycle-sekiraverifiersol-remove-unused-logic"><span class="icon icon-link"></span></a>‚ôªÔ∏è [SekiraVerifier.sol] Remove Unused Logic</h3>
<p><code>SekiraVerifier.sol</code>&#x27;s code size can be significantly reduced. This contract acts as a simple proxy that propagates owned balances and staked balances of the <em>Sekira</em> ERC721. It does not require any of the existing ERC721 logic, as it is never expected to be called (there exists no logic for minting tokens).
The only function that is necessary (for collab.land) is <code>balanceOf</code>.</p>
<p><strong>Mitigation:</strong>
Consider removing the ERC721 logic in order to save gas costs for deployment.</p>
<p><strong>Update:</strong>
The client has noted that they will be using <em>Whop</em> which requires some additional logic.</p>
<h3 id="Ô∏èÔ∏èrecycle-fxbaseroottunnelsol-make-non-changing-variables-immutable"><a href="/audit/2022/haki-audit#%EF%B8%8F%EF%B8%8Frecycle-fxbaseroottunnelsol-make-non-changing-variables-immutable"><span class="icon icon-link"></span></a>Ô∏èÔ∏è‚ôªÔ∏è [FxBaseRootTunnel.sol] Make Non-Changing Variables Immutable</h3>
<p><em>Note: Originally declared as out of scope.</em></p>
<pre><pre before="FxBaseRootTunnel.sol" class="" style="-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre-wrap;word-wrap:normal;font-family:Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:14px;color:#76d9e6;text-shadow:none;background:#2a2a2a;padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative"><code style="white-space:pre"><span><span>    </span><span class="token" style="color:#6f705e">// state sender contract</span><span>
</span></span><span class="line line-del"><span>    IFxStateSender </span><span class="token" style="color:#ef3b7d">public</span><span> fxRoot</span><span class="token" style="color:#bebec5">;</span><span> 
</span></span><span class="line line-add"><span>    IFxStateSender </span><span class="token" style="color:#ef3b7d">public</span><span> immutable fxRoot</span><span class="token" style="color:#bebec5">;</span><span> 
</span></span><span><span>    </span><span class="token" style="color:#6f705e">// root chain manager</span><span>
</span></span><span class="line line-del"><span>    ICheckpointManager </span><span class="token" style="color:#ef3b7d">public</span><span> checkpointManager</span><span class="token" style="color:#bebec5">;</span><span> 
</span></span><span class="line line-add"><span>    ICheckpointManager </span><span class="token" style="color:#ef3b7d">public</span><span> immutable checkpointManager</span><span class="token" style="color:#bebec5">;</span><span> 
</span></span><span><span>    </span><span class="token" style="color:#6f705e">// child tunnel contract which receives and sends messages</span><span>
</span></span><span><span>    </span><span class="token builtin">address</span><span> </span><span class="token" style="color:#ef3b7d">public</span><span> fxChildTunnel</span><span class="token" style="color:#bebec5">;</span></span></code></pre></pre>
<p><code>IFxStateSender fxRoot</code> and <code>ICheckpointManager checkpointManager</code>
are declared as storage variables that do not contain logic to be changed/updated in any form.</p>
<p><strong>Mitigation:</strong>
These variables can be declared <em>immutable</em> saving roughly 4200 gas.</p>
<p><em>Note</em>: <code>address fxChildTunnel</code> is not part of the constructor variables, as it requires the address of the child contract on Polygon to be set.
It is, however, possible to first deploy the child contract or to
pre-compute the address. This way <code>fxChildTunnel</code> could also be declared
<em>immutable</em> saving a total of 6300 gas.</p>
<h2 id="disclaimer"><a href="/audit/2022/haki-audit#disclaimer"><span class="icon icon-link"></span></a>Disclaimer</h2>
<p>A contract audit is <em>not</em> a security guarantee of &quot;bug-free&quot; code.
The audit is a best-effort endeavour operating within reasonable constraints
of time, understanding, expertise and decidability.
The significance of this report must be understood
in this context and given the outlined scope of the assignment.
I shall not be held liable for any future damages.</p></div></div></div></main></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"slug":["audit","2022","haki-audit"],"contentRaw":"\n\n# Table of Contents\n\n# Context\n\nThe audit was performed as a \"non-extensive review\".\nThis means that solely the code is reviewed as is\nand no further tests have been prepared for this review.\nUnit-tests are essential for ensuring correct behavior and calculations.\n\nThis audit is a review of the [Haki staking contracts](https://github.com/rekttdoteth/haki-staking-contract)\n(private)\nand was performed at commit\n[77865daafe1311dd45ad29bb8087f55fdc660c54](https://github.com/rekttdoteth/haki-staking-contract/commit/77865daafe1311dd45ad29bb8087f55fdc660c54).\n\nThe given repository itself contains no tests.\n\n**Focus:**\n\nGas optimizations (specifically storage accesses) \non `TheShrine.sol` (to be deployed on Ethereum) are highlighted, whereas they are largely ignored for `ShrineToken.sol` (to be deployed on Polygon).\n\nSpecial attention was given to unauthorized access-control and exploitability. Logical errors were covered as best as possible,\nalthough these require extensive unit-testing to cover appropriately.\n\n# Overview\n\nThe client has designed contracts that allow for staking of ERC721 NFTs.\nWhile the staking itself will be performed on Ethereum, \nstaking rewards are emitted as ERC20 tokens on Polygon.\nThe communication between the chains is done using Polygon's \n[flexible portal contracts](https://github.com/fx-portal/contracts).\nStaking on Ethereum is handled by\n`TheShrine.sol` which is designed to be able to handle multiple ERC721 contracts.\n`ShrineToken.sol` is an ERC20 token on Polygon that contains logic\nto handle state updates from the root contract `TheShrine.sol`.\n`SekiraVerifier.sol` acts as a simple \"proxy\" that allows counting owned and staked NFT balances for the _Sekira_ contract.\n\n\n# Scope\n\nThe repository contains the following contracts\n```ml\n‚îî‚îÄ‚îÄ contracts\n    ‚îú‚îÄ‚îÄ ERC20.sol\n    ‚îú‚îÄ‚îÄ ExitPayloadReader.sol\n    ‚îú‚îÄ‚îÄ FxBaseChildTunnel.sol\n    ‚îú‚îÄ‚îÄ FxBaseRootTunnel.sol\n    ‚îú‚îÄ‚îÄ Merkle.sol\n    ‚îú‚îÄ‚îÄ MerklePatriciaProof.sol\n    ‚îú‚îÄ‚îÄ RLPReader.sol\n    ‚îú‚îÄ‚îÄ SekiraVerifier.sol\n    ‚îú‚îÄ‚îÄ ShrineToken.sol\n    ‚îî‚îÄ‚îÄ TheShrine.sol\n```\n\nAs a basis for the ERC20 contract, `ShrineToken.sol` uses Rari-Capital solmate's [ERC20 implementation](https://github.com/Rari-Capital/solmate/blob/main/src/tokens/ERC20.sol) `ERC20.sol`.\nNo noteworthy differences to the [latest commit](https://github.com/Rari-Capital/solmate/commit/25015a1d18e75921f8cb1bacd4beb9f364e788a9) exist.\n\nPolygon's [flexible portal contracts](https://github.com/fx-portal/contracts)\nare being used for message passing between Ethereum and Polygon.\nNo noteworthy differences to the [latest commit](https://github.com/fx-portal/contracts/commit/baed24d22178201bca33140c303e0925661ec0ac) exist.\n\nThese external contracts are out of scope.\nThe focus of the review is narrowed down to the following contracts.\n\n```ml\n‚îî‚îÄ‚îÄ contracts\n    ‚îú‚îÄ‚îÄ SekiraVerifier.sol\n    ‚îú‚îÄ‚îÄ ShrineToken.sol\n    ‚îî‚îÄ‚îÄ TheShrine.sol\n```\n\n# Summary\n\nNo critical errors were identified.\n\nThe contracts could benefit from simplification\nto reduce complexity, computation and storage access.\nFurthermore, although not explicitly detailed,\nrepetition of contract logic/functions can be avoided.\nThis would also help validate logic and improve readability.\nIt is further noted that the use of custom errors vs. require-statements could chosen consistently and docstring comments could be standardized.\n\n# Audit Findings Classifications\n\n# Medium Findings\n\n## :zap: [ShrineToken.sol] State-Desync Possible\n\nCurrently `ShrineToken.sol` gets relative balance updates from the root contract `TheShrine.sol` on Ethereum.\nA complete synchronization between the two chains is not guaranteed and incoming tokens are not validated to be uniquely counted in \n`userInfo.stakedBalance` and `userInfo.stakedIds`. \n\nSetting the child contract `ShrineToken.sol` to be paused\nwould lead to failed transactions and a state-desync when `_processMessageFromRoot` is called.\nThis would mean that, for example, unstaking on Ethereum L1\nwould not be updated on L2.\n\nThe results of this effect, however, are minimized due to the way \nrewards are being calculated.\nWhen claiming rewards, the ids found in `userInfo.stakedIds`\nare iterated over and the reward is calculated based on the\n`record` found for each individual id. The individual id is immediately \"marked\" as claimed by updating `stakeRecord.lastClaimed`.\n\nThis does, however, still mean that it could be possible for a user to claim\nrewards for an NFT no longer owned, even if it is currently being\nstaked by someone else. Additionally, this could lead to a higher `multipleStakedBoostThreshold`.\n\n**Mitigation:**\nNew token ids being registered in the `ShrineToken` contract could\ncheck whether they are currently still attributed to someone else\nin the system. If they are, they should be removed from that user's\nbalance/stake.\n\n\n## :zap: [TheShrine.sol] Hardcoded Testnet Address \n\n```TheShrine.sol\n    function balanceOf(address owner) external view returns (uint256) {\n        address hakiContract = 0xd053b4FdbC3470E6aAF9f65ED13AFDaA5af0d7E5; //highlight-line\n        return\n            addressToContractStakedIds[owner][hakiContract].length +\n            ERC721(hakiContract).balanceOf(owner);\n    }\n```\n\n`TheShrine.sol` contains a hardcoded `address hakiContract` which does not correspond to `address hakiERC721` of the constructor. This address currently only contains code on test-nets.\n\n**Mitigation:**\nUpdate address pointing to the correct ERC721 contract on Ethereum or declare a variable that is set\nby the constructor parameter.\n\n**Update:**\nThe client has responded that this address will be updated accordingly.\n\n\n# Minor Findings\n\n## :zap: [FxBaseRootTunnel.sol] Unprotected Function\n\n_Note: Originally declared as out of scope._\n\n```FxBaseRootTunnel.sol\n    function setFxChildTunnel(address _fxChildTunnel) public virtual { //highlight-line\n        require(fxChildTunnel == address(0x0), \"FxBaseRootTunnel: CHILD_TUNNEL_ALREADY_SET\");\n        fxChildTunnel = _fxChildTunnel;\n    }\n```\n\n`setFxChildTunnel` does not contain any access-control. Anyone is able to call this function. Although, once set, it cannot be changed due to the contract logic. Any malicious address is able to call this and essentially void the full contract if accidentally left unset.\nThis generally should be seen as bad practice, even if introduced by the Matic-Team.\n\n**Mitigation:**\nOverride function in inheriting contract `TheShrine.sol` and add the `onlyOwner` modifier.\nA check for whether it has been set already is not strictly necessary, otherwise this could be marked as immutable, furthermore ensuring that it is set and reducing gas costs.\n\n```TheShrine.sol\n    function setFxChildTunnel(address _fxChildTunnel) public override onlyOwner { //highlight-line\n        fxChildTunnel = _fxChildTunnel;\n    }\n```\n\n_Note:_\nThe same holds for `setFxRootTunnel` in `FxBaseChildTunnel.sol`.\n\n\n## :recycle: [ShrineToken.sol] Reduce Use of Permits\n\n`gaslessHarvest` and `gaslessHarvestByNFT` allow an authorized party\nto distribute pending rewards to a user.\nThese function are currently guarded by the `onlyHarvester` modifier\nonly allowing calls by previously authorized accounts.\n\n**Mitigation:**\nSince `_harvestReward` does not contain any security-critical\nlogic, this extra authorization could be foregone to increase simplicity.\n\n\n## :recycle: [ShrineToken.sol] Reduce Logic for Tracking Staked Contracts\n\n`_processMessageFromRoot` keeps track contracts a user\nhas any staked balances separately through the use of an 'enumerable set'\nstructure. This is done via the mapping `addressToContractIndex`\nthat keeps track of multiple values, including an index to `userInfo.stakedContract`. There are multiple variables that are being tracked\nthat could be redundant.\n\n\n**Mitigation:**\nTo reduce complexity, `addressToContractIndex` and `userInfo.stakedContract` could be removed and logic could be simplified:\nInstead of iterating over the `userInfo.stakedContract` array,\nlooping over both contracts and checking `userInfo.stakedIds[collection].length` would reduce complexity.\n\nA lot of the \"messy\" logic for enumerable sets can be hidden by using\ntrusted libraries, like [OpenZeppelin's Enumerable Set](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/utils/structs/EnumerableSet.sol).\n\n## :recycle: [TheShrine.sol] Nearly Identical Logic\n\n`stake` \u0026 `stakeMultiple` (and `unstake` \u0026 `unstakeMultiple`) largely contain the same code.\nThere is very little gas overhead involved when simply using `stakeMultiple`, `unstakeMultiple`,\nas these would likely involve only a few more stack-operations.\nRemoving duplicate code, reduces maintenance work and \nsimplifies interfacing the contract on a frontend\ndue to multiple choices of functions being considered.\n\n**Mitigation:**\nConsider removing `stake` and `unstake` functions.\n\n## :recycle: [TheShrine.sol] Reduce External Calls\n\n`_sendMessageToChild` is being called in a loop requiring multiple external calls (\u0026 memory accesses, event emissions).\n\n**Mitigation:**\nConsider directly encoding an array of token ids thus only requiring one message to be sent.\n\n```TheShrine.sol\n    _sendMessageToChild(\n        abi.encode(\n            msg.sender,\n            collection,\n            tokenIds[i], //del-line\n            tokenIds, //add-line\n            lockupDelta,\n            true\n        )\n    );\n```\n\n## :recycle: [TheShrine.sol] Optimize Storage Reads/Writes\n\nCurrently `TheShrine.sol` keeps track of token ownerships through the use of 3 mappings:\n- `contractToTokenStaker` (tracks token ownership)\n- `addressToContractStakedIds` (enumerable list of ids per user)\n- `contractToTokenIndex` (tracks indices in enumerable list)\n\nThis is comparable to `ERC721Enumerable` vs. `ERC721` (logic-wise and storage cost-wise). Reducing these mappings to one would simplify logic\nand lower gas costs.\n\n**Mitigation:**\nThe contract could simply track `contractToTokenStaker` (token ownerships) and balances.\n\n*Note:*\nBecause `contractToTokenIndex` is a mapping to a list, keeping track of ownerships\nin the `stake` function update involves 4 distinct storage slots,\nwhereas, if optimized, it would only involve one.\nThis would also remove the complexity of keeping track of and re-arranging indices.\n\n*Further Note:*\nBecause `contractToTokenIndex` and `unlockOn` share the same mapping keys, these\ncould further be combined into one packed storage slot instead of taking up 2 separate slots.\n\n\n\n## :recycle: [SekiraVerifier.sol] Remove Unused Logic\n\n`SekiraVerifier.sol`'s code size can be significantly reduced. This contract acts as a simple proxy that propagates owned balances and staked balances of the _Sekira_ ERC721. It does not require any of the existing ERC721 logic, as it is never expected to be called (there exists no logic for minting tokens).\nThe only function that is necessary (for collab.land) is `balanceOf`.\n\n**Mitigation:**\nConsider removing the ERC721 logic in order to save gas costs for deployment.\n\n**Update:**\nThe client has noted that they will be using *Whop* which requires some additional logic.\n\n\n## Ô∏èÔ∏è:recycle: [FxBaseRootTunnel.sol] Make Non-Changing Variables Immutable\n\n_Note: Originally declared as out of scope._\n\n```FxBaseRootTunnel.sol\n    // state sender contract\n    IFxStateSender public fxRoot; //delete-line\n    IFxStateSender public immutable fxRoot; //add-line\n    // root chain manager\n    ICheckpointManager public checkpointManager; //delete-line\n    ICheckpointManager public immutable checkpointManager; //add-line\n    // child tunnel contract which receives and sends messages\n    address public fxChildTunnel;\n```\n`IFxStateSender fxRoot` and `ICheckpointManager checkpointManager`\nare declared as storage variables that do not contain logic to be changed/updated in any form.\n\n**Mitigation:**\nThese variables can be declared _immutable_ saving roughly 4200 gas.\n\n_Note_: `address fxChildTunnel` is not part of the constructor variables, as it requires the address of the child contract on Polygon to be set.\nIt is, however, possible to first deploy the child contract or to\npre-compute the address. This way `fxChildTunnel` could also be declared\n_immutable_ saving a total of 6300 gas.\n\n\n# Audit Disclaimer","title":"Haki/Sekira Contract Audit","date":"Jun 21, 2022"}},"__N_SSG":true},"page":"/[...slug]","query":{"slug":["audit","2022","haki-audit"]},"buildId":"anQS0UR8oNItiQN4Mw4Oo","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>